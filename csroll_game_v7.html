<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>CS:ROLL â€” The Ultimate CSGO Experience</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Barlow:wght@300;400;500;600&family=Barlow+Condensed:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0d0e12;--bg2:#13141a;--bg3:#1a1b23;--bg4:#22232e;--bg5:#2a2b38;
  --accent:#f0a500;--accent2:#ff6b35;--accent3:#00c8ff;
  --consumer:#b0c3d9;--industrial:#5e98d9;--milspec:#4b69ff;
  --restricted:#8847ff;--classified:#d32ce6;--covert:#eb4b4b;--knife:#e4ae39;
  --text:#e8e9f0;--text2:#9a9bb0;--text3:#5a5b70;
  --green:#2ecc71;--red:#e74c3c;--gold:#f1c40f;
  --sidebar:220px;--header:56px;
  --radius:8px;--radius2:12px;
  --shadow:0 4px 24px rgba(0,0,0,.5);
  font-size:15px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:'Barlow',sans-serif;min-height:100vh;overflow-x:hidden}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:var(--bg2)}
::-webkit-scrollbar-thumb{background:var(--bg5);border-radius:3px}
button{cursor:pointer;border:none;outline:none;font-family:'Barlow',sans-serif}
input,select{font-family:'Barlow',sans-serif;outline:none}
a{color:inherit;text-decoration:none}
.hidden{display:none!important}
.flex{display:flex}.flex-col{flex-direction:column}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-1{gap:8px}.gap-2{gap:12px}.gap-3{gap:20px}.wrap{flex-wrap:wrap}
.grid{display:grid}.g2{grid-template-columns:repeat(2,1fr)}.g3{grid-template-columns:repeat(3,1fr)}.g4{grid-template-columns:repeat(4,1fr)}.g5{grid-template-columns:repeat(5,1fr)}
.w-full{width:100%}.h-full{height:100%}
.p-1{padding:8px}.p-2{padding:16px}.p-3{padding:24px}.mt-1{margin-top:8px}.mt-2{margin-top:16px}.mb-1{margin-bottom:8px}
.text-sm{font-size:12px}.text-lg{font-size:18px}.text-xl{font-size:24px}.text-2xl{font-size:32px}
.font-bold{font-weight:700}.font-mono{font-family:'Barlow Condensed',sans-serif}
.rounded{border-radius:var(--radius)}.rounded-2{border-radius:var(--radius2)}
.card{background:var(--bg3);border:1px solid var(--bg5);border-radius:var(--radius2);padding:16px}
.card-dark{background:var(--bg2);border:1px solid var(--bg4);border-radius:var(--radius2)}
.btn{display:inline-flex;align-items:center;justify-content:center;padding:8px 18px;border-radius:var(--radius);font-weight:600;font-size:14px;transition:all .15s;letter-spacing:.3px}
.btn-primary{background:linear-gradient(135deg,#f0a500,#ff6b35);color:#000}
.btn-primary:hover{opacity:.9;transform:translateY(-1px);box-shadow:0 4px 16px rgba(240,165,0,.3)}
.btn-secondary{background:var(--bg4);color:var(--text);border:1px solid var(--bg5)}
.btn-secondary:hover{background:var(--bg5);border-color:var(--accent)}
.btn-green{background:#1a3a27;color:var(--green);border:1px solid #2ecc7140}
.btn-green:hover{background:#2ecc7120}
.btn-red{background:#3a1a1a;color:var(--red);border:1px solid #e74c3c40}
.btn-red:hover{background:#e74c3c20}
.btn-sm{padding:5px 12px;font-size:12px}
.btn-lg{padding:12px 28px;font-size:16px}
.tag{display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;letter-spacing:.5px}
.badge{background:var(--accent);color:#000;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:700}

/* ===== CUSTOM SVG ICON SYSTEM ===== */
.ico{display:inline-flex;align-items:center;justify-content:center;flex-shrink:0}
.ico svg{width:100%;height:100%;display:block}

/* ===== BOTTOM HOTBAR ===== */
#bottom-hotbar{position:fixed;bottom:0;left:0;right:0;height:62px;background:var(--bg2);border-top:1px solid var(--bg4);display:flex;align-items:stretch;z-index:200;backdrop-filter:blur(10px)}
.hb-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;cursor:pointer;transition:.15s;padding:6px 4px;color:var(--text3);border:none;background:none;font-size:9px;font-family:'Barlow',sans-serif;font-weight:600;letter-spacing:.3px;position:relative}
.hb-btn:hover{color:var(--text);background:rgba(255,255,255,.04)}
.hb-btn.active{color:var(--accent)}
.hb-btn svg{width:22px;height:22px;transition:.15s}
.hb-btn.active svg{filter:drop-shadow(0 0 4px rgba(240,165,0,.6))}
.hb-btn .hb-badge{position:absolute;top:6px;right:calc(50% - 18px);background:var(--red);color:#fff;border-radius:50%;width:14px;height:14px;font-size:8px;display:flex;align-items:center;justify-content:center;font-weight:700}
.page,.main{padding-bottom:70px}
@media(min-width:768px){#bottom-hotbar{display:none}.page,.main{padding-bottom:0}}

/* ===== COMBO CLICK SYSTEM ===== */
.combo-display{position:absolute;top:-60px;left:50%;transform:translateX(-50%);white-space:nowrap;pointer-events:none}
.combo-badge{font-family:'Rajdhani',sans-serif;font-size:28px;font-weight:700;padding:4px 16px;border-radius:8px;background:rgba(0,0,0,.7);border:2px solid var(--accent);color:var(--accent);transition:all .3s;animation:comboPulse .3s ease}
@keyframes comboPulse{0%{transform:scale(1.3)}100%{transform:scale(1)}}
.combo-badge.hot{border-color:#eb4b4b;color:#eb4b4b}
.combo-badge.ultra{border-color:#ff44ff;color:#ff44ff;box-shadow:0 0 20px rgba(255,68,255,.4)}
.combo-meter{width:200px;height:6px;background:var(--bg4);border-radius:3px;margin-top:8px;overflow:hidden}
.combo-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .1s}

/* ===== CLICK BUTTON REDESIGN ===== */
.click-btn{width:200px;height:200px;border-radius:50%;background:radial-gradient(circle at 35% 30%,#2a2c40,#0d0e16);border:3px solid var(--accent);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.08s;box-shadow:0 0 30px rgba(240,165,0,.2),0 0 60px rgba(240,165,0,.05),inset 0 -8px 20px rgba(0,0,0,.5);position:relative;overflow:hidden;padding:0}
.click-btn:active{transform:scale(.93);box-shadow:0 0 60px rgba(240,165,0,.5),inset 0 0 30px rgba(240,165,0,.1)}
.click-btn-inner{width:160px;height:160px;display:flex;align-items:center;justify-content:center;position:relative;z-index:2}

/* ===== PRESTIGE STORE ===== */
.pstore-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;margin-top:14px}
.pstore-card{background:linear-gradient(135deg,var(--bg3),var(--bg2));border:1px solid rgba(255,68,255,.2);border-radius:14px;padding:16px;display:flex;gap:12px;align-items:flex-start;transition:.2s;cursor:pointer}
.pstore-card:hover{border-color:rgba(255,68,255,.5);transform:translateY(-2px)}
.pstore-card.owned{border-color:rgba(46,204,113,.4);background:linear-gradient(135deg,#0a1a10,var(--bg2))}
.pstore-icon{width:48px;height:48px;border-radius:10px;background:rgba(255,68,255,.1);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.pstore-icon svg{width:28px;height:28px}

/* ===== RANKED MATCHES ===== */
.ranked-arena{background:linear-gradient(135deg,#0d0e16,#14091a);border:1px solid rgba(139,71,255,.3);border-radius:16px;padding:24px;text-align:center;margin-bottom:16px}
.ranked-vs{display:grid;grid-template-columns:1fr auto 1fr;gap:16px;align-items:center;margin:20px 0}
.ranked-fighter{background:var(--bg3);border-radius:12px;padding:16px;text-align:center}
.ranked-fighter-name{font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:700;margin-bottom:4px}
.ranked-fighter-elo{font-size:12px;color:var(--text2)}
.ranked-hp{height:8px;border-radius:4px;overflow:hidden;margin-top:8px;background:var(--bg5)}
.ranked-hp-fill{height:100%;border-radius:4px;transition:.4s}
.ranked-log{background:var(--bg3);border-radius:10px;padding:12px;max-height:150px;overflow-y:auto;font-size:12px;color:var(--text2);font-family:'Barlow Condensed',sans-serif;line-height:1.6;text-align:left;margin-bottom:12px}

/* ===== LUCKY WHEEL (enhanced) ===== */
.wheel-wrap{position:relative;width:300px;height:300px;margin:0 auto}
.wheel-pointer{position:absolute;top:-14px;left:50%;transform:translateX(-50%);z-index:10;filter:drop-shadow(0 2px 8px rgba(240,165,0,.6))}
.wheel-hub{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:36px;height:36px;border-radius:50%;background:var(--bg);border:3px solid var(--accent);z-index:5;box-shadow:0 0 16px rgba(240,165,0,.4)}

/* ===== QUICK BETS PANEL ===== */
.quickbet-panel{background:var(--bg3);border-radius:14px;padding:16px;margin-top:20px}
.quickbet-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px}
.qb-btn{padding:10px 8px;background:var(--bg4);border:1px solid var(--bg5);border-radius:8px;color:var(--text);font-weight:700;font-size:13px;cursor:pointer;transition:.15s;font-family:'Barlow Condensed',sans-serif;text-align:center}
.qb-btn:hover{border-color:var(--accent);background:rgba(240,165,0,.08)}
.qb-btn .qb-mult{display:block;font-size:20px;color:var(--accent)}
.qb-btn .qb-chance{display:block;font-size:10px;color:var(--text3);margin-top:2px}

/* ===== LUCK LAB ===== */
.lab-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px;margin:14px 0}
.reagent-card{background:var(--bg3);border:1px solid var(--bg5);border-radius:10px;padding:12px;text-align:center;cursor:pointer;transition:.2s;position:relative}
.reagent-card:hover{border-color:var(--accent3)}
.reagent-card.selected{border-color:var(--accent3);background:rgba(0,200,255,.08)}
.reagent-icon{width:48px;height:48px;margin:0 auto 8px;display:flex;align-items:center;justify-content:center}
.brew-slot{width:64px;height:64px;border-radius:12px;border:2px dashed var(--bg5);display:flex;align-items:center;justify-content:center;transition:.2s}
.brew-slot.filled{border-style:solid;border-color:var(--accent3);background:rgba(0,200,255,.08)}
.brew-slots{display:flex;gap:12px;justify-content:center;margin:16px 0}

/* ===== NOTIFICATIONS UPGRADE ===== */
.notif{border-left-width:3px}
.notif-icon{width:22px;height:22px;flex-shrink:0;margin-right:8px}

/* ===== LOGIN PAGE ===== */
#login-page{position:fixed;inset:0;background:linear-gradient(135deg,#0a0b10 0%,#0d0e16 50%,#0a0c14 100%);display:flex;align-items:center;justify-content:center;z-index:9999}
#login-page::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 60% 40% at 50% 50%,rgba(240,165,0,.06),transparent);pointer-events:none}
.login-box{background:var(--bg2);border:1px solid var(--bg5);border-radius:20px;padding:40px 48px;width:420px;max-width:95vw;position:relative;overflow:hidden}
.login-box::before{content:'';position:absolute;top:-1px;left:20%;right:20%;height:2px;background:linear-gradient(90deg,transparent,var(--accent),var(--accent2),transparent)}
.login-logo{text-align:center;margin-bottom:32px}
.login-logo .logo-text{font-family:'Rajdhani',sans-serif;font-size:38px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.login-logo .logo-sub{color:var(--text2);font-size:13px;letter-spacing:2px;margin-top:2px}
.login-tabs{display:flex;background:var(--bg4);border-radius:8px;padding:4px;margin-bottom:24px}
.login-tab{flex:1;padding:8px;text-align:center;border-radius:6px;font-weight:600;font-size:14px;cursor:pointer;transition:.2s;color:var(--text2)}
.login-tab.active{background:var(--bg2);color:var(--text);box-shadow:var(--shadow)}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:12px;color:var(--text2);margin-bottom:6px;letter-spacing:.5px;text-transform:uppercase}
.form-group input{width:100%;background:var(--bg4);border:1px solid var(--bg5);border-radius:8px;padding:10px 14px;color:var(--text);font-size:14px;transition:.2s}
.form-group input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(240,165,0,.1)}
.login-btn{width:100%;padding:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#000;font-weight:700;font-size:15px;border-radius:8px;transition:.15s;font-family:'Rajdhani',sans-serif;letter-spacing:.5px}
.login-btn:hover{opacity:.9;transform:translateY(-1px);box-shadow:0 6px 20px rgba(240,165,0,.3)}
.login-error{color:var(--red);font-size:13px;text-align:center;margin-top:12px;min-height:20px}

/* ===== MAIN LAYOUT ===== */
#app{display:flex;height:100vh;overflow:hidden}
.sidebar{width:var(--sidebar);background:var(--bg2);border-right:1px solid var(--bg4);display:flex;flex-direction:column;flex-shrink:0;overflow-y:auto;overflow-x:hidden;z-index:100}
.sidebar-logo{padding:16px 20px;border-bottom:1px solid var(--bg4);flex-shrink:0}
.sidebar-logo .brand{font-family:'Rajdhani',sans-serif;font-size:26px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.sidebar-logo .brand-sub{font-size:10px;color:var(--text3);letter-spacing:1.5px}
.sidebar-balance{padding:12px 20px;border-bottom:1px solid var(--bg4);background:var(--bg3)}
.balance-amount{font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:700;color:var(--accent)}
.balance-label{font-size:10px;color:var(--text3);letter-spacing:1px}
.balance-xp{margin-top:8px}
.xp-bar{height:4px;background:var(--bg5);border-radius:2px;margin-top:4px;overflow:hidden}
.xp-fill{height:100%;background:linear-gradient(90deg,var(--accent3),var(--accent));border-radius:2px;transition:width .5s}
.nav-section{padding:8px 0}
.nav-label{padding:8px 20px 4px;font-size:10px;color:var(--text3);letter-spacing:1.5px;text-transform:uppercase}
.nav-group-header{display:flex;align-items:center;justify-content:space-between;padding:10px 20px;cursor:pointer;font-size:12px;font-weight:700;color:var(--text2);letter-spacing:.5px;text-transform:uppercase;transition:.15s;user-select:none;border-top:1px solid var(--bg4)}
.nav-group-header:hover{background:var(--bg3);color:var(--text)}
.nav-group-header.open{color:var(--accent)}
.nav-group-header .nav-arrow{font-size:10px;transition:transform .2s}
.nav-group-header.open .nav-arrow{transform:rotate(0deg)}
.nav-group-header:not(.open) .nav-arrow{transform:rotate(-90deg)}
.nav-group-body{overflow:hidden;transition:max-height .25s ease}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 20px;cursor:pointer;transition:.15s;color:var(--text2);font-size:13px;font-weight:500;position:relative}
.nav-item:hover{background:var(--bg3);color:var(--text)}
.nav-item.active{background:linear-gradient(90deg,rgba(240,165,0,.1),transparent);color:var(--accent);border-right:2px solid var(--accent)}
.nav-item .nav-icon{width:18px;text-align:center;font-size:15px;flex-shrink:0}
.nav-item .nav-badge{margin-left:auto;background:var(--accent2);color:#fff;font-size:9px;padding:1px 5px;border-radius:10px;font-weight:700}
.sidebar-user{margin-top:auto;padding:12px 20px;border-top:1px solid var(--bg4);background:var(--bg2)}
.user-info{display:flex;align-items:center;gap:10px}
.user-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;color:#000;flex-shrink:0}
.user-name{font-size:13px;font-weight:600}
.user-rank{font-size:11px;color:var(--text2)}
.logout-btn{margin-left:auto;background:none;color:var(--text3);font-size:18px;padding:4px;transition:.15s}
.logout-btn:hover{color:var(--red)}

/* ===== MAIN CONTENT ===== */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}
.topbar{height:var(--header);background:var(--bg2);border-bottom:1px solid var(--bg4);display:flex;align-items:center;padding:0 20px;gap:16px;flex-shrink:0}
.topbar-title{font-family:'Rajdhani',sans-serif;font-size:22px;font-weight:700;flex:1}
.topbar-stat{display:flex;align-items:center;gap:6px;padding:6px 12px;background:var(--bg3);border-radius:8px;font-size:12px}
.topbar-stat .val{font-weight:700;color:var(--accent);font-family:'Barlow Condensed',sans-serif}
.mobile-menu-btn{display:none;background:none;color:var(--text);font-size:22px;padding:4px}
.page{flex:1;overflow-y:auto;padding:20px;display:none;min-height:0}
.page.active{display:block}
.page-header{margin-bottom:24px}
.page-title{font-family:'Rajdhani',sans-serif;font-size:28px;font-weight:700;margin-bottom:4px}
.page-subtitle{color:var(--text2);font-size:14px}
.section-title{font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.section-title::after{content:'';flex:1;height:1px;background:var(--bg4);margin-left:8px}

/* ===== CLICKER PAGE ===== */
.click-area{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;text-align:center}
.click-btn-wrap{position:relative;margin:20px 0}
.click-btn{width:200px;height:200px;border-radius:50%;background:radial-gradient(circle at 35% 35%,#2a2b38,#13141a);border:3px solid var(--accent);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:64px;transition:.08s;box-shadow:0 0 30px rgba(240,165,0,.2),0 0 60px rgba(240,165,0,.05);position:relative;overflow:hidden}
.click-btn:active{transform:scale(.94);box-shadow:0 0 50px rgba(240,165,0,.4)}
.click-btn::after{content:'';position:absolute;inset:0;border-radius:50%;background:radial-gradient(circle at 50% 0%,rgba(255,255,255,.1),transparent 60%)}
.click-value{font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:700;color:var(--accent);margin-bottom:8px}
.click-cps{font-size:13px;color:var(--text2)}
.float-text{position:absolute;pointer-events:none;font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:20px;color:var(--accent);animation:floatUp .8s ease-out forwards}
@keyframes floatUp{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-60px)}}
.upgrades-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;margin-top:16px}
.upgrade-card{background:var(--bg3);border:1px solid var(--bg5);border-radius:var(--radius2);padding:14px;display:flex;gap:12px;align-items:center;cursor:pointer;transition:.15s;position:relative;overflow:hidden}
.upgrade-card:hover:not(.locked){background:var(--bg4);border-color:var(--accent)}
.upgrade-card.locked{opacity:.5;cursor:not-allowed}
.upgrade-card.owned{border-color:var(--green);}
.upgrade-icon{font-size:28px;flex-shrink:0}
.upgrade-info{flex:1}
.upgrade-name{font-weight:600;font-size:14px;margin-bottom:2px}
.upgrade-desc{font-size:11px;color:var(--text2);margin-bottom:6px}
.upgrade-cost{font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:700;color:var(--accent)}
.upgrade-owned-badge{position:absolute;top:8px;right:8px;font-size:10px;color:var(--green);font-weight:700}
.passive-income{background:linear-gradient(135deg,var(--bg3),var(--bg2));border:1px solid rgba(240,165,0,.2);border-radius:var(--radius2);padding:16px;text-align:center;margin-bottom:20px}

/* ===== CASES PAGE ===== */
.cases-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:16px;margin-bottom:24px}
.case-card{background:var(--bg3);border:1px solid var(--bg5);border-radius:var(--radius2);padding:14px;text-align:center;cursor:pointer;transition:.2s;position:relative;overflow:hidden}
.case-card:hover{border-color:var(--accent);transform:translateY(-3px);box-shadow:0 8px 24px rgba(0,0,0,.4)}
.case-img{font-size:52px;margin-bottom:10px;display:block;filter:drop-shadow(0 4px 8px rgba(0,0,0,.5))}
.case-name{font-size:12px;font-weight:600;margin-bottom:4px;line-height:1.3}
.case-price{font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:700;color:var(--accent)}
.case-shine{position:absolute;top:0;left:-100%;width:60%;height:100%;background:linear-gradient(105deg,transparent,rgba(255,255,255,.05),transparent);transition:left .4s}
.case-card:hover .case-shine{left:140%}

/* ===== CASE OPENER ===== */
#case-modal{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:1000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);animation:fadeIn .2s}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.case-modal-inner{background:var(--bg2);border:1px solid var(--bg4);border-radius:20px;width:90%;max-width:900px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column}
.case-modal-header{padding:16px 24px;border-bottom:1px solid var(--bg4);display:flex;align-items:center;justify-content:space-between}
.modal-close{background:none;color:var(--text2);font-size:24px;transition:.15s}
.modal-close:hover{color:var(--text)}
.case-spinner-wrap{padding:20px;position:relative}
.spinner-container{overflow:hidden;border-radius:12px;position:relative}
.spinner-container::before,.spinner-container::after{content:'';position:absolute;top:0;bottom:0;width:100px;z-index:2;pointer-events:none}
.spinner-container::before{left:0;background:linear-gradient(90deg,var(--bg2),transparent)}
.spinner-container::after{right:0;background:linear-gradient(-90deg,var(--bg2),transparent)}
.spinner-track{display:flex;gap:8px;padding:12px;transition:transform .0s;will-change:transform}
.spinner-item{flex-shrink:0;width:120px;height:140px;border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;border:2px solid var(--bg5);background:var(--bg3);position:relative;overflow:hidden}
.spinner-item .item-icon{font-size:36px}
.spinner-item .item-name{font-size:10px;text-align:center;padding:0 6px;font-weight:500;line-height:1.3}
.spinner-item .item-rarity{width:100%;height:3px;position:absolute;bottom:0}
.spinner-needle{position:absolute;top:0;bottom:0;left:50%;width:2px;background:var(--accent);z-index:5;box-shadow:0 0 8px var(--accent)}
.spinner-needle::before{content:'â–¼';position:absolute;top:-8px;left:50%;transform:translateX(-50%);color:var(--accent);font-size:14px}
.case-modal-actions{padding:16px 24px;border-top:1px solid var(--bg4);display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap}
.quantity-btn{padding:6px 14px;background:var(--bg4);border:1px solid var(--bg5);border-radius:6px;color:var(--text);font-weight:600;font-size:13px;cursor:pointer;transition:.15s}
.quantity-btn.active,.quantity-btn:hover{background:var(--accent);color:#000;border-color:var(--accent)}
.win-display{padding:24px;text-align:center;display:none;flex-direction:column;align-items:center}
.win-skin-icon{font-size:80px;margin-bottom:12px;animation:bounceIn .5s}
@keyframes bounceIn{0%{transform:scale(0.5);opacity:0}70%{transform:scale(1.1)}100%{transform:scale(1);opacity:1}}
.win-skin-name{font-family:'Rajdhani',sans-serif;font-size:28px;font-weight:700;margin-bottom:4px}
.win-skin-value{font-family:'Barlow Condensed',sans-serif;font-size:32px;color:var(--accent);margin-bottom:16px}
.win-rarity-text{font-size:13px;font-weight:700;letter-spacing:1px;text-transform:uppercase;margin-bottom:20px}

/* Rarity borders */
.rarity-consumer{border-color:#b0c3d9!important;color:#b0c3d9}
.rarity-industrial{border-color:#5e98d9!important;color:#5e98d9}
.rarity-milspec{border-color:#4b69ff!important;color:#4b69ff}
.rarity-restricted{border-color:#8847ff!important;color:#8847ff}
.rarity-classified{border-color:#d32ce6!important;color:#d32ce6}
.rarity-covert{border-color:#eb4b4b!important;color:#eb4b4b}
.rarity-knife{border-color:#e4ae39!important;color:#e4ae39}
.rarity-bg-consumer{background:#b0c3d940}
.rarity-bg-industrial{background:#5e98d940}
.rarity-bg-milspec{background:#4b69ff40}
.rarity-bg-restricted{background:#8847ff40}
.rarity-bg-classified{background:#d32ce640}
.rarity-bg-covert{background:#eb4b4b40}
.rarity-bg-knife{background:#e4ae3940}

/* ===== INVENTORY ===== */
.inventory-filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px}
.filter-btn{padding:5px 12px;border-radius:6px;background:var(--bg4);border:1px solid var(--bg5);color:var(--text2);font-size:12px;font-weight:600;cursor:pointer;transition:.15s}
.filter-btn.active,.filter-btn:hover{color:var(--text);border-color:var(--accent)}
.inv-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
.inv-item{background:var(--bg3);border-radius:var(--radius2);overflow:hidden;cursor:pointer;transition:.2s;position:relative;border:2px solid transparent}
.inv-item:hover{transform:translateY(-2px)}
.inv-item-img{height:90px;display:flex;align-items:center;justify-content:center;font-size:40px}
.inv-item-info{padding:8px;background:var(--bg4)}
.inv-item-name{font-size:11px;font-weight:600;margin-bottom:2px;line-height:1.3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.inv-item-price{font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:700;color:var(--accent)}
.inv-item-float{font-size:10px;color:var(--text3)}
.fav-star{position:absolute;top:6px;right:6px;color:var(--text3);font-size:14px;cursor:pointer;transition:.15s;z-index:1;background:none;padding:2px}
.fav-star.active{color:var(--gold)}
.fav-star:hover{color:var(--gold)}

/* ===== CASINO GAMES ===== */
.games-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;margin-bottom:30px}
.game-card{background:var(--bg3);border:1px solid var(--bg5);border-radius:var(--radius2);overflow:hidden;cursor:pointer;transition:.2s;position:relative}
.game-card:hover{border-color:var(--accent);transform:translateY(-3px)}
.game-card-banner{height:120px;display:flex;align-items:center;justify-content:center;font-size:52px;position:relative;overflow:hidden}
.game-card-body{padding:12px}
.game-card-name{font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:700;margin-bottom:2px}
.game-card-desc{font-size:12px;color:var(--text2)}
.game-panel{display:none}
.game-panel.active{display:block}

/* BLACKJACK */
.bj-table{background:radial-gradient(ellipse 100% 80% at 50% 60%,#1a3a25,#0d1f12);border-radius:20px;padding:24px;position:relative;min-height:360px;border:2px solid #2d5a1e;margin-bottom:16px}
.bj-label{font-size:12px;color:#88b87a;letter-spacing:1px;text-transform:uppercase;margin-bottom:8px;font-weight:600}
.bj-cards{display:flex;gap:-4px;flex-wrap:wrap;gap:6px;min-height:100px;align-items:center}
.card-item{width:60px;height:86px;background:white;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:700;box-shadow:0 3px 10px rgba(0,0,0,.5);position:relative;flex-shrink:0}
.card-item.red{color:#c0392b}
.card-item.black{color:#111}
.card-back{background:linear-gradient(135deg,#1a3a7a,#0d1f4a);color:#5e98d9;font-size:28px}
.bj-score{font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:700;color:#a8d8a8;margin-top:8px}
.bj-controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:16px}

/* ROULETTE */
.roulette-wrap{text-align:center;padding:20px}
.roulette-wheel{width:220px;height:220px;border-radius:50%;margin:0 auto;position:relative;border:4px solid var(--accent)}
.roulette-belt{background:var(--bg3);border-radius:12px;overflow:hidden;position:relative;margin:16px 0;height:60px;border:1px solid var(--bg5)}
.roulette-belt-inner{display:flex;height:100%;transition:transform 3s cubic-bezier(.17,.67,.12,.99)}
.roulette-num{width:50px;height:60px;display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:700;flex-shrink:0;border-right:1px solid rgba(255,255,255,.05)}
.roulette-bets{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:16px}
.roulette-bet-btn{padding:10px;border-radius:8px;font-weight:700;font-size:14px;cursor:pointer;border:2px solid transparent;transition:.15s;font-family:'Barlow Condensed',sans-serif;letter-spacing:.5px}

/* CRASH */
.crash-canvas-wrap{background:var(--bg3);border-radius:var(--radius2);overflow:hidden;position:relative;margin-bottom:16px;border:1px solid var(--bg5)}
#crash-canvas{display:block;width:100%;height:250px}
.crash-multiplier{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'Barlow Condensed',sans-serif;font-size:64px;font-weight:700;color:var(--green);text-shadow:0 0 20px currentColor;transition:.1s}
.crash-multiplier.crashed{color:var(--red)}

/* MINES */
.mines-grid-wrap{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;max-width:340px;margin:0 auto 16px}
.mine-cell{aspect-ratio:1;background:var(--bg4);border:1px solid var(--bg5);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;transition:.15s;position:relative}
.mine-cell:hover:not(.revealed){background:var(--bg5)}
.mine-cell.revealed-safe{background:#1a3a27;border-color:#2ecc7160;animation:revealCell .2s}
.mine-cell.revealed-mine{background:#3a1a1a;border-color:#e74c3c60;animation:shakeMine .3s}
@keyframes revealCell{0%{transform:scale(.8);opacity:.5}100%{transform:scale(1);opacity:1}}
@keyframes shakeMine{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
.mine-cell.revealed{cursor:default}

/* SLOTS */
.slots-machine{background:var(--bg3);border:2px solid var(--accent);border-radius:16px;padding:20px;max-width:400px;margin:0 auto;text-align:center}
.slots-reels{display:flex;gap:8px;justify-content:center;margin:16px 0}
.slot-reel{width:80px;height:80px;background:var(--bg2);border-radius:8px;border:2px solid var(--bg5);overflow:hidden;position:relative;font-size:40px;display:flex;align-items:center;justify-content:center}
.slot-reel.spinning{animation:spinReel .1s linear infinite}
@keyframes spinReel{0%{filter:blur(2px)}100%{filter:blur(2px)}}

/* PLINKO */
#plinko-canvas{display:block;border-radius:var(--radius2);border:1px solid var(--bg5)}

/* COINFLIP */
.coin-wrap{width:120px;height:120px;margin:20px auto;perspective:600px}
.coin{width:100%;height:100%;border-radius:50%;position:relative;transform-style:preserve-3d;transition:transform 1.5s cubic-bezier(.4,0,.2,1)}
.coin.flipping{animation:flipCoin 1.5s ease-out forwards}
@keyframes flipCoin{0%{transform:rotateY(0)}100%{transform:rotateY(1440deg)}}
.coin-face{position:absolute;inset:0;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:40px;backface-visibility:hidden}
.coin-heads{background:radial-gradient(circle,#f0a500,#c8860a);border:3px solid #e4ae39}
.coin-tails{background:radial-gradient(circle,#5e98d9,#3a6cb8);border:3px solid #4b69ff;transform:rotateY(180deg)}

/* JACKPOT */
.jackpot-pot{background:linear-gradient(135deg,#1a1200,#2a1e00);border:2px solid var(--gold);border-radius:var(--radius2);padding:20px;text-align:center;margin-bottom:16px}
.jackpot-total{font-family:'Barlow Condensed',sans-serif;font-size:48px;font-weight:700;color:var(--gold);text-shadow:0 0 20px rgba(241,196,15,.4)}
.jackpot-entries{display:flex;flex-direction:column;gap:6px;max-height:200px;overflow-y:auto}
.jackpot-entry{display:flex;align-items:center;gap:10px;padding:8px;background:var(--bg3);border-radius:8px}
.jackpot-bar{height:8px;border-radius:4px;transition:width .3s}
.jackpot-wheel{height:60px;overflow:hidden;border-radius:8px;position:relative;margin:12px 0;background:var(--bg3)}
.jackpot-strip{display:flex;height:60px;transition:transform 4s cubic-bezier(.17,.67,.12,.99)}
.jackpot-strip-seg{height:60px;display:flex;align-items:center;justify-content:center;flex-shrink:0;padding:0 20px;font-weight:700;font-size:18px}

/* ===== ROULETTE NUMBERS ===== */
.rl-red{background:#c0392b}
.rl-black{background:#1a1a1a}
.rl-green{background:#27ae60}

/* ===== STATS PAGE ===== */
.stat-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin-bottom:24px}
.stat-card{background:var(--bg3);border:1px solid var(--bg5);border-radius:var(--radius2);padding:14px;text-align:center}
.stat-val{font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:700;color:var(--accent);margin-bottom:2px}
.stat-label{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:.8px}
.profit-chart{background:var(--bg3);border:1px solid var(--bg5);border-radius:var(--radius2);padding:16px;margin-bottom:16px}
#stats-canvas{display:block;width:100%;border-radius:8px}

/* ===== HISTORY ===== */
.history-panel{background:var(--bg2);border:1px solid var(--bg4);border-radius:var(--radius2);max-height:320px;overflow-y:auto}
.history-item{display:flex;align-items:center;gap:10px;padding:8px 14px;border-bottom:1px solid var(--bg4);font-size:12px;animation:slideIn .2s}
@keyframes slideIn{from{opacity:0;transform:translateX(-10px)}to{opacity:1;transform:translateX(0)}}
.history-item:last-child{border-bottom:none}
.history-icon{font-size:18px;flex-shrink:0}
.history-desc{flex:1}
.history-val{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:15px}
.history-val.pos{color:var(--green)}
.history-val.neg{color:var(--red)}
.history-time{color:var(--text3);font-size:10px;flex-shrink:0}

/* ===== BANK ===== */
.bank-vault{background:linear-gradient(135deg,#1a1200,#0d0e12);border:2px solid #d4a30060;border-radius:20px;padding:24px;text-align:center;margin-bottom:16px}
.vault-total{font-family:'Barlow Condensed',sans-serif;font-size:52px;font-weight:700;color:var(--gold)}
.bank-stats{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px}
.bank-stat{background:var(--bg3);border-radius:10px;padding:12px;text-align:center}

/* ===== MARKETPLACE ===== */
.market-item{background:var(--bg3);border:1px solid var(--bg5);border-radius:var(--radius2);padding:12px;display:flex;align-items:center;gap:12px;transition:.15s}
.market-item:hover{border-color:var(--accent)}
.market-item-img{font-size:32px;flex-shrink:0}
.market-item-info{flex:1}
.market-price{font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:700;color:var(--accent)}
.market-btn{padding:6px 14px;border-radius:6px;background:var(--accent);color:#000;font-weight:700;font-size:12px;cursor:pointer;border:none;transition:.15s}
.market-btn:hover{opacity:.85}

/* ===== BATTLE PASS ===== */
.bp-track{display:flex;gap:0;overflow-x:auto;padding-bottom:8px;margin-bottom:16px}
.bp-node{flex-shrink:0;width:90px;text-align:center;position:relative}
.bp-node::before{content:'';position:absolute;top:24px;right:-45px;left:-45px;height:2px;background:var(--bg5);z-index:0}
.bp-node:first-child::before{left:50%}
.bp-node:last-child::before{right:50%}
.bp-circle{width:48px;height:48px;border-radius:50%;background:var(--bg4);border:2px solid var(--bg5);display:flex;align-items:center;justify-content:center;font-size:22px;margin:0 auto 6px;position:relative;z-index:1}
.bp-circle.completed{background:var(--bg4);border-color:var(--accent);box-shadow:0 0 12px rgba(240,165,0,.3)}
.bp-circle.current{background:var(--accent);border-color:var(--accent);box-shadow:0 0 20px rgba(240,165,0,.4);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{box-shadow:0 0 20px rgba(240,165,0,.4)}50%{box-shadow:0 0 30px rgba(240,165,0,.6)}}
.bp-reward{font-size:9px;color:var(--text2);line-height:1.2}
.bp-label{font-size:10px;font-weight:600;margin-bottom:2px}
.bp-xp-bar{background:var(--bg5);border-radius:4px;height:6px;overflow:hidden;margin:8px 0}
.bp-xp-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:4px;transition:width .5s}

/* ===== MISSIONS ===== */
.mission-card{background:var(--bg3);border:1px solid var(--bg5);border-radius:var(--radius2);padding:14px;margin-bottom:10px;display:flex;align-items:center;gap:14px}
.mission-icon{font-size:28px;flex-shrink:0}
.mission-info{flex:1}
.mission-name{font-weight:600;font-size:14px;margin-bottom:4px}
.mission-prog{background:var(--bg5);border-radius:4px;height:6px;overflow:hidden;margin-top:6px}
.mission-fill{height:100%;background:linear-gradient(90deg,var(--accent3),var(--accent));border-radius:4px;transition:width .5s}
.mission-reward{font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:700;color:var(--accent);text-align:right}
.mission-claim-btn{padding:6px 12px;border-radius:6px;background:var(--green);color:#000;font-size:12px;font-weight:700;cursor:pointer;border:none;margin-top:4px;display:none}

/* ===== CASE BATTLES ===== */
.battle-setup{background:var(--bg3);border-radius:var(--radius2);padding:20px;margin-bottom:16px}
.battle-slots{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
.battle-slot{background:var(--bg4);border:2px dashed var(--bg5);border-radius:var(--radius2);padding:20px;text-align:center;min-height:150px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px}
.battle-slot.active{border-color:var(--accent);border-style:solid}
.battle-result-wrap{display:none;animation:fadeIn .3s}
.battle-result-row{display:flex;gap:16px;margin-bottom:12px;align-items:stretch}
.battle-col{flex:1;background:var(--bg3);border-radius:var(--radius2);padding:16px;text-align:center}
.battle-col.winner{border:2px solid var(--gold);background:rgba(225,190,60,.05)}
.battle-items{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-top:12px}
.battle-item{width:60px;height:80px;background:var(--bg4);border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;font-size:24px;border:1px solid var(--bg5)}
.battle-item-val{font-size:10px;color:var(--accent);font-weight:700;font-family:'Barlow Condensed',sans-serif}

/* ===== ADMIN PANEL ===== */
.admin-panel{background:linear-gradient(135deg,var(--bg2),#1a0d1a);border:1px solid #8847ff40;border-radius:var(--radius2);padding:20px;margin-bottom:16px}
.admin-title{font-family:'Rajdhani',sans-serif;font-size:22px;color:#8847ff;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.admin-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}
.admin-input-wrap{display:flex;gap:8px}
.admin-input{background:var(--bg4);border:1px solid var(--bg5);border-radius:8px;padding:8px 12px;color:var(--text);font-size:13px;flex:1}

/* ===== MARKET/TRADE CHARTS ===== */
.market-chart-wrap{background:var(--bg3);border:1px solid var(--bg5);border-radius:var(--radius2);padding:16px;margin-bottom:16px}

/* ===== LEADERBOARD ===== */
.lb-item{display:flex;align-items:center;gap:12px;padding:10px 14px;background:var(--bg3);border-radius:10px;margin-bottom:8px;border:1px solid var(--bg5)}
.lb-rank{font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:700;width:32px;text-align:center;color:var(--text3)}
.lb-rank.gold{color:var(--gold)}
.lb-rank.silver{color:#aaa}
.lb-rank.bronze{color:#cd7f32}
.lb-avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;flex-shrink:0}
.lb-info{flex:1}
.lb-name{font-weight:600;font-size:14px}
.lb-val{font-size:12px;color:var(--text2)}
.lb-amount{font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:700;color:var(--accent)}

/* ===== REBIRTH ===== */
.rebirth-card{background:linear-gradient(135deg,#1a0a00,#0d0e12);border:2px solid var(--accent2);border-radius:20px;padding:32px;text-align:center;max-width:500px;margin:0 auto}
.rebirth-flame{font-size:64px;animation:flamePulse 2s infinite}
@keyframes flamePulse{0%,100%{filter:drop-shadow(0 0 8px var(--accent2))}50%{filter:drop-shadow(0 0 20px var(--accent2))}}

/* ===== PROFILE ===== */
.profile-card{background:linear-gradient(135deg,var(--bg3),var(--bg2));border:1px solid var(--bg5);border-radius:20px;padding:24px;margin-bottom:16px;display:flex;align-items:center;gap:20px}
.profile-avatar-lg{width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:32px;font-weight:700;color:#000;flex-shrink:0;border:3px solid var(--accent)}
.rank-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 12px;border-radius:20px;font-size:13px;font-weight:700;letter-spacing:.5px;margin-top:6px}

/* ===== NOTIFICATIONS ===== */
.notif-container{position:fixed;top:16px;right:16px;z-index:9000;pointer-events:none;display:flex;flex-direction:column;gap:8px;max-width:300px}
.notif{background:var(--bg3);border-left:3px solid var(--accent);border-radius:8px;padding:10px 14px;font-size:13px;box-shadow:var(--shadow);animation:notifIn .3s;pointer-events:auto}
.notif.success{border-color:var(--green)}
.notif.error{border-color:var(--red)}
.notif.rare{border-color:var(--knife);box-shadow:0 0 20px rgba(228,174,57,.3)}
@keyframes notifIn{from{opacity:0;transform:translateX(100%)}to{opacity:1;transform:translateX(0)}}
@keyframes notifOut{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(100%)}}

/* ===== SPECIAL EFFECTS ===== */
.knife-overlay{position:fixed;inset:0;z-index:5000;pointer-events:none;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.8);animation:overlayIn .3s;flex-direction:column;gap:12px}
@keyframes overlayIn{from{opacity:0}to{opacity:1}}
.knife-glow{font-size:120px;animation:knifeGlow 1s ease-out forwards,knifeFloat 3s ease-in-out infinite}
@keyframes knifeGlow{0%{filter:drop-shadow(0 0 0px gold)}100%{filter:drop-shadow(0 0 40px gold)}}
@keyframes knifeFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
.knife-text{font-family:'Rajdhani',sans-serif;font-size:48px;font-weight:700;background:linear-gradient(135deg,#e4ae39,#fff,#e4ae39);-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:knifeTextGlow 1s infinite alternate;text-align:center}
@keyframes knifeTextGlow{from{filter:drop-shadow(0 0 8px gold)}to{filter:drop-shadow(0 0 20px gold)}}
.gold-particles{position:fixed;inset:0;pointer-events:none;z-index:4999;overflow:hidden}
.particle{position:absolute;width:6px;height:6px;background:var(--gold);border-radius:50%;animation:particleFly var(--dur) ease-out forwards}
@keyframes particleFly{0%{transform:translate(0,0) scale(1);opacity:1}100%{transform:translate(var(--tx),var(--ty)) scale(0);opacity:0}}

/* ===== LOADING / WEEKEND BANNER ===== */
.event-banner{background:linear-gradient(135deg,rgba(240,165,0,.15),rgba(255,107,53,.1));border:1px solid rgba(240,165,0,.3);border-radius:10px;padding:10px 16px;display:flex;align-items:center;gap:10px;margin-bottom:16px;font-size:13px}

/* ===== TRADE-UP / CRAFTING ===== */
.tradeup-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin:12px 0}
.tradeup-slot{aspect-ratio:1;background:var(--bg4);border:2px dashed var(--bg5);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:28px;cursor:pointer;transition:.15s}
.tradeup-slot.filled{border-style:solid}
.tradeup-slot:hover{border-color:var(--accent)}

/* ===== SPIN WHEEL ===== */
#spin-canvas{border-radius:50%;box-shadow:0 0 40px rgba(240,165,0,.3),0 0 80px rgba(240,165,0,.1);border:3px solid rgba(240,165,0,.3)}
/* ===== UPGRADE CATEGORIES ===== */
.upgrades-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;margin-top:16px;align-items:start}
.upgrade-cat-header{grid-column:1/-1;padding:4px 0}
/* ===== INSPECTOR ===== */
#inspect-modal[style*="flex"]{display:flex!important}

@media (max-width: 900px){
  :root{--sidebar:0px}
  .sidebar{position:fixed;left:-260px;width:260px;height:100%;transition:left .3s;z-index:500}
  .sidebar.open{left:0}
  .mobile-menu-btn{display:block}
  .sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:499}
  .sidebar-overlay.open{display:block}
  .main{width:100%}
  .cases-grid{grid-template-columns:repeat(auto-fill,minmax(130px,1fr))}
  .inv-grid{grid-template-columns:repeat(auto-fill,minmax(110px,1fr))}
  .g4{grid-template-columns:repeat(2,1fr)}
  .g5{grid-template-columns:repeat(3,1fr)}
  .battle-slots{grid-template-columns:1fr}
  .bp-track{padding-bottom:16px}
}
@media (max-width: 480px){
  .page{padding:12px}
  .bj-table{padding:12px}
  .login-box{padding:24px 20px}
  .cases-grid{grid-template-columns:repeat(auto-fill,minmax(110px,1fr))}
  .spinner-item{width:90px;height:110px}
  .case-modal-inner{width:98%;max-height:96vh}
  .crash-multiplier{font-size:42px}
}
/* ===== EXPANSION SYSTEMS CSS ===== */
.skill-node{background:var(--bg4);border:2px solid var(--bg5);border-radius:10px;padding:10px;text-align:center;cursor:pointer;transition:.2s;position:relative;margin-bottom:8px}
.skill-node:hover:not(.locked){border-color:var(--accent);transform:translateY(-1px)}
.skill-node.unlocked{border-color:var(--green)!important;background:rgba(46,204,113,.08)}
.skill-node.maxed{border-color:var(--gold)!important;background:rgba(241,196,15,.08)}
.skill-node.locked{opacity:.45;cursor:not-allowed}
.skill-icon{font-size:24px;margin-bottom:4px}
.skill-name{font-size:11px;font-weight:700;margin-bottom:2px;font-family:'Rajdhani',sans-serif}
.skill-desc{font-size:9px;color:var(--text3);line-height:1.3}
.skill-cost{font-size:10px;color:var(--gold);margin-top:4px;font-weight:700}
.skill-branch-title{font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:700;padding:8px 12px;border-radius:8px;text-align:center;margin-bottom:10px;background:var(--bg4);border:1px solid var(--bg5)}
.prestige-tier{background:var(--bg3);border:2px solid var(--bg5);border-radius:14px;padding:16px;text-align:center;margin-bottom:12px;transition:.2s}
.prestige-tier.active-tier{border-color:var(--gold);background:rgba(241,196,15,.06)}
.boss-sprite-anim{animation:bossBob 2s ease-in-out infinite}
@keyframes bossBob{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
.boss-dmg-float{position:fixed;font-family:'Rajdhani',sans-serif;font-size:20px;font-weight:700;color:var(--red);pointer-events:none;animation:floatUp 1.2s ease-out forwards;z-index:9999}
@keyframes floatUp{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-70px) scale(1.2)}}
.dungeon-room{background:var(--bg3);border:2px solid var(--bg5);border-radius:10px;padding:14px;margin-bottom:10px;text-align:center;transition:.2s}
.dungeon-room.d-completed{border-color:var(--green)}
.dungeon-room.d-current{border-color:var(--accent);box-shadow:0 0 12px rgba(240,165,0,.3)}
.dungeon-room.d-locked{opacity:.45}
.auction-card{background:var(--bg3);border:2px solid var(--bg5);border-radius:12px;overflow:hidden;transition:.2s}
.auction-card:hover{border-color:var(--accent3)}
.bm-item{background:var(--bg3);border:2px solid #eb4b4b30;border-radius:10px;padding:10px;text-align:center;cursor:pointer;transition:.2s}
.bm-item:hover{border-color:var(--red);transform:scale(1.02)}
.bm-item.sold{opacity:.35;pointer-events:none}
.invest-card{background:var(--bg3);border:2px solid var(--bg5);border-radius:12px;padding:14px;cursor:pointer;transition:.2s}
.invest-card:hover{border-color:var(--accent3);transform:translateY(-2px)}
.legacy-perk{background:var(--bg3);border:2px solid var(--bg5);border-radius:10px;padding:14px;transition:.2s}
.legacy-perk.lp-owned{border-color:var(--gold);background:rgba(241,196,15,.05)}
.legacy-perk.lp-locked{opacity:.5}
.tilt-indicator{height:5px;border-radius:3px;background:var(--bg5);overflow:hidden}
.tilt-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,#f0a500,var(--red));transition:width .4s}
.volatility-btn{padding:7px 14px;border-radius:8px;border:2px solid var(--bg5);background:var(--bg4);color:var(--text2);cursor:pointer;font-weight:700;font-size:12px;transition:.15s}
.volatility-btn.active-vol{border-color:var(--accent);color:var(--accent);background:rgba(240,165,0,.1)}
.stattrak-badge{background:#cf6a32;color:#fff;font-size:8px;font-weight:700;padding:1px 4px;border-radius:3px;margin-left:3px;vertical-align:middle}
.corrupted-item{box-shadow:0 0 10px var(--classified)!important;border-color:var(--classified)!important}
.artifact-item{box-shadow:0 0 14px var(--gold)!important;border-color:var(--gold)!important;animation:artifactGlow 2s ease-in-out infinite}
@keyframes artifactGlow{0%,100%{box-shadow:0 0 14px var(--gold)}50%{box-shadow:0 0 24px var(--gold)}}
.global-event-banner{position:fixed;top:64px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#1a0000,#2a0000);border:2px solid var(--red);border-radius:12px;padding:14px 22px;z-index:1500;text-align:center;animation:slideInTop .4s ease;max-width:380px;box-shadow:0 8px 40px rgba(235,75,75,.4);pointer-events:none}
@keyframes slideInTop{from{opacity:0;transform:translateX(-50%) translateY(-20px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.blood-moon-bg{position:fixed;inset:0;background:radial-gradient(ellipse at top,rgba(180,0,0,.08) 0%,transparent 55%);pointer-events:none;z-index:4;animation:bmPulse 3s ease-in-out infinite}
@keyframes bmPulse{0%,100%{opacity:.5}50%{opacity:1}}
.golden-hour-bg{position:fixed;inset:0;background:radial-gradient(ellipse at top,rgba(255,200,0,.07) 0%,transparent 50%);pointer-events:none;z-index:4}
</style>
</head>
<body>

<!-- LOGIN PAGE -->
<div id="login-page">
  <div class="login-box">
    <div class="login-logo">
      <div class="logo-text">CS:ROLL</div>
      <div class="logo-sub">THE ULTIMATE CSGO EXPERIENCE</div>
    </div>
    <!-- Live ticker above login -->
    <div id="login-ticker" style="background:var(--bg4);border-radius:8px;padding:8px 12px;margin-bottom:18px;font-size:12px;color:var(--text2);text-align:center;overflow:hidden;white-space:nowrap;text-overflow:ellipsis">
      ðŸ”´ Loading recent wins...
    </div>
    <div class="login-tabs">
      <div class="login-tab active" onclick="switchLoginTab('login')">Sign In</div>
      <div class="login-tab" onclick="switchLoginTab('register')">Register</div>
    </div>
    <div id="login-form">
      <div class="form-group"><label>Username</label><input type="text" id="login-user" placeholder="Enter username" autocomplete="username" onkeydown="if(event.key==='Enter')document.getElementById('login-pass').focus()"/></div>
      <div class="form-group"><label>Password</label><input type="password" id="login-pass" placeholder="Enter password" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()"/></div>
      <button class="login-btn" onclick="doLogin()">SIGN IN</button>
    </div>
    <div id="register-form" style="display:none">
      <div class="form-group"><label>Username</label><input type="text" id="reg-user" placeholder="Choose username" onkeydown="if(event.key==='Enter')document.getElementById('reg-pass').focus()"/></div>
      <div class="form-group"><label>Password</label><input type="password" id="reg-pass" placeholder="Choose password" onkeydown="if(event.key==='Enter')doRegister()"/></div>
      <button class="login-btn" onclick="doRegister()">CREATE ACCOUNT</button>
    </div>
    <div class="login-error" id="auth-error"></div>
    <div style="margin-top:14px;text-align:center">
      <div style="font-size:11px;color:var(--text3);margin-bottom:8px">â€” or â€”</div>
      <button onclick="doGuestLogin()" style="width:100%;padding:10px;background:var(--bg4);border:1px solid var(--bg5);color:var(--text2);font-weight:600;font-size:14px;border-radius:8px;transition:.15s;cursor:pointer" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--text)'" onmouseout="this.style.borderColor='var(--bg5)';this.style.color='var(--text2)'">ðŸ‘¤ Play as Guest (no save)</button>
    </div>
    <div style="margin-top:14px;text-align:center;font-size:11px;color:var(--text3)">
      <span id="live-player-count">ðŸŸ¢ 2,847 players online</span>
    </div>
  </div>
</div>

<div id="sidebar-overlay" class="sidebar-overlay" onclick="closeSidebar()"></div>

<!-- MAIN APP -->
<div id="app" style="display:none">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <div class="brand">CS:ROLL</div>
      <div class="brand-sub">PREMIUM SIMULATOR</div>
    </div>
    <div class="sidebar-balance">
      <div class="balance-label">WALLET</div>
      <div class="balance-amount" id="sb-balance">$0.00</div>
      <div class="balance-xp">
        <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text3);margin-bottom:2px">
          <span id="sb-level">LVL 1</span><span id="sb-xp-text">0 / 100 XP</span>
        </div>
        <div class="xp-bar"><div class="xp-fill" id="sb-xp-bar" style="width:0%"></div></div>
      </div>
    </div>
    <div class="nav-section">
      <div class="nav-group-header open" onclick="toggleNavGroup(this)">
        <span><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="display:inline;margin-right:5px;vertical-align:-2px"><polygon points="5,3 19,12 5,21"/></svg>Play</span><span class="nav-arrow">â–¾</span>
      </div>
      <div class="nav-group-body">
        <div class="nav-item active" onclick="showPage('clicker')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M12 8v4l3 3"/></svg></span>Click Farm</div>
        <div class="nav-item" onclick="showPage('cases')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 8h14l-1 12H6L5 8z"/><path d="M9 8V6a3 3 0 0 1 6 0v2"/><line x1="3" y1="8" x2="21" y2="8"/></svg></span>Cases</div>
        <div class="nav-item" onclick="showPage('casino')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><circle cx="8" cy="10" r="1.5" fill="currentColor"/><circle cx="12" cy="12" r="1.5" fill="currentColor"/><circle cx="16" cy="14" r="1.5" fill="currentColor"/></svg></span>Casino<span class="nav-badge">HOT</span></div>
        <div class="nav-item" onclick="showPage('scratch')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="5" width="18" height="14" rx="2"/><path d="M7 9h10M7 13h6" stroke-dasharray="2 2"/><path d="M15 16l3-3-3-3" stroke-width="2"/></svg></span>Scratch Cards</div>
        <div class="nav-item" onclick="showPage('mystery')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l2.4 7.4H22l-6.2 4.5 2.4 7.4L12 17l-6.2 4.3 2.4-7.4L2 9.4h7.6z"/></svg></span>Mystery Crate<span class="nav-badge" style="background:var(--restricted)">NEW</span></div>
        <div class="nav-item" onclick="showPage('wagerwars')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg></span>Wager Wars<span class="nav-badge" style="background:var(--red)">NEW</span></div>
        <div class="nav-item" onclick="showPage('battles')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 9.5L16 8l-4-4-1.5 1.5"/><path d="M8 8L4 12l8 8 4-4"/><line x1="7" y1="17" x2="3" y2="21"/><line x1="17" y1="7" x2="21" y2="3"/></svg></span>Case Battles</div>
        <div class="nav-item" onclick="showPage('jackpot')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M9 12l2 2 4-4"/></svg></span>Jackpot</div>
        <div class="nav-item" onclick="showPage('tradeup')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 16V4m0 0L3 8m4-4l4 4M17 8v12m0 0l4-4m-4 4l-4-4"/></svg></span>Trade-Up</div>
        <div class="nav-item" onclick="showPage('dice')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="3"/><circle cx="8" cy="8" r="1.5" fill="currentColor"/><circle cx="16" cy="8" r="1.5" fill="currentColor"/><circle cx="12" cy="12" r="1.5" fill="currentColor"/><circle cx="8" cy="16" r="1.5" fill="currentColor"/><circle cx="16" cy="16" r="1.5" fill="currentColor"/></svg></span>Dice</div>
        <div class="nav-item" onclick="showPage('heist')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="5"/><path d="M12 13v8M8 17h8"/><path d="M9 13H7a5 5 0 0 0-5 5v1h20v-1a5 5 0 0 0-5-5h-2"/></svg></span>Heist</div>
        <div class="nav-item" onclick="showPage('chicken')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3c1.5 0 3 1 3 2.5 0 1-0.5 2-1 2.5"/><path d="M8 8c0-2.5 1.5-5 4-5s4 2.5 4 5c0 3-1.5 5-4 7-2.5-2-4-4-4-7z"/><path d="M12 15v6M9 21h6"/></svg></span>Chicken Game</div>
        <div class="nav-item" onclick="showPage('ranked')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></svg></span>Ranked<span class="nav-badge" style="background:var(--accent)">NEW</span></div>
      </div>
    </div>
    <div class="nav-section">
      <div class="nav-group-header" onclick="toggleNavGroup(this)">
        <span><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="display:inline;margin-right:5px;vertical-align:-2px"><path d="M14.5 9.5L16 8l-4-4-1.5 1.5"/><path d="M8 8L4 12l8 8 4-4"/></svg>Combat</span><span class="nav-arrow">â–¾</span>
      </div>
      <div class="nav-group-body" style="display:none">
        <div class="nav-item" onclick="showPage('boss')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M6 20v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2"/><path d="M12 4v-2M8 6l-2-2M16 6l2-2"/></svg></span>Boss Fight<span class="nav-badge" id="boss-badge" style="background:#eb4b4b;display:none">!</span></div>
        <div class="nav-item" onclick="showPage('dungeon')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7v12a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7"/><path d="M3 7l9-5 9 5"/><path d="M9 22V12h6v10"/></svg></span>Dungeon</div>
        <div class="nav-item" onclick="showPage('tournament')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 0 0 0 5H6M18 9h1.5a2.5 2.5 0 0 1 0 5H18"/><path d="M8 5h8v14H8z"/></svg></span>Tournament</div>
        <div class="nav-item" onclick="showPage('highroller')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/></svg></span>High Roller<span id="hr-lock" class="nav-badge" style="background:#8847ff">LV25</span></div>
      </div>
    </div>
    <div class="nav-section">
      <div class="nav-group-header" onclick="toggleNavGroup(this)">
        <span><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="display:inline;margin-right:5px;vertical-align:-2px"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>Crafting</span><span class="nav-arrow">â–¾</span>
      </div>
      <div class="nav-group-body" style="display:none">
        <div class="nav-item" onclick="showPage('upgrade')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20V10M18 20V4M6 20v-6"/></svg></span>Skin Upgrade</div>
        <div class="nav-item" onclick="showPage('forge')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 14.5C4 10.5 7 8 12 8s8 2.5 8 6.5C20 19 16 22 12 22s-8-3-8-7.5z"/><path d="M12 8V2M8 4l4-2 4 2"/></svg></span>Skin Forge</div>
        <div class="nav-item" onclick="showPage('lucklab')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 2v7.31L6 20h12l-4-10.69V2"/><path d="M8.5 2h7"/><circle cx="14" cy="14" r="1" fill="currentColor"/><circle cx="10" cy="17" r="1" fill="currentColor"/></svg></span>Luck Lab<span class="nav-badge" style="background:var(--accent3)">NEW</span></div>
      </div>
    </div>
    <div class="nav-section">
      <div class="nav-group-header" onclick="toggleNavGroup(this)">
        <span><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="display:inline;margin-right:5px;vertical-align:-2px"><circle cx="12" cy="12" r="9"/><path d="M12 6v6l4 2"/></svg>Economy</span><span class="nav-arrow">â–¾</span>
      </div>
      <div class="nav-group-body" style="display:none">
        <div class="nav-item" onclick="showPage('inventory')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 0 0-4 0v2M8 7V5a2 2 0 0 0-4 0"/><path d="M12 12v5M9.5 14.5h5"/></svg></span>Inventory</div>
        <div class="nav-item" onclick="showPage('bank')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="8" width="20" height="12" rx="2"/><path d="M12 2L2 8h20L12 2z"/><line x1="6" y1="12" x2="6" y2="16"/><line x1="10" y1="12" x2="10" y2="16"/><line x1="14" y1="12" x2="14" y2="16"/><line x1="18" y1="12" x2="18" y2="16"/></svg></span>Bank</div>
        <div class="nav-item" onclick="showPage('invest')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></span>Investments</div>
        <div class="nav-item" onclick="showPage('auction')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 2H9l-1 4H5l-1 4h16l-1-4h-3l-1-4z"/><rect x="3" y="10" width="18" height="2"/><path d="M7 12v8M17 12v8M4 20h16"/></svg></span>Auction<span class="nav-badge" id="auction-badge" style="background:var(--green);display:none">LIVE</span></div>
        <div class="nav-item" onclick="showPage('blackmarket')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M9 12l2 2 4-4"/></svg></span>Black Market<span class="nav-badge" id="bm-badge" style="background:var(--red);display:none">!</span></div>
        <div class="nav-item" onclick="showPage('market')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/></svg></span>Marketplace</div>
        <div class="nav-item" onclick="showPage('tokens')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M12 6v2M12 16v2M8.5 9.5l1 1M14.5 14.5l1 1M6 12h2M16 12h2M9.5 14.5l-1 1M14.5 9.5l-1 1"/></svg></span>Tokens <span class="token-balance" style="font-size:10px;color:var(--accent3);margin-left:auto">0</span></div>
      </div>
    </div>
    <div class="nav-section">
      <div class="nav-group-header" onclick="toggleNavGroup(this)">
        <span><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="display:inline;margin-right:5px;vertical-align:-2px"><circle cx="12" cy="8" r="5"/><path d="M3 21v-2a7 7 0 0 1 14 0v2"/></svg>Character</span><span class="nav-arrow">â–¾</span>
      </div>
      <div class="nav-group-body" style="display:none">
        <div class="nav-item" onclick="showPage('skilltree')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="5" r="2"/><circle cx="6" cy="15" r="2"/><circle cx="18" cy="15" r="2"/><path d="M12 7v4M10 15l-2-2M14 15l2-2"/></svg></span>Skill Tree<span class="nav-badge" id="skill-badge" style="background:var(--green);display:none">SP!</span></div>
        <div class="nav-item" onclick="showPage('prestige')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/></svg></span>Prestige</div>
        <div class="nav-item" onclick="showPage('legacyperks')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01z"/></svg></span>Legacy Perks</div>
        <div class="nav-item" onclick="showPage('prestigestore')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg></span>Prestige Store<span class="nav-badge" style="background:rgba(255,68,255,.8)">NEW</span></div>
        <div class="nav-item" onclick="showPage('shop')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.38 3.46L16 2a4 4 0 0 1-8 0L3.62 3.46a2 2 0 0 0-1.34 2.23l.58 3.57a1 1 0 0 0 .99.84H3v10a1 1 0 0 0 1 1h16a1 1 0 0 0 1-1V10h.11a1 1 0 0 0 .99-.84l.58-3.57a2 2 0 0 0-1.3-2.13z"/></svg></span>Cosmetic Shop</div>
        <div class="nav-item" onclick="showPage('profile')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></span>Profile & Rival</div>
      </div>
    </div>
    <div class="nav-section">
      <div class="nav-group-header" onclick="toggleNavGroup(this)">
        <span><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="display:inline;margin-right:5px;vertical-align:-2px"><polyline points="22,12 18,12 15,21 9,3 6,12 2,12"/></svg>Progress</span><span class="nav-arrow">â–¾</span>
      </div>
      <div class="nav-group-body" style="display:none">
        <div class="nav-item" onclick="showPage('missions')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg></span>Missions<span class="nav-badge" id="mission-badge" style="display:none">!</span></div>
        <div class="nav-item" onclick="showPage('battlepass')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/><path d="M7 15h.01M11 15h4"/></svg></span>Battle Pass</div>
        <div class="nav-item" onclick="showPage('streak')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2c-1 3-4 4-4 8a4 4 0 0 0 8 0c0-4-3-5-4-8z" stroke-width="2"/><path d="M12 14v8"/></svg></span>Daily Streak<span class="nav-badge" id="streak-nav-badge" style="background:var(--accent);display:none">!</span></div>
        <div class="nav-item" onclick="showPage('collection')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg></span>Collection Book<span class="nav-badge" style="background:var(--knife)">NEW</span></div>
        <div class="nav-item" onclick="showPage('stats')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></span>Analytics</div>
        <div class="nav-item" onclick="showPage('leaderboard')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 0 0 0 5H6M18 9h1.5a2.5 2.5 0 0 1 0 5H18M8 5h8v14H8z"/></svg></span>Leaderboard</div>
        <div class="nav-item" onclick="showPage('fairness')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></span>Provably Fair</div>
      </div>
    </div>
    <div class="nav-section">
      <div class="nav-group-header" onclick="toggleNavGroup(this)">
        <span><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="display:inline;margin-right:5px;vertical-align:-2px"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/></svg>Settings</span><span class="nav-arrow">â–¾</span>
      </div>
      <div class="nav-group-body" style="display:none">
        <div class="nav-item" onclick="showPage('settings')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></span>Settings</div>
        <div class="nav-item" onclick="openSpinModal()"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M12 12l-4-4M12 12l4 0M12 12l0 4"/></svg></span>Daily Spin<span class="nav-badge" id="spin-badge" style="background:var(--green)">FREE</span></div>
        <div class="nav-item" id="admin-nav" style="display:none" onclick="showPage('admin')"><span class="nav-icon ico" style="width:18px;height:18px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></span>Admin Panel</div>
      </div>
    </div>
    <div style="padding:8px 12px;border-top:1px solid var(--bg4);flex-shrink:0">
      <div style="font-size:9px;color:var(--text3);letter-spacing:1px;margin-bottom:4px;text-transform:uppercase;display:flex;align-items:center;gap:4px"><span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--green);box-shadow:0 0 4px var(--green)"></span> Live Activity</div>
      <div id="activity-feed" style="font-size:11px"></div>
    </div>
    <div class="sidebar-user">
      <div class="user-info">
        <div class="user-avatar" id="sb-avatar">?</div>
        <div>
          <div class="user-name" id="sb-username">Guest</div>
          <div class="user-rank" id="sb-rank">Silver I</div>
        </div>
        <button class="logout-btn" onclick="doLogout()" title="Logout"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/></svg></button>
      </div>
    </div>
  </aside>

  <div class="main">
    <div class="topbar">
      <button class="mobile-menu-btn" onclick="toggleSidebar()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
      <div class="topbar-title" id="topbar-title">Click Farm</div>
      <div class="topbar-stat"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="var(--accent3)" stroke-width="2.5" style="flex-shrink:0"><path d="M5 8h14l-1 12H6L5 8z"/><path d="M9 8V6a3 3 0 0 1 6 0v2"/></svg><span class="val" id="top-inv-count">0</span><span>items</span></div>
      <div class="topbar-stat"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2.5" style="flex-shrink:0"><path d="M6 9H4.5a2.5 2.5 0 0 0 0 5H6M18 9h1.5a2.5 2.5 0 0 1 0 5H18M8 5h8v14H8z"/></svg><span class="val" id="top-rank">S1</span></div>
      <div class="topbar-stat" id="hot-streak-display" style="display:none;border-color:rgba(235,75,75,.5);background:rgba(235,75,75,.08)"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#eb4b4b" stroke-width="2" style="flex-shrink:0"><path d="M12 2c-1 3-4 4-4 8a4 4 0 0 0 8 0c0-4-3-5-4-8z"/><path d="M12 14v8"/></svg><span class="val" id="hs-count" style="color:#eb4b4b">0</span><span style="font-size:10px;color:var(--text3)">streak</span><span class="val" id="hs-mult" style="color:var(--gold)">1.0x</span></div>
      <div class="topbar-stat" id="weekend-stat" style="display:none;border-color:rgba(240,165,0,.4)"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2" style="flex-shrink:0"><path d="M11.048 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 0 0 .95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 0 0-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 0 0-1.176 0l-3.976 2.888c-.783.57-1.838-.196-1.538-1.118l1.518-4.674a1 1 0 0 0-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 0 0 .951-.69l1.519-4.674z"/></svg><span class="val" style="color:var(--gold)">2x LUCK</span></div>
      <div class="topbar-stat" id="streak-stat" style="display:none;border-color:rgba(235,75,75,.4)"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#eb4b4b" stroke-width="2" style="flex-shrink:0"><path d="M12 2c-1 3-4 4-4 8a4 4 0 0 0 8 0c0-4-3-5-4-8z"/></svg><span class="val" id="streak-val" style="color:#eb4b4b">0</span></div>
    </div>

    <!-- CLICKER PAGE -->
    <div class="page active" id="page-clicker">
      <div id="weekend-banner" class="event-banner hidden"><span>ðŸ€</span><b style="color:var(--gold)">Weekend Bonus Active!</b> â€” 2x Luck on all case openings until Sunday midnight</div>
      <div class="flex gap-3">
        <div style="flex:1">
          <div class="click-area">
            <div class="passive-income">
              <div style="font-size:11px;color:var(--text2);letter-spacing:1px;margin-bottom:4px">PASSIVE INCOME</div>
              <div style="font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:700;color:var(--accent3)" id="cps-display">$0.00/s</div>
            </div>
            <div class="click-btn-wrap" style="position:relative">
              <div class="combo-display" id="combo-display" style="display:none">
                <div class="combo-badge" id="combo-badge">2Ã— COMBO</div>
                <div class="combo-meter"><div class="combo-fill" id="combo-fill" style="width:100%"></div></div>
              </div>
              <button class="click-btn" id="click-btn" onclick="doClick(event)">
                <div class="click-btn-inner">
                  <svg width="110" height="110" viewBox="0 0 110 110" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <!-- Coin outer ring -->
                    <circle cx="55" cy="55" r="50" fill="url(#coinGrad)" opacity="0.95"/>
                    <circle cx="55" cy="55" r="50" fill="none" stroke="#f0a500" stroke-width="2" opacity="0.6"/>
                    <circle cx="55" cy="55" r="44" fill="none" stroke="#f0a500" stroke-width="0.8" opacity="0.3"/>
                    <!-- Inner design -->
                    <circle cx="55" cy="55" r="36" fill="#0d0e16" opacity="0.7"/>
                    <!-- CS crosshair -->
                    <circle cx="55" cy="55" r="18" fill="none" stroke="#f0a500" stroke-width="1.5" opacity="0.8"/>
                    <circle cx="55" cy="55" r="3" fill="#f0a500" opacity="0.9"/>
                    <line x1="37" y1="55" x2="47" y2="55" stroke="#f0a500" stroke-width="2" stroke-linecap="round"/>
                    <line x1="63" y1="55" x2="73" y2="55" stroke="#f0a500" stroke-width="2" stroke-linecap="round"/>
                    <line x1="55" y1="37" x2="55" y2="47" stroke="#f0a500" stroke-width="2" stroke-linecap="round"/>
                    <line x1="55" y1="63" x2="55" y2="73" stroke="#f0a500" stroke-width="2" stroke-linecap="round"/>
                    <!-- Dollar sign inside -->
                    <text x="55" y="60" text-anchor="middle" font-size="22" font-weight="700" fill="#f0a500" font-family="Barlow Condensed" opacity="0.9">$</text>
                    <!-- Tick marks on rim -->
                    <defs>
                      <radialGradient id="coinGrad" cx="40%" cy="30%">
                        <stop offset="0%" stop-color="#3a3020"/>
                        <stop offset="60%" stop-color="#1a1b24"/>
                        <stop offset="100%" stop-color="#0d0e16"/>
                      </radialGradient>
                    </defs>
                  </svg>
                </div>
              </button>
            </div>
            <div class="click-value" id="click-val-display">+$0.01 per click</div>
            <div class="click-cps" id="total-clicks-display">0 total clicks</div>
          </div>
        </div>
        <div style="width:320px;flex-shrink:0" class="hidden-mobile">
          <div class="section-title">ðŸ“œ History</div>
          <div class="history-panel" id="history-panel"></div>
        </div>
      </div>
      <div class="section-title">Quick Bet</div>
      <div class="quickbet-panel">
        <div style="font-size:13px;color:var(--text2);margin-bottom:8px">One-click bets â€” no screen changes needed.</div>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap">
          <span style="font-size:12px;color:var(--text2)">Bet:</span>
          <input type="number" id="qb-bet" value="50" min="1" style="width:80px;background:var(--bg4);border:1px solid var(--bg5);border-radius:6px;padding:5px 8px;color:var(--text);font-size:13px">
          <button class="btn btn-secondary btn-sm" onclick="document.getElementById('qb-bet').value=Math.max(1,(G.balance*0.1)|0)">10%</button>
          <button class="btn btn-secondary btn-sm" onclick="document.getElementById('qb-bet').value=Math.max(1,(G.balance*0.5)|0)">50%</button>
          <button class="btn btn-secondary btn-sm" onclick="document.getElementById('qb-bet').value=Math.max(1,G.balance|0)">All</button>
        </div>
        <div class="quickbet-grid">
          <button class="qb-btn" onclick="quickBet(1.5,0.6)"><span class="qb-mult">1.5Ã—</span><span style="color:var(--text2);font-size:12px">Easy</span><span class="qb-chance">60% win</span></button>
          <button class="qb-btn" onclick="quickBet(2,0.45)"><span class="qb-mult">2Ã—</span><span style="color:var(--text2);font-size:12px">Normal</span><span class="qb-chance">45% win</span></button>
          <button class="qb-btn" onclick="quickBet(3,0.3)"><span class="qb-mult">3Ã—</span><span style="color:var(--accent2);font-size:12px">Risky</span><span class="qb-chance">30% win</span></button>
          <button class="qb-btn" onclick="quickBet(5,0.18)"><span class="qb-mult" style="color:var(--classified)">5Ã—</span><span style="color:var(--text2);font-size:12px">High Risk</span><span class="qb-chance">18% win</span></button>
          <button class="qb-btn" onclick="quickBet(10,0.09)"><span class="qb-mult" style="color:var(--covert)">10Ã—</span><span style="color:var(--text2);font-size:12px">Extreme</span><span class="qb-chance">9% win</span></button>
          <button class="qb-btn" onclick="quickBet(50,0.02)"><span class="qb-mult" style="color:var(--knife)">50Ã—</span><span style="color:var(--knife);font-size:12px">LEGENDARY</span><span class="qb-chance">2% win</span></button>
        </div>
        <div id="qb-result" style="text-align:center;margin-top:8px;font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:700;min-height:24px"></div>
      </div>
      <div class="section-title mt-2">Upgrades</div>
      <div class="upgrades-grid" id="upgrades-grid"></div>
      <div class="section-title mt-2">Rebirth</div>
      <div class="rebirth-card">
        <div class="rebirth-flame"><svg width="36" height="36" viewBox="0 0 36 36" fill="none"><path d="M18 3c-1.5 4.5-6 6-6 12a6 6 0 0 0 12 0c0-6-4.5-7.5-6-12z" fill="#ff6b35" opacity="0.8"/><path d="M18 12c-.8 2-3 3.5-3 6a3 3 0 0 0 6 0c0-2.5-2.2-4-3-6z" fill="#f0a500" opacity="0.9"/></svg></div>
        <div style="font-family:'Rajdhani',sans-serif;font-size:24px;font-weight:700;color:var(--accent2);margin:8px 0">REBIRTH SYSTEM</div>
        <div style="color:var(--text2);font-size:13px;margin-bottom:16px">Reset your progress for a permanent <b style="color:var(--accent2)">+25% luck boost</b> and special Rebirth badge! You keep your inventory.</div>
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:14px;color:var(--text3);margin-bottom:12px">Rebirths: <span id="rebirth-count" style="color:var(--accent2)">0</span> â€” Luck Bonus: <span id="rebirth-luck" style="color:var(--green)">+0%</span></div>
        <button class="btn btn-primary btn-lg" onclick="doRebirth()">REBIRTH (Requires $100,000)</button>
      </div>
    </div>

    <!-- CASES PAGE -->
    <div class="page" id="page-cases">
      <div class="page-header">
        <div class="page-title">ðŸ“¦ Cases</div>
        <div class="page-subtitle">Open cases to win rare skins. Higher price = better odds!</div>
      </div>
      <div id="event-banner-wrapper" class="hidden">
        <div id="event-banner" class="event-banner"></div>
      </div>
      <div id="weekend-banner2" class="event-banner hidden"><span>ðŸ€</span><b style="color:var(--gold)">Weekend Bonus Active!</b> â€” 2x Luck on all case openings!</div>
      <div class="flex gap-2 mb-2 items-center" style="flex-wrap:wrap">
        <div class="section-title" style="margin:0">ðŸŽ CSGO Cases</div>
        <div style="margin-left:auto;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-secondary btn-sm" onclick="showPage('cases')" id="auto-open-btn" style="display:none">â–¶ Auto-Open</button>
          <div style="font-size:12px;color:var(--text3);align-self:center">Select a case to enable auto-open</div>
        </div>
      </div>
      <div class="cases-grid" id="cases-grid"></div>
      <div id="multi-open-grid" style="display:none;margin-top:16px;gap:4px;min-height:60px"></div>
    </div>

    <!-- CASINO PAGE -->
    <div class="page" id="page-casino">
      <div class="page-header">
        <div class="page-title">ðŸŽ² Casino</div>
        <div class="page-subtitle">Play fair simulated casino games</div>
      </div>
      <div id="casino-hub">
        <div class="games-grid" id="games-grid"></div>
      </div>
      <!-- Blackjack -->
      <div id="game-blackjack" class="game-panel">
        <button class="btn btn-secondary btn-sm mb-1" onclick="showCasinoHub()">â† Back</button>
        <div class="page-title" style="margin-bottom:16px">ðŸƒ Blackjack</div>
        <div class="bj-table">
          <div class="bj-label">Dealer</div>
          <div class="bj-cards" id="dealer-cards"></div>
          <div class="bj-score" id="dealer-score">?</div>
          <div style="position:absolute;bottom:24px;left:24px;right:24px">
            <div class="bj-label">Your Hand</div>
            <div class="bj-cards" id="player-cards"></div>
            <div class="bj-score" id="player-score">0</div>
          </div>
        </div>
        <div class="flex items-center justify-center gap-2 mb-1">
          <div style="font-size:13px;color:var(--text2)">Bet:</div>
          <input type="number" id="bj-bet" value="100" min="1" style="width:90px;background:var(--bg4);border:1px solid var(--bg5);border-radius:6px;padding:6px 10px;color:var(--text)" placeholder="ðŸ”µ tokens">
          <button class="btn btn-secondary btn-sm" onclick="setBet('bj-bet',0.5)">Â½</button>
          <button class="btn btn-secondary btn-sm" onclick="setBet('bj-bet',2)">2Ã—</button>
          <button class="btn btn-secondary btn-sm" onclick="setBetMax('bj-bet')">Max</button>
        </div>
        <div class="bj-controls">
          <button class="btn btn-primary btn-lg" id="bj-deal" onclick="bjDeal()">ðŸƒ Deal</button>
          <button class="btn btn-green" id="bj-hit" onclick="bjHit()" style="display:none">Hit</button>
          <button class="btn btn-secondary" id="bj-stand" onclick="bjStand()" style="display:none">Stand</button>
          <button class="btn btn-secondary" id="bj-double" onclick="bjDouble()" style="display:none">Double Down</button>
        </div>
        <div id="bj-result" style="text-align:center;margin-top:16px;font-family:'Rajdhani',sans-serif;font-size:24px;font-weight:700;min-height:30px"></div>
      </div>
      <!-- Roulette -->
      <div id="game-roulette" class="game-panel">
        <button class="btn btn-secondary btn-sm mb-1" onclick="showCasinoHub()">â† Back</button>
        <div class="page-title" style="margin-bottom:16px">ðŸŽ¯ Roulette</div>
        <div class="roulette-wrap">
          <div class="roulette-belt">
            <div class="roulette-belt-inner" id="rl-belt"></div>
          </div>
          <div style="width:3px;height:60px;background:var(--accent);position:absolute;top:0;bottom:0;margin:auto 0;left:50%;transform:translateX(-50%);z-index:5;pointer-events:none"></div>
          <div class="flex items-center justify-center gap-2 mb-1 mt-2">
            <div style="font-size:13px;color:var(--text2)">Bet:</div>
            <input type="number" id="rl-bet" value="100" min="1" style="width:90px;background:var(--bg4);border:1px solid var(--bg5);border-radius:6px;padding:6px 10px;color:var(--text)" placeholder="ðŸ”µ tokens">
            <button class="btn btn-secondary btn-sm" onclick="setBet('rl-bet',0.5)">Â½</button>
            <button class="btn btn-secondary btn-sm" onclick="setBet('rl-bet',2)">2Ã—</button>
          </div>
          <div class="roulette-bets">
            <button class="roulette-bet-btn rl-red" style="background:#c0392b;color:white;border-color:#c0392b" onclick="rlBet('red')">ðŸ”´ RED 2Ã—</button>
            <button class="roulette-bet-btn rl-green" style="background:#27ae60;color:white;border-color:#27ae60" onclick="rlBet('green')">ðŸŸ¢ GREEN 14Ã—</button>
            <button class="roulette-bet-btn rl-black" style="background:#2a2b38;color:white;border:2px solid #555" onclick="rlBet('black')">âš« BLACK 2Ã—</button>
          </div>
          <div id="rl-result" style="text-align:center;margin-top:12px;font-family:'Rajdhani',sans-serif;font-size:24px;font-weight:700;min-height:30px"></div>
        </div>
      </div>
      <!-- Crash -->
      <div id="game-crash" class="game-panel">
        <button class="btn btn-secondary btn-sm mb-1" onclick="showCasinoHub()">â† Back</button>
        <div class="page-title" style="margin-bottom:16px">ðŸš€ Crash</div>
        <div class="crash-canvas-wrap">
          <canvas id="crash-canvas" width="800" height="250"></canvas>
          <div class="crash-multiplier" id="crash-mult">1.00Ã—</div>
        </div>
        <div class="flex items-center justify-center gap-2 mb-2">
          <div style="font-size:13px;color:var(--text2)">Bet:</div>
          <input type="number" id="crash-bet" value="100" min="1" style="width:90px;background:var(--bg4);border:1px solid var(--bg5);border-radius:6px;padding:6px 10px;color:var(--text)" placeholder="ðŸ”µ tokens">
          <div style="font-size:13px;color:var(--text2)">Auto Cash-out:</div>
          <input type="number" id="crash-auto" value="2" step="0.1" min="1.1" style="width:80px;background:var(--bg4);border:1px solid var(--bg5);border-radius:6px;padding:6px 10px;color:var(--text)">
        </div>
        <div style="text-align:center;display:flex;gap:12px;justify-content:center">
          <button class="btn btn-primary btn-lg" id="crash-bet-btn" onclick="crashBet()">ðŸš€ Place Bet</button>
          <button class="btn btn-green btn-lg" id="crash-cashout-btn" onclick="crashCashout()" style="display:none">ðŸ’° Cash Out</button>
        </div>
        <div id="crash-result" style="text-align:center;margin-top:12px;font-family:'Rajdhani',sans-serif;font-size:22px;font-weight:700;min-height:28px"></div>
      </div>
      <!-- Mines -->
      <div id="game-mines" class="game-panel">
        <button class="btn btn-secondary btn-sm mb-1" onclick="showCasinoHub()">â† Back</button>
        <div class="page-title" style="margin-bottom:16px">ðŸ’£ Mines</div>
        <div class="flex items-center justify-center gap-3 mb-2 flex-wrap">
          <div class="flex items-center gap-2">
            <span style="font-size:13px;color:var(--text2)">Bet:</span>
            <input type="number" id="mines-bet" value="100" min="1" style="width:90px;background:var(--bg4);border:1px solid var(--bg5);border-radius:6px;padding:6px 10px;color:var(--text)" placeholder="ðŸ”µ tokens">
          </div>
          <div class="flex items-center gap-2">
            <span style="font-size:13px;color:var(--text2)">Mines:</span>
            <select id="mines-count" style="background:var(--bg4);border:1px solid var(--bg5);border-radius:6px;padding:6px;color:var(--text)">
              <option value="1">1</option><option value="3">3</option><option value="5" selected>5</option>
              <option value="10">10</option><option value="15">15</option>
            </select>
          </div>
          <button class="btn btn-primary" id="mines-start-btn" onclick="minesStart()">ðŸ’£ Start Game</button>
          <button class="btn btn-green" id="mines-cashout-btn" onclick="minesCashout()" style="display:none">ðŸ’° Cash Out <span id="mines-mult">1.00Ã—</span></button>
        </div>
        <div class="mines-grid-wrap" id="mines-grid"></div>
        <div id="mines-result" style="text-align:center;margin-top:8px;font-family:'Rajdhani',sans-serif;font-size:22px;font-weight:700;min-height:28px"></div>
      </div>
      <!-- Slots -->
      <div id="game-slots" class="game-panel">
        <button class="btn btn-secondary btn-sm mb-1" onclick="showCasinoHub()">â† Back</button>
        <div class="page-title" style="margin-bottom:16px">ðŸŽ° Slots</div>
        <div class="slots-machine">
          <div style="font-family:'Rajdhani',sans-serif;font-size:16px;color:var(--text2);letter-spacing:1px;margin-bottom:8px">JACKPOT SLOTS</div>
          <div class="slots-reels" id="slots-reels">
            <div class="slot-reel" id="reel-0">ðŸ’</div>
            <div class="slot-reel" id="reel-1">ðŸ‹</div>
            <div class="slot-reel" id="reel-2">ðŸ‡</div>
          </div>
          <div id="slots-result" style="font-family:'Rajdhani',sans-serif;font-size:20px;font-weight:700;min-height:28px;margin-bottom:12px"></div>
          <div class="flex items-center justify-center gap-2 mb-2">
            <span style="font-size:13px;color:var(--text2)">Bet:</span>
            <input type="number" id="slots-bet" value="50" min="1" style="width:80px;background:var(--bg2);border:1px solid var(--bg5);border-radius:6px;padding:6px;color:var(--text)" placeholder="ðŸ”µ">
          </div>
          <button class="btn btn-primary btn-lg w-full" id="slots-spin-btn" onclick="slotsPlay()">ðŸŽ° SPIN</button>
        </div>
        <div style="margin-top:16px;background:var(--bg3);border-radius:10px;padding:14px">
          <div class="section-title" style="font-size:14px">Paytable</div>
          <div class="grid g2 gap-1 mt-1" style="font-size:12px">
            <div>ðŸ’ŽðŸ’ŽðŸ’Ž = 100Ã—</div><div>7ï¸âƒ£7ï¸âƒ£7ï¸âƒ£ = 50Ã—</div>
            <div>ðŸ’ðŸ’ðŸ’ = 20Ã—</div><div>ðŸ‹ðŸ‹ðŸ‹ = 15Ã—</div>
            <div>ðŸ‡ðŸ‡ðŸ‡ = 12Ã—</div><div>ðŸ””ðŸ””ðŸ”” = 10Ã—</div>
            <div>â­â­â­ = 8Ã—</div><div>Any 3 match = 5Ã—</div>
          </div>
        </div>
      </div>
      <!-- Plinko -->
      <div id="game-plinko" class="game-panel">
        <button class="btn btn-secondary btn-sm mb-1" onclick="showCasinoHub()">â† Back</button>
        <div class="page-title" style="margin-bottom:16px">ðŸ”µ Plinko</div>
        <div class="flex items-center justify-center gap-2 mb-2 flex-wrap">
          <span style="font-size:13px;color:var(--text2)">Bet:</span>
          <input type="number" id="plinko-bet" value="10" min="1" style="width:80px;background:var(--bg4);border:1px solid var(--bg5);border-radius:6px;padding:6px 10px;color:var(--text)">
          <span style="font-size:11px;color:var(--text3)">Balls:</span>
          <button class="btn btn-secondary btn-sm plinko-multi-btn active" onclick="setPlinkoBalls(1)">Ã—1</button>
          <button class="btn btn-secondary btn-sm plinko-multi-btn" onclick="setPlinkoBalls(3)">Ã—3</button>
          <button class="btn btn-secondary btn-sm plinko-multi-btn" onclick="setPlinkoBalls(5)">Ã—5</button>
        </div>
        <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-bottom:8px">
          <button class="btn btn-primary btn-lg" onclick="plinkoDropMulti()">ðŸ”µ Drop</button>
          <button class="btn btn-secondary" id="plinko-auto-btn" onclick="togglePlinkoAuto()">â–¶ Auto Drop</button>
        </div>
        <div style="text-align:center">
          <canvas id="plinko-canvas" width="400" height="380" style="max-width:100%"></canvas>
        </div>
        <div id="plinko-result" style="text-align:center;margin-top:8px;font-family:'Rajdhani',sans-serif;font-size:22px;font-weight:700;min-height:28px"></div>
      </div>
      <!-- Coinflip -->
      <div id="game-coinflip" class="game-panel">
        <button class="btn btn-secondary btn-sm mb-1" onclick="showCasinoHub()">â† Back</button>
        <div class="page-title" style="margin-bottom:16px">ðŸª™ Coinflip</div>
        <div style="text-align:center">
          <div class="coin-wrap"><div class="coin" id="coin">
            <div class="coin-face coin-heads">ðŸ”¶</div>
            <div class="coin-face coin-tails">ðŸ”·</div>
          </div></div>
          <div class="flex items-center justify-center gap-2 mb-2">
            <span style="font-size:13px;color:var(--text2)">Bet:</span>
            <input type="number" id="cf-bet" value="100" min="1" style="width:90px;background:var(--bg4);border:1px solid var(--bg5);border-radius:6px;padding:6px 10px;color:var(--text)" placeholder="ðŸ”µ tokens">
          </div>
          <div class="flex gap-3 justify-center mt-2">
            <button class="btn btn-lg" style="background:#c0392b;color:white" onclick="coinflip('heads')">ðŸ”¶ CT (Heads)</button>
            <button class="btn btn-lg" style="background:#1a3a7a;color:white" onclick="coinflip('tails')">ðŸ”· T (Tails)</button>
          </div>
          <div id="cf-result" style="margin-top:16px;font-family:'Rajdhani',sans-serif;font-size:24px;font-weight:700;min-height:30px"></div>
        </div>
      </div>

      <!-- KENO -->
      <div id="game-keno" class="game-panel">
        <button class="btn btn-secondary btn-sm mb-1" onclick="showCasinoHub()">â† Back</button>
        <div class="page-title" style="margin-bottom:4px">ðŸŸ¡ Keno</div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:12px;text-align:center">Pick up to 10 numbers. We draw 20. More matches = bigger payout!</div>
        <div style="text-align:center;margin-bottom:8px">
          <span style="font-size:12px;color:var(--text3)">Your picks: </span>
          <span id="keno-pick-count" style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:700;color:var(--accent)">0</span>
          <span style="font-size:12px;color:var(--text3)">/10</span>
          <span style="margin-left:12px;font-size:12px;color:var(--text3)">Tokens: </span><span class="token-balance" style="font-size:12px;color:var(--accent3)">0</span>
        </div>
        <div id="keno-grid" style="display:grid;grid-template-columns:repeat(8,1fr);gap:4px;max-width:480px;margin:0 auto 12px"></div>
        <div style="display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap;margin-bottom:10px">
          <span style="font-size:13px;color:var(--text2)">Bet:</span>
          <input type="number" id="keno-bet" value="100" min="1" style="width:80px;background:var(--bg4);border:1px solid var(--bg5);border-radius:6px;padding:6px;color:var(--text)">
          <button class="btn btn-secondary btn-sm" onclick="kenoQuickPick()">ðŸŽ² Quick Pick</button>
          <button class="btn btn-secondary btn-sm" onclick="kenoClear()">âœ• Clear</button>
          <button class="btn btn-primary btn-lg" onclick="kenoPlay()">ðŸŸ¡ Draw!</button>
        </div>
        <div id="keno-result" style="text-align:center;font-family:'Rajdhani',sans-serif;font-size:20px;font-weight:700;min-height:28px"></div>
        <div id="keno-drawn-display" style="margin-top:8px;text-align:center;font-size:12px;color:var(--text2)"></div>
      </div>

      <!-- TOWER -->
      <div id="game-tower" class="game-panel">
        <button class="btn btn-secondary btn-sm mb-1" onclick="showCasinoHub()">â† Back</button>
        <div class="page-title" style="margin-bottom:4px">ðŸ—¼ Tower Climb</div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:12px;text-align:center">Each floor: pick a safe door. Wrong door = game over. Correct = multiplier grows!</div>
        <div style="display:flex;gap:20px;max-width:520px;margin:0 auto">
          <div style="flex:1">
            <div id="tower-grid" style="display:flex;flex-direction:column-reverse;gap:4px"></div>
          </div>
          <div style="width:130px">
            <div class="card" style="text-align:center;padding:12px">
              <div style="font-size:10px;color:var(--text3)">FLOOR</div>
              <div id="tower-floor-num" style="font-family:'Barlow Condensed',sans-serif;font-size:32px;font-weight:700;color:var(--gold)">0</div>
              <div style="font-size:10px;color:var(--text3)">MULTIPLIER</div>
              <div id="tower-mult-display" style="font-family:'Barlow Condensed',sans-serif;font-size:26px;font-weight:700;color:var(--green)">1.00Ã—</div>
              <div style="font-size:10px;color:var(--text3);margin-top:6px">PAYOUT</div>
              <div id="tower-payout-display" style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:700;color:var(--accent)">0</div>
              <button class="btn btn-green w-full mt-1 btn-sm" id="tower-cashout-btn" onclick="towerCashout()" style="display:none">ðŸ’° Cash Out</button>
            </div>
            <div style="margin-top:8px;display:flex;gap:6px;align-items:center">
              <span style="font-size:11px;color:var(--text2)">Bet:</span>
              <input type="number" id="tower-bet" value="100" min="1" style="width:75px;background:var(--bg4);border:1px solid var(--bg5);border-radius:6px;padding:5px 8px;color:var(--text);font-size:12px">
            </div>
            <div style="margin-top:6px;display:flex;gap:6px;align-items:center">
              <span style="font-size:11px;color:var(--text2)">Mines:</span>
              <select id="tower-mines" style="background:var(--bg4);border:1px solid var(--bg5);border-radius:6px;padding:5px;color:var(--text);font-size:12px;flex:1">
                <option value="1">Easy (1/3)</option>
                <option value="2" selected>Hard (2/3)</option>
              </select>
            </div>
            <button class="btn btn-primary w-full mt-1" id="tower-start-btn" onclick="towerStart()">ðŸ—¼ Start</button>
          </div>
        </div>
        <div id="tower-result" style="text-align:center;margin-top:12px;font-family:'Rajdhani',sans-serif;font-size:22px;font-weight:700;min-height:28px"></div>
      </div>

      <!-- LIMBO -->
      <div id="game-limbo" class="game-panel">
        <button class="btn btn-secondary btn-sm mb-1" onclick="showCasinoHub()">â† Back</button>
        <div class="page-title" style="margin-bottom:4px">ðŸŒ€ Limbo</div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:16px;text-align:center">Set your target multiplier. We generate a random one. If ours â‰¥ yours, you win!</div>
        <div style="text-align:center;margin-bottom:20px">
          <div id="limbo-result-num" style="font-family:'Rajdhani',sans-serif;font-size:90px;font-weight:700;color:var(--text3);line-height:1;min-height:90px;transition:all .3s">â€”</div>
          <div id="limbo-result-text" style="font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:700;min-height:20px;margin-top:6px"></div>
        </div>
        <div style="max-width:400px;margin:0 auto">
          <div style="background:var(--bg4);border-radius:12px;padding:14px;margin-bottom:14px">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:10px">
              <div>
                <div style="font-size:11px;color:var(--text3);margin-bottom:4px">TARGET MULTIPLIER</div>
                <input type="number" id="limbo-target" value="2" min="1.01" max="1000" step="0.1"
                  oninput="updateLimboInfo()"
                  style="width:100%;background:var(--bg3);border:1px solid var(--bg5);border-radius:6px;padding:8px;color:var(--text);font-size:18px;font-weight:700;font-family:'Barlow Condensed',sans-serif">
              </div>
              <div>
                <div style="font-size:11px;color:var(--text3);margin-bottom:4px">BET (TOKENS)</div>
                <input type="number" id="limbo-bet" value="100" min="1"
                  style="width:100%;background:var(--bg3);border:1px solid var(--bg5);border-radius:6px;padding:8px;color:var(--text);font-size:18px;font-weight:700;font-family:'Barlow Condensed',sans-serif">
              </div>
            </div>
            <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:10px">
              <span style="color:var(--text3)">Win chance: <b id="limbo-win-pct" style="color:var(--accent)">50.0%</b></span>
              <span style="color:var(--text3)">Payout: <b id="limbo-payout-display" style="color:var(--green)">2.00Ã—</b></span>
              <span style="color:var(--text3)">Edge: <b style="color:var(--red)">2%</b></span>
            </div>
            <div style="display:flex;gap:6px;margin-bottom:4px;flex-wrap:wrap;justify-content:center">
              <button class="btn btn-secondary btn-sm" onclick="setLimboTarget(1.5)">1.5Ã—</button>
              <button class="btn btn-secondary btn-sm" onclick="setLimboTarget(2)">2Ã—</button>
              <button class="btn btn-secondary btn-sm" onclick="setLimboTarget(5)">5Ã—</button>
              <button class="btn btn-secondary btn-sm" onclick="setLimboTarget(10)">10Ã—</button>
              <button class="btn btn-secondary btn-sm" onclick="setLimboTarget(50)">50Ã—</button>
              <button class="btn btn-secondary btn-sm" onclick="setLimboTarget(100)">100Ã—</button>
            </div>
          </div>
          <button class="btn btn-primary btn-lg w-full" onclick="limboRoll()">ðŸŒ€ Drop</button>
        </div>
      </div>

      <!-- WHEEL OF FORTUNE -->
      <div id="game-wheel" class="game-panel">
        <button class="btn btn-secondary btn-sm mb-1" onclick="showCasinoHub()">â† Back</button>
        <div class="page-title" style="margin-bottom:4px">ðŸŽ¡ Wheel of Fortune</div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:12px;text-align:center">Spin the wheel â€” land on your multiplier! High-risk segments give massive rewards.</div>
        <div style="display:flex;flex-direction:column;align-items:center;gap:12px">
          <div style="position:relative;width:280px;height:280px">
            <canvas id="wheel-canvas" width="280" height="280" style="border-radius:50%"></canvas>
            <div style="position:absolute;top:-14px;left:50%;transform:translateX(-50%);font-size:28px;line-height:1;filter:drop-shadow(0 2px 4px rgba(0,0,0,.6))">â–¼</div>
          </div>
          <div id="wheel-result" style="font-family:'Rajdhani',sans-serif;font-size:24px;font-weight:700;min-height:30px;text-align:center"></div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:center">
            <span style="font-size:13px;color:var(--text2)">Bet:</span>
            <input type="number" id="wheel-bet" value="100" min="1" style="width:80px;background:var(--bg4);border:1px solid var(--bg5);border-radius:6px;padding:6px;color:var(--text)">
            <button class="btn btn-primary btn-lg" id="wheel-spin-btn" onclick="wheelSpin()">ðŸŽ¡ SPIN</button>
          </div>
          <div id="wheel-paytable" style="display:flex;flex-wrap:wrap;gap:6px;justify-content:center;font-size:11px;max-width:400px"></div>
        </div>
      </div>

      <!-- VIDEO POKER -->
      <div id="game-poker" class="game-panel">
        <button class="btn btn-secondary btn-sm mb-1" onclick="showCasinoHub()">â† Back</button>
        <div class="page-title" style="margin-bottom:4px">ðŸƒ Video Poker</div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:12px;text-align:center">Jacks or Better. Hold your best cards, draw to improve your hand!</div>
        <div style="max-width:520px;margin:0 auto">
          <div style="background:var(--bg3);border-radius:12px;padding:16px;margin-bottom:12px">
            <div id="vp-cards" style="display:flex;gap:8px;justify-content:center;margin-bottom:10px"></div>
            <div id="vp-hold-btns" style="display:flex;gap:8px;justify-content:center"></div>
          </div>
          <div id="vp-hand-name" style="text-align:center;font-family:'Rajdhani',sans-serif;font-size:22px;font-weight:700;color:var(--gold);min-height:28px;margin-bottom:8px"></div>
          <div id="vp-result" style="text-align:center;font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:700;min-height:24px;margin-bottom:10px"></div>
          <div style="display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap">
            <span style="font-size:13px;color:var(--text2)">Bet:</span>
            <input type="number" id="vp-bet" value="100" min="1" style="width:80px;background:var(--bg4);border:1px solid var(--bg5);border-radius:6px;padding:6px;color:var(--text)">
            <button class="btn btn-primary btn-lg" id="vp-deal-btn" onclick="vpDeal()">ðŸƒ Deal</button>
            <button class="btn btn-green btn-lg" id="vp-draw-btn" onclick="vpDraw()" style="display:none">â†© Draw</button>
          </div>
          <div style="margin-top:14px;background:var(--bg4);border-radius:8px;padding:10px;font-size:11px;color:var(--text3);display:grid;grid-template-columns:1fr 1fr">
            <div>Royal Flush: 800Ã—</div><div>Straight Flush: 50Ã—</div>
            <div>Four of a Kind: 25Ã—</div><div>Full House: 9Ã—</div>
            <div>Flush: 6Ã—</div><div>Straight: 4Ã—</div>
            <div>Three of a Kind: 3Ã—</div><div>Two Pair: 2Ã—</div>
            <div>Jacks or Better: 1Ã—</div><div>Other: lose</div>
          </div>
        </div>
      </div>
    </div>

    <!-- HEIST MODE (ORIGINAL) -->
    <div class="page" id="page-heist">
      <div class="page-header">
        <div class="page-title">ðŸ•µï¸ The Heist</div>
        <div class="page-subtitle">5-stage narrative gamble. Clear all stages for 32Ã— your bet. One failure = everything lost. No mercy.</div>
      </div>
      <div style="max-width:560px;margin:0 auto">
        <div class="card" id="heist-lobby">
          <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:20px" id="heist-stages-display"></div>
          <div id="heist-narrative" style="background:var(--bg4);border-radius:10px;padding:14px;font-size:13px;color:var(--text2);margin-bottom:16px;min-height:60px;line-height:1.6;font-style:italic"></div>
          <div style="display:flex;gap:10px;align-items:center;justify-content:center;margin-bottom:16px;flex-wrap:wrap">
            <span style="font-size:13px;color:var(--text2)">Heist Fund (tokens):</span>
            <input type="number" id="heist-bet" value="500" min="100"
              style="width:100px;background:var(--bg3);border:1px solid var(--bg5);border-radius:8px;padding:8px;color:var(--text);font-size:16px;font-weight:700">
            <div style="font-size:11px;color:var(--text3)">Win all 5 â†’ <span style="color:var(--gold);font-weight:700">32Ã—</span> payout</div>
          </div>
          <div style="display:flex;gap:10px;justify-content:center">
            <button class="btn btn-primary btn-lg" id="heist-action-btn" onclick="heistAction()">ðŸšª Begin Heist</button>
            <button class="btn btn-red" id="heist-abort-btn" onclick="heistAbort()" style="display:none">ðŸš¨ Abort (Keep winnings)</button>
          </div>
          <div id="heist-result" style="text-align:center;margin-top:12px;font-family:'Rajdhani',sans-serif;font-size:20px;font-weight:700;min-height:26px"></div>
        </div>
      </div>
    </div>

    <!-- SKIN FORGE (ORIGINAL) -->
    <div class="page" id="page-forge">
      <div class="page-header">
        <div class="page-title">âš—ï¸ Skin Forge</div>
        <div class="page-subtitle">Fuse 3 skins of the same rarity for a guaranteed upgrade to the next tier. High risk, high reward crafting!</div>
      </div>
      <div style="max-width:580px;margin:0 auto">
        <div class="card">
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px" id="forge-slots">
            <div class="forge-slot" id="forge-slot-0" onclick="forgeSlotClick(0)" style="background:var(--bg4);border:2px dashed var(--bg5);border-radius:12px;height:110px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:.2s">
              <div style="font-size:28px">âž•</div><div style="font-size:11px;color:var(--text3);margin-top:4px">Add Skin</div>
            </div>
            <div class="forge-slot" id="forge-slot-1" onclick="forgeSlotClick(1)" style="background:var(--bg4);border:2px dashed var(--bg5);border-radius:12px;height:110px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:.2s">
              <div style="font-size:28px">âž•</div><div style="font-size:11px;color:var(--text3);margin-top:4px">Add Skin</div>
            </div>
            <div class="forge-slot" id="forge-slot-2" onclick="forgeSlotClick(2)" style="background:var(--bg4);border:2px dashed var(--bg5);border-radius:12px;height:110px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:.2s">
              <div style="font-size:28px">âž•</div><div style="font-size:11px;color:var(--text3);margin-top:4px">Add Skin</div>
            </div>
          </div>
          <div style="text-align:center;margin-bottom:10px">
            <div id="forge-info" style="font-size:13px;color:var(--text2)">Select 3 skins of the same rarity to begin forging</div>
          </div>
          <div style="display:flex;gap:10px;justify-content:center">
            <button class="btn btn-primary btn-lg" id="forge-btn" onclick="forgeExecute()" disabled>âš—ï¸ Forge</button>
            <button class="btn btn-secondary" onclick="forgeClear()">âœ• Clear</button>
          </div>
          <div id="forge-result" style="text-align:center;margin-top:12px;min-height:40px"></div>
        </div>
        <div style="margin-top:12px;background:var(--bg3);border-radius:10px;padding:12px;font-size:12px;color:var(--text3);line-height:1.8">
          <b style="color:var(--accent)">How Forging Works:</b><br>
          âœ¦ 3Ã— Consumer â†’ 1Ã— Industrial &nbsp;|&nbsp; 3Ã— Industrial â†’ 1Ã— Mil-Spec<br>
          âœ¦ 3Ã— Mil-Spec â†’ 1Ã— Restricted &nbsp;|&nbsp; 3Ã— Restricted â†’ 1Ã— Classified<br>
          âœ¦ 3Ã— Classified â†’ 1Ã— Covert &nbsp;|&nbsp; 3Ã— Covert â†’ 1Ã— ðŸ”ª Knife!<br>
          âœ¦ Skins are consumed in the process. No insurance available.
        </div>
        <!-- Skin picker modal for forge -->
        <div id="forge-picker-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:3000;overflow-y:auto;padding:20px" onclick="if(event.target===this)closeForgePicker()">
          <div style="max-width:700px;margin:0 auto;background:var(--bg2);border-radius:16px;padding:20px">
            <div style="display:flex;justify-content:space-between;margin-bottom:14px">
              <div style="font-family:'Rajdhani',sans-serif;font-size:20px;font-weight:700">Select Skin for Forge</div>
              <button onclick="closeForgePicker()" style="background:none;color:var(--text2);font-size:22px;cursor:pointer">âœ•</button>
            </div>
            <div id="forge-picker-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:8px;max-height:400px;overflow-y:auto"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- CHICKEN GAME (ORIGINAL) -->
    <div class="page" id="page-chicken">
      <div class="page-header">
        <div class="page-title">ðŸ” Chicken Game</div>
        <div class="page-subtitle">You vs an AI. Both bet tokens each round. Escalate or chicken out. First to fold loses everything. Last one standing wins the pot!</div>
      </div>
      <div style="max-width:520px;margin:0 auto">
        <div class="card" style="text-align:center">
          <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:12px;align-items:center;margin-bottom:20px">
            <div style="background:var(--bg4);border-radius:12px;padding:12px">
              <div style="font-size:24px">ðŸ˜¤</div>
              <div style="font-size:12px;color:var(--text2);margin-top:4px">YOU</div>
              <div id="chicken-player-tokens" style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:700;color:var(--green)">0</div>
              <div id="chicken-player-in" style="font-size:10px;color:var(--text3)">In pot: 0</div>
            </div>
            <div>
              <div id="chicken-pot" style="font-family:'Rajdhani',sans-serif;font-size:26px;font-weight:700;color:var(--gold)">ðŸ† 0</div>
              <div style="font-size:10px;color:var(--text3)">POT</div>
              <div id="chicken-round-num" style="font-size:12px;color:var(--accent);margin-top:4px">Round 0</div>
            </div>
            <div style="background:var(--bg4);border-radius:12px;padding:12px">
              <div id="chicken-bot-emoji" style="font-size:24px">ðŸ¤–</div>
              <div id="chicken-bot-name" style="font-size:12px;color:var(--text2);margin-top:4px">BOT</div>
              <div id="chicken-bot-tokens" style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:700;color:var(--red)">0</div>
              <div id="chicken-bot-in" style="font-size:10px;color:var(--text3)">In pot: 0</div>
            </div>
          </div>
          <div id="chicken-log" style="background:var(--bg4);border-radius:8px;padding:10px;height:80px;overflow-y:auto;text-align:left;font-size:12px;color:var(--text2);margin-bottom:14px;font-family:'Barlow Condensed',sans-serif;line-height:1.6"></div>
          <div style="display:flex;gap:10px;align-items:center;justify-content:center;margin-bottom:14px;flex-wrap:wrap">
            <span style="font-size:13px;color:var(--text2)">Starting bet:</span>
            <input type="number" id="chicken-bet" value="100" min="50"
              style="width:90px;background:var(--bg4);border:1px solid var(--bg5);border-radius:6px;padding:6px;color:var(--text)">
            <select id="chicken-bot-difficulty" style="background:var(--bg4);border:1px solid var(--bg5);border-radius:6px;padding:6px;color:var(--text);font-size:13px">
              <option value="wimp">Wimp Bot (easy)</option>
              <option value="normal" selected>Normal Bot</option>
              <option value="maniac">Maniac Bot (hard)</option>
            </select>
          </div>
          <div style="display:flex;gap:10px;justify-content:center" id="chicken-buttons">
            <button class="btn btn-primary btn-lg" onclick="chickenStart()">ðŸ” Start Game</button>
          </div>
        </div>
      </div>
    </div>

    <!-- SCRATCH CARDS PAGE -->
    <div class="page" id="page-scratch">
      <div class="page-header">
        <div class="page-title">ðŸŽ« Scratch Cards</div>
        <div class="page-subtitle">Scratch to reveal prizes. Match 3 symbols to win big!</div>
      </div>
      <div style="max-width:600px;margin:0 auto">
        <div class="card" style="margin-bottom:14px">
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px">
            <span style="font-size:13px;color:var(--text2)">Card price:</span>
            <div style="display:flex;gap:6px">
              <button class="btn btn-secondary btn-sm scratch-tier-btn active" onclick="setScratchTier(50,'ðŸ¥ˆ',this)">$50 Silver</button>
              <button class="btn btn-secondary btn-sm scratch-tier-btn" onclick="setScratchTier(200,'ðŸ¥‡',this)">$200 Gold</button>
              <button class="btn btn-secondary btn-sm scratch-tier-btn" onclick="setScratchTier(1000,'ðŸ’Ž',this)">$1K Diamond</button>
            </div>
            <button class="btn btn-primary" onclick="buyScratchCard()" style="margin-left:auto">ðŸŽ« Buy Card ($<span id="scratch-price-display">50</span>)</button>
          </div>
          <div id="scratch-cards-area" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;min-height:100px">
            <div style="grid-column:1/-1;text-align:center;color:var(--text3);padding:30px;font-size:14px">Buy a scratch card to play!</div>
          </div>
        </div>
        <div class="card">
          <div class="section-title">Paytable</div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;font-size:12px">
            <div style="background:var(--bg4);padding:8px;border-radius:8px;text-align:center"><div style="font-size:20px">ðŸ’°ðŸ’°ðŸ’°</div><div style="color:var(--gold);font-weight:700">100Ã—</div></div>
            <div style="background:var(--bg4);padding:8px;border-radius:8px;text-align:center"><div style="font-size:20px">ðŸ”«ðŸ”«ðŸ”«</div><div style="color:var(--accent);font-weight:700">25Ã—</div></div>
            <div style="background:var(--bg4);padding:8px;border-radius:8px;text-align:center"><div style="font-size:20px">ðŸ’ŽðŸ’ŽðŸ’Ž</div><div style="color:#4b69ff;font-weight:700">15Ã—</div></div>
            <div style="background:var(--bg4);padding:8px;border-radius:8px;text-align:center"><div style="font-size:20px">â­â­â­</div><div style="color:var(--green);font-weight:700">8Ã—</div></div>
            <div style="background:var(--bg4);padding:8px;border-radius:8px;text-align:center"><div style="font-size:20px">ðŸŽ²ðŸŽ²ðŸŽ²</div><div style="color:var(--accent2);font-weight:700">4Ã—</div></div>
            <div style="background:var(--bg4);padding:8px;border-radius:8px;text-align:center"><div style="font-size:20px">Any 2 ðŸ’°</div><div style="color:var(--text2);font-weight:700">2Ã—</div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- DAILY STREAK PAGE -->
    <div class="page" id="page-streak">
      <div class="page-header">
        <div class="page-title">ðŸ”¥ Daily Streak</div>
        <div class="page-subtitle">Log in every day to build your streak and earn bigger rewards!</div>
      </div>
      <div style="max-width:600px;margin:0 auto">
        <div class="card" style="text-align:center;margin-bottom:14px">
          <div style="font-size:64px;margin-bottom:8px" id="streak-emoji-display">ðŸ”¥</div>
          <div style="font-family:'Rajdhani',sans-serif;font-size:48px;font-weight:700;color:var(--accent)" id="streak-count-display">0</div>
          <div style="font-size:13px;color:var(--text2)">Day Streak</div>
          <div id="streak-claim-area" style="margin-top:16px"></div>
        </div>
        <div class="card">
          <div class="section-title">Streak Milestones</div>
          <div id="streak-milestones" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin-top:8px"></div>
        </div>
      </div>
    </div>

    <!-- MYSTERY CRATE PAGE -->
    <div class="page" id="page-mystery">
      <div class="page-header">
        <div class="page-title">ðŸŽ Mystery Crate</div>
        <div class="page-subtitle">Pay once â€” get a random bundle of skins, cash, tokens, or rare items. What's inside?</div>
      </div>
      <div style="max-width:700px;margin:0 auto">
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:14px;margin-bottom:20px" id="crate-tiers">
          <!-- Filled by JS -->
        </div>
        <div class="card" id="crate-reveal-area" style="text-align:center;min-height:120px;display:flex;align-items:center;justify-content:center">
          <div style="color:var(--text3);font-size:14px">Buy a crate to see what you get!</div>
        </div>
        <div class="card" style="margin-top:14px">
          <div class="section-title">Possible Contents</div>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;font-size:12px;margin-top:8px">
            <div style="background:var(--bg4);padding:8px;border-radius:8px;text-align:center"><div style="font-size:18px">ðŸ”«</div><div style="color:var(--text2)">2â€“5 Skins</div></div>
            <div style="background:var(--bg4);padding:8px;border-radius:8px;text-align:center"><div style="font-size:18px">ðŸ’°</div><div style="color:var(--text2)">Cash Bundle</div></div>
            <div style="background:var(--bg4);padding:8px;border-radius:8px;text-align:center"><div style="font-size:18px">ðŸ”µ</div><div style="color:var(--text2)">Token Stack</div></div>
            <div style="background:var(--bg4);padding:8px;border-radius:8px;text-align:center"><div style="font-size:18px">ðŸ”ª</div><div style="color:var(--knife)">Rare Knife (0.5%)</div></div>
            <div style="background:var(--bg4);padding:8px;border-radius:8px;text-align:center"><div style="font-size:18px">â­</div><div style="color:var(--gold)">XP Bomb</div></div>
            <div style="background:var(--bg4);padding:8px;border-radius:8px;text-align:center"><div style="font-size:18px">ðŸ’Ž</div><div style="color:var(--classified)">Multiplier Token</div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- WAGER WARS PAGE -->
    <div class="page" id="page-wagerwars">
      <div class="page-header">
        <div class="page-title">âš¡ Wager Wars</div>
        <div class="page-subtitle">Timed challenges â€” wager as much as possible before the clock runs out. Top wagerers win bonus prizes!</div>
      </div>
      <div style="max-width:640px;margin:0 auto">
        <div class="card" style="text-align:center;margin-bottom:14px">
          <div id="ww-event-banner" style="margin-bottom:14px">
            <div style="font-size:12px;color:var(--text3);letter-spacing:1px;margin-bottom:6px">CURRENT CHALLENGE</div>
            <div style="font-family:'Rajdhani',sans-serif;font-size:22px;font-weight:700;color:var(--gold)" id="ww-title">No active challenge</div>
            <div style="font-size:13px;color:var(--text2);margin:6px 0" id="ww-desc">Check back soon for a new challenge</div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:14px">
            <div style="background:var(--bg4);padding:10px;border-radius:8px">
              <div style="font-size:11px;color:var(--text3)">TIME LEFT</div>
              <div style="font-family:'Barlow Condensed',sans-serif;font-size:24px;font-weight:700;color:var(--red)" id="ww-timer">--:--</div>
            </div>
            <div style="background:var(--bg4);padding:10px;border-radius:8px">
              <div style="font-size:11px;color:var(--text3)">YOUR WAGER</div>
              <div style="font-family:'Barlow Condensed',sans-serif;font-size:24px;font-weight:700;color:var(--accent)" id="ww-my-wager">$0</div>
            </div>
            <div style="background:var(--bg4);padding:10px;border-radius:8px">
              <div style="font-size:11px;color:var(--text3)">PRIZE POOL</div>
              <div style="font-family:'Barlow Condensed',sans-serif;font-size:24px;font-weight:700;color:var(--green)" id="ww-prize">$0</div>
            </div>
          </div>
          <button class="btn btn-primary btn-lg" onclick="joinWagerWar()" id="ww-join-btn">âš¡ Join Challenge</button>
        </div>
        <div class="card">
          <div class="section-title">ðŸ† Leaderboard (This Round)</div>
          <div id="ww-leaderboard" style="margin-top:8px"></div>
        </div>
        <div class="card" style="margin-top:14px">
          <div class="section-title">Previous Winners</div>
          <div id="ww-history" style="font-size:13px;color:var(--text2)">No history yet.</div>
        </div>
      </div>
    </div>

    <!-- COLLECTION BOOK PAGE -->
    <div class="page" id="page-collection">
      <div class="page-header">
        <div class="page-title">ðŸ“– Collection Book</div>
        <div class="page-subtitle">Track every unique skin you've ever owned. Complete sets to earn bonus rewards!</div>
      </div>
      <div style="max-width:800px;margin:0 auto">
        <div class="card" style="margin-bottom:14px">
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;text-align:center">
            <div><div style="font-family:'Barlow Condensed',sans-serif;font-size:32px;font-weight:700;color:var(--accent)" id="col-unique">0</div><div style="font-size:11px;color:var(--text3)">UNIQUE SKINS</div></div>
            <div><div style="font-family:'Barlow Condensed',sans-serif;font-size:32px;font-weight:700;color:var(--green)" id="col-pct">0%</div><div style="font-size:11px;color:var(--text3)">COMPLETION</div></div>
            <div><div style="font-family:'Barlow Condensed',sans-serif;font-size:32px;font-weight:700;color:var(--gold)" id="col-sets">0/0</div><div style="font-size:11px;color:var(--text3)">SETS COMPLETE</div></div>
          </div>
          <div style="background:var(--bg4);border-radius:6px;height:8px;margin-top:12px;overflow:hidden">
            <div id="col-progress-bar" style="height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:6px;transition:width .5s;width:0%"></div>
          </div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px" id="col-rarity-filters">
          <button class="btn btn-secondary btn-sm col-filter active" onclick="filterCollection('all',this)">All</button>
          <button class="btn btn-secondary btn-sm col-filter" onclick="filterCollection('consumer',this)" style="color:var(--consumer)">Consumer</button>
          <button class="btn btn-secondary btn-sm col-filter" onclick="filterCollection('industrial',this)" style="color:var(--industrial)">Industrial</button>
          <button class="btn btn-secondary btn-sm col-filter" onclick="filterCollection('milspec',this)" style="color:var(--milspec)">Mil-Spec</button>
          <button class="btn btn-secondary btn-sm col-filter" onclick="filterCollection('restricted',this)" style="color:var(--restricted)">Restricted</button>
          <button class="btn btn-secondary btn-sm col-filter" onclick="filterCollection('classified',this)" style="color:var(--classified)">Classified</button>
          <button class="btn btn-secondary btn-sm col-filter" onclick="filterCollection('covert',this)" style="color:var(--covert)">Covert</button>
          <button class="btn btn-secondary btn-sm col-filter" onclick="filterCollection('knife',this)" style="color:var(--knife)">Knife â˜…</button>
        </div>
        <div id="collection-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px"></div>
      </div>
    </div>

    <!-- CASE BATTLES PAGE -->
    <div class="page" id="page-battles">
      <div class="page-header">
        <div class="page-title">âš”ï¸ Case Battles</div>
        <div class="page-subtitle">Battle other players â€” highest skin wins everything!</div>
      </div>
      <div class="card mb-2">
        <div class="section-title">Create Battle</div>
        <div class="flex gap-2 flex-wrap mb-2">
          <select id="battle-case-select" style="background:var(--bg4);border:1px solid var(--bg5);border-radius:8px;padding:8px 12px;color:var(--text);flex:1">
          </select>
          <select id="battle-mode" style="background:var(--bg4);border:1px solid var(--bg5);border-radius:8px;padding:8px 12px;color:var(--text)">
            <option value="1v1">1v1</option>
            <option value="2v2">2v2</option>
            <option value="ffa4">FFA (4 players)</option>
          </select>
          <select id="battle-rounds" style="background:var(--bg4);border:1px solid var(--bg5);border-radius:8px;padding:8px 12px;color:var(--text)">
            <option value="1">1 Case</option>
            <option value="3" selected>3 Cases</option>
            <option value="5">5 Cases</option>
          </select>
          <button class="btn btn-primary" onclick="startBattle()">âš”ï¸ Start Battle</button>
        </div>
      </div>
      <div id="battle-result-wrap" class="battle-result-wrap"></div>
      <div class="section-title">Active Battles</div>
      <div id="battle-list" class="grid g2 gap-2"></div>
    </div>

    <!-- JACKPOT PAGE -->
    <div class="page" id="page-jackpot">
      <div class="page-header">
        <div class="page-title">ðŸ’° Jackpot</div>
        <div class="page-subtitle">Enter cash â€” random winner takes the pot!</div>
      </div>
      <div class="jackpot-pot">
        <div style="font-size:12px;color:var(--text2);letter-spacing:1px;margin-bottom:4px">CURRENT POT</div>
        <div class="jackpot-total" id="jp-total">$0.00</div>
        <div style="font-size:12px;color:var(--text2);margin-top:4px" id="jp-players-count">0 players</div>
      </div>
      <div class="jackpot-wheel" id="jp-wheel-wrap" style="display:none">
        <div class="jackpot-strip" id="jp-strip"></div>
      </div>
      <div class="flex gap-2 items-center mb-2">
        <input type="number" id="jp-bet-input" value="50" min="1" style="flex:1;background:var(--bg4);border:1px solid var(--bg5);border-radius:8px;padding:10px 14px;color:var(--text);font-size:14px">
        <button class="btn btn-primary" onclick="jpEnter()">Enter Jackpot</button>
        <button class="btn btn-secondary" id="jp-spin-btn" onclick="jpSpin()">ðŸŽ° Spin</button>
      </div>
      <div id="jp-result" style="text-align:center;font-family:'Rajdhani',sans-serif;font-size:24px;font-weight:700;min-height:28px;margin-bottom:12px"></div>
      <div class="section-title">Entries</div>
      <div class="jackpot-entries" id="jp-entries"></div>
    </div>

    <!-- TRADE-UP PAGE -->
    <div class="page" id="page-tradeup">
      <div class="page-header">
        <div class="page-title">ðŸ”„ Trade-Up Contract</div>
        <div class="page-subtitle">Combine 10 skins of the same rarity for a chance at higher tier!</div>
      </div>
      <div class="card">
        <div class="section-title">Select 10 Skins</div>
        <div class="tradeup-grid" id="tradeup-grid"></div>
        <div style="text-align:center;margin-top:16px">
          <div id="tradeup-info" style="color:var(--text2);font-size:13px;margin-bottom:12px">Select 10 skins of the same rarity to proceed</div>
          <button class="btn btn-primary btn-lg" onclick="doTradeup()">ðŸ”„ Execute Trade-Up</button>
        </div>
      </div>
      <div id="tradeup-result" style="text-align:center;margin-top:16px;font-family:'Rajdhani',sans-serif;font-size:24px;font-weight:700;min-height:28px"></div>
    </div>

    <!-- INVENTORY PAGE -->
    <div class="page" id="page-inventory">
      <div class="page-header">
        <div class="page-title">ðŸŽ’ Inventory</div>
        <div class="page-subtitle">All your skins â€” filter, sort, favorite, and sell!</div>
      </div>
      <div class="inventory-filters" id="inv-filters">
        <button class="filter-btn active" onclick="invFilter('all')">All</button>
        <button class="filter-btn" onclick="invFilter('consumer')" style="color:var(--consumer)">Consumer</button>
        <button class="filter-btn" onclick="invFilter('industrial')" style="color:var(--industrial)">Industrial</button>
        <button class="filter-btn" onclick="invFilter('milspec')" style="color:var(--milspec)">Mil-Spec</button>
        <button class="filter-btn" onclick="invFilter('restricted')" style="color:var(--restricted)">Restricted</button>
        <button class="filter-btn" onclick="invFilter('classified')" style="color:var(--classified)">Classified</button>
        <button class="filter-btn" onclick="invFilter('covert')" style="color:var(--covert)">Covert</button>
        <button class="filter-btn" onclick="invFilter('knife')" style="color:var(--knife)">â˜… Knife/Rare</button>
        <button class="filter-btn" onclick="invFilter('favorites')" style="color:var(--gold)">â­ Favorites</button>
        <select id="inv-sort" onchange="invSort(this.value)" style="margin-left:auto;background:var(--bg4);border:1px solid var(--bg5);border-radius:6px;padding:5px 10px;color:var(--text);font-size:12px">
          <option value="date">Newest</option>
          <option value="price-h">Price â†“</option>
          <option value="price-l">Price â†‘</option>
          <option value="rarity">Rarity</option>
        </select>
      </div>
      <div style="margin-bottom:12px;display:flex;justify-content:space-between;align-items:center">
        <div style="font-size:13px;color:var(--text2)">Total value: <span style="color:var(--accent);font-weight:700;font-family:'Barlow Condensed',sans-serif" id="inv-total-val">$0.00</span></div>
        <button class="btn btn-red btn-sm" onclick="sellAll()">Sell All</button>
      </div>
      <div class="inv-grid" id="inventory-grid"></div>
    </div>

    <!-- BANK PAGE -->
    <div class="page" id="page-bank">
      <div class="page-header">
        <div class="page-title">ðŸ¦ Bank</div>
        <div class="page-subtitle">Store money, earn interest, and manage loans</div>
      </div>
      <div class="bank-vault">
        <div style="font-size:11px;color:#d4a300;letter-spacing:1px;margin-bottom:4px">VAULT BALANCE</div>
        <div class="vault-total" id="bank-total">$0.00</div>
        <div style="color:#d4a30080;font-size:12px;margin-top:4px">Interest: 2% daily | Loan Rate: 10% daily</div>
      </div>
      <div class="grid g2 gap-2 mb-2">
        <div class="card">
          <div style="font-size:13px;color:var(--text2);margin-bottom:8px">ðŸ’° Deposit</div>
          <div class="flex gap-2">
            <input type="number" id="deposit-amount" placeholder="Amount" style="flex:1;background:var(--bg4);border:1px solid var(--bg5);border-radius:6px;padding:8px;color:var(--text)">
            <button class="btn btn-green" onclick="bankDeposit()">Deposit</button>
          </div>
        </div>
        <div class="card">
          <div style="font-size:13px;color:var(--text2);margin-bottom:8px">ðŸ’¸ Withdraw</div>
          <div class="flex gap-2">
            <input type="number" id="withdraw-amount" placeholder="Amount" style="flex:1;background:var(--bg4);border:1px solid var(--bg5);border-radius:6px;padding:8px;color:var(--text)">
            <button class="btn btn-red" onclick="bankWithdraw()">Withdraw</button>
          </div>
        </div>
      </div>
      <div class="card mb-2">
        <div style="font-size:13px;color:var(--text2);margin-bottom:4px">âš ï¸ Loan (High Risk â€” 10% daily interest)</div>
        <div id="loan-limit-display" style="font-size:12px;color:var(--accent);margin-bottom:8px">Loading...</div>
        <div style="font-size:11px;color:var(--red);margin-bottom:8px">â±ï¸ If unpaid for 1 hour, skins will be seized as collateral!</div>
        <div class="flex gap-2 flex-wrap">
          <input type="number" id="loan-amount" placeholder="Loan amount" style="flex:1;min-width:120px;background:var(--bg4);border:1px solid var(--bg5);border-radius:6px;padding:8px;color:var(--text)">
          <button class="btn btn-secondary" onclick="takeLoan()">Take Loan</button>
          <button class="btn btn-red" onclick="repayLoan()">Repay Loan</button>
        </div>
        <div style="margin-top:8px;font-size:12px;color:var(--text3)">Outstanding loan: <span id="loan-display" style="color:var(--red);font-weight:700">$0.00</span></div>
      </div>
      <div class="section-title">ðŸ¦ Locked Skins</div>
      <div id="bank-skins" class="inv-grid"></div>
    </div>

    <!-- MARKETPLACE PAGE -->
    <div class="page" id="page-market">
      <div class="page-header">
        <div class="page-title">ðŸª Marketplace</div>
        <div class="page-subtitle">Buy and sell skins with dynamic pricing</div>
      </div>
      <div class="market-chart-wrap">
        <div style="font-size:13px;color:var(--text2);margin-bottom:8px">ðŸ“ˆ Market Trend</div>
        <canvas id="market-canvas" width="600" height="100" style="width:100%;display:block"></canvas>
      </div>
      <div class="flex gap-2 mb-2">
        <input type="text" id="market-search" placeholder="ðŸ” Search skins..." onkeyup="renderMarket()" style="flex:1;background:var(--bg4);border:1px solid var(--bg5);border-radius:8px;padding:9px 14px;color:var(--text);font-size:13px">
        <select id="market-sort" onchange="renderMarket()" style="background:var(--bg4);border:1px solid var(--bg5);border-radius:8px;padding:9px;color:var(--text)">
          <option value="popular">Popular</option>
          <option value="price-h">Price â†“</option>
          <option value="price-l">Price â†‘</option>
        </select>
      </div>
      <div id="market-list" style="display:flex;flex-direction:column;gap:8px"></div>
    </div>

    <!-- PROFILE PAGE -->
    <div class="page" id="page-profile">
      <div class="page-header">
        <div class="page-title">ðŸ‘¤ Profile</div>
      </div>
      <div class="profile-card">
        <div class="profile-avatar-lg" id="profile-avatar">?</div>
        <div style="flex:1">
          <div style="font-family:'Rajdhani',sans-serif;font-size:26px;font-weight:700" id="profile-name">Username</div>
          <div class="rank-badge" id="profile-rank-badge" style="background:rgba(107,107,255,.15);color:var(--milspec)">ðŸ… Silver I</div>
          <div style="margin-top:8px;font-size:13px;color:var(--text2)">Member since: <span id="profile-since" style="color:var(--text)">Today</span></div>
          <div style="margin-top:4px;font-size:13px;color:var(--text2)">Rebirths: <span id="profile-rebirths" style="color:var(--accent2)">0</span></div>
        </div>
      </div>
      <div class="card mb-2">
        <div class="section-title">Level Progress</div>
        <div class="flex justify-between items-center mb-1">
          <div style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:700;color:var(--accent3)" id="profile-level">Level 1</div>
          <div style="font-size:13px;color:var(--text2)" id="profile-xp-text">0 / 100 XP</div>
        </div>
        <div class="xp-bar" style="height:8px"><div class="xp-fill" id="profile-xp-bar" style="width:0%"></div></div>
      </div>
      <div class="section-title">ðŸ† Achievements</div>
      <div id="achievements-grid" class="grid g2 gap-2"></div>
    </div>

    <!-- MISSIONS PAGE -->
    <div class="page" id="page-missions">
      <div class="page-header">
        <div class="page-title">ðŸ“‹ Missions & Achievements</div>
      </div>
      <div class="section-title">Daily Missions</div>
      <div id="daily-missions"></div>
      <div class="section-title mt-2">Weekly Missions</div>
      <div id="weekly-missions"></div>
    </div>

    <!-- BATTLE PASS PAGE -->
    <div class="page" id="page-battlepass">
      <div class="page-header">
        <div class="page-title">ðŸŽ« Battle Pass</div>
        <div class="page-subtitle">Free and Premium tiers â€” earn XP to unlock rewards</div>
      </div>
      <div class="card mb-2">
        <div class="flex justify-between items-center mb-1">
          <div>
            <div style="font-size:12px;color:var(--text2);letter-spacing:1px">BATTLE PASS LEVEL</div>
            <div style="font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:700;color:var(--accent)" id="bp-level-display">1</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:12px;color:var(--text2)">XP Progress</div>
            <div style="font-family:'Barlow Condensed',sans-serif;font-size:16px;color:var(--text)" id="bp-xp-display">0 / 500</div>
          </div>
        </div>
        <div class="bp-xp-bar"><div class="bp-xp-fill" id="bp-xp-bar" style="width:0%"></div></div>
      </div>
      <div class="bp-track" id="bp-track"></div>
      <div id="premium-upgrade" style="text-align:center;margin-top:16px">
        <button class="btn btn-primary btn-lg" onclick="upgradeToPremium()">â­ Upgrade to Premium â€” $9.99</button>
        <div style="font-size:12px;color:var(--text2);margin-top:6px">(Simulated â€” free in this game!)</div>
      </div>
    </div>

    <!-- STATS PAGE -->
    <div class="page" id="page-stats">
      <div class="page-header">
        <div class="page-title">ðŸ“Š Statistics</div>
      </div>
      <div class="stat-cards" id="stat-cards"></div>
      <div class="profit-chart">
        <div class="section-title">Net Worth Over Time</div>
        <canvas id="stats-canvas" height="150"></canvas>
      </div>
      <div class="section-title">ðŸ“œ Recent Activity</div>
      <div class="history-panel" id="stats-history"></div>
    </div>

    <!-- LEADERBOARD PAGE -->
    <div class="page" id="page-leaderboard">
      <div class="page-header">
        <div class="page-title">ðŸ† Leaderboard</div>
      </div>
      <div class="flex gap-2 mb-2">
        <button class="filter-btn active" onclick="showLB('wealth')">Wealthiest</button>
        <button class="filter-btn" onclick="showLB('opens')">Most Opens</button>
        <button class="filter-btn" onclick="showLB('wins')">Casino Wins</button>
      </div>
      <div id="leaderboard-list"></div>
    </div>

    <!-- SETTINGS PAGE -->
    <div class="page" id="page-settings">
      <div class="page-header">
        <div class="page-title">âš™ï¸ Settings</div>
      </div>
      <div class="card mb-2">
        <div class="section-title">Sound</div>
        <div class="flex items-center gap-3 mb-1">
          <span style="font-size:13px">Sound Effects</span>
          <label style="position:relative;display:inline-block;width:44px;height:24px;flex-shrink:0">
            <input type="checkbox" id="sfx-toggle" checked onchange="toggleSFX()" style="opacity:0;width:0;height:0">
            <span style="position:absolute;cursor:pointer;inset:0;background:var(--bg5);border-radius:24px;transition:.3s"></span>
            <span id="sfx-knob" style="position:absolute;content:'';height:18px;width:18px;left:3px;bottom:3px;background:var(--accent);border-radius:50%;transition:.3s;transform:translateX(0)"></span>
          </label>
        </div>
      </div>
      <div class="card mb-2">
        <div class="section-title">Display</div>
        <div class="flex gap-2 mb-1">
          <button class="btn btn-secondary" onclick="setTheme('dark')" id="theme-dark">ðŸŒ™ Dark</button>
          <button class="btn btn-secondary" onclick="setTheme('light')" id="theme-light">â˜€ï¸ Light</button>
        </div>
      </div>
      <div class="card">
        <div class="section-title">Account</div>
        <div style="font-size:13px;color:var(--text2);margin-bottom:8px">Reset all data (can't undo!)</div>
        <button class="btn btn-red" onclick="resetAllData()">ðŸ—‘ï¸ Reset Account</button>
      </div>
      <div class="card mt-2">
        <div class="section-title">ðŸ’¾ Save Data</div>
        <div style="font-size:13px;color:var(--text2);margin-bottom:10px">Export your save or import a backup</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-secondary" onclick="exportSave()">ðŸ“¤ Export Save</button>
          <button class="btn btn-secondary" onclick="importSave()">ðŸ“¥ Import Save</button>
        </div>
      </div>
    </div>

    <!-- SHOP PAGE -->
    <div class="page" id="page-shop">
      <div class="page-header">
        <div class="page-title">ðŸ›ï¸ Cosmetic Shop</div>
        <div class="page-subtitle">Unlock unique themes, titles, and avatars</div>
      </div>
      <div style="background:var(--bg3);border-radius:12px;padding:12px 18px;display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <div style="font-size:13px;color:var(--text2)">Your Shop Coins</div>
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:24px;font-weight:700;color:var(--gold)" id="shop-coins">0 ðŸª™</div>
      </div>
      <div style="font-size:12px;color:var(--text3);margin-bottom:12px">ðŸ’¡ Earn shop coins by winning casino streaks and completing challenges!</div>
      <div class="section-title">ðŸŽ¨ UI Themes</div>
      <div class="grid g3 gap-2 mb-2" id="shop-themes" style="margin-top:8px"></div>
      <div class="section-title">ðŸ“› Titles</div>
      <div style="display:flex;flex-direction:column;gap:6px;margin-top:8px;margin-bottom:16px" id="shop-titles"></div>
      <div class="section-title">ðŸ‘¤ Avatar Icons</div>
      <div class="grid g5 gap-2" id="shop-avatars" style="margin-top:8px"></div>
    </div>

    <!-- TOKENS PAGE -->
    <div class="page" id="page-tokens">
      <div class="page-header">
        <div class="page-title">ðŸ”µ Casino Tokens</div>
        <div class="page-subtitle">1 Token = $0.01 cash. Use tokens for all casino games.</div>
      </div>
      <div class="card mb-2" style="text-align:center">
        <div style="font-size:12px;color:var(--text2);letter-spacing:1px">YOUR TOKENS</div>
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:48px;font-weight:700;color:var(--accent3)" id="token-big-display">0</div>
        <div style="font-size:12px;color:var(--text3)">â‰ˆ $<span id="token-usd-val">0.00</span> USD</div>
      </div>
      <div class="grid g2 gap-2 mb-2">
        <div class="card">
          <div class="section-title">ðŸ’µ Buy Tokens</div>
          <div style="font-size:12px;color:var(--text2);margin-bottom:8px">$0.01 per token</div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px">
            <button class="btn btn-secondary btn-sm" onclick="quickBuyTokens(100)">100 (ðŸ’µ$1)</button>
            <button class="btn btn-secondary btn-sm" onclick="quickBuyTokens(500)">500 (ðŸ’µ$5)</button>
            <button class="btn btn-secondary btn-sm" onclick="quickBuyTokens(1000)">1K (ðŸ’µ$10)</button>
            <button class="btn btn-primary btn-sm" onclick="quickBuyTokens(5000)">5K (ðŸ’µ$50)</button>
          </div>
          <div style="display:flex;gap:8px">
            <input type="number" id="buy-token-amount" value="100" min="1" style="background:var(--bg4);border:1px solid var(--bg5);border-radius:6px;padding:6px 10px;color:var(--text);width:100px">
            <button class="btn btn-primary" onclick="buyTokens()">Buy Tokens</button>
          </div>
        </div>
        <div class="card">
          <div class="section-title">ðŸ’° Convert Tokens</div>
          <div style="font-size:12px;color:var(--text2);margin-bottom:8px">Cash out or get skins</div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:10px">
            <label style="display:flex;align-items:center;gap:6px;font-size:12px"><input type="radio" name="token-convert" value="cash" checked> Cash <span style="color:var(--red)">(25% fee â€” 1000 tokens = $7.50)</span></label>
            <label style="display:flex;align-items:center;gap:6px;font-size:12px"><input type="radio" name="token-convert" value="skin"> Skin <span style="color:var(--green)">(10% fee â€” 1000 tokens â‰ˆ $9 skin)</span></label>
          </div>
          <div style="display:flex;gap:8px">
            <input type="number" id="sell-token-amount" value="100" min="1" style="background:var(--bg4);border:1px solid var(--bg5);border-radius:6px;padding:6px 10px;color:var(--text);width:100px">
            <button class="btn btn-green" onclick="sellTokens()">Convert</button>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="section-title">ðŸ“Š Token Info</div>
        <div style="font-size:13px;color:var(--text2);line-height:1.8">
          â€¢ Buy tokens: $0.01 per token (100 tokens = $1)<br>
          â€¢ Cash out: <b style="color:var(--red)">25% house fee</b> â€” 1000 tokens â†’ $7.50<br>
          â€¢ Skin convert: <b style="color:var(--green)">10% fee</b> â€” 1000 tokens â†’ ~$9 skin<br>
          â€¢ Win streaks give bonus token multipliers (up to 1.5Ã—)<br>
          â€¢ Shop coins earned through casino streaks (1 per streak level)
        </div>
      </div>
    </div>

    <!-- DICE GAME PAGE -->
    <div class="page" id="page-dice">
      <div class="page-header">
        <div class="page-title">ðŸŽ² Dice â€” Under/Over</div>
        <div class="page-subtitle">Set your target number and predict under or over. Payout adjusts to risk!</div>
      </div>
      <div class="card" style="max-width:520px;margin:0 auto">
        <div style="font-size:13px;color:var(--accent3);margin-bottom:12px;text-align:center">Your Tokens: <span class="token-balance">0</span></div>
        <!-- Rolled result display -->
        <div style="text-align:center;margin-bottom:20px">
          <div id="dice-roll-display" style="font-family:'Rajdhani',sans-serif;font-size:88px;font-weight:700;color:var(--text3);line-height:1;transition:color .3s">â€”</div>
          <div id="dice-result-text" style="font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:700;min-height:24px;margin-top:4px"></div>
        </div>
        <!-- Target slider -->
        <div style="margin-bottom:16px">
          <div style="display:flex;justify-content:space-between;margin-bottom:6px;font-size:12px;color:var(--text2)">
            <span>Target Number</span>
            <span id="dice-target-val" style="color:var(--accent);font-weight:700;font-size:16px">50</span>
          </div>
          <input type="range" id="dice-target" min="2" max="98" value="50" oninput="updateDiceOdds()"
            style="width:100%;accent-color:var(--accent)">
          <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text3);margin-top:2px">
            <span>2 (Risky)</span><span>50 (Even)</span><span>98 (Safe)</span>
          </div>
        </div>
        <!-- Under/Over choice -->
        <div style="display:flex;gap:10px;margin-bottom:16px">
          <div id="dice-under-info" onclick="selectDiceSide('under')"
            style="flex:1;background:var(--bg4);border:2px solid var(--bg5);border-radius:10px;padding:12px;text-align:center;cursor:pointer;transition:.2s">
            <div style="font-size:11px;color:var(--text3);margin-bottom:2px">ROLL UNDER</div>
            <div id="dice-under-num" style="font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:700;color:var(--accent2)">49</div>
            <div id="dice-under-mult" style="font-size:13px;color:var(--green)">2.02Ã—</div>
          </div>
          <div style="display:flex;align-items:center;padding:0 6px;color:var(--text3);font-weight:700">OR</div>
          <div id="dice-over-info" onclick="selectDiceSide('over')"
            style="flex:1;background:var(--bg4);border:2px solid var(--bg5);border-radius:10px;padding:12px;text-align:center;cursor:pointer;transition:.2s">
            <div style="font-size:11px;color:var(--text3);margin-bottom:2px">ROLL OVER</div>
            <div id="dice-over-num" style="font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:700;color:var(--accent3)">51</div>
            <div id="dice-over-mult" style="font-size:13px;color:var(--green)">2.02Ã—</div>
          </div>
        </div>
        <!-- Win chance display -->
        <div style="background:var(--bg4);border-radius:8px;padding:8px 12px;margin-bottom:16px;display:flex;justify-content:space-between;font-size:12px">
          <div>Win Chance: <b id="dice-win-pct" style="color:var(--accent)">49.00%</b></div>
          <div>Multiplier: <b id="dice-mult-display" style="color:var(--green)">2.02Ã—</b></div>
          <div>House Edge: <b style="color:var(--red)">2%</b></div>
        </div>
        <!-- Bet + Roll -->
        <div style="display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap">
          <div style="display:flex;gap:6px;align-items:center">
            <span style="font-size:13px;color:var(--text2)">Bet:</span>
            <input type="number" id="dice-bet" value="100" min="1" style="width:90px;background:var(--bg3);border:1px solid var(--bg5);border-radius:6px;padding:6px 10px;color:var(--text)">
            <span style="font-size:11px;color:var(--text3)">tokens</span>
          </div>
          <button class="btn btn-secondary btn-sm" onclick="setBet('dice-bet',0.5)">Â½</button>
          <button class="btn btn-secondary btn-sm" onclick="setBet('dice-bet',2)">2Ã—</button>
          <button class="btn btn-primary btn-lg" onclick="rollDice()" id="dice-roll-btn">ðŸŽ² Roll</button>
        </div>
        <div style="margin-top:12px;background:var(--bg4);border-radius:8px;padding:10px 12px;font-size:11px;color:var(--text3)">
          âœ¦ Move slider right for safer bets (lower payout) or left for risky bets (higher payout)<br>
          âœ¦ Win chance formula: target/100 for under, (100-target)/100 for over
        </div>
      </div>
    </div>

    <!-- ADMIN PAGE -->
    <div class="page" id="page-admin"></div>

    <!-- SKIN UPGRADE PAGE -->
    <div class="page" id="page-upgrade">
      <div class="page-header"><div class="page-title">â¬†ï¸ Skin Upgrade</div><div class="page-subtitle">Risk your skin for a chance to move it to a higher rarity tier.</div></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;max-width:700px;margin:0 auto">
        <div class="card">
          <div class="section-title">Select Skin to Upgrade</div>
          <div id="upgrade-skin-list" style="max-height:340px;overflow-y:auto;margin-top:10px"></div>
        </div>
        <div class="card">
          <div class="section-title">Upgrade Settings</div>
          <div id="upgrade-selected" style="background:var(--bg4);border-radius:8px;padding:12px;text-align:center;margin:12px 0;min-height:70px;display:flex;align-items:center;justify-content:center;color:var(--text3);font-size:13px">No skin selected</div>
          <div style="margin-bottom:14px">
            <div style="display:flex;justify-content:space-between;margin-bottom:4px;font-size:12px"><span style="color:var(--text2)">Success Chance</span><span id="upgrade-pct-label" style="color:var(--accent);font-weight:700">50%</span></div>
            <input type="range" id="upgrade-slider" min="10" max="90" value="50" oninput="updateUpgradeUI()" style="width:100%;accent-color:var(--accent)">
            <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text3)"><span>10% (High Risk)</span><span>90% (Safe)</span></div>
          </div>
          <div style="background:var(--bg4);border-radius:8px;padding:8px 12px;margin-bottom:10px;font-size:12px">
            <div style="display:flex;justify-content:space-between;margin-bottom:3px"><span style="color:var(--text2)">On Success:</span><span id="upgrade-success-label" style="color:var(--green);font-weight:700">â†’ Next Rarity</span></div>
            <div style="display:flex;justify-content:space-between"><span style="color:var(--text2)">On Failure:</span><span style="color:var(--red);font-weight:700">Skin Destroyed ðŸ’¥</span></div>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-primary w-full" onclick="attemptUpgrade()">â¬†ï¸ Upgrade!</button>
            <button class="btn btn-secondary" onclick="toggleInsurance()" id="insurance-btn">ðŸ›¡ï¸ Insure OFF</button>
          </div>
          <div id="upgrade-result" style="margin-top:10px;text-align:center;font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:700;min-height:22px"></div>
          <div style="margin-top:6px;font-size:11px;color:var(--text3)">ðŸ›¡ï¸ Insurance: Pay 20% of skin value. On failure, recover 50% back.</div>
        </div>
      </div>
    </div>

    <!-- BOSS FIGHT PAGE -->
    <div class="page" id="page-boss">
      <div class="page-header"><div class="page-title">ðŸ‘¹ Boss Fight</div><div class="page-subtitle">Your skin collection's total value determines your attack power. Better skins = stronger hits!</div></div>
      <div style="max-width:600px;margin:0 auto">
        <div class="card" style="text-align:center">
          <div id="boss-name" style="font-family:'Rajdhani',sans-serif;font-size:26px;font-weight:700;color:var(--red)">The Shadow Lord</div>
          <div id="boss-tier-label" style="font-size:11px;color:var(--text3);margin-bottom:10px">Tier I Boss</div>
          <div style="position:relative;background:var(--bg4);border-radius:8px;height:24px;margin-bottom:6px;overflow:hidden">
            <div id="boss-hp-bar" style="height:100%;background:linear-gradient(90deg,#e74c3c,#ff6b35);transition:.4s;width:100%"></div>
            <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700" id="boss-hp-text">10,000 / 10,000</div>
          </div>
          <div id="boss-sprite" style="font-size:64px;margin:12px 0;line-height:1;filter:drop-shadow(0 0 16px rgba(235,75,75,.5));transition:transform .2s">ðŸ‘¹</div>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
            <div style="background:var(--bg4);border-radius:8px;padding:8px"><div style="font-size:10px;color:var(--text3)">YOUR POWER</div><div id="player-power" style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:700;color:var(--green)">0</div></div>
            <div style="background:var(--bg4);border-radius:8px;padding:8px"><div style="font-size:10px;color:var(--text3)">YOUR HP</div><div id="player-hp-label" style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:700;color:var(--accent3)">100</div></div>
            <div style="background:var(--bg4);border-radius:8px;padding:8px"><div style="font-size:10px;color:var(--text3)">BOSS ATK</div><div id="boss-atk" style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:700;color:var(--red)">0</div></div>
          </div>
          <div id="boss-log" style="background:var(--bg3);border-radius:8px;padding:8px;max-height:100px;overflow-y:auto;text-align:left;font-size:12px;color:var(--text2);margin-bottom:12px;font-family:'Barlow Condensed',sans-serif;line-height:1.5"></div>
          <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
            <button class="btn btn-red btn-lg" onclick="bossAttack()">âš”ï¸ Attack</button>
            <button class="btn btn-secondary" onclick="bossSpecial()">âœ¨ Special (10% HP cost)</button>
            <button class="btn btn-secondary btn-sm" onclick="initBoss()">ðŸ”„ New Boss</button>
          </div>
          <div id="boss-reward-display" style="margin-top:10px;min-height:22px;font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:700;color:var(--gold)"></div>
        </div>
      </div>
    </div>

    <!-- DUNGEON PAGE -->
    <div class="page" id="page-dungeon">
      <div class="page-header"><div class="page-title">ðŸšï¸ Dungeon Run</div><div class="page-subtitle">Multi-stage rogue-lite run. Complete all 5 rooms for a legendary artifact. One death = full reset!</div></div>
      <div style="max-width:580px;margin:0 auto" id="dungeon-content">
        <div class="card" style="text-align:center">
          <div style="font-size:48px;margin-bottom:12px">ðŸšï¸</div>
          <div style="font-family:'Rajdhani',sans-serif;font-size:22px;font-weight:700;margin-bottom:8px">Dungeon Run</div>
          <div style="font-size:13px;color:var(--text2);margin-bottom:16px">5 rooms, each harder than the last. Complete all rooms for a legendary artifact. One mistake = full reset!</div>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;max-width:360px;margin:0 auto 16px">
            <div style="background:var(--bg4);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px">âš”ï¸</div><div style="font-size:10px;color:var(--text2)">Combat</div></div>
            <div style="background:var(--bg4);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px">ðŸ’°</div><div style="font-size:10px;color:var(--text2)">Treasure</div></div>
            <div style="background:var(--bg4);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px">ðŸ§©</div><div style="font-size:10px;color:var(--text2)">Puzzle</div></div>
            <div style="background:var(--bg4);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px">ðŸª</div><div style="font-size:10px;color:var(--text2)">Shop</div></div>
            <div style="background:var(--bg4);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px">ðŸ‘¹</div><div style="font-size:10px;color:var(--text2)">Boss</div></div>
            <div style="background:var(--bg4);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px">ðŸ—ï¸</div><div style="font-size:10px;color:var(--text2)">Secret</div></div>
          </div>
          <button class="btn btn-primary btn-lg" onclick="startDungeon()">ðŸšï¸ Enter Dungeon (costs $500)</button>
        </div>
      </div>
    </div>

    <!-- TOURNAMENT PAGE -->
    <div class="page" id="page-tournament">
      <div class="page-header"><div class="page-title">ðŸ† Tournament</div><div class="page-subtitle">Single-elimination bracket. Entry fee goes into the prize pool. Win all rounds to claim it!</div></div>
      <div style="max-width:600px;margin:0 auto" id="tournament-content">
        <div class="card" style="text-align:center">
          <div style="font-size:48px;margin-bottom:12px">ðŸ†</div>
          <div style="font-family:'Rajdhani',sans-serif;font-size:22px;font-weight:700;margin-bottom:8px">Tournament Mode</div>
          <div style="font-size:13px;color:var(--text2);margin-bottom:16px">8-player single-elimination bracket. Beat all opponents to claim the prize pool!</div>
          <div style="font-size:12px;color:var(--text3);margin-bottom:16px">Your ELO: <b id="tournament-elo" style="color:var(--accent)">1000</b></div>
          <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
            <button class="btn btn-secondary" onclick="startTournament(500)">Entry $500 â†’ Prize $4K</button>
            <button class="btn btn-primary" onclick="startTournament(2000)">Entry $2K â†’ Prize $16K</button>
            <button class="btn btn-secondary" onclick="startTournament(10000)" style="border-color:var(--gold);color:var(--gold)">Entry $10K â†’ Prize $80K</button>
          </div>
        </div>
      </div>
    </div>

    <!-- HIGH ROLLER PAGE -->
    <div class="page" id="page-highroller">
      <div class="page-header"><div class="page-title">ðŸ’Ž High Roller Room</div><div class="page-subtitle">Level 25+ exclusive. Mythic-biased drops. Maximum bet limits removed.</div></div>
      <div style="max-width:620px;margin:0 auto" id="highroller-content">
        <div class="card" style="text-align:center;background:linear-gradient(135deg,var(--bg3),#1a0a00)">
          <div style="font-size:48px;margin-bottom:12px">ðŸ’Ž</div>
          <div style="font-family:'Rajdhani',sans-serif;font-size:22px;font-weight:700;color:var(--gold);margin-bottom:8px">High Roller Room</div>
          <div style="font-size:13px;color:var(--text2);margin-bottom:16px">Exclusive to Level 25+. No bet limits. Mythic-biased drops. Special multipliers.</div>
          <div id="hr-locked-msg" style="background:var(--bg4);border-radius:10px;padding:16px;display:inline-block">
            <div style="font-size:32px">ðŸ”’</div>
            <div style="font-weight:700;color:var(--accent);margin-top:4px">Locked â€” Reach Level 25</div>
          </div>
        </div>
      </div>
    </div>

    <!-- INVESTMENTS PAGE -->
    <div class="page" id="page-invest">
      <div class="page-header"><div class="page-title">ðŸ“ˆ Investment Portfolio</div><div class="page-subtitle">Put your money to work across three risk tiers. Returns mature over time.</div></div>
      <div style="max-width:660px;margin:0 auto">
        <div class="card" style="margin-bottom:12px;display:flex;gap:16px;align-items:center;background:linear-gradient(135deg,var(--bg3),var(--bg4))">
          <div style="font-size:32px">ðŸ“ˆ</div>
          <div><div style="font-weight:700;margin-bottom:2px">Investment Portfolio</div><div style="font-size:12px;color:var(--text2)">Put money to work. Low risk = slow returns. High risk = big gains or losses.</div></div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px" id="invest-tiers"></div>
        <div class="card"><div class="section-title">Active Investments</div><div id="active-investments" style="margin-top:10px"></div></div>
      </div>
    </div>

    <!-- AUCTION HOUSE PAGE -->
    <div class="page" id="page-auction">
      <div class="page-header"><div class="page-title">ðŸ”¨ Auction House</div><div class="page-subtitle">Bid against bots on rare skins. Auctions last 90 seconds. Highest bid wins!</div></div>
      <div style="max-width:640px;margin:0 auto">
        <div class="card" style="margin-bottom:12px;text-align:center;background:linear-gradient(135deg,var(--bg3),var(--bg4))">
          <div style="font-size:13px;color:var(--text2);margin-bottom:4px">Live auctions happen every 90 seconds. Outbid bots to win rare skins!</div>
        </div>
        <div id="auction-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:14px"></div>
      </div>
    </div>

    <!-- BLACK MARKET PAGE -->
    <div class="page" id="page-blackmarket">
      <div class="page-header"><div class="page-title">ðŸ•µï¸ Black Market</div><div class="page-subtitle">Rare items appear for 5 minutes every 30 minutes. Very limited stock. No questions asked.</div></div>
      <div style="max-width:620px;margin:0 auto">
        <div class="card" style="margin-bottom:12px;background:linear-gradient(135deg,#1a0a14,var(--bg3));border-color:var(--red)40">
          <div style="font-size:13px;color:var(--red);font-weight:700;margin-bottom:4px">âš ï¸ Underground Trading</div>
          <div style="font-size:12px;color:var(--text2)">Rare items appear every 30 minutes for just 5 minutes. No refunds. No questions asked.</div>
        </div>
        <div id="bm-timer-bar" style="text-align:center;font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:700;color:var(--red);margin-bottom:16px"></div>
        <div id="bm-grid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px"></div>
      </div>
    </div>

    <!-- SKILL TREE PAGE -->
    <div class="page" id="page-skilltree">
      <div class="page-header"><div class="page-title">ðŸŒ³ Skill Tree</div><div class="page-subtitle">Spend Skill Points (1 per level-up) to unlock permanent upgrades across 4 branches.</div></div>
      <div class="card" style="margin-bottom:14px;text-align:center">
          <div style="font-size:13px;color:var(--text2);margin-bottom:4px">Spend Skill Points (earned every level) to permanently unlock upgrades.</div>
          <div style="font-size:14px;font-weight:700;color:var(--accent)">Skill Points: <span id="skill-points-display">0</span></div>
        </div>
        <div style="text-align:center;margin-bottom:16px;background:var(--bg3);padding:10px;border-radius:10px;display:inline-block;position:relative;left:50%;transform:translateX(-50%)">
        <span style="font-size:14px;color:var(--text2)">Available Skill Points: </span>
        <span id="skill-points-display" style="font-family:'Barlow Condensed',sans-serif;font-size:24px;font-weight:700;color:var(--gold)">0</span>
      </div>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;max-width:860px;margin:0 auto" id="skill-tree-grid"></div>
    </div>

    <!-- PRESTIGE PAGE -->
    <div class="page" id="page-prestige">
      <div class="page-header"><div class="page-title">â­ Prestige System</div><div class="page-subtitle">Reset your progress for permanent multipliers that persist forever. Higher prestige = massive bonuses.</div></div>
      <div style="max-width:620px;margin:0 auto" id="prestige-content">
        <div class="card" style="text-align:center;margin-bottom:14px">
          <div style="font-size:48px;margin-bottom:8px">â­</div>
          <div style="font-family:'Rajdhani',sans-serif;font-size:22px;font-weight:700;margin-bottom:8px">Prestige System</div>
          <div style="font-size:13px;color:var(--text2);margin-bottom:8px">Reset your progress for permanent 2Ã— click multiplier and 25% luck bonus. Stacks forever.</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px">
            <div style="background:var(--bg4);padding:12px;border-radius:8px"><div style="font-size:11px;color:var(--text3)">PRESTIGE TIER</div><div id="prestige-tier-display" style="font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:700;color:var(--accent)">0</div></div>
            <div style="background:var(--bg4);padding:12px;border-radius:8px"><div style="font-size:11px;color:var(--text3)">TOTAL BONUS</div><div id="prestige-bonus-display" style="font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:700;color:var(--green)">Ã—1</div></div>
          </div>
          <button class="btn btn-primary btn-lg" onclick="doPrestige()">â­ Prestige Reset</button>
          <div style="font-size:11px;color:var(--text3);margin-top:8px">Requires Level 50 Â· Resets balance, level, inventory</div>
        </div></div>
    </div>

    <!-- LEGACY PERKS PAGE -->
    <div class="page" id="page-legacyperks">
      <div class="page-header"><div class="page-title">ðŸ‘‘ Legacy Perks</div><div class="page-subtitle">Meta-progression perks unlocked through rebirths. These NEVER reset.</div></div>
      <div class="card" style="margin-bottom:14px;text-align:center">
          <div style="font-size:13px;color:var(--text2)">Legacy Perks are earned through Prestige resets and never reset. They stack across all runs.</div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:14px;max-width:720px;margin:0 auto" id="legacy-perks-grid"></div>
    </div>

    <!-- FAIRNESS PAGE -->
    <div class="page" id="page-fairness">
      <div class="page-header"><div class="page-title">ðŸ” Provably Fair</div><div class="page-subtitle">Every outcome is derived from a cryptographic seed. Nothing is hidden â€” verify any roll.</div></div>
      <div style="max-width:520px;margin:0 auto">
        <div class="card" style="margin-bottom:12px">
          <div class="section-title">Current Active Seed</div>
          <div id="current-seed-display" style="font-family:'Barlow Condensed',sans-serif;font-size:12px;color:var(--accent);word-break:break-all;padding:8px;background:var(--bg4);border-radius:6px;margin-top:8px;user-select:all">â€”</div>
          <div style="font-size:10px;color:var(--text3);margin-top:4px">Nonce (rolls completed): <span id="seed-nonce-display">0</span></div>
          <div style="display:flex;gap:8px;margin-top:8px"><button class="btn btn-secondary btn-sm" onclick="rotateSeed()">ðŸ”„ New Seed</button><button class="btn btn-secondary btn-sm" onclick="copySeed()">ðŸ“‹ Copy</button></div>
        </div>
        <div class="card" style="margin-bottom:12px">
          <div class="section-title">Recent Verified Rolls</div>
          <div id="seed-roll-log" style="max-height:200px;overflow-y:auto;margin-top:8px;font-size:11px;font-family:'Barlow Condensed',sans-serif;color:var(--text2)"></div>
        </div>
        <div class="card">
          <div class="section-title">Verify a Past Roll</div>
          <div style="display:grid;gap:8px;margin-top:10px">
            <input id="verify-seed" placeholder="Seed string" style="background:var(--bg4);border:1px solid var(--bg5);border-radius:6px;padding:8px;color:var(--text);width:100%">
            <input id="verify-nonce" type="number" placeholder="Nonce (roll #)" style="background:var(--bg4);border:1px solid var(--bg5);border-radius:6px;padding:8px;color:var(--text);width:100%">
            <button class="btn btn-primary" onclick="verifyRoll()">ðŸ” Verify</button>
            <div id="verify-result" style="font-size:12px;color:var(--text2);min-height:18px"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="page" id="page-admin">
      <div class="page-header">
        <div class="page-title" style="color:#8847ff">ðŸ›¡ï¸ Admin Panel</div>
      </div>
      <div class="admin-panel">
        <div class="admin-title">ðŸ›¡ï¸ Economy Controls</div>
        <div class="admin-grid">
          <div class="card-dark p-2 rounded-2">
            <div style="font-size:12px;color:var(--text2);margin-bottom:6px">Add Balance</div>
            <div class="admin-input-wrap">
              <input type="number" class="admin-input" id="admin-balance" value="1000">
              <button class="btn btn-primary btn-sm" onclick="adminAddBalance()">Add</button>
            </div>
          </div>
          <div class="card-dark p-2 rounded-2">
            <div style="font-size:12px;color:var(--text2);margin-bottom:6px">Add XP</div>
            <div class="admin-input-wrap">
              <input type="number" class="admin-input" id="admin-xp" value="500">
              <button class="btn btn-primary btn-sm" onclick="adminAddXP()">Add</button>
            </div>
          </div>
          <div class="card-dark p-2 rounded-2">
            <div style="font-size:12px;color:var(--text2);margin-bottom:6px">Spawn Skin</div>
            <div class="admin-input-wrap">
              <select class="admin-input" id="admin-skin-rarity">
                <option value="consumer">Consumer</option>
                <option value="industrial">Industrial</option>
                <option value="milspec">Mil-Spec</option>
                <option value="restricted">Restricted</option>
                <option value="classified">Classified</option>
                <option value="covert">Covert</option>
                <option value="knife">Knife â˜…</option>
              </select>
              <button class="btn btn-primary btn-sm" onclick="adminSpawnSkin()">Spawn</button>
            </div>
          </div>
          <div class="card-dark p-2 rounded-2">
            <div style="font-size:12px;color:var(--text2);margin-bottom:6px">Set Level</div>
            <div class="admin-input-wrap">
              <input type="number" class="admin-input" id="admin-level" value="50" min="1">
              <button class="btn btn-primary btn-sm" onclick="adminSetLevel()">Set</button>
            </div>
          </div>
          <div class="card-dark p-2 rounded-2">
            <div style="font-size:12px;color:var(--text2);margin-bottom:6px">Toggle 2x Luck</div>
            <button class="btn btn-primary" onclick="adminToggleLuck()">Toggle 2Ã— Luck</button>
          </div>
          <div class="card-dark p-2 rounded-2">
            <div style="font-size:12px;color:var(--text2);margin-bottom:6px">Max Upgrades</div>
            <button class="btn btn-primary" onclick="adminMaxUpgrades()">Buy All Upgrades</button>
          </div>
        </div>
      </div>
    </div>

    <!-- RANKED MATCHES PAGE -->
    <div class="page" id="page-ranked">
      <div class="page-header">
        <div class="page-title">Ranked Matches</div>
        <div class="page-subtitle">5-round ladder against bot opponents â€” climb tiers to earn massive rewards!</div>
      </div>
      <div style="max-width:640px;margin:0 auto">
        <div class="card" style="margin-bottom:14px;display:grid;grid-template-columns:repeat(4,1fr);gap:10px;text-align:center">
          <div><div style="font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:700;color:var(--accent)" id="ranked-elo-display">1000</div><div style="font-size:10px;color:var(--text3)">ELO RATING</div></div>
          <div><div style="font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:700;color:var(--green)" id="ranked-wins">0</div><div style="font-size:10px;color:var(--text3)">WINS</div></div>
          <div><div style="font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:700;color:var(--red)" id="ranked-losses">0</div><div style="font-size:10px;color:var(--text3)">LOSSES</div></div>
          <div><div style="font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:700;color:var(--gold)" id="ranked-tier-badge">Bronze</div><div style="font-size:10px;color:var(--text3)">TIER</div></div>
        </div>
        <div id="ranked-content">
          <div class="ranked-arena">
            <div style="font-family:'Rajdhani',sans-serif;font-size:20px;font-weight:700;margin-bottom:4px">Enter the Arena</div>
            <div style="font-size:13px;color:var(--text2);margin-bottom:20px">Beat 5 opponents in a row to climb tiers and earn rewards.</div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px" id="ranked-tiers-display"></div>
            <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
              <button class="btn btn-secondary" onclick="startRankedMatch(100)">Bronze â€” Entry $100</button>
              <button class="btn btn-primary" onclick="startRankedMatch(500)">Silver â€” Entry $500</button>
              <button class="btn btn-secondary" style="border-color:var(--gold);color:var(--gold)" onclick="startRankedMatch(2500)">Gold â€” Entry $2,500</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- PRESTIGE STORE PAGE -->
    <div class="page" id="page-prestigestore">
      <div class="page-header">
        <div class="page-title">Prestige Store</div>
        <div class="page-subtitle">Spend Prestige Tokens earned from Prestige resets on permanent, game-changing upgrades!</div>
      </div>
      <div style="max-width:700px;margin:0 auto">
        <div class="card" style="margin-bottom:16px;display:flex;gap:20px;align-items:center">
          <div style="text-align:center">
            <div style="font-family:'Barlow Condensed',sans-serif;font-size:40px;font-weight:700;color:rgba(255,68,255,1)" id="pstore-tokens">0</div>
            <div style="font-size:10px;color:var(--text3);letter-spacing:1px">PRESTIGE TOKENS</div>
          </div>
          <div style="flex:1;font-size:13px;color:var(--text2)">Earn Prestige Tokens by Prestige-resetting. Each prestige gives you tokens based on your level. Spend them here on permanent power-ups that never reset.</div>
        </div>
        <div class="pstore-grid" id="pstore-grid"></div>
      </div>
    </div>

    <!-- LUCK LAB PAGE -->
    <div class="page" id="page-lucklab">
      <div class="page-header">
        <div class="page-title">Luck Lab</div>
        <div class="page-subtitle">Combine reagents to brew Luck Potions â€” temporary luck boosts for case openings!</div>
      </div>
      <div style="max-width:660px;margin:0 auto">
        <div class="card" style="margin-bottom:14px">
          <div style="display:flex;gap:16px;align-items:center">
            <div style="text-align:center;flex-shrink:0">
              <svg width="56" height="56" viewBox="0 0 56 56" fill="none">
                <path d="M22 8h12v14l8 18H14L22 22V8z" fill="none" stroke="var(--accent3)" stroke-width="1.5" opacity="0.8"/>
                <path d="M19 8h18" stroke="var(--accent3)" stroke-width="2" stroke-linecap="round"/>
                <circle cx="24" cy="32" r="2" fill="var(--accent3)" opacity="0.6"/>
                <circle cx="32" cy="36" r="1.5" fill="var(--accent3)" opacity="0.4"/>
                <circle cx="28" cy="30" r="1" fill="var(--accent3)" opacity="0.8"/>
              </svg>
            </div>
            <div>
              <div style="font-weight:700;margin-bottom:4px">Active Brew</div>
              <div id="lab-active-potion" style="font-size:13px;color:var(--text2)">No active potion. Brew one below!</div>
              <div id="lab-potion-timer" style="font-size:12px;color:var(--accent3);margin-top:4px"></div>
            </div>
          </div>
        </div>
        <div class="section-title">Reagents</div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:10px">Earn reagents by opening cases and winning casino games. Combine 2-3 reagents to brew a potion.</div>
        <div class="lab-grid" id="reagent-grid"></div>
        <div class="card" style="margin-top:14px">
          <div class="section-title">Brew Station</div>
          <div class="brew-slots" id="brew-slots">
            <div class="brew-slot" id="brew-slot-0" onclick="clearBrewSlot(0)"><span style="color:var(--text3);font-size:10px">Slot 1</span></div>
            <div class="brew-slot" id="brew-slot-1" onclick="clearBrewSlot(1)"><span style="color:var(--text3);font-size:10px">Slot 2</span></div>
            <div class="brew-slot" id="brew-slot-2" onclick="clearBrewSlot(2)"><span style="color:var(--text3);font-size:10px">Slot 3</span></div>
          </div>
          <div id="brew-preview" style="text-align:center;font-size:13px;color:var(--text2);margin-bottom:12px">Add reagents to see what you'll brew</div>
          <div style="text-align:center">
            <button class="btn btn-primary btn-lg" onclick="brewPotion()">Brew Potion</button>
          </div>
          <div id="brew-result" style="text-align:center;margin-top:10px;font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:700;min-height:24px"></div>
        </div>
      </div>
    </div>

  </div><!-- .main -->
</div><!-- #app -->

<!-- BOTTOM HOTBAR -->
<nav id="bottom-hotbar">
  <button class="hb-btn active" id="hb-clicker" onclick="showPage('clicker')">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M12 8v4l3 3"/></svg>
    Farm
  </button>
  <button class="hb-btn" id="hb-cases" onclick="showPage('cases')">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 8h14l-1 12H6L5 8z"/><path d="M9 8V6a3 3 0 0 1 6 0v2"/><line x1="3" y1="8" x2="21" y2="8"/></svg>
    Cases
  </button>
  <button class="hb-btn" id="hb-casino" onclick="showPage('casino')">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><circle cx="8" cy="10" r="1.5" fill="currentColor"/><circle cx="12" cy="12" r="1.5" fill="currentColor"/><circle cx="16" cy="14" r="1.5" fill="currentColor"/></svg>
    Casino
  </button>
  <button class="hb-btn" id="hb-inventory" onclick="showPage('inventory')">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 0 0-4 0v2M8 7V5a2 2 0 0 0-4 0"/></svg>
    Inv
  </button>
  <button class="hb-btn" id="hb-spin" onclick="openSpinModal()" style="position:relative">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M12 12l-4-4M12 12l4 0M12 12l0 4"/></svg>
    Spin
    <span class="hb-badge" id="hb-spin-badge" style="display:none">!</span>
  </button>
  <button class="hb-btn" id="hb-missions" onclick="showPage('missions')">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
    Tasks
    <span class="hb-badge" id="hb-mission-badge" style="display:none">!</span>
  </button>
</nav>

<!-- CASE OPENING MODAL -->
<div id="case-modal" style="display:none">
  <div class="case-modal-inner">
    <div class="case-modal-header">
      <div style="font-family:'Rajdhani',sans-serif;font-size:20px;font-weight:700" id="modal-case-name">Case</div>
      <button class="modal-close" onclick="closeCase()">âœ•</button>
    </div>
    <div class="case-spinner-wrap" id="spinner-section">
      <div class="spinner-container" id="spinner-container">
        <div class="spinner-track" id="spinner-track"></div>
        <div class="spinner-needle"></div>
      </div>
    </div>
    <div class="win-display" id="win-display">
      <div id="win-icon" style="width:200px;height:140px;overflow:hidden;border-radius:12px;margin-bottom:12px;border:2px solid transparent" class="rarity-consumer"></div>
      <div class="win-skin-name" id="win-name">Skin Name</div>
      <div class="win-rarity-text" id="win-rarity">Covert</div>
      <div class="win-skin-value" id="win-value">$0.00</div>
      <div id="case-modal-multi-grid" style="display:none;flex-wrap:wrap;gap:5px;justify-content:center;max-height:320px;overflow-y:auto;width:100%;padding:4px;margin:4px 0"></div>
      <div class="flex gap-2">
        <button class="btn btn-green" onclick="addWinToInventory()">âœ“ Keep All</button>
        <button class="btn btn-red" onclick="sellWin()">ðŸ’° Sell All</button>
      </div>
    </div>
    <div class="case-modal-actions" id="modal-actions">
      <div class="flex gap-1 items-center flex-wrap">
        <span style="font-size:12px;color:var(--text2)">Qty:</span>
        <div id="qty-btns" class="flex gap-1 flex-wrap">
          <button class="quantity-btn active" onclick="setOpenQty(1)">Ã—1</button>
        </div>
        <span style="font-size:10px;color:var(--text3)" id="qty-level-hint"></span>
      </div>
      <button class="btn btn-primary btn-lg" id="open-btn" onclick="openCase()">ðŸ”“ Open Case</button>
      <div id="case-cost-display" style="font-size:13px;color:var(--text2)"></div>
    </div>
  </div>
</div>

<!-- SKIN INSPECT MODAL -->
<div id="inspect-modal" style="position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:2000;display:none;align-items:center;justify-content:center;backdrop-filter:blur(6px)"
  onclick="if(event.target===this)closeInspect()">
  <div style="background:var(--bg2);border-radius:20px;width:90%;max-width:520px;overflow:hidden;border:1px solid var(--bg5)">
    <div style="padding:16px 20px;border-bottom:1px solid var(--bg4);display:flex;align-items:center;justify-content:space-between">
      <div style="font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:700" id="inspect-title">Inspect</div>
      <button onclick="closeInspect()" style="background:none;color:var(--text2);font-size:22px;cursor:pointer">âœ•</button>
    </div>
    <div style="padding:0;background:#0d0e14;height:220px;overflow:hidden" id="inspect-art"></div>
    <div style="padding:20px">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
        <div><div style="font-size:10px;color:var(--text3);letter-spacing:1px">WEAPON</div><div style="font-weight:700" id="inspect-weapon">â€”</div></div>
        <div><div style="font-size:10px;color:var(--text3);letter-spacing:1px">FINISH</div><div style="font-weight:700" id="inspect-finish">â€”</div></div>
        <div><div style="font-size:10px;color:var(--text3);letter-spacing:1px">RARITY</div><div style="font-weight:700" id="inspect-rarity">â€”</div></div>
        <div><div style="font-size:10px;color:var(--text3);letter-spacing:1px">WEAR</div><div style="font-weight:700" id="inspect-wear">â€”</div></div>
        <div><div style="font-size:10px;color:var(--text3);letter-spacing:1px">FLOAT</div><div style="font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:700" id="inspect-float">â€”</div></div>
        <div><div style="font-size:10px;color:var(--text3);letter-spacing:1px">PATTERN SEED</div><div style="font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:700" id="inspect-seed">â€”</div></div>
      </div>
      <div style="background:var(--bg4);border-radius:8px;padding:3px;margin-bottom:16px">
        <div style="height:8px;border-radius:6px;background:linear-gradient(90deg,#2ecc71,#f0a500,#eb4b4b);position:relative">
          <div id="inspect-float-marker" style="position:absolute;top:-4px;width:4px;height:16px;background:#fff;border-radius:2px;box-shadow:0 0 6px rgba(255,255,255,.5);transform:translateX(-50%)"></div>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--text3);margin-top:2px"><span>FN</span><span>MW</span><span>FT</span><span>WW</span><span>BS</span></div>
      </div>
      <div style="text-align:center;margin-bottom:4px">
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:32px;font-weight:700" id="inspect-price">$0.00</div>
      </div>
      <!-- Sticker Slots -->
      <div style="margin-top:10px">
        <div style="font-size:10px;color:var(--text3);letter-spacing:1px;margin-bottom:6px">STICKERS</div>
        <div id="inspect-stickers" style="display:flex;gap:6px;justify-content:center"></div>
      </div>
      <div style="display:flex;gap:8px;justify-content:center;margin-top:12px;flex-wrap:wrap">
        <button class="btn btn-red" onclick="sellInspected()">ðŸ’° Sell</button>
        <button class="btn btn-secondary" onclick="applyRandomSticker()">ðŸ·ï¸ Add Sticker ($50)</button>
        <button class="btn btn-secondary" onclick="closeInspect()">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- DAILY SPIN MODAL -->
<div id="spin-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:2000;align-items:center;justify-content:center;backdrop-filter:blur(4px)">
  <div style="background:var(--bg2);border-radius:20px;width:90%;max-width:480px;overflow:hidden;border:1px solid var(--bg5);text-align:center;padding:32px;position:relative">
    <div style="position:absolute;top:-1px;left:20%;right:20%;height:2px;background:linear-gradient(90deg,transparent,var(--accent),var(--accent2),transparent)"></div>
    <div style="display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:4px">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M12 12l-4-4M12 12l4 0M12 12l0 4"/><circle cx="12" cy="12" r="2" fill="var(--accent)"/></svg>
      <div style="font-family:'Rajdhani',sans-serif;font-size:28px;font-weight:700;color:var(--accent)">Daily Spin</div>
    </div>
    <div style="font-size:13px;color:var(--text2);margin-bottom:24px">One free spin every 24 hours!</div>
    <div class="wheel-wrap">
      <div class="wheel-pointer">
        <svg width="24" height="28" viewBox="0 0 24 28" fill="var(--accent)"><polygon points="12,0 24,28 0,28"/></svg>
      </div>
      <canvas id="spin-canvas" width="300" height="300"></canvas>
      <div class="wheel-hub"></div>
    </div>
    <div id="spin-result" style="font-family:'Rajdhani',sans-serif;font-size:22px;font-weight:700;min-height:28px;margin-bottom:16px;margin-top:12px"></div>
    <button class="btn btn-primary btn-lg" id="spin-btn" onclick="doSpin()">SPIN!</button>
    <button class="btn btn-secondary" onclick="closeSpinModal()" style="margin-left:8px">Close</button>
  </div>
</div>

<!-- NOTIFICATIONS -->
<div class="notif-container" id="notif-container"></div>
<div id="knife-overlay" style="display:none" onclick="closeKnifeOverlay()">
  <div class="gold-particles" id="particles"></div>
  <div style="font-family:'Rajdhani',sans-serif;font-size:16px;color:var(--text2);letter-spacing:2px">EXTRAORDINARY ITEM!</div>
  <div class="knife-glow" id="knife-icon" style="width:120px;height:90px;display:flex;align-items:center;justify-content:center;margin:16px auto">
    <svg width="100" height="70" viewBox="0 0 100 70" fill="none">
      <path d="M10,35 L75,22 L82,28 L82,38 L75,44 L10,38Z" fill="#e4ae39" opacity="0.9"/>
      <path d="M8,34 L22,44 L22,36 L8,30Z" fill="#2a2b38"/>
      <line x1="8" y1="36" x2="75" y2="30" stroke="#f1c40f" stroke-width="0.6" opacity="0.5"/>
      <rect x="34" y="29" width="3" height="14" rx="1" fill="#e4ae39" opacity="0.7"/>
    </svg>
  </div>
  <div class="knife-text" id="knife-name">â˜… Karambit | Doppler</div>
  <div style="font-family:'Barlow Condensed',sans-serif;font-size:32px;color:var(--gold);margin:4px 0" id="knife-val">$450.00</div>
  <div style="font-size:12px;color:var(--text2);margin-top:8px">Click anywhere to continue</div>
</div>

<script>
// ============================================================
// GAME DATA
// ============================================================
const RARITIES = {
  consumer:{name:'Consumer Grade',color:'#b0c3d9',key:'consumer'},
  industrial:{name:'Industrial Grade',color:'#5e98d9',key:'industrial'},
  milspec:{name:'Mil-Spec Grade',color:'#4b69ff',key:'milspec'},
  restricted:{name:'Restricted',color:'#8847ff',key:'restricted'},
  classified:{name:'Classified',color:'#d32ce6',key:'classified'},
  covert:{name:'Covert',color:'#eb4b4b',key:'covert'},
  knife:{name:'â˜… Extraordinary',color:'#e4ae39',key:'knife'},
  mythic:{name:'â˜…â˜… Mythic',color:'#ff44ff',key:'mythic'},
  exotic:{name:'â˜…â˜…â˜… Exotic',color:'#00ffe7',key:'exotic'},
};

// CSGO Drop Rates
const DROP_RATES = [
  {rarity:'consumer',weight:7992},
  {rarity:'industrial',weight:1598},
  {rarity:'milspec',weight:320},
  {rarity:'restricted',weight:64},
  {rarity:'classified',weight:13},
  {rarity:'covert',weight:2},
  {rarity:'knife',weight:1},
];
const TOTAL_WEIGHT = DROP_RATES.reduce((s,r)=>s+r.weight,0);

const WEAPONS = {
  pistols:['Glock-18','USP-S','P250','Five-SeveN','Tec-9','CZ75-Auto','Desert Eagle','Dual Berettas','P2000','R8 Revolver'],
  smgs:['MP9','MP7','MAC-10','PP-Bizon','MP5-SD','UMP-45','P90','MP5'],
  rifles:['AK-47','M4A4','M4A1-S','SG 553','AUG','FAMAS','Galil AR','SSG 08','SCAR-20','G3SG1','AWP','SG 550'],
  heavy:['XM1014','Nova','MAG-7','Sawed-Off','M249','Negev'],
  knives:['â˜… Karambit','â˜… Butterfly Knife','â˜… M9 Bayonet','â˜… Bayonet','â˜… Flip Knife','â˜… Gut Knife','â˜… Huntsman Knife',
          'â˜… Falchion Knife','â˜… Shadow Daggers','â˜… Bowie Knife','â˜… Ursus Knife','â˜… Navaja Knife','â˜… Stiletto Knife',
          'â˜… Talon Knife','â˜… Classic Knife','â˜… Skeleton Knife','â˜… Paracord Knife','â˜… Survival Knife','â˜… Nomad Knife',
          'â˜… Kukri Knife','â˜… Daggers','â˜… Canis Knife','â˜… Cord Knife','â˜… Phantom Knife','â˜… Ghost Knife'],
};
const ALL_GUNS = [...WEAPONS.pistols,...WEAPONS.smgs,...WEAPONS.rifles,...WEAPONS.heavy];

const FINISHES = {
  consumer:['Forest DDPAT','Sand Dune','Groundwater','Urban DDPAT','Contractor','Stained','Safari Mesh','Olive Plaid','Rust Coat','Faded','Mudder','Cold Blooded'],
  industrial:['Boreal Forest','Tornado','Silver','Gila','Faded Zebra','Amber Fade','Mudder','Splatter','Polar Mesh','Full Stop','Fuel Injector','Lapis Gator'],
  milspec:['Teardown','Muertos','Torque','Whiteout','Cobalt Halftone','Corticera','Death by Kitty','Blue Spruce','Graphite','Hazard','Translucence','Carbon Series','Indigo'],
  restricted:['Cyrex','Varicamo','Valence','Oxide Blaze','Buzz Kill','Flashback','Twilight Galaxy','Vortex','Nitro','Brass','Vulcan','Frontside Misty','Pulse','Orion'],
  classified:['Empress','Blood Tiger','Asiimov','Redline','Neo-Noir','Temukau','Wildfire','Desolate Space','Emerald','Crimson Web','Hyper Beast','Printstream','Fade','Tiger Tooth'],
  covert:['Dragon Lore','Fade','Doppler','Hyper Beast','Fire Serpent','Printstream','Howl','Skull Crusher','Wild Lotus','Duality','Marble Fade','Case Hardened (Blue Gem)','Gungnir','Lightning Strike'],
  knife:['Doppler','Fade','Tiger Tooth','Marble Fade','Ultraviolet','Night','Crimson Web','Slaughter','Autotropic','Case Hardened','Lore','Boreal Forest','Forest DDPAT','Vanilla','Damascus Steel','Blue Steel','Stained'],
};

const SKIN_ICONS = {
  consumer:'ðŸ”«',industrial:'ðŸ”«',milspec:'ðŸ”«',restricted:'ðŸ”«',classified:'ðŸ”«',covert:'âš¡',knife:'ðŸ”ª',
};

function rarityBasePrice(rarity){
  const prices={consumer:[0.03,0.15],industrial:[0.1,0.5],milspec:[0.5,3],restricted:[3,15],classified:[15,80],covert:[80,500],knife:[200,2000]};
  const r=prices[rarity];
  return +(r[0]+Math.random()*(r[1]-r[0])).toFixed(2);
}

function generateSkin(rarity,caseSource=''){
  const weapon = rarity==='knife' ? WEAPONS.knives[Math.floor(Math.random()*WEAPONS.knives.length)] : ALL_GUNS[Math.floor(Math.random()*ALL_GUNS.length)];
  const finish = FINISHES[rarity][Math.floor(Math.random()*FINISHES[rarity].length)];
  const float = +(Math.random()).toFixed(8);
  let wear='';
  if(float<0.07)wear='Factory New';
  else if(float<0.15)wear='Minimal Wear';
  else if(float<0.38)wear='Field-Tested';
  else if(float<0.45)wear='Well-Worn';
  else wear='Battle-Scarred';
  const pattern = Math.floor(Math.random()*1000);
  const price = rarityBasePrice(rarity);
  const id = Date.now()+Math.random();
  return {id,weapon,finish,name:`${weapon} | ${finish}`,rarity,float,wear,pattern,price,icon:SKIN_ICONS[rarity],case:caseSource,date:Date.now(),fav:false,banked:false};
}

const CASES = [
  // Classic Series
  {id:'cs1',name:'CS:GO Weapon Case',price:0.05,color:'#4b69ff',theme:'blue',special:'Classic Knives'},
  {id:'cs2',name:'CS:GO Weapon Case 2',price:0.05,color:'#8847ff',theme:'purple'},
  {id:'cs3',name:'CS:GO Weapon Case 3',price:0.05,color:'#d32ce6',theme:'pink'},
  {id:'esports13',name:'eSports 2013 Case',price:0.05,color:'#f0a500',theme:'gold'},
  {id:'esports14',name:'eSports 2014 Summer Case',price:0.08,color:'#00c8ff',theme:'cyan'},
  // Operation Series
  {id:'bravo',name:'Operation Bravo Case',price:35,color:'#e4ae39',theme:'knife',special:'Rare & Valuable'},
  {id:'phoenix',name:'Operation Phoenix Case',price:0.10,color:'#ff6b35',theme:'orange'},
  {id:'hydra',name:'Operation Hydra Case',price:1.50,color:'#2ecc71',theme:'green',special:'Hydra Gloves'},
  {id:'vanguard',name:'Operation Vanguard Case',price:0.08,color:'#5e98d9',theme:'blue'},
  {id:'wildfire',name:'Operation Wildfire Case',price:0.12,color:'#eb4b4b',theme:'red'},
  // Chroma Series
  {id:'chroma',name:'Chroma Case',price:0.07,color:'#d32ce6',theme:'purple'},
  {id:'chroma2',name:'Chroma 2 Case',price:0.15,color:'#eb4b4b',theme:'red'},
  {id:'chroma3',name:'Chroma 3 Case',price:0.15,color:'#8847ff',theme:'violet'},
  // Color Series
  {id:'shadow',name:'Shadow Case',price:0.12,color:'#3a3b50',theme:'dark'},
  {id:'falchion',name:'Falchion Case',price:0.20,color:'#eb4b4b',theme:'red'},
  {id:'revolver',name:'Revolver Case',price:0.04,color:'#8b7355',theme:'tan'},
  {id:'winter',name:'Winter Offensive Case',price:0.12,color:'#5e98d9',theme:'ice',special:'Cold Skins'},
  {id:'breakout',name:'Breakout Case',price:0.06,color:'#ff6b35',theme:'orange'},
  // Gamma Series
  {id:'gamma',name:'Gamma Case',price:0.14,color:'#2ecc71',theme:'green'},
  {id:'gamma2',name:'Gamma 2 Case',price:0.18,color:'#00c8ff',theme:'teal'},
  // Glove Special
  {id:'glove',name:'Glove Case',price:2.10,color:'#e4ae39',theme:'gold',special:'â˜… Gloves'},
  // Spectrum
  {id:'spectrum',name:'Spectrum Case',price:0.20,color:'#ff6b35',theme:'spectrum'},
  {id:'spectrum2',name:'Spectrum 2 Case',price:0.25,color:'#8847ff',theme:'purple'},
  // Danger Zone
  {id:'danger',name:'Danger Zone Case',price:0.34,color:'#eb4b4b',theme:'red'},
  // Horizon Series
  {id:'horizon',name:'Horizon Case',price:0.45,color:'#ff6b35',theme:'sunset'},
  // Prisma Series
  {id:'prisma',name:'PRISMA Case',price:0.68,color:'#d32ce6',theme:'prism'},
  {id:'prisma2',name:'PRISMA 2 Case',price:0.52,color:'#00c8ff',theme:'cyan'},
  // CS20
  {id:'cs20',name:'CS20 Case',price:0.55,color:'#f0a500',theme:'anniversary',special:'20th Anniversary'},
  // Fracture
  {id:'fracture',name:'Fracture Case',price:0.45,color:'#eb4b4b',theme:'red'},
  // Snakebite
  {id:'snakebite',name:'Snakebite Case',price:0.38,color:'#2ecc71',theme:'green'},
  // Dreams & Nightmares
  {id:'dreams',name:'Dreams & Nightmares Case',price:0.55,color:'#8847ff',theme:'nightmare',special:'Unique Art'},
  // Recoil
  {id:'recoil',name:'Recoil Case',price:0.72,color:'#4b69ff',theme:'cyber'},
  // Revolution
  {id:'revolution',name:'Revolution Case',price:0.88,color:'#00c8ff',theme:'neon'},
  // Kilowatt
  {id:'kilowatt',name:'Kilowatt Case',price:1.20,color:'#f0a500',theme:'electric',special:'New 2024 Skins'},
  // Gallery
  {id:'gallery',name:'Gallery Case',price:0.65,color:'#d32ce6',theme:'art'},
  // Event Cases
  {id:'sticker2021',name:'Stockholm 2021 Souvenir',price:8.50,color:'#e4ae39',theme:'souvenir',special:'â­ Souvenir'},
  {id:'sticker2022',name:'Antwerp 2022 Souvenir',price:12.00,color:'#ff6b35',theme:'souvenir',special:'â­ Souvenir'},
  {id:'paris2023',name:'Paris 2023 Souvenir',price:15.00,color:'#4b69ff',theme:'souvenir',special:'â­ Souvenir'},
  // Special/Event
  {id:'event_halloween',name:'Halloween Horror Case',price:2.50,color:'#ff6b35',theme:'halloween',special:'ðŸŽƒ Limited Event'},
  {id:'event_christmas',name:'Winter Gift Case',price:3.00,color:'#5e98d9',theme:'christmas',special:'ðŸŽ„ Limited Event'},
  {id:'event_summer',name:'Summer Heat Case',price:1.80,color:'#f0a500',theme:'summer',special:'â˜€ï¸ Limited Event'},
  // Ultra Rare
  {id:'ancient',name:'The Ancient Case',price:4.20,color:'#8847ff',theme:'ancient',special:'â˜… Ultra Rare Pool'},
];

const CASINO_GAMES=[
  {id:'blackjack',name:'Blackjack',icon:'ðŸƒ',desc:'Beat the dealer to 21',color:'#1a3a25'},
  {id:'roulette',name:'Roulette',icon:'ðŸŽ¯',desc:'Bet on Red, Black or Green',color:'#3a1a1a'},
  {id:'crash',name:'Crash',icon:'ðŸš€',desc:'Cash out before it crashes',color:'#0d1f3a'},
  {id:'mines',name:'Mines',icon:'ðŸ’£',desc:'Dodge mines for multipliers',color:'#1a1a0d'},
  {id:'slots',name:'Slots',icon:'ðŸŽ°',desc:'Classic 3-reel slot machine',color:'#1a0a1a'},
  {id:'plinko',name:'Plinko',icon:'ðŸ”µ',desc:'Drop balls for big multipliers',color:'#0a1a2a'},
  {id:'coinflip',name:'Coinflip',icon:'ðŸª™',desc:'50/50 â€” CT vs T side',color:'#1a1204'},
  {id:'keno',name:'Keno',icon:'ðŸŸ¡',desc:'Pick numbers, match for prizes',color:'#1a1a0a'},
  {id:'tower',name:'Tower Climb',icon:'ðŸ—¼',desc:'Climb floors, cash out anytime',color:'#0a1a0a'},
  {id:'limbo',name:'Limbo',icon:'ðŸŒ€',desc:'Target a multiplier, win or lose',color:'#0a0a1a'},
  {id:'wheel',name:'Wheel',icon:'ðŸŽ¡',desc:'Spin the fortune wheel',color:'#1a0a0a'},
  {id:'poker',name:'Video Poker',icon:'ðŸƒ',desc:'Jacks or Better 5-card draw',color:'#0d1a1a'},
];

const UPGRADES = [
  // Click Power
  {id:'mpad',name:'Mousepad Pro',desc:'+$0.50/click',cost:50,icon:'ðŸ–±ï¸',clickAdd:0.50,max:30,cat:'click'},
  {id:'mech',name:'Mechanical Keyboard',desc:'+$2/click',cost:600,icon:'âŒ¨ï¸',clickAdd:2,max:25,cat:'click'},
  {id:'gmouse',name:'Gaming Mouse',desc:'+$10/click',cost:8000,icon:'ðŸ–±ï¸',clickAdd:10,max:20,cat:'click'},
  {id:'golden',name:'Golden Mouse',desc:'+$50/click',cost:75000,icon:'âœ¨',clickAdd:50,max:15,cat:'click'},
  {id:'quantum',name:'Quantum Clicker',desc:'+$250/click',cost:600000,icon:'âš›ï¸',clickAdd:250,max:10,cat:'click'},
  {id:'cosmic',name:'Cosmic Force',desc:'+$2000/click',cost:5000000,icon:'ðŸŒŒ',clickAdd:2000,max:5,cat:'click'},
  // Passive Income
  {id:'autoclk',name:'Auto Clicker',desc:'+$0.50/s',cost:100,icon:'ðŸ¤–',cpsAdd:0.5,max:50,cat:'passive'},
  {id:'farm1',name:'Click Farm I',desc:'+$5/s',cost:2500,icon:'ðŸ­',cpsAdd:5,max:40,cat:'passive'},
  {id:'farm2',name:'Click Farm II',desc:'+$25/s',cost:25000,icon:'ðŸ—ï¸',cpsAdd:25,max:30,cat:'passive'},
  {id:'aibot',name:'AI Bot Network',desc:'+$200/s',cost:250000,icon:'ðŸ§ ',cpsAdd:200,max:20,cat:'passive'},
  {id:'megafarm',name:'Mega Farm',desc:'+$1500/s',cost:2000000,icon:'ðŸŒ†',cpsAdd:1500,max:10,cat:'passive'},
  {id:'infinity',name:'Infinity Engine',desc:'+$15,000/s',cost:20000000,icon:'â™¾ï¸',cpsAdd:15000,max:5,cat:'passive'},
  // Luck
  {id:'luck1',name:'Lucky Charm',desc:'+5% case luck',cost:1200,icon:'ðŸ€',luckAdd:5,max:20,cat:'luck'},
  {id:'luck2',name:'Horseshoe',desc:'+15% case luck',cost:18000,icon:'ðŸŒˆ',luckAdd:15,max:10,cat:'luck'},
  {id:'luck3',name:'Crystal Ball',desc:'+40% case luck',cost:200000,icon:'ðŸ”®',luckAdd:40,max:5,cat:'luck'},
];

const RANKS = [
  {name:'Silver I',short:'S1',min:0,icon:'ðŸ¥ˆ'},
  {name:'Silver II',short:'S2',min:5,icon:'ðŸ¥ˆ'},
  {name:'Silver III',short:'S3',min:10,icon:'ðŸ¥ˆ'},
  {name:'Silver IV',short:'S4',min:15,icon:'ðŸ¥ˆ'},
  {name:'Silver Elite',short:'SE',min:20,icon:'ðŸ¥ˆ'},
  {name:'Silver Elite Master',short:'SEM',min:25,icon:'ðŸ¥ˆ'},
  {name:'Gold Nova I',short:'GN1',min:30,icon:'ðŸ¥‡'},
  {name:'Gold Nova II',short:'GN2',min:35,icon:'ðŸ¥‡'},
  {name:'Gold Nova III',short:'GN3',min:40,icon:'ðŸ¥‡'},
  {name:'Gold Nova Master',short:'GNM',min:45,icon:'ðŸ¥‡'},
  {name:'Master Guardian I',short:'MG1',min:50,icon:'ðŸ…'},
  {name:'Master Guardian II',short:'MG2',min:55,icon:'ðŸ…'},
  {name:'Master Guardian Elite',short:'MGE',min:60,icon:'ðŸ…'},
  {name:'Distinguished Master Guardian',short:'DMG',min:65,icon:'ðŸ†'},
  {name:'Legendary Eagle',short:'LE',min:70,icon:'ðŸ¦…'},
  {name:'Legendary Eagle Master',short:'LEM',min:75,icon:'ðŸ¦…'},
  {name:'Supreme Master First Class',short:'SMFC',min:80,icon:'ðŸ‘‘'},
  {name:'The Global Elite',short:'GE',min:90,icon:'ðŸŒŸ'},
];

const ACHIEVEMENTS = [
  {id:'first_open',name:'First Open',desc:'Open your first case',icon:'ðŸ“¦',done:false,req:'casesOpened',val:1},
  {id:'open_100',name:'Centurion',desc:'Open 100 cases',icon:'ðŸ’¯',done:false,req:'casesOpened',val:100},
  {id:'open_1000',name:'Case Addict',desc:'Open 1000 cases',icon:'ðŸ“¦',done:false,req:'casesOpened',val:1000},
  {id:'first_knife',name:'Knife!',desc:'Unbox your first knife',icon:'ðŸ”ª',done:false,req:'knivesUnboxed',val:1},
  {id:'rich',name:'Millionaire',desc:'Earn $1,000,000 total',icon:'ðŸ’Ž',done:false,req:'totalEarned',val:1000000},
  {id:'gambler',name:'High Roller',desc:'Win 10 casino games',icon:'ðŸŽ²',done:false,req:'casinoWins',val:10},
  {id:'collector',name:'Collector',desc:'Have 50 skins in inventory',icon:'ðŸŽ’',done:false,req:'invCount',val:50},
  {id:'rebirth1',name:'Phoenix',desc:'Complete first rebirth',icon:'ðŸ”¥',done:false,req:'rebirths',val:1},
  {id:'profit100',name:'Profit Pro',desc:'Make $100 profit from selling',icon:'ðŸ“ˆ',done:false,req:'sellProfit',val:100},
];

const ROULETTE_SEQUENCE = [0,32,15,19,4,21,2,25,17,34,6,27,13,36,11,30,8,23,10,5,24,16,33,1,20,14,31,9,22,18,29,7,28,12,35,3,26];

// ============================================================
// GAME STATE
// ============================================================
let G; // main game state

function defaultState(){
  return {
    // Core economy
    balance:100,bankBalance:0,loan:0,
    clicks:0,totalClicks:0,totalEarned:100,sellProfit:0,
    cps:0,clickValue:0.50,
    // Casino
    winStreak:0,tiltLevel:0,casinoWins:0,casinoLosses:0,totalBet:0,totalWagered:0,
    // Provably fair
    fairnessSeed:generateSeed(),seedNonce:0,seedLog:[],
    // Player state
    lastSpinDate:'',inspectSkinId:null,
    xp:0,level:1,skillPoints:0,bpLevel:1,bpXP:0,bpPremium:false,
    rebirths:0,prestigeTier:0,luckBonus:0,riskIndex:0,
    reputation:0,elo:1000,vipTier:0,
    // Mode flags
    volatilityMode:'normal', // 'low','normal','high'
    insuranceOn:false,
    hardcoreMode:false,ironmanMode:false,
    debtSpiralMode:false,
    // Items
    casesOpened:0,knivesUnboxed:0,
    inventory:[],bankSkins:[],favorites:[],artifacts:[],
    statTrakItems:{}, // skinId -> kills
    upgrades:{},
    history:[],marketHistory:[],
    lastInterest:Date.now(),lastLoanInterest:Date.now(),
    username:'',avatar:'',since:new Date().toLocaleDateString(),
    achievements:[...ACHIEVEMENTS],
    missions:generateMissions(),
    // Skills, legacy, prestige
    skillTree:{luck:[],economy:[],highroller:[],prestige:[]},
    legacyPerks:[],
    // Market
    seasonEvents:[],
    marketTrend:Array.from({length:20},()=>+(0.8+Math.random()*0.4).toFixed(2)),
    inflationFactor:1.0,
    supplyDemand:{},
    // Jackpot
    jpEntries:[],jpPot:0,
    // Investments
    investments:[],
    // Auction
    auctionItems:[],
    // Black market
    blackMarket:{items:[],refreshAt:0,nextOpenAt:0},
    // Boss
    boss:{name:'',hp:0,maxHp:0,tier:0,sprite:'',defeated:0},
    playerBossHp:100,playerBossMaxHp:100,
    // Dungeon
    dungeonRun:null,
    // Tournament
    tournament:null,
    // Daily events
    dailyEventModifier:null,dailyEventDate:'',
    globalEvent:null,globalEventExpiry:0,
    bloodMoonActive:false,goldenHourActive:false,goldenHourExpiry:0,
    // Rival
    rival:{name:'',level:1,balance:100,casesOpened:0,wins:0},
    // Stats
    totalNetWorthHistory:[100],netWorthSamples:[{t:Date.now(),v:100}],
    lifetimeBiggestWin:0,lifetimeBiggestLoss:0,lifetimeRolls:0,
    // UI
    sfxOn:true,theme:'dark',
    tokens:0,
    activeEvent:null,
    loanTakenAt:0,
    lastOnline:Date.now(),
    autoOpenActive:false,
    cosmetics:{theme:'default',avatar:'default',title:'Newbie',ownedThemes:['default'],ownedTitles:['Newbie'],ownedAvatars:['default'],shopCoins:0},
    jpEntries:[],jpPot:0,
  };
}

function generateMissions(){
  const daily=[
    {id:'d1',name:'Open 5 Cases',desc:'Open any 5 cases',icon:'ðŸ“¦',type:'daily',req:'casesOpened',start:0,goal:5,reward:50,claimed:false},
    {id:'d2',name:'Win at Casino',desc:'Win 3 casino games',icon:'ðŸŽ²',type:'daily',req:'casinoWins',start:0,goal:3,reward:30,claimed:false},
    {id:'d3',name:'Click 1000 Times',desc:'Click the money button 1000 times',icon:'ðŸ‘†',type:'daily',req:'totalClicks',start:0,goal:1000,reward:25,claimed:false},
  ];
  const weekly=[
    {id:'w1',name:'Open 50 Cases',desc:'Open 50 cases this week',icon:'ðŸ“¦',type:'weekly',req:'casesOpened',start:0,goal:50,reward:500,claimed:false},
    {id:'w2',name:'Big Gambler',desc:'Win $500 from casino',icon:'ðŸ†',type:'weekly',req:'casinoWinAmount',start:0,goal:500,reward:200,claimed:false},
    {id:'w3',name:'Collector Week',desc:'Get 20 skins in inventory',icon:'ðŸŽ’',type:'weekly',req:'invCount',goal:20,reward:150,claimed:false},
    {id:'w4',name:'Rebirth Ready',desc:'Earn $10,000 total',icon:'ðŸ’°',type:'weekly',req:'totalEarned',start:0,goal:10000,reward:300,claimed:false},
  ];
  return{daily,weekly,casinoWinAmount:0};
}

// ============================================================
// PERSISTENCE
// ============================================================
function saveGame(){
  if(!G||!currentUser)return;
  try{
    ACCOUNTS[currentUser].state=G;
    localStorage.setItem('csroll_accounts',JSON.stringify(ACCOUNTS));
    localStorage.setItem('csroll_last_user',currentUser);
  }catch(e){}
}
function migrateSave(){
  if(!G)return;
  if(G.clickValue<0.50)G.clickValue=0.50;
  if(!G.tokens)G.tokens=0;
  if(typeof G.winStreak!=='number')G.winStreak=0;
  if(!G.lastSpinDate)G.lastSpinDate='';
  if(!G.loanTakenAt)G.loanTakenAt=0;
  if(!G.activeEvent)G.activeEvent=null;
  if(!G.cosmetics)G.cosmetics={theme:'default',avatar:'default',title:'Newbie',ownedThemes:['default'],ownedTitles:['Newbie'],ownedAvatars:['default'],shopCoins:0};
  if(!Array.isArray(G.bankSkins))G.bankSkins=[];
  if(!Array.isArray(G.inventory))G.inventory=[];
  if(!Array.isArray(G.history))G.history=[];
  if(!Array.isArray(G.achievements))G.achievements=[...ACHIEVEMENTS];
  if(!G.autoOpenActive)G.autoOpenActive=false;
  if(typeof G.lastOnline!=='number')G.lastOnline=Date.now();
  if(!G.jpEntries)G.jpEntries=[];
  if(typeof G.jpPot!=='number')G.jpPot=0;
  // New fields
  if(typeof G.tiltLevel!=='number')G.tiltLevel=0;
  if(typeof G.totalWagered!=='number')G.totalWagered=0;
  if(typeof G.skillPoints!=='number')G.skillPoints=0;
  if(typeof G.prestigeTier!=='number')G.prestigeTier=0;
  if(typeof G.riskIndex!=='number')G.riskIndex=0;
  if(typeof G.reputation!=='number')G.reputation=0;
  if(typeof G.elo!=='number')G.elo=1000;
  if(typeof G.vipTier!=='number')G.vipTier=0;
  if(!G.volatilityMode)G.volatilityMode='normal';
  if(typeof G.insuranceOn!=='boolean')G.insuranceOn=false;
  if(typeof G.hardcoreMode!=='boolean')G.hardcoreMode=false;
  if(typeof G.ironmanMode!=='boolean')G.ironmanMode=false;
  if(!Array.isArray(G.artifacts))G.artifacts=[];
  if(!G.statTrakItems)G.statTrakItems={};
  if(!Array.isArray(G.investments))G.investments=[];
  if(!G.auctionItems)G.auctionItems=[];
  if(!G.blackMarket)G.blackMarket={items:[],refreshAt:0,nextOpenAt:0};
  if(!G.boss)G.boss={name:'',hp:0,maxHp:0,tier:0,sprite:'',defeated:0};
  if(typeof G.playerBossHp!=='number')G.playerBossHp=100;
  if(typeof G.playerBossMaxHp!=='number')G.playerBossMaxHp=100;
  if(!G.dungeonRun)G.dungeonRun=null;
  if(!G.tournament)G.tournament=null;
  if(!G.dailyEventModifier)G.dailyEventModifier=null;
  if(!G.dailyEventDate)G.dailyEventDate='';
  if(!G.rival||!G.rival.name)G.rival={name:'Bot_'+Math.random().toString(36).slice(2,6),level:Math.max(1,G.level-2),balance:G.balance*0.8,casesOpened:Math.floor(G.casesOpened*0.9),wins:0};
  if(!G.skillTree)G.skillTree={luck:[],economy:[],highroller:[],prestige:[]};
  if(!Array.isArray(G.legacyPerks))G.legacyPerks=[];
  if(!G.fairnessSeed)G.fairnessSeed=generateSeed();
  if(typeof G.seedNonce!=='number')G.seedNonce=0;
  if(!Array.isArray(G.seedLog))G.seedLog=[];
  if(typeof G.lifetimeBiggestWin!=='number')G.lifetimeBiggestWin=0;
  if(typeof G.lifetimeBiggestLoss!=='number')G.lifetimeBiggestLoss=0;
  if(typeof G.lifetimeRolls!=='number')G.lifetimeRolls=0;
  if(typeof G.inflationFactor!=='number')G.inflationFactor=1.0;
  if(!G.supplyDemand)G.supplyDemand={};
  if(typeof G.bloodMoonActive!=='boolean')G.bloodMoonActive=false;
  if(typeof G.goldenHourActive!=='boolean')G.goldenHourActive=false;
  if(typeof G.goldenHourExpiry!=='number')G.goldenHourExpiry=0;
  if(typeof G.globalEventExpiry!=='number')G.globalEventExpiry=0;
  if(!G.globalEvent)G.globalEvent=null;
  updateVIPTier();
}
function loadGame(){
  try{
    const d=localStorage.getItem('csroll_state');
    if(d){G=JSON.parse(d);if(!G.missions)G.missions=generateMissions();if(!G.marketTrend)G.marketTrend=Array.from({length:20},()=>+(0.8+Math.random()*0.4).toFixed(2));}
  }catch(e){G=null;}
}

// ============================================================
// AUTH
// ============================================================
let ACCOUNTS = {};
function loadAccounts(){try{ACCOUNTS=JSON.parse(localStorage.getItem('csroll_accounts')||'{}');}catch(e){ACCOUNTS={};}}
function saveAccounts(){localStorage.setItem('csroll_accounts',JSON.stringify(ACCOUNTS));}
let currentUser=null;

function switchLoginTab(t){
  document.querySelectorAll('.login-tab').forEach(el=>el.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('login-form').style.display=t==='login'?'block':'none';
  document.getElementById('register-form').style.display=t==='register'?'block':'none';
  document.getElementById('auth-error').textContent='';
}
function doLogin(){
  const user=document.getElementById('login-user').value.trim();
  const pass=document.getElementById('login-pass').value;
  if(!user||!pass){setAuthError('Please fill in all fields');return;}
  if(!ACCOUNTS[user]){setAuthError('No account found. Please register.');return;}
  if(ACCOUNTS[user].pass!==pass){setAuthError('Incorrect password.');return;}
  currentUser=user;
  G=ACCOUNTS[user].state||defaultState();
  G.username=user;
  if(!G.missions)G.missions=generateMissions();
  if(!G.marketTrend)G.marketTrend=Array.from({length:20},()=>+(0.8+Math.random()*0.4).toFixed(2));
  migrateSave();
  // Offline earnings
  if(G.lastOnline&&G.cps>0){
    const offMs=Date.now()-G.lastOnline;
    const offSecs=Math.min(offMs/1000,3600);// cap at 1hr
    const offEarned=+(offSecs*G.cps*0.5).toFixed(2);// 50% efficiency offline
    if(offEarned>0.01){
      G.balance+=offEarned;G.totalEarned+=offEarned;
      setTimeout(()=>notify(`ðŸ’¤ Offline earnings: +$${fmt(offEarned)} (${Math.floor(offSecs/60)}m offline)`,'success'),800);
    }
  }
  G.lastOnline=Date.now();
  startApp();
}
function doRegister(){
  const user=document.getElementById('reg-user').value.trim();
  const pass=document.getElementById('reg-pass').value;
  if(!user||!pass){setAuthError('Please fill all fields');return;}
  if(user.length<3){setAuthError('Username must be 3+ characters');return;}
  if(ACCOUNTS[user]){setAuthError('Username already taken');return;}
  ACCOUNTS[user]={pass,state:null};
  saveAccounts();
  currentUser=user;
  G=defaultState();
  G.username=user;
  migrateSave();
  startApp();
}
function setAuthError(msg){document.getElementById('auth-error').textContent=msg;}
function doLogout(){
  if(G)ACCOUNTS[currentUser].state=G;
  saveAccounts();
  location.reload();
}
function startApp(){
  document.getElementById('login-page').style.display='none';
  document.getElementById('app').style.display='flex';
  if(currentUser==='d3vi0us')document.getElementById('admin-nav').style.display='flex';
  if(currentUser!=='__guest__')localStorage.setItem('csroll_last_user',currentUser);
  initApp();
}

// ============================================================
// APP INIT
// ============================================================
function initApp(){
  migrateSave();
  renderSidebar();
  renderCases();
  renderUpgrades();
  renderInventory();
  renderMissions();
  renderBattlePass();
  renderStats();
  renderLeaderboard();
  renderMarket();
  renderCasino();
  renderShop();
  initPlinko();
  initRouletteBelt();
  initMinesGrid();
  startPassiveIncome();
  checkWeekend();
  checkInterest();
  checkEventState();
  updateSpecialUI();
  updateTokenDisplay();
  renderBank();
  applyTheme(G.cosmetics?.theme||'default');
  // Auto-open button visible when case is selected (done via openCaseModal)
  setInterval(saveGame,15000);
  setInterval(updateBP,1000);
  setInterval(checkInterest,60000);
  setInterval(()=>{fluctuateMarket();renderMarketChart();},5000);
  setInterval(()=>{G.lastOnline=Date.now();},30000);
  setInterval(checkLoanConsequences,300000);// every 5 min
  setInterval(()=>{earnShopCoins(1);},60000);// 1 coin/min passive
  initAppExtensions();
  showPage('clicker');
  notify('Welcome back, '+G.username+'! ðŸŽ®','success');
}

// ============================================================
// SIDEBAR/UI UPDATES
// ============================================================
function renderSidebar(){
  if(!G)return;
  const lvl=getLevel();
  const rank=getRank();
  const initials=G.username.slice(0,2).toUpperCase();
  document.getElementById('sb-balance').textContent='$'+fmt(G.balance);
  document.getElementById('sb-level').textContent='LVL '+G.level;
  document.getElementById('sb-xp-text').textContent=G.xp+' / '+xpForLevel(G.level)+' XP';
  const pct=Math.min(100,(G.xp/xpForLevel(G.level))*100);
  document.getElementById('sb-xp-bar').style.width=pct+'%';
  document.getElementById('sb-avatar').textContent=initials;
  document.getElementById('sb-username').textContent=G.username;
  document.getElementById('sb-rank').textContent=rank.icon+' '+rank.name;
  document.getElementById('top-rank').textContent=rank.short;
  document.getElementById('top-inv-count').textContent=G.inventory.length;
  document.getElementById('rebirth-count').textContent=G.rebirths;
  document.getElementById('rebirth-luck').textContent='+'+(G.rebirths*25)+'%';
  document.getElementById('profile-name').textContent=G.username;
  document.getElementById('profile-avatar').textContent=initials;
  document.getElementById('profile-rank-badge').innerHTML=rank.icon+' '+rank.name;
  document.getElementById('profile-level').textContent='Level '+G.level;
  document.getElementById('profile-xp-text').textContent=G.xp+' / '+xpForLevel(G.level)+' XP';
  document.getElementById('profile-xp-bar').style.width=pct+'%';
  document.getElementById('profile-rebirths').textContent=G.rebirths;
  document.getElementById('profile-since').textContent=G.since;
  document.getElementById('bank-total').textContent='$'+fmt(G.bankBalance);
  document.getElementById('loan-display').textContent='$'+fmt(G.loan);
  checkMissionBadge();
}

function xpForLevel(l){return 100*Math.pow(1.4,l-1)|0;}
function getLevel(){return G.level;}
function getRank(){
  for(let i=RANKS.length-1;i>=0;i--)if(G.level>=RANKS[i].min)return RANKS[i];
  return RANKS[0];
}

function addXP(amt){
  // Volatility mode affects XP
  if(G.volatilityMode==='high')amt=Math.floor(amt*0.7);
  if(G.volatilityMode==='low')amt=Math.floor(amt*1.2);
  G.xp+=amt;
  while(G.xp>=xpForLevel(G.level)){
    G.xp-=xpForLevel(G.level);
    G.level++;
    G.skillPoints=(G.skillPoints||0)+1; // 1 SP per level-up
    G.bpXP+=50;
    notify('ðŸŽ‰ Level Up! Level '+G.level+' â€” +1 Skill Point!','success');
    checkBPLevelUp();
    updateSkillBadge();
    // Unlock High Roller at 25
    if(G.level===25)notify('ðŸ’Ž High Roller Room Unlocked! (Level 25)','rare');
    // Update rival to track player
    if(G.rival){G.rival.level=Math.max(1,G.level-Math.floor(Math.random()*4+1));G.rival.balance=G.balance*(0.6+Math.random()*0.8);}
  }
  renderSidebar();
}
function addBalance(amt,label,type='win'){
  G.balance+=amt;
  G.totalEarned+=Math.max(0,amt);
  addHistory(label,amt,type);
  if(G.balance<0)G.balance=0;
  renderSidebar();
  saveGame();
}
function fmt(n){return Number(n).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,',');}
function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebar-overlay').classList.toggle('open');
}
function closeSidebar(){
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebar-overlay').classList.remove('open');
}

// ============================================================
// HISTORY
// ============================================================
function addHistory(desc,val,type='neutral'){
  const item={desc,val,type,time:Date.now()};
  G.history.unshift(item);
  if(G.history.length>100)G.history.pop();
  const panel=document.getElementById('history-panel');
  const statsPanel=document.getElementById('stats-history');
  renderHistoryPanel(panel);
  renderHistoryPanel(statsPanel);
  // track net worth
  G.netWorthSamples.push({t:Date.now(),v:G.balance+G.bankBalance+inventoryValue()});
  if(G.netWorthSamples.length>50)G.netWorthSamples.shift();
}
function renderHistoryPanel(panel){
  if(!panel)return;
  panel.innerHTML=G.history.slice(0,30).map(h=>{
    const cls=h.val>0?'pos':h.val<0?'neg':'';
    const prefix=h.val>0?'+':'';
    return `<div class="history-item"><span class="history-icon">${h.val>0?'ðŸ’š':'â¤ï¸'}</span><span class="history-desc">${h.desc}</span><span class="history-val ${cls}">${prefix}$${fmt(Math.abs(h.val))}</span><span class="history-time">${timeAgo(h.time)}</span></div>`;
  }).join('');
}
function timeAgo(t){
  const d=(Date.now()-t)/1000;
  if(d<60)return d|0+'s';if(d<3600)return (d/60|0)+'m';return (d/3600|0)+'h';
}
function inventoryValue(){return G.inventory.reduce((s,i)=>s+i.price,0);}

// ============================================================
// CLICKER
// ============================================================
function doClick(e){
  playSound('click');
  const val=G.clickValue*(1+G.rebirths*0.1);
  G.balance+=val;G.totalEarned+=val;G.totalClicks++;G.clicks++;
  // Float text
  const btn=document.getElementById('click-btn');
  const rect=btn.getBoundingClientRect();
  const span=document.createElement('div');
  span.className='float-text';
  span.textContent='+$'+val.toFixed(2);
  span.style.cssText=`left:${e.clientX-rect.left-20}px;top:${e.clientY-rect.top-20}px;position:absolute;pointer-events:none`;
  btn.parentElement.style.position='relative';
  btn.parentElement.appendChild(span);
  setTimeout(()=>span.remove(),800);
  addXP(1);
  updateClickerDisplay();
  checkMissions();
  renderSidebar();
}
function updateClickerDisplay(){
  document.getElementById('click-val-display').textContent='+$'+fmt(G.clickValue*(1+G.rebirths*0.1))+' per click';
  document.getElementById('total-clicks-display').textContent=fmt(G.totalClicks)+' total clicks';
  document.getElementById('cps-display').textContent='$'+fmt(G.cps*(1+G.rebirths*0.1))+'/s';
}
function startPassiveIncome(){
  setInterval(()=>{
    if(!G)return;
    const earned=G.cps*(1+G.rebirths*0.1)/10;
    G.balance+=earned;G.totalEarned+=earned;
    renderSidebar();
    updateClickerDisplay();
  },100);
}
function doRebirth(){
  if(G.balance<100000){notify('Need $100,000 to Rebirth!','error');return;}
  if(!confirm('Rebirth? You lose all cash and upgrades but gain permanent +25% luck and keep inventory.'))return;
  G.rebirths++;
  G.luckBonus=G.rebirths*25;
  G.balance=0;
  G.cps=0;G.clickValue=0.50;
  G.upgrades={};
  renderUpgrades();
  notify('ðŸ”¥ Rebirth #'+G.rebirths+'! +25% Luck bonus!','success');
  renderSidebar();
  addXP(500);
}

function renderUpgrades(){
  const grid=document.getElementById('upgrades-grid');
  const cats={click:'ðŸ–±ï¸ Click Power',passive:'ðŸ’° Passive Income',luck:'ðŸ€ Luck Boosts'};
  let html='';
  Object.keys(cats).forEach(cat=>{
    html+=`<div style="grid-column:1/-1;margin-top:8px"><div class="section-title" style="font-size:15px">${cats[cat]}</div></div>`;
    UPGRADES.filter(u=>u.cat===cat).forEach(u=>{
      const count=G.upgrades[u.id]||0;
      const atMax=u.max&&count>=u.max;
      const nextCost=Math.ceil(u.cost*Math.pow(1.5,count));
      const canAfford=G.balance>=nextCost;
      const pct=Math.min(100,u.max?count/u.max*100:0);
      const perPurchaseLabel=u.clickAdd?`+$${u.clickAdd}/click`:u.cpsAdd?`+$${u.cpsAdd}/s`:u.luckAdd?`+${u.luckAdd}% luck`:'';
      html+=`<div class="upgrade-card ${atMax?'owned':canAfford?'':'locked'}" onclick="purchaseUpgrade('${u.id}')">
        <div class="upgrade-icon">${u.icon}</div>
        <div class="upgrade-info">
          <div class="upgrade-name">${u.name} ${count>0?`<span style="color:var(--accent);font-size:11px">Lv${count}</span>`:''}</div>
          <div class="upgrade-desc">${perPurchaseLabel}</div>
          <div style="background:var(--bg5);height:3px;border-radius:2px;margin:5px 0;overflow:hidden"><div style="height:100%;width:${pct}%;background:${atMax?'var(--green)':'var(--accent)'};border-radius:2px;transition:width .3s"></div></div>
          <div class="upgrade-cost">${atMax?`<span style="color:var(--green)">â˜… MAX (${count}/${u.max})</span>`:canAfford?`$${fmt(nextCost)}<span style="color:var(--text3);font-size:10px;margin-left:4px">${count+1}/${u.max}</span>`:`<span style="color:var(--text3)">$${fmt(nextCost)}</span>`}</div>
        </div>
      </div>`;
    });
  });
  grid.innerHTML=html;
}
function purchaseUpgrade(id){
  const u=UPGRADES.find(x=>x.id===id);
  if(!u)return;
  const count=G.upgrades[id]||0;
  if(u.max&&count>=u.max){notify('Max level reached!','error');return;}
  const cost=Math.ceil(u.cost*Math.pow(1.5,count));
  if(G.balance<cost){notify('Not enough funds!','error');return;}
  G.balance-=cost;
  G.upgrades[id]=(count+1);
  if(u.clickAdd)G.clickValue+=u.clickAdd;
  if(u.cpsAdd)G.cps+=u.cpsAdd;
  if(u.luckAdd)G.luckBonus=(G.luckBonus||0)+u.luckAdd;
  addHistory('Upgrade: '+u.name+' Lv'+(count+1),-cost,'expense');
  playSound('buy');
  notify(u.name+' â†’ Level '+(count+1)+'!','success');
  renderUpgrades();
  renderSidebar();
}

// ============================================================
// CASES
// ============================================================
let currentCase=null,openQty=1,lastWin=null,multiWins=[];

// SVG Art Generator for cases
function getCaseSVG(c){
  const col = c.color;
  const themes = {
    blue:`<polygon points="40,12 65,30 65,50 40,58 15,50 15,30" fill="none" stroke="${col}" stroke-width="1.5" opacity="0.8"/><circle cx="40" cy="35" r="10" fill="${col}" opacity="0.3"/><circle cx="40" cy="35" r="5" fill="${col}" opacity="0.7"/>`,
    purple:`<rect x="18" y="18" width="44" height="34" rx="3" fill="none" stroke="${col}" stroke-width="1.5" opacity="0.8"/><line x1="18" y1="28" x2="62" y2="28" stroke="${col}" stroke-width="1" opacity="0.5"/><circle cx="40" cy="41" r="6" fill="${col}" opacity="0.5"/>`,
    pink:`<ellipse cx="40" cy="35" rx="22" ry="18" fill="none" stroke="${col}" stroke-width="1.5" opacity="0.8"/><path d="M28,25 Q40,15 52,25 Q60,35 52,45 Q40,55 28,45 Q20,35 28,25Z" fill="${col}" opacity="0.2"/>`,
    gold:`<polygon points="40,10 50,25 66,25 54,37 58,53 40,44 22,53 26,37 14,25 30,25" fill="none" stroke="${col}" stroke-width="1.5" opacity="0.9"/><polygon points="40,18 46,28 57,28 49,34 51,46 40,39 29,46 31,34 23,28 34,28" fill="${col}" opacity="0.3"/>`,
    cyan:`<path d="M40,12 L60,22 L60,48 L40,58 L20,48 L20,22Z" fill="none" stroke="${col}" stroke-width="1.5" opacity="0.8"/><path d="M30,30 L50,30 L50,42 L30,42Z" fill="none" stroke="${col}" stroke-width="1" opacity="0.5"/>`,
    knife:`<path d="M25,15 L55,20 L58,45 L40,52 L22,45Z" fill="none" stroke="${col}" stroke-width="2" opacity="0.9"/><path d="M35,25 L48,28 L48,42 L35,42Z" fill="${col}" opacity="0.4"/><circle cx="40" cy="18" r="3" fill="${col}"/>`,
    orange:`<rect x="15" y="18" width="50" height="34" rx="6" fill="none" stroke="${col}" stroke-width="1.5" opacity="0.8"/><path d="M20,28 Q40,18 60,28" fill="none" stroke="${col}" stroke-width="1.5" opacity="0.6"/><rect x="28" y="32" width="24" height="12" rx="3" fill="${col}" opacity="0.3"/>`,
    green:`<polygon points="40,12 62,24 62,46 40,58 18,46 18,24" fill="none" stroke="${col}" stroke-width="1.5" opacity="0.8"/><polygon points="40,20 56,29 56,43 40,52 24,43 24,29" fill="${col}" opacity="0.2"/><circle cx="40" cy="35" r="5" fill="${col}" opacity="0.7"/>`,
    ice:`<polygon points="40,12 55,20 60,36 55,52 40,58 25,52 20,36 25,20" fill="none" stroke="${col}" stroke-width="1.5" opacity="0.8"/><line x1="40" y1="12" x2="40" y2="58" stroke="${col}" stroke-width="0.5" opacity="0.4"/><line x1="20" y1="36" x2="60" y2="36" stroke="${col}" stroke-width="0.5" opacity="0.4"/>`,
    dark:`<rect x="16" y="16" width="48" height="38" rx="4" fill="none" stroke="${col}" stroke-width="1.5" opacity="0.7"/><rect x="22" y="22" width="36" height="26" rx="2" fill="${col}" opacity="0.15"/><circle cx="40" cy="35" r="7" fill="none" stroke="${col}" stroke-width="1.5" opacity="0.6"/>`,
    tan:`<circle cx="40" cy="35" r="22" fill="none" stroke="${col}" stroke-width="1.5" opacity="0.8"/><circle cx="40" cy="35" r="15" fill="none" stroke="${col}" stroke-width="1" opacity="0.5"/><circle cx="40" cy="35" r="6" fill="${col}" opacity="0.5"/>`,
    red:`<path d="M20,20 L60,20 L65,50 L40,58 L15,50Z" fill="none" stroke="${col}" stroke-width="1.5" opacity="0.8"/><path d="M25,25 L55,25 L60,48 L40,54 L20,48Z" fill="${col}" opacity="0.2"/>`,
    spectrum:`<path d="M40,12 A28,28 0,1,1,39.9,12" fill="none" stroke="${col}" stroke-width="1.5" opacity="0.8"/><path d="M40,20 A20,20 0,1,1,39.9,20" fill="none" stroke="${col}" stroke-width="1" opacity="0.5"/><path d="M40,28 A12,12 0,1,1,39.9,28" fill="${col}" opacity="0.3"/>`,
    sunset:`<path d="M15,45 Q40,10 65,45 Z" fill="none" stroke="${col}" stroke-width="1.5" opacity="0.8"/><path d="M20,45 Q40,18 60,45" fill="none" stroke="${col}" stroke-width="1" opacity="0.5"/><ellipse cx="40" cy="45" rx="18" ry="5" fill="${col}" opacity="0.3"/>`,
    prism:`<polygon points="40,10 65,55 15,55" fill="none" stroke="${col}" stroke-width="1.5" opacity="0.9"/><line x1="40" y1="10" x2="40" y2="55" stroke="${col}" stroke-width="0.5" opacity="0.4"/><polygon points="40,20 58,52 22,52" fill="${col}" opacity="0.2"/>`,
    anniversary:`<circle cx="40" cy="35" r="23" fill="none" stroke="${col}" stroke-width="2" opacity="0.8"/><text x="40" y="31" text-anchor="middle" font-size="9" fill="${col}" font-weight="700" opacity="0.9">CS</text><text x="40" y="43" text-anchor="middle" font-size="7" fill="${col}" opacity="0.7">20 YEARS</text>`,
    nightmare:`<path d="M22,15 Q40,8 58,15 L62,55 L40,62 L18,55Z" fill="none" stroke="${col}" stroke-width="1.5" opacity="0.8"/><path d="M32,28 Q40,22 48,28 Q52,35 48,42 Q40,48 32,42 Q28,35 32,28Z" fill="${col}" opacity="0.3"/>`,
    cyber:`<rect x="14" y="14" width="52" height="42" rx="2" fill="none" stroke="${col}" stroke-width="1.5" opacity="0.8"/><line x1="14" y1="24" x2="66" y2="24" stroke="${col}" stroke-width="1" opacity="0.4"/><line x1="14" y1="46" x2="66" y2="46" stroke="${col}" stroke-width="1" opacity="0.4"/><rect x="22" y="28" width="16" height="14" rx="1" fill="${col}" opacity="0.3"/><rect x="42" y="28" width="16" height="14" rx="1" fill="${col}" opacity="0.3"/>`,
    neon:`<circle cx="40" cy="35" r="22" fill="none" stroke="${col}" stroke-width="2" opacity="0.8"/><circle cx="40" cy="35" r="14" fill="none" stroke="${col}" stroke-width="1" opacity="0.5"/><path d="M28,35 Q34,22 40,20 Q46,22 52,35 Q46,48 40,50 Q34,48 28,35Z" fill="${col}" opacity="0.25"/>`,
    electric:`<polygon points="40,10 58,22 64,40 50,55 30,55 16,40 22,22" fill="none" stroke="${col}" stroke-width="1.5" opacity="0.9"/><path d="M44,18 L36,36 L44,36 L36,52" fill="none" stroke="${col}" stroke-width="2.5" stroke-linecap="round"/>`,
    art:`<rect x="15" y="15" width="50" height="40" rx="3" fill="none" stroke="${col}" stroke-width="1.5" opacity="0.8"/><rect x="20" y="20" width="20" height="15" rx="2" fill="${col}" opacity="0.3"/><rect x="44" y="20" width="16" height="15" rx="2" fill="${col}" opacity="0.2"/><rect x="20" y="39" width="40" height="10" rx="2" fill="${col}" opacity="0.2"/>`,
    souvenir:`<polygon points="40,10 52,28 70,28 56,40 62,58 40,46 18,58 24,40 10,28 28,28" fill="none" stroke="${col}" stroke-width="2" opacity="0.9"/><polygon points="40,18 49,31 62,31 52,38 56,52 40,43 24,52 28,38 18,31 31,31" fill="${col}" opacity="0.35"/>`,
    halloween:`<path d="M25,20 Q40,8 55,20 L58,50 Q50,58 40,60 Q30,58 22,50Z" fill="none" stroke="${col}" stroke-width="1.5" opacity="0.8"/><ellipse cx="33" cy="34" rx="5" ry="7" fill="${col}" opacity="0.4"/><ellipse cx="47" cy="34" rx="5" ry="7" fill="${col}" opacity="0.4"/><path d="M32,46 Q40,52 48,46" fill="none" stroke="${col}" stroke-width="2"/>`,
    christmas:`<polygon points="40,10 55,30 65,30 50,45 55,60 40,50 25,60 30,45 15,30 25,30" fill="none" stroke="${col}" stroke-width="1.5" opacity="0.9"/><circle cx="40" cy="30" r="4" fill="${col}" opacity="0.7"/><circle cx="30" cy="42" r="3" fill="${col}" opacity="0.5"/><circle cx="50" cy="42" r="3" fill="${col}" opacity="0.5"/>`,
    summer:`<circle cx="40" cy="35" r="22" fill="none" stroke="${col}" stroke-width="2" opacity="0.9"/><path d="M40,13 L40,57 M18,35 L62,35 M24,19 L56,51 M56,19 L24,51" stroke="${col}" stroke-width="1" opacity="0.4"/>`,
    ancient:`<path d="M22,58 L18,20 L40,12 L62,20 L58,58Z" fill="none" stroke="${col}" stroke-width="1.5" opacity="0.8"/><path d="M29,52 L26,24 L40,18 L54,24 L51,52Z" fill="${col}" opacity="0.2"/><circle cx="40" cy="35" r="8" fill="none" stroke="${col}" stroke-width="1.5" opacity="0.6"/><circle cx="40" cy="35" r="3" fill="${col}" opacity="0.7"/>`,
    violet:`<rect x="15" y="15" width="50" height="40" rx="8" fill="none" stroke="${col}" stroke-width="1.5" opacity="0.8"/><circle cx="40" cy="25" r="8" fill="${col}" opacity="0.3"/><rect x="22" y="36" width="36" height="12" rx="4" fill="${col}" opacity="0.25"/>`,
    teal:`<hexagon/><polygon points="40,10 62,22 62,48 40,60 18,48 18,22" fill="none" stroke="${col}" stroke-width="1.5" opacity="0.8"/><polygon points="40,18 56,27 56,43 40,52 24,43 24,27" fill="${col}" opacity="0.2"/><line x1="30" y1="35" x2="50" y2="35" stroke="${col}" stroke-width="1.5" opacity="0.6"/>`,
  };
  const shape = themes[c.theme] || themes.blue;
  return `<svg width="80" height="70" viewBox="0 0 80 70" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="cg${c.id}" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stop-color="${col}" stop-opacity="0.25"/>
        <stop offset="100%" stop-color="#080910" stop-opacity="1"/>
      </linearGradient>
      <filter id="glow${c.id}"><feGaussianBlur stdDeviation="2" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
    </defs>
    <rect width="80" height="70" rx="8" fill="url(#cg${c.id})"/>
    <rect x="0" y="0" width="80" height="8" rx="8" fill="${col}" opacity="0.5"/>
    <rect x="0" y="6" width="80" height="2" fill="${col}" opacity="0.3"/>
    <g filter="url(#glow${c.id})" transform="translate(0,3)">${shape}</g>
    <rect x="20" y="60" width="40" height="4" rx="2" fill="${col}" opacity="0.4"/>
  </svg>`;
}

// SVG skin art generator
// ============================================================
// ADVANCED SKIN ART ENGINE v2 â€” Weapon-specific detailed SVGs
// ============================================================
function getSkinGradients(skin, gid){
  const c=RARITIES[skin.rarity].color;
  const f=skin.finish||'';
  // Wear overlay intensity based on float
  const wearAlpha=Math.min(0.5,skin.float*0.6);
  const wearLines=skin.float>0.38?`<rect width="100" height="80" fill="none" stroke="rgba(0,0,0,${wearAlpha})" stroke-width="0.3" stroke-dasharray="2,3" opacity="${wearAlpha}"/>`:'' ;
  let defs=`<linearGradient id="${gid}" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="${c}"/><stop offset="100%" stop-color="#050608"/></linearGradient>`;
  let bgFx='';
  if(f.includes('Doppler')||f.includes('Case Hardened')){
    defs=`<radialGradient id="${gid}" cx="35%" cy="35%"><stop offset="0%" stop-color="${c}"/><stop offset="40%" stop-color="#6a0080"/><stop offset="80%" stop-color="#00228a"/><stop offset="100%" stop-color="#050608"/></radialGradient>`;
    bgFx=`<ellipse cx="28" cy="22" rx="18" ry="10" fill="url(#${gid})" opacity="0.35" filter="url(#blur${gid})"/><ellipse cx="65" cy="45" rx="12" ry="8" fill="${c}" opacity="0.2" filter="url(#blur${gid})"/>`;
    defs+=`<filter id="blur${gid}"><feGaussianBlur stdDeviation="3"/></filter>`;
  } else if(f.includes('Fade')){
    defs=`<linearGradient id="${gid}" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#ff6b35"/><stop offset="30%" stop-color="#d32ce6"/><stop offset="70%" stop-color="${c}"/><stop offset="100%" stop-color="#4b69ff"/></linearGradient>`;
  } else if(f.includes('Tiger')||f.includes('Tooth')){
    defs=`<linearGradient id="${gid}" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#f0a500"/><stop offset="50%" stop-color="#e8922a"/><stop offset="100%" stop-color="#050608"/></linearGradient>`;
    bgFx=`<line x1="25" y1="0" x2="15" y2="80" stroke="#000" stroke-width="2.5" opacity="0.35"/><line x1="40" y1="0" x2="30" y2="80" stroke="#000" stroke-width="1.5" opacity="0.25"/><line x1="58" y1="0" x2="48" y2="80" stroke="#000" stroke-width="2" opacity="0.3"/>`;
  } else if(f.includes('Hyper')||f.includes('Beast')){
    defs=`<linearGradient id="${gid}" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#f0a500"/><stop offset="100%" stop-color="${c}"/></linearGradient>`;
    bgFx=`<rect x="0" y="0" width="8" height="80" fill="${c}" opacity="0.15"/><rect x="18" y="0" width="5" height="80" fill="${c}" opacity="0.1"/><rect x="30" y="0" width="8" height="80" fill="${c}" opacity="0.15"/>`;
  } else if(f.includes('Slaughter')||f.includes('Blood')||f.includes('Crimson')){
    defs=`<linearGradient id="${gid}" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#eb4b4b"/><stop offset="60%" stop-color="#8a0000"/><stop offset="100%" stop-color="#050608"/></linearGradient>`;
    bgFx=`<ellipse cx="50" cy="40" rx="30" ry="20" fill="#eb4b4b" opacity="0.08"/>`;
  } else if(f.includes('Galaxy')||f.includes('Stardust')||f.includes('Night')){
    defs=`<radialGradient id="${gid}" cx="50%" cy="50%"><stop offset="0%" stop-color="${c}"/><stop offset="100%" stop-color="#000020"/></radialGradient>`;
    bgFx=`<circle cx="20" cy="15" r="1" fill="white" opacity="0.7"/><circle cx="40" cy="25" r="0.8" fill="white" opacity="0.6"/><circle cx="60" cy="10" r="1.2" fill="white" opacity="0.8"/><circle cx="75" cy="30" r="0.7" fill="white" opacity="0.5"/><circle cx="35" cy="55" r="1" fill="${c}" opacity="0.9"/><circle cx="80" cy="55" r="0.9" fill="white" opacity="0.6"/>`;
  } else if(f.includes('Marble')||f.includes('Stone')){
    defs=`<linearGradient id="${gid}" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="white" stop-opacity="0.8"/><stop offset="40%" stop-color="${c}" stop-opacity="0.6"/><stop offset="100%" stop-color="#1a1b23"/></linearGradient>`;
    bgFx=`<path d="M10,20 Q40,35 20,50 Q50,40 80,60" fill="none" stroke="white" stroke-width="1.5" opacity="0.2"/><path d="M0,40 Q30,25 60,45 Q80,52 100,38" fill="none" stroke="white" stroke-width="1" opacity="0.15"/>`;
  }
  return {defs, bgFx, wearLines};
}

function getSkinSVG(skin){
  const c=RARITIES[skin.rarity].color;
  const isKnife=skin.rarity==='knife';
  const gid=`sg${skin.id.toString().slice(-6).replace('.','_')}`;
  const {defs,bgFx,wearLines}=getSkinGradients(skin,gid);
  const wn=skin.weapon||'';
  // Highlight shimmer
  const shimmer=`<rect x="0" y="0" width="100" height="6" fill="rgba(255,255,255,0.05)"/>`;
  // StatTrak indicator
  const st=skin.statTrak?`<rect x="2" y="2" width="12" height="5" rx="1" fill="#f0a50090"/><text x="8" y="6" text-anchor="middle" font-size="3.5" fill="#000" font-weight="700">ST</text>`:'';
  // Float wear bar at bottom
  const fw=skin.float||0;
  const fwPct=Math.round(fw*100);
  const fwCol=fw<0.15?'#2ecc71':fw<0.38?'#f0a500':fw<0.45?'#ff6b35':'#e74c3c';
  const footerBar=`<rect x="8" y="72" width="84" height="2" rx="1" fill="#1a1b23"/><rect x="8" y="72" width="${fwPct*0.84}" height="2" rx="1" fill="${fwCol}"/>`;
  const label=`<text x="50" y="71" text-anchor="middle" font-size="4.5" fill="rgba(255,255,255,0.35)" font-family="Barlow Condensed">${skin.wear} â€¢ ${fw.toFixed(4)}</text>`;

  if(isKnife){
    // Knife type determines shape
    let bladePath='', handlePath='', guardPath='';
    if(wn.includes('Karambit')){
      bladePath=`<path d="M22,42 Q38,18 62,22 Q72,24 72,30 Q65,26 55,28 Q38,30 26,44Z" fill="url(#${gid})" opacity="0.92"/><path d="M62,22 Q72,24 72,30 L65,32 Q70,27 62,25Z" fill="${c}" opacity="0.7"/><circle cx="20" cy="44" r="5" fill="none" stroke="${c}" stroke-width="1.5" opacity="0.8"/><circle cx="20" cy="44" r="2.5" fill="${c}" opacity="0.4"/>`;
      handlePath=`<rect x="22" y="41" width="18" height="8" rx="3" fill="#1e1f28"/><rect x="23" y="42" width="16" height="6" rx="2" fill="${c}" opacity="0.3"/><line x1="25" y1="44" x2="37" y2="44" stroke="${c}" stroke-width="0.5" opacity="0.6"/>`;
    } else if(wn.includes('Butterfly')){
      bladePath=`<path d="M15,40 L72,28 L76,34 L72,40 L15,44Z" fill="url(#${gid})" opacity="0.9"/><line x1="15" y1="42" x2="72" y2="34" stroke="${c}" stroke-width="0.6" opacity="0.6"/><path d="M72,28 L76,34 L72,40 L74,34Z" fill="${c}" opacity="0.5"/>`;
      handlePath=`<rect x="14" y="38" width="22" height="9" rx="2" fill="#1a1b23"/><rect x="15" y="39" width="20" height="7" rx="1.5" fill="${c}" opacity="0.25"/><circle cx="36" cy="42.5" r="1" fill="${c}" opacity="0.6"/>`;
      guardPath=`<rect x="35" y="36" width="3" height="12" rx="1" fill="${c}" opacity="0.7"/>`;
    } else if(wn.includes('M9')||wn.includes('Bayonet')){
      bladePath=`<path d="M18,38 L76,30 L80,34 L76,40 L60,42 L18,44Z" fill="url(#${gid})" opacity="0.9"/><path d="M60,42 L76,40 L80,34 L76,36 L60,38Z" fill="${c}" opacity="0.3"/>`;
      handlePath=`<rect x="16" y="36" width="24" height="10" rx="3" fill="#15161e"/><rect x="17" y="37" width="22" height="8" rx="2" fill="${c}" opacity="0.2"/>`;
      guardPath=`<rect x="39" y="34" width="4" height="14" rx="1.5" fill="${c}" opacity="0.6"/>`;
    } else {
      // Generic knife
      bladePath=`<path d="M14,40 L72,26 L79,32 L79,40 L72,46 L14,44Z" fill="url(#${gid})" opacity="0.9"/><line x1="14" y1="42" x2="72" y2="36" stroke="${c}" stroke-width="0.7" opacity="0.5"/>`;
      handlePath=`<rect x="13" y="37" width="22" height="11" rx="3" fill="#1a1b23"/><rect x="14" y="38" width="20" height="9" rx="2" fill="${c}" opacity="0.22"/><line x1="16" y1="42" x2="32" y2="42" stroke="${c}" stroke-width="0.5" opacity="0.5"/>`;
      guardPath=`<rect x="34" y="35" width="3.5" height="13" rx="1.5" fill="${c}" opacity="0.65"/>`;
    }
    return `<svg width="100%" height="100%" viewBox="0 0 100 80" xmlns="http://www.w3.org/2000/svg">
      <defs>${defs}<filter id="glow${gid}"><feGaussianBlur stdDeviation="1.5" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs>
      <rect width="100" height="80" fill="#08090f"/>
      ${bgFx}
      <rect width="100" height="80" fill="url(#${gid})" opacity="0.06"/>
      ${bladePath}${guardPath}${handlePath}
      ${wearLines}${shimmer}${st}
      <text x="50" y="61" text-anchor="middle" font-size="5.5" fill="${c}" opacity="0.8" font-family="Barlow Condensed" font-weight="700">${wn.replace('â˜… ','')}</text>
      <text x="50" y="68" text-anchor="middle" font-size="4.5" fill="rgba(255,255,255,0.4)" font-family="Barlow Condensed">${(skin.finish||'').slice(0,16)}</text>
      ${label}${footerBar}
    </svg>`;
  }

  // â”€â”€â”€ GUN SHAPES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let body='', extras='';
  const R=`url(#${gid})`;
  if(wn.includes('AK')){
    body=`<path d="M8,36 L68,36 L70,31 L64,27 L28,27 L26,31 L8,31Z" fill="${R}" opacity="0.9"/>`;
    extras=`<rect x="12" y="31" width="9" height="5" rx="1" fill="${c}" opacity="0.5"/><rect x="58" y="28" width="10" height="3" rx="1" fill="${c}" opacity="0.65"/><path d="M26,31 L30,27 L34,27 L30,31Z" fill="${c}" opacity="0.35"/><line x1="68" y1="33" x2="75" y2="33" stroke="${c}" stroke-width="1.8" stroke-linecap="round" opacity="0.8"/><rect x="40" y="36" width="12" height="7" rx="1" fill="#0d0e14"/><rect x="41" y="37" width="10" height="5" rx="0.5" fill="${c}" opacity="0.2"/>`;
  } else if(wn.includes('AWP')){
    body=`<path d="M6,34 L78,34 L80,29 L32,27 L8,29Z" fill="${R}" opacity="0.9"/>`;
    extras=`<rect x="48" y="22" width="22" height="7" rx="2" fill="${c}" opacity="0.6"/><circle cx="71" cy="25.5" r="4" fill="none" stroke="${c}" stroke-width="1.2" opacity="0.8"/><line x1="78" y1="31" x2="84" y2="31" stroke="${c}" stroke-width="2" stroke-linecap="round" opacity="0.9"/><rect x="14" y="34" width="8" height="8" rx="1" fill="#0d0e14"/><rect x="15" y="35" width="6" height="6" rx="0.5" fill="${c}" opacity="0.2"/>`;
  } else if(wn.includes('M4A1')||wn.includes('M4A4')){
    body=`<path d="M9,36 L70,36 L73,31 L66,27 L28,27 L26,31 L9,31Z" fill="${R}" opacity="0.9"/>`;
    extras=`<rect x="12" y="31" width="9" height="5" rx="1" fill="${c}" opacity="0.5"/><rect x="57" y="28" width="11" height="3" rx="1" fill="${c}" opacity="0.6"/><line x1="70" y1="33" x2="77" y2="33" stroke="${c}" stroke-width="2" stroke-linecap="round" opacity="0.8"/><rect x="38" y="36" width="11" height="7" rx="1" fill="#0d0e14"/><rect x="39" y="37" width="9" height="5" rx="0.5" fill="${c}" opacity="0.2"/>`;
  } else if(wn.includes('Glock')||wn.includes('USP')||wn.includes('P2000')||wn.includes('P250')){
    body=`<path d="M12,34 L68,34 L70,29 L62,25 L28,25 L24,29 L12,29Z" fill="${R}" opacity="0.9"/>`;
    extras=`<rect x="24" y="34" width="14" height="12" rx="2" fill="#0d0e14"/><rect x="25" y="35" width="12" height="10" rx="1.5" fill="${c}" opacity="0.2"/><line x1="68" y1="31" x2="74" y2="31" stroke="${c}" stroke-width="1.8" stroke-linecap="round" opacity="0.9"/>`;
  } else if(wn.includes('Desert')||wn.includes('Deagle')){
    body=`<path d="M10,35 L66,35 L69,29 L60,24 L26,24 L22,29 L10,29Z" fill="${R}" opacity="0.9"/>`;
    extras=`<rect x="22" y="35" width="14" height="13" rx="2" fill="#0d0e14"/><rect x="23" y="36" width="12" height="11" rx="1.5" fill="${c}" opacity="0.22"/><line x1="66" y1="32" x2="73" y2="32" stroke="${c}" stroke-width="2" stroke-linecap="round" opacity="0.9"/>`;
  } else if(wn.includes('MP5')||wn.includes('MP9')||wn.includes('MAC')||wn.includes('P90')){
    body=`<path d="M10,37 L72,37 L74,32 L68,28 L22,28 L20,32 L10,32Z" fill="${R}" opacity="0.9"/>`;
    extras=`<rect x="14" y="32" width="8" height="5" rx="1" fill="${c}" opacity="0.5"/><rect x="58" y="29" width="12" height="3" rx="1" fill="${c}" opacity="0.6"/><line x1="72" y1="34" x2="78" y2="34" stroke="${c}" stroke-width="1.6" stroke-linecap="round" opacity="0.8"/>`;
  } else if(wn.includes('SG')||wn.includes('AUG')){
    body=`<path d="M8,36 L72,36 L75,30 L66,26 L26,26 L24,30 L8,30Z" fill="${R}" opacity="0.9"/>`;
    extras=`<circle cx="70" cy="28" r="3.5" fill="none" stroke="${c}" stroke-width="1" opacity="0.7"/><rect x="12" y="30" width="10" height="6" rx="1" fill="${c}" opacity="0.4"/><line x1="72" y1="33" x2="79" y2="33" stroke="${c}" stroke-width="1.8" stroke-linecap="round" opacity="0.9"/>`;
  } else if(wn.includes('SSG')||wn.includes('SCAR')||wn.includes('G3SG')){
    body=`<path d="M6,34 L80,34 L82,29 L74,25 L22,25 L18,29 L6,29Z" fill="${R}" opacity="0.9"/>`;
    extras=`<rect x="52" y="20" width="18" height="6" rx="1.5" fill="${c}" opacity="0.6"/><line x1="80" y1="31" x2="86" y2="31" stroke="${c}" stroke-width="2" stroke-linecap="round" opacity="0.9"/>`;
  } else {
    // Default rifle
    body=`<path d="M9,36 L71,36 L74,31 L66,27 L30,27 L27,31 L9,31Z" fill="${R}" opacity="0.9"/>`;
    extras=`<rect x="12" y="31" width="9" height="5" rx="1" fill="${c}" opacity="0.5"/><rect x="57" y="28" width="11" height="3" rx="1" fill="${c}" opacity="0.6"/><line x1="71" y1="33" x2="78" y2="33" stroke="${c}" stroke-width="2" stroke-linecap="round" opacity="0.9"/>`;
  }

  // Finish overlay effects on gun body
  let finishOverlay='';
  const f=skin.finish||'';
  if(f.includes('Tiger')||f.includes('Tooth')){
    finishOverlay=`<line x1="25" y1="25" x2="18" y2="40" stroke="#000" stroke-width="2.5" opacity="0.3"/><line x1="38" y1="25" x2="31" y2="40" stroke="#000" stroke-width="1.8" opacity="0.22"/><line x1="50" y1="25" x2="44" y2="40" stroke="#000" stroke-width="2" opacity="0.25"/>`;
  } else if(f.includes('Doppler')||f.includes('Case Hardened')){
    finishOverlay=`<ellipse cx="35" cy="32" rx="14" ry="6" fill="#8800cc" opacity="0.2" filter="url(#blur${gid})"/><ellipse cx="55" cy="30" rx="10" ry="5" fill="#0044ff" opacity="0.18" filter="url(#blur${gid})"/>`;
  } else if(f.includes('Marble')||f.includes('Stone')){
    finishOverlay=`<path d="M15,28 Q30,35 25,38 Q40,32 55,36" fill="none" stroke="rgba(255,255,255,0.22)" stroke-width="1.2"/>`;
  }

  return `<svg width="100%" height="100%" viewBox="0 0 100 80" xmlns="http://www.w3.org/2000/svg">
    <defs>${defs}<filter id="glow${gid}"><feGaussianBlur stdDeviation="2" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs>
    <rect width="100" height="80" fill="#08090f"/>
    ${bgFx}
    <rect width="100" height="80" fill="url(#${gid})" opacity="0.07"/>
    ${body}${extras}${finishOverlay}
    ${wearLines}${shimmer}${st}
    <text x="50" y="58" text-anchor="middle" font-size="5.5" fill="${c}" opacity="0.85" font-family="Barlow Condensed" font-weight="700">${wn.slice(0,14)}</text>
    <text x="50" y="65" text-anchor="middle" font-size="4.8" fill="rgba(255,255,255,0.45)" font-family="Barlow Condensed">${f.slice(0,16)}</text>
    ${label}${footerBar}
  </svg>`;
}

function renderCases(){
  const grid=document.getElementById('cases-grid');
  const bcs=document.getElementById('battle-case-select');
  if(bcs)bcs.innerHTML=CASES.map(c=>`<option value="${c.id}">${c.name} ($${fmt(c.price)})</option>`).join('');
  grid.innerHTML=CASES.map(c=>`
    <div class="case-card" onclick="openCaseModal('${c.id}')" style="border-color:${c.color}30">
      <div class="case-shine"></div>
      <div class="case-img" style="display:flex;align-items:center;justify-content:center;filter:drop-shadow(0 0 12px ${c.color}80)">${getCaseSVG(c)}</div>
      <div class="case-name">${c.name}</div>
      <div class="case-price" style="color:${c.price>5?'var(--gold)':c.price>1?'var(--accent)':'var(--text2)'}">$${fmt(c.price)}</div>
      ${c.special?`<div style="font-size:10px;color:${c.color};margin-top:2px;font-weight:600">${c.special}</div>`:''}
    </div>
  `).join('');
}
function openCaseModal(id){
  currentCase=CASES.find(c=>c.id===id);
  if(!currentCase)return;
  document.getElementById('modal-case-name').textContent=currentCase.name;
  document.getElementById('case-modal').style.display='flex';
  document.getElementById('win-display').style.display='none';
  document.getElementById('spinner-section').style.display='block';
  document.getElementById('modal-actions').style.display='flex';
  document.getElementById('multi-open-grid').style.display='none';
  updateCaseCostDisplay();
  updateCaseQtyButtons();
  buildSpinnerTrack();
  const autoBtn=document.getElementById('auto-open-btn');
  if(autoBtn){autoBtn.style.display='inline-flex';autoBtn.textContent=G.autoOpenActive?'â¹ Stop Auto-Open':'â–¶ Auto-Open';autoBtn.style.background=G.autoOpenActive?'var(--red)':'';}
}
function closeCase(){
  document.getElementById('case-modal').style.display='none';
  const mg=document.getElementById('case-modal-multi-grid');
  if(mg){mg.style.display='none';mg.innerHTML='';}
  lastWin=null;multiWins=[];
}
function getMaxOpenQty(){
  const lvl=G.level||1;
  if(lvl>=30)return 50;
  if(lvl>=20)return 25;
  if(lvl>=15)return 10;
  if(lvl>=10)return 5;
  if(lvl>=5)return 3;
  return 1;
}

function updateCaseQtyButtons(){
  const max=getMaxOpenQty();
  const qtys=[1,3,5,10,25,50];
  const container=document.getElementById('qty-btns');
  if(!container)return;
  container.innerHTML=qtys.filter(q=>q<=max).map(q=>`
    <button class="quantity-btn${openQty===q?' active':''}" onclick="setOpenQty(${q})">Ã—${q}</button>
  `).join('');
}

function setOpenQty(n){
  openQty=n;
  document.querySelectorAll('.quantity-btn').forEach(b=>b.classList.remove('active'));
  event?.target?.classList.add('active');
  updateCaseCostDisplay();
}
function updateCaseCostDisplay(){
  if(!currentCase)return;
  const total=currentCase.price*openQty;
  document.getElementById('case-cost-display').textContent='Total: $'+fmt(total);
}

// ============================================================
// CENTRAL RNG ENGINE (Provably Fair + All Modifiers)
// ============================================================
function generateSeed(){return Math.random().toString(36).slice(2)+Date.now().toString(36)+Math.random().toString(36).slice(2);}

function seededRandom(seed,nonce){
  // Simple deterministic hash from seed+nonce
  let h=0;const s=seed+':'+nonce;
  for(let i=0;i<s.length;i++){h=((h<<5)-h+s.charCodeAt(i))|0;}
  return Math.abs(h)/2147483647;
}

function getBaseRoll(){
  G.lifetimeRolls++;
  G.seedNonce++;
  const val=seededRandom(G.fairnessSeed,G.seedNonce);
  // Log roll
  if(Array.isArray(G.seedLog)){
    G.seedLog.unshift({nonce:G.seedNonce,seed:G.fairnessSeed,val:val.toFixed(6),time:Date.now()});
    if(G.seedLog.length>20)G.seedLog.pop();
  }
  return val;
}

function rollRarity(priceMult=1){
  const baseLuck = 1+(G.luckBonus||0)/100;
  const weekendBoost = isWeekend()?2:1;
  const priceBoost = priceMult>1?1+Math.log10(priceMult)*0.4:1;
  const eventBoost = (G.activeEvent?.active)?1.5:1;
  const goldenBoost = G.goldenHourActive&&Date.now()<G.goldenHourExpiry?2.0:1;
  const bloodMoonMult = G.bloodMoonActive?1.8:1;  // Blood moon increases rare drops
  const prestigeBoost = 1+(G.prestigeTier||0)*0.1; // +10% per prestige tier
  // Volatility
  let volBoost=1;
  if(G.volatilityMode==='high')volBoost=1.5;
  else if(G.volatilityMode==='low')volBoost=0.7;
  // Tilt reduces luck (losing streak)
  const tiltPenalty=1-Math.min((G.tiltLevel||0)/100,0.3);
  // Skill tree: luck branch
  const skillLuck=1+(getSkillBonus('luck')||0)/100;

  const combined=baseLuck*weekendBoost*priceBoost*eventBoost*goldenBoost*bloodMoonMult*prestigeBoost*volBoost*tiltPenalty*skillLuck;

  let weights=DROP_RATES.map((r,i)=>{
    if(i>3)return {rarity:r.rarity,weight:r.weight*combined};
    if(i===6)return {rarity:r.rarity,weight:r.weight*combined*1.5};
    return r;
  });
  const total=weights.reduce((s,r)=>s+r.weight,0);
  const roll=getBaseRoll()*total;
  let acc=0;
  for(const r of weights){acc+=r.weight;if(roll<=acc)return r.rarity;}
  return 'consumer';
}

function rotateSeed(){
  G.fairnessSeed=generateSeed();G.seedNonce=0;
  notify('ðŸ” New fairness seed generated!','success');
  renderFairness();saveGame();
}
function copySeed(){if(G.fairnessSeed){navigator.clipboard?.writeText(G.fairnessSeed).then(()=>notify('Seed copied!','success'));}}
function verifyRoll(){
  const seed=document.getElementById('verify-seed')?.value;
  const nonce=parseInt(document.getElementById('verify-nonce')?.value)||0;
  if(!seed){notify('Enter a seed to verify','error');return;}
  const val=seededRandom(seed,nonce);
  document.getElementById('verify-result').textContent=`Roll ${nonce}: Random value = ${val.toFixed(6)}`;
}
function renderFairness(){
  const sd=document.getElementById('current-seed-display');
  const nn=document.getElementById('seed-nonce-display');
  const rl=document.getElementById('seed-roll-log');
  if(sd)sd.textContent=G.fairnessSeed;
  if(nn)nn.textContent=G.seedNonce;
  if(rl&&Array.isArray(G.seedLog)){
    rl.innerHTML=G.seedLog.map(r=>`<div style="padding:3px 0;border-bottom:1px solid var(--bg5)">
      #${r.nonce} â€” ${r.val} <span style="color:var(--text3);float:right">${new Date(r.time).toLocaleTimeString()}</span>
    </div>`).join('')||'<div style="color:var(--text3)">No rolls yet</div>';
  }
}

function quickBuyTokens(amt){
  const cost=+(amt*0.01).toFixed(2);
  if(!checkBal(cost))return;
  G.balance-=cost;addTokens(amt,'Quick buy tokens');renderSidebar();
  // Update token page displays
  const bigEl=document.getElementById('token-big-display');
  const usdEl=document.getElementById('token-usd-val');
  if(bigEl)bigEl.textContent=fmtTokens(G.tokens);
  if(usdEl)usdEl.textContent=fmt((G.tokens||0)*0.01);
  notify(`Bought ${fmtTokens(amt)} tokens for $${fmt(cost)}!`,'success');
}

function openCase(){
  if(!currentCase)return;
  const totalCost=currentCase.price*openQty;
  if(G.balance<totalCost){notify('Not enough funds!','error');return;}
  G.balance-=totalCost;
  addHistory('Opened '+openQty+'Ã— '+currentCase.name,-totalCost,'expense');
  G.casesOpened+=openQty;
  addXP(openQty*5);
  multiWins=[];
  // Check for event skin injection (15% per open during active event)
  for(let i=0;i<openQty;i++){
    let skin;
    if(G.activeEvent?.active&&Math.random()<0.15){
      skin=generateEventSkin()||generateSkin(rollRarity(currentCase.price),currentCase.name);
    }else{
      const rarity=rollRarity(currentCase.price);
      skin=generateSkin(rarity,currentCase.name);
    }
    multiWins.push(skin);
    addToCollection(skin); // Track in collection book
  }
  lastWin=multiWins[0];
  playSound('case_open');
  if(openQty>1){
    // Show all results simultaneously in grid
    document.getElementById('spinner-section').style.display='none';
    document.getElementById('modal-actions').style.display='none';
    renderMultiOpenResults(multiWins);
    // Find best skin to potentially trigger knife overlay
    const bestSkin=multiWins.reduce((best,s)=>{
      const order=['consumer','industrial','milspec','restricted','classified','covert','knife'];
      return order.indexOf(s.rarity)>order.indexOf(best.rarity)?s:best;
    },multiWins[0]);
    showWinDisplay(bestSkin,true);
  }else{
    animateSpin(multiWins[0]);
  }
  checkMissions();
  checkAchievements();
}

function buildSpinnerTrack(){
  const track=document.getElementById('spinner-track');
  const items=[];
  for(let i=0;i<60;i++){
    const rarity=rollRarity();
    const skin=generateSkin(rarity);
    items.push(skin);
  }
  track.innerHTML=items.map(s=>`
    <div class="spinner-item rarity-${s.rarity}" style="border-color:${RARITIES[s.rarity].color}80;overflow:hidden;padding:0;width:120px;height:140px">
      <div style="width:100%;height:95px;overflow:hidden">${getSkinSVG(s)}</div>
      <div style="padding:2px 4px;font-size:9px;text-align:center;color:${RARITIES[s.rarity].color};font-weight:600;line-height:1.2;background:var(--bg3)">${s.name.slice(0,22)}</div>
      <div class="item-rarity" style="background:${RARITIES[s.rarity].color}"></div>
    </div>
  `).join('');
  track.style.transform='translateX(0)';
}

function animateSpin(winSkin){
  const track=document.getElementById('spinner-track');
  const itemW=128;// 120+8 gap
  const items=track.children;
  // Place win skin at index 45
  const winIndex=45;
  // Replace item at winIndex with winSkin
  const winEl=items[winIndex];
  if(winEl){
    winEl.innerHTML=`<div class="item-icon">${winSkin.icon}</div><div class="item-name">${winSkin.name}</div><div class="item-rarity" style="background:${RARITIES[winSkin.rarity].color}"></div>`;
    winEl.className=`spinner-item rarity-${winSkin.rarity}`;
  }
  // Center of container
  const containerW=document.getElementById('spinner-container').offsetWidth;
  const targetX=-(winIndex*itemW)+(containerW/2-60);
  const jitter=(Math.random()-0.5)*60;
  track.style.transition='transform 4s cubic-bezier(.15,.6,.2,1)';
  track.style.transform=`translateX(${targetX+jitter}px)`;
  setTimeout(()=>{
    track.style.transition='none';
    showWinDisplay(winSkin);
  },4100);
}

function showWinDisplay(skin, isMulti=false){
  document.getElementById('spinner-section').style.display='none';
  document.getElementById('modal-actions').style.display='none';
  const wd=document.getElementById('win-display');
  wd.style.display='flex';
  const winIconEl=document.getElementById('win-icon');
  winIconEl.innerHTML=skin.isEvent?getEventSkinSVG(skin):getSkinSVG(skin);
  winIconEl.style.borderColor=skin.isEvent?(skin.eventColor||RARITIES[skin.rarity].color):RARITIES[skin.rarity].color;
  winIconEl.className='rarity-'+skin.rarity;
  const totalVal=multiWins.reduce((s,x)=>s+x.price,0);
  document.getElementById('win-name').textContent=isMulti?`${openQty}Ã— Opened! Best: ${skin.name}`:skin.name;
  document.getElementById('win-rarity').textContent=skin.isEvent?'â˜… EVENT SKIN â€” '+RARITIES[skin.rarity].name:RARITIES[skin.rarity].name;
  document.getElementById('win-rarity').style.color=skin.isEvent?(skin.eventColor||RARITIES[skin.rarity].color):RARITIES[skin.rarity].color;
  document.getElementById('win-value').textContent=isMulti?`Total: $${fmt(totalVal)} across ${openQty} skins`:'$'+fmt(skin.price);
  document.getElementById('win-value').style.color=RARITIES[skin.rarity].color;
  if(skin.rarity==='knife'||skin.rarity==='covert'||skin.isEvent){
    showKnifeOverlay(skin);spawnParticles();playSound('knife');
  }else if(skin.rarity==='classified'){playSound('rare');}
  else{playSound('win');}
  // Show multi-open grid always
  renderMultiOpenResults(multiWins);
  // Save to inventory (single opens add here, multi-opens already added in openCase)
  if(!isMulti){
    G.inventory.push(skin);
    addHistory('Won '+skin.name+' from '+currentCase.name,skin.price,'win');
  }
  renderInventory();renderSidebar();saveGame();
  checkAchievements();
  earnShopCoins(Math.ceil(skin.price/10));
}

function addWinToInventory(){
  closeCase();notify('Skins added to inventory!','success');
}
function sellWin(){
  if(!lastWin)return;
  const skins=multiWins.length>0?multiWins:[lastWin];
  const total=skins.reduce((s,x)=>s+x.price,0);
  // Remove these skins from inventory (they were just added)
  skins.forEach(sk=>{const i=G.inventory.findIndex(x=>+x.id===+sk.id);if(i>=0)G.inventory.splice(i,1);});
  G.balance+=total;G.totalEarned+=total;G.sellProfit+=total;
  addHistory('Sold '+skins.length+' skin(s)',total,'win');
  renderSidebar();renderInventory();saveGame();closeCase();
  notify('Sold for $'+fmt(total)+'!','success');
}

// ============================================================
// KNIFE OVERLAY
// ============================================================
function showKnifeOverlay(skin){
  const overlay=document.getElementById('knife-overlay');
  const iconEl=document.getElementById('knife-icon');
  iconEl.innerHTML=`<div style="width:200px;height:150px;overflow:hidden;border-radius:16px;border:2px solid ${RARITIES[skin.rarity].color}">${getSkinSVG(skin)}</div>`;
  document.getElementById('knife-name').textContent=skin.name;
  document.getElementById('knife-val').textContent='$'+fmt(skin.price);
  overlay.style.display='flex';
}
function closeKnifeOverlay(){document.getElementById('knife-overlay').style.display='none';}
function spawnParticles(){
  const p=document.getElementById('particles');
  p.innerHTML='';
  for(let i=0;i<40;i++){
    const el=document.createElement('div');
    el.className='particle';
    const dur=(0.8+Math.random()*1.5).toFixed(2);
    el.style.cssText=`left:${Math.random()*100}%;top:${Math.random()*100}%;--dur:${dur}s;--tx:${(Math.random()-0.5)*200}px;--ty:${-(50+Math.random()*200)}px;background:${['#f1c40f','#e4ae39','#fff','#ff6b35'][Math.random()*4|0]};animation-delay:${Math.random()*0.5}s`;
    p.appendChild(el);
  }
}

// ============================================================
// INVENTORY
// ============================================================
let invFilterRarity='all',invSortMode='date';

function renderInventory(){
  let items=[...G.inventory];
  if(invFilterRarity==='favorites')items=items.filter(i=>i.fav);
  else if(invFilterRarity!=='all')items=items.filter(i=>i.rarity===invFilterRarity);
  if(invSortMode==='price-h')items.sort((a,b)=>b.price-a.price);
  else if(invSortMode==='price-l')items.sort((a,b)=>a.price-b.price);
  else if(invSortMode==='rarity'){
    const order=['knife','covert','classified','restricted','milspec','industrial','consumer'];
    items.sort((a,b)=>order.indexOf(a.rarity)-order.indexOf(b.rarity));
  }else items.sort((a,b)=>b.date-a.date);
  const grid=document.getElementById('inventory-grid');
  const totalVal=G.inventory.reduce((s,i)=>s+i.price,0);
  document.getElementById('inv-total-val').textContent='$'+fmt(totalVal);
  if(!items.length){grid.innerHTML='<div style="color:var(--text3);padding:20px;grid-column:1/-1;text-align:center">No skins found</div>';return;}
  grid.innerHTML=items.map(skin=>`
    <div class="inv-item rarity-${skin.rarity}" style="border-color:${RARITIES[skin.rarity].color}50;cursor:pointer" onclick="inspectSkin('${skin.id}')">
      <button class="fav-star ${skin.fav?'active':''}" onclick="toggleFav('${skin.id}');event.stopPropagation()">â­</button>
      <div class="inv-item-img rarity-bg-${skin.rarity}" style="height:100px;overflow:hidden">${getSkinSVG(skin)}</div>
      <div class="inv-item-info">
        <div class="inv-item-name" title="${skin.name}">${skin.name}</div>
        <div class="inv-item-price" style="color:${RARITIES[skin.rarity].color}">$${fmt(skin.price)}</div>
        <div class="inv-item-float">${skin.wear} Â· ${skin.float.toFixed(4)}</div>
        <div style="font-size:9px;color:var(--text3)">Seed: ${skin.pattern}</div>
        <div style="display:flex;gap:4px;margin-top:4px">
          <button class="btn btn-red" style="font-size:10px;padding:2px 6px" onclick="sellSkin('${skin.id}');event.stopPropagation()">Sell</button>
          <button class="btn btn-secondary" style="font-size:10px;padding:2px 6px" onclick="bankSkin('${skin.id}');event.stopPropagation()">Bank</button>
        </div>
      </div>
    </div>
  `).join('');
  renderBankSkins();
  document.getElementById('top-inv-count').textContent=G.inventory.length;
}
function invFilter(r){
  invFilterRarity=r;
  document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
  event.target.classList.add('active');
  renderInventory();
}
function invSort(v){invSortMode=v;renderInventory();}
function toggleFav(id){
  const skin=G.inventory.find(s=>s.id===id);
  if(skin){skin.fav=!skin.fav;saveGame();renderInventory();}
}
function sellSkin(id){
  id=+id;
  const idx=G.inventory.findIndex(s=>+s.id===id);
  if(idx<0)return;
  const skin=G.inventory[idx];
  G.balance+=skin.price;G.totalEarned+=skin.price;G.sellProfit+=skin.price;
  addHistory('Sold '+skin.name,skin.price,'win');
  G.inventory.splice(idx,1);
  renderInventory();renderSidebar();saveGame();notify('Sold for $'+fmt(skin.price),'success');
}
function bankSkin(id){
  id=+id;
  const idx=G.inventory.findIndex(s=>+s.id===id);
  if(idx<0)return;
  const skin=G.inventory.splice(idx,1)[0];
  skin.banked=true;
  G.bankSkins.push(skin);
  saveGame();renderInventory();renderBankSkins();notify('Skin locked in bank!','success');
}
function withdrawBankSkin(id){
  id=+id;
  const idx=G.bankSkins.findIndex(s=>+s.id===id);
  if(idx<0)return;
  const skin=G.bankSkins.splice(idx,1)[0];
  skin.banked=false;
  G.inventory.push(skin);
  saveGame();renderInventory();renderBankSkins();notify('Skin returned to inventory!','success');
}
function sellAll(){
  if(!G.inventory.length)return;
  const total=G.inventory.reduce((s,i)=>s+i.price,0);
  G.balance+=total;G.totalEarned+=total;G.sellProfit+=total;
  addHistory('Sold all skins ('+G.inventory.length+')',total,'win');
  G.inventory=[];
  saveGame();renderInventory();renderSidebar();notify('Sold all skins for $'+fmt(total),'success');
}
function renderBankSkins(){
  const el=document.getElementById('bank-skins');
  if(!el)return;
  if(!G.bankSkins.length){el.innerHTML='<div style="color:var(--text3);padding:12px">No skins in bank</div>';return;}
  el.innerHTML=G.bankSkins.map(skin=>`
    <div class="inv-item rarity-${skin.rarity}" style="border-color:${RARITIES[skin.rarity].color}40">
      <div class="inv-item-img rarity-bg-${skin.rarity}" style="height:70px;overflow:hidden">${getSkinSVG(skin)}</div>
      <div class="inv-item-info">
        <div class="inv-item-name">${skin.name}</div>
        <div class="inv-item-price" style="color:${RARITIES[skin.rarity].color}">$${fmt(skin.price)}</div>
        <button class="btn btn-secondary" style="font-size:10px;padding:2px 6px;margin-top:4px" onclick="withdrawBankSkin('${skin.id}')">Withdraw</button>
      </div>
    </div>
  `).join('');
}


// ============================================================
// CASINO GAMES
// ============================================================
function renderCasino(){
  const grid=document.getElementById('games-grid');
  grid.innerHTML=CASINO_GAMES.map(g=>`
    <div class="game-card" onclick="showGame('${g.id}')">
      <div class="game-card-banner" style="background:linear-gradient(135deg,${g.color},${g.color}88)"><span style="font-size:56px">${g.icon}</span></div>
      <div class="game-card-body">
        <div class="game-card-name">${g.name}</div>
        <div class="game-card-desc">${g.desc}</div>
      </div>
    </div>
  `).join('');
}
function showCasinoHub(){
  document.querySelectorAll('.game-panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('casino-hub').style.display='block';
}
function showGame(id){
  document.getElementById('casino-hub').style.display='none';
  document.querySelectorAll('.game-panel').forEach(p=>p.classList.remove('active'));
  const panel=document.getElementById('game-'+id);
  if(panel)panel.classList.add('active');
  if(id==='crash')initCrash();
  if(id==='plinko')drawPlinko();
  if(id==='keno')initKeno();
  if(id==='tower')initTower();
  if(id==='limbo')updateLimboInfo();
  if(id==='wheel'){initWheelCanvas();renderWheelPaytable();}
  if(id==='poker')vpInit();
}
function setBet(inputId,mult){
  const el=document.getElementById(inputId);
  el.value=Math.max(1,(parseFloat(el.value)||0)*mult).toFixed(0);
}
function setBetMax(inputId){
  // Casino bets use tokens
  document.getElementById(inputId).value=Math.floor(G.tokens||0);
}
function checkBal(amt){if(G.balance<amt){notify('Insufficient funds!','error');return false;}return true;}

// --- BLACKJACK ---
const DECK_CARDS=[{v:'A',s:'â™ '},{v:'2',s:'â™ '},{v:'3',s:'â™ '},{v:'4',s:'â™ '},{v:'5',s:'â™ '},{v:'6',s:'â™ '},{v:'7',s:'â™ '},{v:'8',s:'â™ '},{v:'9',s:'â™ '},{v:'10',s:'â™ '},{v:'J',s:'â™ '},{v:'Q',s:'â™ '},{v:'K',s:'â™ '},{v:'A',s:'â™¥'},{v:'2',s:'â™¥'},{v:'3',s:'â™¥'},{v:'4',s:'â™¥'},{v:'5',s:'â™¥'},{v:'6',s:'â™¥'},{v:'7',s:'â™¥'},{v:'8',s:'â™¥'},{v:'9',s:'â™¥'},{v:'10',s:'â™¥'},{v:'J',s:'â™¥'},{v:'Q',s:'â™¥'},{v:'K',s:'â™¥'},{v:'A',s:'â™¦'},{v:'2',s:'â™¦'},{v:'3',s:'â™¦'},{v:'4',s:'â™¦'},{v:'5',s:'â™¦'},{v:'6',s:'â™¦'},{v:'7',s:'â™¦'},{v:'8',s:'â™¦'},{v:'9',s:'â™¦'},{v:'10',s:'â™¦'},{v:'J',s:'â™¦'},{v:'Q',s:'â™¦'},{v:'K',s:'â™¦'},{v:'A',s:'â™£'},{v:'2',s:'â™£'},{v:'3',s:'â™£'},{v:'4',s:'â™£'},{v:'5',s:'â™£'},{v:'6',s:'â™£'},{v:'7',s:'â™£'},{v:'8',s:'â™£'},{v:'9',s:'â™£'},{v:'10',s:'â™£'},{v:'J',s:'â™£'},{v:'Q',s:'â™£'},{v:'K',s:'â™£'}];
let bjDeck=[],bjPlayer=[],bjDealer=[],bjBet=0,bjActive=false;
function bjShuffle(){bjDeck=[...DECK_CARDS];for(let i=bjDeck.length-1;i>0;i--){const j=Math.random()*(i+1)|0;[bjDeck[i],bjDeck[j]]=[bjDeck[j],bjDeck[i]];}}
function bjDraw(){if(bjDeck.length<10)bjShuffle();return bjDeck.pop();}
function bjCardVal(c){if(['J','Q','K'].includes(c.v))return 10;if(c.v==='A')return 11;return +c.v;}
function bjHandVal(hand){let v=hand.reduce((s,c)=>s+bjCardVal(c),0);let aces=hand.filter(c=>c.v==='A').length;while(v>21&&aces>0){v-=10;aces--;}return v;}
function bjRender(showAll=false){
  const isRed=c=>['â™¥','â™¦'].includes(c.s);
  const cardHTML=c=>`<div class="card-item ${isRed(c)?'red':'black'}">${c.v}${c.s}</div>`;
  const backHTML=`<div class="card-item card-back">ðŸ‚ </div>`;
  document.getElementById('dealer-cards').innerHTML=(showAll?bjDealer:[bjDealer[0],{back:true}]).map((c,i)=>c.back?backHTML:cardHTML(c)).join('');
  document.getElementById('player-cards').innerHTML=bjPlayer.map(cardHTML).join('');
  document.getElementById('dealer-score').textContent=showAll?bjHandVal(bjDealer):'?';
  document.getElementById('player-score').textContent=bjHandVal(bjPlayer);
}
function bjDeal(){
  const bet=parseInt(document.getElementById('bj-bet').value)||100;
  if(!spendTokens(bet))return;
  bjBet=bet;bjShuffle();bjPlayer=[bjDraw(),bjDraw()];bjDealer=[bjDraw(),bjDraw()];bjActive=true;
  bjRender();
  document.getElementById('bj-deal').style.display='none';
  document.getElementById('bj-hit').style.display='inline-flex';
  document.getElementById('bj-stand').style.display='inline-flex';
  document.getElementById('bj-double').style.display='inline-flex';
  document.getElementById('bj-result').textContent='';
  if(bjHandVal(bjPlayer)===21){bjEndGame('blackjack');return;}
  playSound('card');
}
function bjHit(){if(!bjActive)return;bjPlayer.push(bjDraw());bjRender();if(bjHandVal(bjPlayer)>21)bjEndGame('bust');playSound('card');}
function bjStand(){if(!bjActive)return;while(bjHandVal(bjDealer)<17)bjDealer.push(bjDraw());bjEndGame('stand');}
function bjDouble(){
  if(!bjActive)return;
  if(!spendTokens(bjBet))return;
  bjBet*=2;bjPlayer.push(bjDraw());bjRender();
  if(bjHandVal(bjPlayer)>21)bjEndGame('bust');else bjStand();
}
function bjEndGame(type){
  bjActive=false;bjRender(true);
  const pv=bjHandVal(bjPlayer),dv=bjHandVal(bjDealer);
  let msg='',win=false,winAmt=0;
  if(type==='blackjack'){winAmt=Math.floor(bjBet*2.5);msg='ðŸƒ BLACKJACK! +'+fmtTokens(winAmt)+' tokens';tokenWin(winAmt,'Blackjack BJ!');win=true;}
  else if(type==='bust'){msg='ðŸ’¥ BUST! Lost '+fmtTokens(bjBet)+' tokens';tokenLose(0,'Blackjack Bust');}
  else if(dv>21){winAmt=bjBet*2;msg='ðŸŽ‰ Dealer Busted! +'+fmtTokens(winAmt)+' tokens';tokenWin(winAmt,'Blackjack Win');win=true;}
  else if(pv>dv){winAmt=bjBet*2;msg='âœ… You Win! +'+fmtTokens(winAmt)+' tokens';tokenWin(winAmt,'Blackjack Win');win=true;}
  else if(pv===dv){msg='ðŸ¤ Push! Tokens returned';addTokens(bjBet,'Blackjack Push');}
  else{msg='âŒ Dealer Wins! Lost '+fmtTokens(bjBet)+' tokens';tokenLose(0,'Blackjack Loss');}
  document.getElementById('bj-result').textContent=msg;
  document.getElementById('bj-result').style.color=win?'var(--green)':'var(--red)';
  document.getElementById('bj-deal').style.display='inline-flex';
  document.getElementById('bj-hit').style.display='none';
  document.getElementById('bj-stand').style.display='none';
  document.getElementById('bj-double').style.display='none';
  if(win)playSound('win');else playSound('lose');
}

// --- ROULETTE ---
const RL_COLORS={0:'green',32:'red',15:'black',19:'red',4:'black',21:'red',2:'black',25:'red',17:'black',34:'red',6:'black',27:'red',13:'black',36:'red',11:'black',30:'red',8:'black',23:'red',10:'black',5:'red',24:'black',16:'red',33:'black',1:'red',20:'black',14:'red',31:'black',9:'red',22:'black',18:'red',29:'black',7:'red',28:'black',12:'red',35:'black',3:'red',26:'black'};
function initRouletteBelt(){
  const belt=document.getElementById('rl-belt');
  if(!belt)return;
  const nums=[...ROULETTE_SEQUENCE,...ROULETTE_SEQUENCE,...ROULETTE_SEQUENCE];
  belt.innerHTML=nums.map(n=>`<div class="roulette-num ${n===0?'rl-green':RL_COLORS[n]==='red'?'rl-red':'rl-black'}">${n}</div>`).join('');
}
let rlSpinning=false;
function rlBet(color){
  if(rlSpinning){notify('Wait for spin to finish!','error');return;}
  const bet=parseInt(document.getElementById('rl-bet').value)||100;
  if(!spendTokens(bet))return;
  const result=ROULETTE_SEQUENCE[Math.floor(Math.random()*ROULETTE_SEQUENCE.length)];
  const resultColor=result===0?'green':RL_COLORS[result];
  rlSpinning=true;
  const belt=document.getElementById('rl-belt');
  const targetIdx=ROULETTE_SEQUENCE.indexOf(result)+37;
  const offset=targetIdx*50;
  belt.parentElement.style.position='relative';
  belt.style.transition='transform 3s cubic-bezier(.17,.67,.12,.99)';
  belt.style.transform=`translateX(-${offset+(Math.random()-0.5)*25}px)`;
  setTimeout(()=>{
    belt.style.transition='none';
    rlSpinning=false;
    let mult=0;
    if(color===resultColor){
      mult=color==='green'?14:2;
      tokenWin(bet*mult,'Roulette Win ('+color+')');
      document.getElementById('rl-result').textContent=`âœ… ${result} (${resultColor.toUpperCase()}) â€” Won ${fmtTokens(bet*mult)} tokens`;
      document.getElementById('rl-result').style.color='var(--green)';
      playSound('win');
    }else{
      tokenLose(0,'Roulette Loss');
      document.getElementById('rl-result').textContent=`âŒ ${result} (${resultColor.toUpperCase()}) â€” Lost ${fmtTokens(bet)} tokens`;
      document.getElementById('rl-result').style.color='var(--red)';
      playSound('lose');
    }
  },3100);
}

// --- CRASH ---
let crashInterval=null,crashMult=1,crashBetAmt=0,crashActive=false,crashBetPlaced=false;
let crashPoints=[];
function initCrash(){
  const canvas=document.getElementById('crash-canvas');
  if(!canvas)return;
  canvas.width=canvas.offsetWidth*window.devicePixelRatio||800;
  canvas.height=250*window.devicePixelRatio||250;
  drawCrashGraph();
}
function crashBet(){
  const bet=parseInt(document.getElementById('crash-bet').value)||100;
  if(!spendTokens(bet))return;
  crashBetAmt=bet;crashBetPlaced=true;
  crashMult=1;crashPoints=[];crashActive=true;
  document.getElementById('crash-bet-btn').style.display='none';
  document.getElementById('crash-cashout-btn').style.display='inline-flex';
  document.getElementById('crash-result').textContent='';
  document.getElementById('crash-mult').className='crash-multiplier';
  clearInterval(crashInterval);
  const auto=parseFloat(document.getElementById('crash-auto').value)||0;
  crashInterval=setInterval(()=>{
    // Slower growth + higher early crash chance = more balanced
    crashMult*=(1+0.003+Math.random()*0.003);
    crashPoints.push(crashMult);
    document.getElementById('crash-mult').textContent=crashMult.toFixed(2)+'Ã—';
    drawCrashGraph();
    if(auto>1&&crashMult>=auto){crashCashout();return;}
    // Increased crash probability: ~50% crash before 2Ã—, ~80% before 5Ã—
    const crashProb = 0.012*Math.log(crashMult+1) + (crashMult>3?0.006:0);
    if(Math.random()<crashProb){
      clearInterval(crashInterval);
      crashActive=false;
      tokenLose(0,'Crash â€” Crashed at '+crashMult.toFixed(2)+'Ã—');
      document.getElementById('crash-mult').className='crash-multiplier crashed';
      document.getElementById('crash-result').textContent='ðŸ’¥ Crashed at '+crashMult.toFixed(2)+'Ã—! Lost '+fmtTokens(crashBetAmt)+' tokens';
      document.getElementById('crash-result').style.color='var(--red)';
      document.getElementById('crash-bet-btn').style.display='inline-flex';
      document.getElementById('crash-cashout-btn').style.display='none';
      playSound('lose');crashBetPlaced=false;
    }
  },80);
}
function crashCashout(){
  if(!crashBetPlaced||!crashActive)return;
  clearInterval(crashInterval);crashActive=false;crashBetPlaced=false;
  const won=Math.floor(crashBetAmt*crashMult);
  tokenWin(won,'Crash Cashout at '+crashMult.toFixed(2)+'Ã—');
  document.getElementById('crash-result').textContent='âœ… Cashed out at '+crashMult.toFixed(2)+'Ã—! Won '+fmtTokens(won)+' tokens';
  document.getElementById('crash-result').style.color='var(--green)';
  document.getElementById('crash-bet-btn').style.display='inline-flex';
  document.getElementById('crash-cashout-btn').style.display='none';
  playSound('win');
}
function drawCrashGraph(){
  const canvas=document.getElementById('crash-canvas');
  if(!canvas)return;
  const ctx=canvas.getContext('2d');
  const w=canvas.width,h=canvas.height;
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle='#13141a';ctx.fillRect(0,0,w,h);
  // Grid
  ctx.strokeStyle='#22232e';ctx.lineWidth=1;
  for(let i=0;i<5;i++){ctx.beginPath();ctx.moveTo(0,h/5*i);ctx.lineTo(w,h/5*i);ctx.stroke();}
  if(crashPoints.length<2)return;
  const maxM=Math.max(...crashPoints,2);
  const pts=crashPoints;
  ctx.beginPath();
  ctx.strokeStyle='#2ecc71';ctx.lineWidth=3;
  pts.forEach((m,i)=>{
    const x=i/(pts.length-1)*w;
    const y=h-(m-1)/(maxM-1)*h*0.9-h*0.05;
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
  });
  ctx.stroke();
  // Fill
  ctx.lineTo(w,h);ctx.lineTo(0,h);ctx.closePath();
  ctx.fillStyle='rgba(46,204,113,0.1)';ctx.fill();
}

// --- MINES ---
let minesBoard=[],minesActive=false,minesRevealed=0,minesList=[];
function initMinesGrid(){
  const grid=document.getElementById('mines-grid');
  if(!grid)return;
  grid.innerHTML=Array.from({length:25},(_,i)=>`<div class="mine-cell" id="mc${i}" onclick="minesClick(${i})"></div>`).join('');
}
function minesStart(){
  const bet=parseInt(document.getElementById('mines-bet').value)||100;
  const mines=parseInt(document.getElementById('mines-count').value)||5;
  if(!spendTokens(bet))return;
  minesBoard=Array(25).fill('safe');
  minesList=[];
  let placed=0;
  while(placed<mines){const idx=Math.floor(Math.random()*25);if(minesBoard[idx]!=='mine'){minesBoard[idx]='mine';minesList.push(idx);placed++;}}
  minesActive=true;minesRevealed=0;
  for(let i=0;i<25;i++){const c=document.getElementById('mc'+i);c.className='mine-cell';c.textContent='';}
  document.getElementById('mines-start-btn').style.display='none';
  document.getElementById('mines-cashout-btn').style.display='inline-flex';
  updateMinesMultiplier();
  document.getElementById('mines-result').textContent='';
  addHistory('Mines Bet (tokens)',-bet,'expense');
}
function minesClick(i){
  if(!minesActive)return;
  const c=document.getElementById('mc'+i);
  if(c.classList.contains('revealed'))return;
  if(minesBoard[i]==='mine'){
    c.className='mine-cell revealed-mine revealed';c.textContent='ðŸ’£';
    minesActive=false;
    // Reveal all mines
    minesList.forEach(m=>{const mc=document.getElementById('mc'+m);mc.className='mine-cell revealed-mine revealed';mc.textContent='ðŸ’£';});
    document.getElementById('mines-start-btn').style.display='inline-flex';
    document.getElementById('mines-cashout-btn').style.display='none';
    document.getElementById('mines-result').textContent='ðŸ’¥ BOOM! You hit a mine!';
    document.getElementById('mines-result').style.color='var(--red)';
    playSound('lose');
  }else{
    c.className='mine-cell revealed-safe revealed';c.textContent='ðŸ’Ž';minesRevealed++;
    updateMinesMultiplier();playSound('click');
  }
}
function updateMinesMultiplier(){
  const mines=parseInt(document.getElementById('mines-count').value)||5;
  const safe=25-mines;
  // More mines = steeper multiplier curve, fewer mines = gentler progression
  const riskFactor=mines/25; // 0.04 (1 mine) to 0.6 (15 mines)
  let mult=1;
  for(let i=0;i<minesRevealed;i++){
    mult*=(safe-i)/(safe-i-mines*(1/(safe-i+1)));
  }
  // Simplified fair formula: base starts near 1 for few mines
  const baseGrowth=1+riskFactor*0.8;
  mult=Math.pow(baseGrowth,minesRevealed)*(1+mines*0.03);
  if(minesRevealed===0)mult=1;
  document.getElementById('mines-mult').textContent=mult.toFixed(2)+'Ã—';
  return mult;
}
function calcMinesMult(){
  const mines=parseInt(document.getElementById('mines-count').value)||5;
  const safe=25-mines;
  const riskFactor=mines/25;
  const baseGrowth=1+riskFactor*0.8;
  const mult=minesRevealed>0?Math.pow(baseGrowth,minesRevealed)*(1+mines*0.03):1;
  return mult;
}
function minesCashout(){
  if(!minesActive)return;
  const bet=parseInt(document.getElementById('mines-bet').value)||100;
  const mult=calcMinesMult();
  const won=Math.floor(bet*mult);
  minesActive=false;
  tokenWin(won,'Mines Cashout ('+minesRevealed+' gems, '+mult.toFixed(2)+'Ã—)');
  document.getElementById('mines-result').textContent='âœ… Cashed out '+minesRevealed+' gems! Won '+fmtTokens(won)+' tokens';
  document.getElementById('mines-result').style.color='var(--green)';
  document.getElementById('mines-start-btn').style.display='inline-flex';
  document.getElementById('mines-cashout-btn').style.display='none';
  playSound('win');
}

// --- SLOTS ---
const SLOT_SYMBOLS=['ðŸ’','ðŸ‹','ðŸ‡','ðŸ””','â­','7ï¸âƒ£','ðŸ’Ž'];
const SLOT_MULTS={'ðŸ’ŽðŸ’ŽðŸ’Ž':100,'7ï¸âƒ£7ï¸âƒ£7ï¸âƒ£':50,'ðŸ’ðŸ’ðŸ’':20,'ðŸ‹ðŸ‹ðŸ‹':15,'ðŸ‡ðŸ‡ðŸ‡':12,'ðŸ””ðŸ””ðŸ””':10,'â­â­â­':8};
let slotSpinning=false;
function slotsPlay(){
  if(slotSpinning)return;
  const bet=parseInt(document.getElementById('slots-bet').value)||50;
  if(!spendTokens(bet))return;
  slotSpinning=true;
  playSound('slots');
  const results=[];
  for(let r=0;r<3;r++){
    const el=document.getElementById('reel-'+r);
    el.classList.add('spinning');
    setTimeout(()=>{
      el.classList.remove('spinning');
      const sym=SLOT_SYMBOLS[Math.random()*SLOT_SYMBOLS.length|0];
      el.textContent=sym;results[r]=sym;
      if(results.length===3&&!results.includes(undefined)){
        const combo=results.join('');
        const mult=SLOT_MULTS[combo]||(results[0]===results[1]&&results[1]===results[2]?5:0);
        slotSpinning=false;
        if(mult>0){
          const won=Math.floor(bet*mult);tokenWin(won,'Slots '+combo);
          document.getElementById('slots-result').textContent='ðŸŽ‰ '+combo+' = '+mult+'Ã— â€” +'+fmtTokens(won)+' tokens';
          document.getElementById('slots-result').style.color='var(--green)';playSound('win');
        }else{
          tokenLose(0,'Slots Loss');
          document.getElementById('slots-result').textContent='âŒ No match â€” Lost '+fmtTokens(bet)+' tokens';
          document.getElementById('slots-result').style.color='var(--red)';playSound('lose');
        }
      }
    },300+r*200);
  }
  addHistory('Slots Bet (tokens)',-bet,'expense');
}

// --- PLINKO ---
const PLINKO_ROWS = 12;
const PLINKO_MULTS = [1000,130,26,9,4,2,0.2,2,4,9,26,130,1000];
let plinkoCtx=null, plinkoActive=false, plinkoCanvas=null, plinkoPegs=[];
function plinkoBucketColor(m){
  if(m>=100)return '#e4ae39'; if(m>=10)return '#d32ce6'; if(m>=2)return '#4b69ff'; if(m>=1)return '#5e98d9'; return '#eb4b4b';
}
function clamp(v,mn,mx){return Math.max(mn,Math.min(mx,v));}
function easeInOut(t){return t<0.5?2*t*t:-1+(4-2*t)*t;}

function initPlinko(){
  plinkoCanvas=document.getElementById('plinko-canvas');
  if(!plinkoCanvas)return;
  plinkoCanvas.width=440; plinkoCanvas.height=420;
  plinkoCtx=plinkoCanvas.getContext('2d');
  buildPlinkoPegs(); drawPlinkoBoard();
}
function buildPlinkoPegs(){
  plinkoPegs=[];
  const W=440,TOP=28,BOTTOM=365;
  const rowSpacing=(BOTTOM-TOP)/(PLINKO_ROWS-1);
  for(let r=0;r<PLINKO_ROWS;r++){
    const numPegs=r+3;
    const rowY=TOP+r*rowSpacing;
    const span=W*0.14+(W*0.72)*(r/(PLINKO_ROWS-1));
    const startX=W/2-span/2;
    for(let c=0;c<numPegs;c++){
      const px=numPegs>1?startX+(span/(numPegs-1))*c:W/2;
      plinkoPegs.push({x:px,y:rowY,r,c});
    }
  }
}
function drawPlinkoBoard(ball=null,pathPts=null,hBucket=-1){
  if(!plinkoCtx||!plinkoCanvas)return;
  const W=plinkoCanvas.width,H=plinkoCanvas.height,ctx=plinkoCtx;
  ctx.clearRect(0,0,W,H);
  const bg=ctx.createLinearGradient(0,0,0,H);
  bg.addColorStop(0,'#0b0c14'); bg.addColorStop(1,'#13141a');
  ctx.fillStyle=bg; ctx.fillRect(0,0,W,H);
  // Side walls
  ctx.fillStyle='rgba(255,255,255,0.03)'; ctx.fillRect(0,0,8,H); ctx.fillRect(W-8,0,8,H);
  // Path trail
  if(pathPts&&pathPts.length>1){
    ctx.beginPath(); ctx.moveTo(pathPts[0].x,pathPts[0].y);
    for(let i=1;i<pathPts.length;i++)ctx.lineTo(pathPts[i].x,pathPts[i].y);
    ctx.strokeStyle='rgba(240,165,0,0.25)'; ctx.lineWidth=2.5; ctx.setLineDash([4,4]); ctx.stroke(); ctx.setLineDash([]);
  }
  // Pegs
  plinkoPegs.forEach(p=>{
    const g=ctx.createRadialGradient(p.x-1,p.y-2,1,p.x,p.y,6);
    g.addColorStop(0,'#b0d4f0'); g.addColorStop(1,'#4b69ff');
    ctx.beginPath(); ctx.arc(p.x,p.y,5,0,Math.PI*2); ctx.fillStyle=g; ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,0.3)'; ctx.lineWidth=0.5; ctx.stroke();
  });
  // Buckets
  const numB=PLINKO_MULTS.length, bw=W/numB, bt=H-52;
  PLINKO_MULTS.forEach((m,i)=>{
    const bx=bw*i; const col=plinkoBucketColor(m); const hl=i===hBucket;
    ctx.fillStyle=col+(hl?'ee':'55');
    if(ctx.roundRect){ctx.beginPath();ctx.roundRect(bx+1,bt,bw-2,48,4);ctx.fill();}
    else{ctx.fillRect(bx+1,bt,bw-2,48);}
    if(hl){ctx.strokeStyle=col;ctx.lineWidth=2;ctx.beginPath();if(ctx.roundRect)ctx.roundRect(bx+1,bt,bw-2,48,4);else ctx.rect(bx+1,bt,bw-2,48);ctx.stroke();}
    ctx.fillStyle='#fff'; ctx.font=`bold ${m>=100?9:10}px 'Barlow Condensed',sans-serif`; ctx.textAlign='center';
    ctx.fillText(m>=1000?'1KÃ—':m+'Ã—',bx+bw/2,bt+26);
  });
  // Ball
  if(ball){
    const bg2=ctx.createRadialGradient(ball.x-2,ball.y-2,1,ball.x,ball.y,9);
    bg2.addColorStop(0,'#fff'); bg2.addColorStop(0.4,'#f0a500'); bg2.addColorStop(1,'#c07800');
    ctx.beginPath(); ctx.arc(ball.x,ball.y,8,0,Math.PI*2);
    ctx.shadowColor='#f0a500'; ctx.shadowBlur=16; ctx.fillStyle=bg2; ctx.fill(); ctx.shadowBlur=0;
  }
}
function plinkoDrop(){
  if(plinkoActive){return;}// silent ignore for multi-drop
  if(!plinkoCanvas)initPlinko();
  const bet=parseInt(document.getElementById('plinko-bet').value)||100;
  if(!spendTokens(bet))return;
  addHistory('Plinko Bet (tokens)',-bet,'expense');
  plinkoActive=true;
  document.getElementById('plinko-result').textContent='';
  // Simulate bounces
  let bucketPos=0;
  const bounces=[];
  for(let r=0;r<PLINKO_ROWS;r++){const d=Math.random()<0.5?0:1;bounces.push(d);bucketPos+=d;}
  // Build waypoints through actual peg positions
  const W=440,H=420,TOP=28,BOTTOM=365;
  const rowSpacing=(BOTTOM-TOP)/(PLINKO_ROWS-1);
  const pathPts=[{x:W/2,y:8}];
  let cumB=0;
  for(let r=0;r<PLINKO_ROWS;r++){
    cumB+=bounces[r];
    const numPegs=r+3;
    const span=W*0.14+(W*0.72)*(r/(PLINKO_ROWS-1));
    const startX=W/2-span/2;
    const pegSpacing=numPegs>1?span/(numPegs-1):0;
    const ry=TOP+r*rowSpacing;
    const gx=startX+(cumB-0.5)*pegSpacing+(Math.random()-0.5)*4;
    pathPts.push({x:clamp(gx,12,W-12),y:ry+rowSpacing*0.45});
  }
  const bw=W/PLINKO_MULTS.length;
  pathPts.push({x:bw*bucketPos+bw/2,y:H-26});
  let pIdx=0,prog=0;
  const ball={x:pathPts[0].x,y:pathPts[0].y};
  const SPEED=0.07;
  const tick=()=>{
    if(!plinkoActive)return;
    prog+=SPEED;
    if(prog>=1){
      prog=0; pIdx++;
      if(pIdx>=pathPts.length-1){
        ball.x=pathPts[pathPts.length-1].x; ball.y=pathPts[pathPts.length-1].y;
        drawPlinkoBoard(ball,pathPts,bucketPos); plinkoActive=false;
        const mult=PLINKO_MULTS[bucketPos];
        setTimeout(()=>{
          if(mult>=1){
            tokenWin(Math.floor(bet*mult),'Plinko '+(mult>=1000?'1000':mult)+'Ã—');
            document.getElementById('plinko-result').textContent='âœ… '+(mult>=1000?'1000':mult)+'Ã— â€” Won '+fmtTokens(Math.floor(bet*mult))+' tokens';
            document.getElementById('plinko-result').style.color=plinkoBucketColor(mult);
            playSound(mult>=100?'knife':'win');
          }else{
            const got=Math.floor(bet*mult);addTokens(got,'Plinko '+mult+'Ã— partial');
            document.getElementById('plinko-result').textContent='âŒ '+mult+'Ã— â€” Lost '+fmtTokens(bet-got)+' tokens';
            document.getElementById('plinko-result').style.color='var(--red)'; playSound('lose');
          }
          drawPlinkoBoard(null,null,bucketPos);
          setTimeout(()=>drawPlinkoBoard(),1800);
        },300);
        return;
      }
    }
    const fr=pathPts[pIdx],to=pathPts[pIdx+1];
    const t=easeInOut(prog);
    ball.x=fr.x+(to.x-fr.x)*t; ball.y=fr.y+(to.y-fr.y)*t;
    drawPlinkoBoard(ball,null,-1);
    requestAnimationFrame(tick);
  };
  requestAnimationFrame(tick);
}

// --- COINFLIP ---
let cfFlipping=false;
function coinflip(side){
  if(cfFlipping)return;
  const bet=parseInt(document.getElementById('cf-bet').value)||100;
  if(!spendTokens(bet))return;
  cfFlipping=true;
  const coin=document.getElementById('coin');
  coin.classList.remove('flipping');void coin.offsetWidth;coin.classList.add('flipping');
  playSound('coin');
  setTimeout(()=>{
    const result=Math.random()<0.5?'heads':'tails';
    cfFlipping=false;
    const res=document.getElementById('cf-result');
    if(result===side){tokenWin(bet*2,'Coinflip Win');res.textContent=`âœ… ${result.toUpperCase()}! Won ${fmtTokens(bet)} tokens`;res.style.color='var(--green)';playSound('win');}
    else{tokenLose(0,'Coinflip Loss');res.textContent=`âŒ ${result.toUpperCase()}! Lost ${fmtTokens(bet)} tokens`;res.style.color='var(--red)';playSound('lose');}
  },1600);
  addHistory('Coinflip Bet (tokens)',-bet,'expense');
}

// ============================================================
// JACKPOT
// ============================================================
const BOT_NAMES=['xXSniper99Xx','CSGO_Pro','Drop_King','MrHyper','SilentStrike'];
function jpEnter(){
  const bet=parseInt(document.getElementById('jp-bet-input').value)||500;
  if(!spendTokens(bet))return;
  G.jpPot=(G.jpPot||0)+bet;
  G.jpEntries=G.jpEntries||[];
  const colors=['#4b69ff','#d32ce6','#eb4b4b','#2ecc71','#f0a500'];
  G.jpEntries.push({name:G.username,amount:bet,color:colors[G.jpEntries.length%colors.length]});
  // Add bots
  const botAmt=Math.floor(bet*(0.2+Math.random()*2));
  G.jpEntries.push({name:BOT_NAMES[Math.random()*BOT_NAMES.length|0],amount:botAmt,color:colors[Math.random()*colors.length|0]});
  G.jpPot+=botAmt;
  renderJackpot();addHistory('Jackpot Entry (tokens)',-bet,'expense');updateTokenDisplay();
  notify('Entered jackpot with '+fmtTokens(bet)+' tokens!','success');
}
function renderJackpot(){
  document.getElementById('jp-total').textContent='$'+fmt(G.jpPot||0);
  const entries=G.jpEntries||[];
  document.getElementById('jp-players-count').textContent=entries.length+' players';
  const total=entries.reduce((s,e)=>s+e.amount,0)||1;
  document.getElementById('jp-entries').innerHTML=entries.map(e=>`
    <div class="jackpot-entry">
      <div class="jackpot-bar" style="width:${(e.amount/total*100).toFixed(1)}%;background:${e.color};min-width:20px;height:8px;border-radius:4px;flex-shrink:0"></div>
      <span style="font-weight:600;min-width:100px">${e.name}</span>
      <span style="font-family:'Barlow Condensed',sans-serif;color:var(--accent)">${(e.amount/total*100).toFixed(1)}%</span>
      <span style="margin-left:auto;color:var(--text2)">$${fmt(e.amount)}</span>
    </div>
  `).join('');
}
function jpSpin(){
  if(!G.jpEntries||!G.jpEntries.length){notify('No entries!','error');return;}
  // Weighted random
  const total=G.jpEntries.reduce((s,e)=>s+e.amount,0);
  let roll=Math.random()*total;
  let winner=G.jpEntries[0];
  for(const e of G.jpEntries){roll-=e.amount;if(roll<=0){winner=e;break;}}
  // Animate strip
  const strip=document.getElementById('jp-strip');
  const colors=G.jpEntries.map(e=>e.color);
  const segments=[];for(let i=0;i<80;i++)segments.push(G.jpEntries[i%G.jpEntries.length]);
  // Place winner near end
  const winIdx=70;segments[winIdx]={...winner};
  strip.innerHTML=segments.map(s=>`<div class="jackpot-strip-seg" style="background:${s.color};width:${(s.amount/total*400).toFixed(0)}px;min-width:60px">${s.name}</div>`).join('');
  document.getElementById('jp-wheel-wrap').style.display='block';
  const segW=Math.max(60,winner.amount/total*400);
  const targetX=winIdx*segW-(strip.parentElement.offsetWidth/2-segW/2);
  strip.style.transition='none';strip.style.transform='translateX(0)';
  setTimeout(()=>{strip.style.transition='transform 4s cubic-bezier(.17,.67,.12,.99)';strip.style.transform=`translateX(-${targetX}px)`;},50);
  setTimeout(()=>{
    const pot=G.jpPot||0;
    if(winner.name===G.username){
      addTokens(pot,'ðŸ† Jackpot Win!');
      addHistory('ðŸ† Won Jackpot! (tokens)',pot,'win');
      document.getElementById('jp-result').textContent='ðŸ† YOU WON the jackpot! +'+fmtTokens(pot)+' tokens';
      document.getElementById('jp-result').style.color='var(--gold)';
      notify('ðŸ† JACKPOT! You won '+fmtTokens(pot)+' tokens!','rare');playSound('knife');
    }else{
      document.getElementById('jp-result').textContent=winner.name+' won the jackpot ('+fmtTokens(pot)+' tokens)!';
      document.getElementById('jp-result').style.color='var(--red)';
    }
    G.jpPot=0;G.jpEntries=[];renderJackpot();renderSidebar();saveGame();
  },4200);
}

// ============================================================
// CASE BATTLES
// ============================================================
const battleBots=['[BOT] AWP_God','[BOT] HeadShot','[BOT] FragMaster','[BOT] CaseKing'];
function startBattle(){
  const caseId=document.getElementById('battle-case-select').value;
  const mode=document.getElementById('battle-mode').value;
  const rounds=parseInt(document.getElementById('battle-rounds').value)||3;
  const c=CASES.find(x=>x.id===caseId);
  if(!c)return;
  const numPlayers=mode==='1v1'?2:mode==='2v2'?4:4;
  const totalCost=c.price*rounds;
  if(!checkBal(totalCost))return;
  G.balance-=totalCost;renderSidebar();
  addHistory('Case Battle Entry',-totalCost,'expense');
  const players=[{name:G.username,skins:[],total:0,isPlayer:true}];
  for(let i=1;i<numPlayers;i++)players.push({name:battleBots[i-1],skins:[],total:0,isPlayer:false});
  for(const p of players){for(let r=0;r<rounds;r++){const s=generateSkin(rollRarity(),c.name);p.skins.push(s);p.total+=s.price;}}
  const winner=players.reduce((a,b)=>b.total>a.total?b:a);
  const allSkins=players.flatMap(p=>p.skins);
  const prize=allSkins.reduce((s,sk)=>s+sk.price,0);
  const wrap=document.getElementById('battle-result-wrap');
  wrap.style.display='block';
  wrap.innerHTML=`
    <div class="section-title">âš”ï¸ Battle Results</div>
    <div class="battle-result-row" style="display:flex;gap:12px;flex-wrap:wrap">
      ${players.map(p=>`
        <div class="battle-col ${p.name===winner.name?'winner':''}">
          <div style="font-weight:700;font-size:16px;margin-bottom:4px">${p.name===winner.name?'ðŸ‘‘ ':''}${p.name}</div>
          <div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;color:${p.name===winner.name?'var(--gold)':'var(--text2)'}">$${fmt(p.total)}</div>
          <div class="battle-items">${p.skins.map(s=>`<div class="battle-item rarity-${s.rarity}" style="border-color:${RARITIES[s.rarity].color}60">${s.icon}<div class="battle-item-val">$${fmt(s.price)}</div></div>`).join('')}</div>
        </div>
      `).join('')}
    </div>
    <div style="text-align:center;margin-top:12px;font-family:'Rajdhani',sans-serif;font-size:20px">
      ${winner.name===G.username?`<span style="color:var(--gold)">ðŸ† You won the battle! +$${fmt(prize)}</span>`:`<span style="color:var(--red)">âŒ ${winner.name} won the battle!</span>`}
    </div>
  `;
  if(winner.isPlayer){casinoWin(prize,'Case Battle Win');playSound('win');}
  else playSound('lose');
}

// ============================================================
// TRADE-UP CONTRACT
// ============================================================
let tradeupSlots=Array(10).fill(null);
function renderTradeupGrid(){
  const grid=document.getElementById('tradeup-grid');
  if(!grid)return;
  grid.innerHTML=tradeupSlots.map((skin,i)=>`
    <div class="tradeup-slot ${skin?'filled rarity-'+skin.rarity:''}" onclick="tradeupSlotClick(${i})" title="${skin?skin.name:'Click to add skin'}">
      ${skin?`<div style="width:100%;height:60px;overflow:hidden;border-radius:4px">${getSkinSVG(skin)}</div><div style="font-size:7px;margin-top:2px;color:${RARITIES[skin.rarity].color};text-align:center;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;padding:0 2px">${skin.name.slice(0,18)}</div>
      <div style="font-size:8px;color:var(--text3)">$${fmt(skin.price)}</div>
      <div style="font-size:9px;color:var(--red);cursor:pointer;margin-top:2px" onclick="event.stopPropagation();tradeupRemove(${i})">âœ• Remove</div>`:'<div style="font-size:24px;color:var(--text3)">âž•</div><div style="font-size:9px;color:var(--text3)">Add skin</div>'}
    </div>
  `).join('');
  const filled=tradeupSlots.filter(Boolean);
  const rarities=[...new Set(filled.map(s=>s.rarity))];
  const info=document.getElementById('tradeup-info');
  if(filled.length===0)info.textContent='Click slots to add skins from inventory (need 10 of same rarity)';
  else if(filled.length<10)info.textContent=`Add ${10-filled.length} more ${rarities[0]} skin(s)`;
  else if(rarities.length>1)info.textContent='âš ï¸ All skins must be the same rarity!';
  else{
    const avgVal=filled.reduce((s,x)=>s+x.price,0)/10;
    info.textContent=`Ready! Average value $${fmt(avgVal)} â†’ guaranteed ${getNextRarity(rarities[0])} skin`;
    info.style.color='var(--green)';
  }
}
function getNextRarity(r){const order=['consumer','industrial','milspec','restricted','classified','covert','knife'];const i=order.indexOf(r);return i>=0?order[Math.min(i+1,order.length-1)]:r;}
function tradeupRemove(slot){tradeupSlots[slot]=null;renderTradeupGrid();}
function tradeupSlotClick(slot){
  if(tradeupSlots[slot]){return;}// clicking filled slot does nothing (use remove button)
  // Show picker modal
  const rarity=tradeupSlots.find(Boolean)?.rarity;
  const avail=G.inventory.filter(s=>!tradeupSlots.some(t=>t&&+t.id===+s.id)&&s.rarity!=='knife'&&(!rarity||s.rarity===rarity));
  if(!avail.length){notify('No eligible skins in inventory! Open some cases first.','error');return;}
  // Build picker popup
  let pickerHtml=`<div style="position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:3000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)" id="tradeup-picker" onclick="if(event.target===this)closePicker()">
    <div style="background:var(--bg2);border-radius:16px;padding:20px;width:90%;max-width:600px;max-height:70vh;overflow-y:auto;border:1px solid var(--bg5)">
      <div style="font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:700;margin-bottom:12px">Select a skin for slot ${slot+1} ${rarity?'('+rarity+' only)':''}</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px">
        ${avail.slice(0,40).map(s=>`
          <div onclick="tradeupPick(${slot},'${s.id}');closePicker()" style="cursor:pointer;background:var(--bg3);border:1px solid ${RARITIES[s.rarity].color}40;border-radius:8px;overflow:hidden;transition:.15s" onmouseover="this.style.borderColor='${RARITIES[s.rarity].color}'" onmouseout="this.style.borderColor='${RARITIES[s.rarity].color}40'">
            <div style="height:70px;overflow:hidden">${getSkinSVG(s)}</div>
            <div style="padding:4px 6px">
              <div style="font-size:9px;color:${RARITIES[s.rarity].color};font-weight:700">${s.name.slice(0,20)}</div>
              <div style="font-size:10px;color:var(--text2)">$${fmt(s.price)}</div>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  </div>`;
  document.body.insertAdjacentHTML('beforeend',pickerHtml);
}
function closePicker(){document.getElementById('tradeup-picker')?.remove();}
function tradeupPick(slot,id){
  id=+id;
  const skin=G.inventory.find(s=>+s.id===id);
  if(!skin)return;
  // Validate rarity
  const existingRarity=tradeupSlots.find(Boolean)?.rarity;
  if(existingRarity&&skin.rarity!==existingRarity){notify('Must use same rarity skins!','error');return;}
  tradeupSlots[slot]=skin;
  renderTradeupGrid();
}
function doTradeup(){
  const filled=tradeupSlots.filter(Boolean);
  if(filled.length<10){notify('Need 10 skins!','error');return;}
  const rarities=[...new Set(filled.map(s=>s.rarity))];
  if(rarities.length>1){notify('All skins must be same rarity!','error');return;}
  const rarityOrder=['consumer','industrial','milspec','restricted','classified','covert','knife'];
  const idx=rarityOrder.indexOf(rarities[0]);
  const nextRarity=rarityOrder[Math.min(idx+1,rarityOrder.length-1)];
  filled.forEach(s=>{const i=G.inventory.findIndex(x=>+x.id===+s.id);if(i>=0)G.inventory.splice(i,1);});
  tradeupSlots=Array(10).fill(null);
  const result=generateSkin(nextRarity,'Trade-Up');
  G.inventory.push(result);
  saveGame();renderTradeupGrid();renderInventory();
  const resEl=document.getElementById('tradeup-result');
  resEl.innerHTML=`<span style="color:${RARITIES[nextRarity].color};font-size:18px;font-weight:700">ðŸŽ‰ Trade-Up Result: ${result.name} (${RARITIES[nextRarity].name}) â€” $${fmt(result.price)}</span>`;
  addXP(50);notify('Trade-Up complete! Got a '+RARITIES[nextRarity].name,'success');
  if(nextRarity==='knife'||nextRarity==='covert'){showKnifeOverlay(result);spawnParticles();}
}

// ============================================================
// BANK
// ============================================================
function bankDeposit(){
  const amt=parseFloat(document.getElementById('deposit-amount').value)||0;
  if(amt<=0||!checkBal(amt))return;
  G.balance-=amt;G.bankBalance+=amt;
  addHistory('Deposited to Bank',-amt,'expense');renderSidebar();notify('Deposited $'+fmt(amt),'success');
}
function bankWithdraw(){
  const amt=parseFloat(document.getElementById('withdraw-amount').value)||0;
  if(amt<=0||G.bankBalance<amt){notify('Insufficient bank balance!','error');return;}
  G.bankBalance-=amt;G.balance+=amt;
  addHistory('Withdrew from Bank',amt,'win');renderSidebar();notify('Withdrew $'+fmt(amt),'success');
}
function takeLoan(){
  const amt=parseFloat(document.getElementById('loan-amount').value)||0;
  if(amt<=0)return;
  const limit=getLoanLimit();
  if((G.loan||0)+amt>limit){notify(`Loan limit is $${fmt(limit)} at your level!`,'error');return;}
  G.loan=(G.loan||0)+amt;G.balance+=amt;
  G.loanTakenAt=Date.now();
  addHistory('Bank Loan',amt,'win');renderSidebar();
  notify('âš ï¸ Loan of $'+fmt(amt)+' taken (10% daily interest, 1hr consequences!)','error');
  renderBank();
}
function renderBank(){
  const limitEl=document.getElementById('loan-limit-display');
  if(limitEl){const limit=getLoanLimit();limitEl.textContent='Max loan: $'+fmt(limit)+' (Level '+G.level+')';}
}
function repayLoan(){
  const loan=G.loan||0;if(!loan)return;
  if(!checkBal(loan)){notify('Not enough to repay!','error');return;}
  G.balance-=loan;G.loan=0;G.loanTakenAt=0;
  addHistory('Repaid Loan',-loan,'expense');renderSidebar();notify('Loan repaid!','success');
  renderBank();
}
function checkInterest(){
  const now=Date.now();
  const dayMs=86400000;
  if(G.bankBalance>0&&now-G.lastInterest>dayMs){
    const interest=G.bankBalance*0.02;
    G.bankBalance+=interest;G.totalEarned+=interest;
    addHistory('Bank Interest',interest,'win');G.lastInterest=now;
    notify('ðŸ’° Bank interest: +$'+fmt(interest),'success');
  }
  if(G.loan>0&&now-G.lastLoanInterest>dayMs){
    const interest=G.loan*0.10;G.loan+=interest;
    addHistory('Loan Interest',-interest,'expense');G.lastLoanInterest=now;
    notify('âš ï¸ Loan interest: -$'+fmt(interest),'error');
  }
  renderSidebar();
}

// ============================================================
// MARKETPLACE
// ============================================================
let marketItems=[];
function generateMarketItems(){
  if(marketItems.length>0)return;
  for(let i=0;i<40;i++){
    const rarity=rollRarity();
    const skin=generateSkin(rarity,'Market');
    skin.listed=true;skin.seller=BOT_NAMES[Math.random()*BOT_NAMES.length|0];
    skin.trend=G.marketTrend[G.marketTrend.length-1]||1;
    marketItems.push(skin);
  }
}
function fluctuateMarket(){
  const trend=G.marketTrend;
  const last=trend[trend.length-1];
  const change=(Math.random()-0.48)*0.05;
  const newVal=Math.max(0.5,Math.min(2,last+change));
  trend.push(+newVal.toFixed(3));
  if(trend.length>30)trend.shift();
  marketItems.forEach(i=>i.price=+(i.price*(0.99+Math.random()*0.02)).toFixed(2));
}
function renderMarket(){
  generateMarketItems();
  const search=document.getElementById('market-search')?.value?.toLowerCase()||'';
  const sort=document.getElementById('market-sort')?.value||'popular';
  let items=[...marketItems];
  if(search)items=items.filter(i=>i.name.toLowerCase().includes(search));
  if(sort==='price-h')items.sort((a,b)=>b.price-a.price);
  else if(sort==='price-l')items.sort((a,b)=>a.price-b.price);
  const list=document.getElementById('market-list');
  if(!list)return;
  list.innerHTML=items.slice(0,20).map(i=>`
    <div class="market-item">
      <div class="market-item-img" style="background:${RARITIES[i.rarity].color}20;padding:10px;border-radius:8px">${i.icon}</div>
      <div class="market-item-info">
        <div style="font-weight:600;font-size:13px">${i.name}</div>
        <div style="font-size:11px;color:${RARITIES[i.rarity].color}">${RARITIES[i.rarity].name}</div>
        <div style="font-size:11px;color:var(--text3)">${i.wear} Â· Float: ${i.float.toFixed(4)}</div>
        <div style="font-size:11px;color:var(--text3)">Seller: ${i.seller}</div>
      </div>
      <div style="text-align:right">
        <div class="market-price">$${fmt(i.price)}</div>
        <button class="market-btn" onclick="buyMarketItem('${i.id}')">Buy</button>
      </div>
    </div>
  `).join('');
}
function buyMarketItem(id){
  const item=marketItems.find(i=>i.id===id);
  if(!item)return;
  if(!checkBal(item.price))return;
  G.balance-=item.price;
  const newSkin={...item,date:Date.now(),listed:false};
  G.inventory.push(newSkin);
  marketItems=marketItems.filter(i=>i.id!==id);
  addHistory('Market Buy: '+item.name,-item.price,'expense');
  renderInventory();renderMarket();renderSidebar();
  notify('Purchased '+item.name,'success');
}
function renderMarketChart(){
  const canvas=document.getElementById('market-canvas');
  if(!canvas)return;
  const ctx=canvas.getContext('2d');
  const w=canvas.width,h=canvas.height;
  const pts=G.marketTrend;
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle='#13141a';ctx.fillRect(0,0,w,h);
  if(pts.length<2)return;
  const min=Math.min(...pts),max=Math.max(...pts);
  const range=max-min||0.1;
  const lastVal=pts[pts.length-1];
  const firstVal=pts[0];
  const isUp=lastVal>=firstVal;
  ctx.beginPath();ctx.strokeStyle=isUp?'#2ecc71':'#e74c3c';ctx.lineWidth=2;
  pts.forEach((v,i)=>{const x=i/(pts.length-1)*w;const y=h-(v-min)/range*(h-10)-5;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});
  ctx.stroke();
  ctx.lineTo(w,h);ctx.lineTo(0,h);ctx.closePath();
  ctx.fillStyle=(isUp?'rgba(46,204,113,0.1)':'rgba(231,76,60,0.1)');ctx.fill();
}

// ============================================================
// MISSIONS
// ============================================================
function updateMissionProgress(){
  if(!G.missions)return;
  const all=[...G.missions.daily,...G.missions.weekly];
  all.forEach(m=>{
    let cur=0;
    if(m.req==='casesOpened')cur=G.casesOpened-(m.start||0);
    else if(m.req==='casinoWins')cur=G.casinoWins-(m.start||0);
    else if(m.req==='totalClicks')cur=G.totalClicks-(m.start||0);
    else if(m.req==='casinoWinAmount')cur=G.missions.casinoWinAmount||0;
    else if(m.req==='invCount')cur=G.inventory.length;
    else if(m.req==='totalEarned')cur=G.totalEarned;
    m.progress=Math.min(m.goal,Math.max(0,cur));
  });
}
function renderMissions(){
  updateMissionProgress();
  renderMissionList('daily-missions',G.missions.daily);
  renderMissionList('weekly-missions',G.missions.weekly);
}
function renderMissionList(id,list){
  const el=document.getElementById(id);if(!el)return;
  el.innerHTML=list.map(m=>{
    const pct=Math.min(100,((m.progress||0)/m.goal)*100);
    const done=m.progress>=m.goal;
    return `<div class="mission-card">
      <div class="mission-icon">${m.icon}</div>
      <div class="mission-info">
        <div class="mission-name">${m.name}</div>
        <div style="font-size:12px;color:var(--text2)">${m.desc}</div>
        <div class="mission-prog"><div class="mission-fill" style="width:${pct}%"></div></div>
        <div style="font-size:11px;color:var(--text3);margin-top:3px">${m.progress||0} / ${m.goal}</div>
        ${done&&!m.claimed?`<button class="mission-claim-btn" style="display:inline-block" onclick="claimMission('${m.id}')">Claim $${fmt(m.reward)}</button>`:
          m.claimed?'<div style="font-size:11px;color:var(--green);margin-top:4px">âœ“ Claimed</div>':''}
      </div>
      <div class="mission-reward">+$${fmt(m.reward)}</div>
    </div>`;
  }).join('');
}
function claimMission(id){
  const all=[...G.missions.daily,...G.missions.weekly];
  const m=all.find(x=>x.id===id);
  if(!m||m.claimed||m.progress<m.goal)return;
  m.claimed=true;addBalance(m.reward,'Mission Reward: '+m.name,'win');
  notify('Claimed $'+fmt(m.reward)+' reward!','success');addXP(50);renderMissions();
}
function checkMissions(){updateMissionProgress();checkMissionBadge();}
function checkMissionBadge(){
  if(!G.missions)return;
  const all=[...G.missions.daily,...G.missions.weekly];
  const hasClaimable=all.some(m=>!m.claimed&&(m.progress||0)>=m.goal);
  const badge=document.getElementById('mission-badge');
  if(badge)badge.style.display=hasClaimable?'inline':'none';
}

// ============================================================
// BATTLE PASS
// ============================================================
const BP_REWARDS=[
  {level:1,free:'ðŸ“¦ Case',premium:'ðŸ’° $50'},
  {level:2,free:'ðŸ’° $25',premium:'ðŸŽ¨ Rare Skin'},
  {level:3,free:'ðŸŽ² Free Spin',premium:'ðŸ’Ž Classified Skin'},
  {level:4,free:'ðŸ’° $50',premium:'ðŸ’° $200'},
  {level:5,free:'ðŸ“¦ 2Ã— Cases',premium:'ðŸ”ª Knife Chance'},
  {level:6,free:'ðŸ’° $75',premium:'ðŸ’° $300'},
  {level:7,free:'ðŸŽ’ Skin',premium:'ðŸŒŸ Covert Skin'},
  {level:8,free:'ðŸ’° $100',premium:'ðŸ’° $500'},
  {level:9,free:'ðŸ“¦ 3Ã— Cases',premium:'ðŸ’Ž Ultra Rare'},
  {level:10,free:'ðŸ‘‘ Title',premium:'ðŸ”ª Guaranteed Knife'},
];
function renderBattlePass(){
  const track=document.getElementById('bp-track');
  if(!track)return;
  track.innerHTML=BP_REWARDS.map((r,i)=>`
    <div class="bp-node">
      <div class="bp-circle ${(G.bpLevel||1)>i+1?'completed':(G.bpLevel||1)===i+1?'current':''}">
        ${(G.bpLevel||1)>i+1?'âœ“':(i+1)}
      </div>
      <div class="bp-label">Lv ${i+1}</div>
      <div class="bp-reward" style="color:#88b87a">${r.free}</div>
      ${G.bpPremium?`<div class="bp-reward" style="color:var(--gold)">${r.premium}</div>`:''}
    </div>
  `).join('');
  document.getElementById('bp-level-display').textContent=G.bpLevel||1;
  const xpNeeded=500;
  document.getElementById('bp-xp-display').textContent=(G.bpXP||0)+' / '+xpNeeded;
  document.getElementById('bp-xp-bar').style.width=Math.min(100,((G.bpXP||0)/xpNeeded)*100)+'%';
}
function updateBP(){
  if(!G)return;
  checkBPLevelUp();
}
function checkBPLevelUp(){
  const xpNeeded=500;
  while((G.bpXP||0)>=xpNeeded){
    G.bpXP-=xpNeeded;G.bpLevel=(G.bpLevel||1)+1;
    claimBPReward(G.bpLevel-1);renderBattlePass();
    notify('ðŸŽ« Battle Pass Level '+(G.bpLevel)+'!','success');
  }
}
function claimBPReward(levelIdx){
  const reward=BP_REWARDS[levelIdx];if(!reward)return;
  if(reward.free.includes('$')){const amt=parseInt(reward.free.replace(/[^0-9]/g,''));addBalance(amt,'BP Reward: '+reward.free,'win');}
  else if(reward.free.includes('Case')){
    const num=parseInt(reward.free)||1;
    for(let i=0;i<num;i++){const s=generateSkin(rollRarity(),'Battle Pass');G.inventory.push(s);}
    renderInventory();notify('ðŸ“¦ Got '+reward.free+' from Battle Pass!','success');
  }
  if(G.bpPremium&&reward.premium){
    if(reward.premium.includes('$')){const amt=parseInt(reward.premium.replace(/[^0-9]/g,''));addBalance(amt,'BP Premium Reward','win');}
    else if(reward.premium.includes('Knife')){const s=generateSkin('knife','Battle Pass');G.inventory.push(s);showKnifeOverlay(s);spawnParticles();renderInventory();}
    else if(reward.premium.includes('Covert')){const s=generateSkin('covert','BP Premium');G.inventory.push(s);renderInventory();}
    else if(reward.premium.includes('Classified')){const s=generateSkin('classified','BP Premium');G.inventory.push(s);renderInventory();}
  }
}
function upgradeToPremium(){
  if(G.bpPremium){notify('Already Premium!');return;}
  if(!checkBal(9.99))return;
  G.balance-=9.99;G.bpPremium=true;renderBattlePass();renderSidebar();
  notify('â­ Upgraded to Premium Battle Pass!','success');
  document.getElementById('premium-upgrade').style.display='none';
}

// ============================================================
// STATS
// ============================================================
// ============================================================
// LEADERBOARD
// ============================================================
let lbMode='wealth';
const LB_BOTS=[
  {name:'xXSniper99Xx',level:42,casesOpened:3842,casinoWins:289,netWorth:87500,avatar:'âš¡'},
  {name:'DROP_KING',level:67,casesOpened:12400,casinoWins:890,netWorth:312000,avatar:'ðŸ‘‘'},
  {name:'FragMaster99',level:28,casesOpened:1240,casinoWins:105,netWorth:24000,avatar:'ðŸ’€'},
  {name:'CaseAddict',level:55,casesOpened:8900,casinoWins:440,netWorth:185000,avatar:'ðŸ“¦'},
  {name:'HighRoller',level:80,casesOpened:22000,casinoWins:1200,netWorth:750000,avatar:'ðŸ’Ž'},
];
function showLB(mode){
  lbMode=mode;
  document.querySelectorAll('#page-leaderboard .filter-btn').forEach((b,i)=>{b.classList.toggle('active',['wealth','opens','wins'][i]===mode);});
  renderLeaderboard();
}
function renderLeaderboard(){
  const me={name:G.username,level:G.level,casesOpened:G.casesOpened,casinoWins:G.casinoWins,netWorth:G.balance+G.bankBalance+inventoryValue(),avatar:G.username.slice(0,2).toUpperCase(),isMe:true};
  const all=[...LB_BOTS,me];
  let sorted;
  if(lbMode==='wealth')sorted=all.sort((a,b)=>b.netWorth-a.netWorth);
  else if(lbMode==='opens')sorted=all.sort((a,b)=>b.casesOpened-a.casesOpened);
  else sorted=all.sort((a,b)=>b.casinoWins-a.casinoWins);
  const rankColors=['gold','silver','bronze'];
  const el=document.getElementById('leaderboard-list');
  if(!el)return;
  el.innerHTML=sorted.map((p,i)=>`
    <div class="lb-item" style="${p.isMe?'border-color:var(--accent);':''}">
      <div class="lb-rank ${rankColors[i]||''}">${i+1}</div>
      <div class="lb-avatar" style="background:${['#4b69ff','#8847ff','#d32ce6','#eb4b4b','#f0a500','#2ecc71'][i%6]}20;border:1px solid ${['#4b69ff','#8847ff','#d32ce6','#eb4b4b','#f0a500','#2ecc71'][i%6]}60">${p.avatar||p.name.slice(0,2).toUpperCase()}</div>
      <div class="lb-info">
        <div class="lb-name">${p.name}${p.isMe?' (You)':''}</div>
        <div class="lb-val">Level ${p.level} Â· ${p.casesOpened} cases</div>
      </div>
      <div class="lb-amount">${lbMode==='wealth'?'$'+fmt(p.netWorth):lbMode==='opens'?fmt(p.casesOpened)+' opens':fmt(p.casinoWins)+' wins'}</div>
    </div>
  `).join('');
}

// ============================================================
// ACHIEVEMENTS
// ============================================================
function checkAchievements(){
  G.achievements.forEach(a=>{
    if(a.done)return;
    let cur=0;
    if(a.req==='casesOpened')cur=G.casesOpened;
    else if(a.req==='knivesUnboxed')cur=G.knivesUnboxed;
    else if(a.req==='totalEarned')cur=G.totalEarned;
    else if(a.req==='casinoWins')cur=G.casinoWins;
    else if(a.req==='invCount')cur=G.inventory.length;
    else if(a.req==='rebirths')cur=G.rebirths;
    else if(a.req==='sellProfit')cur=G.sellProfit;
    if(cur>=a.val){a.done=true;notify('ðŸ† Achievement Unlocked: '+a.name,'success');addXP(100);}
  });
}
function renderAchievements(){
  const grid=document.getElementById('achievements-grid');
  if(!grid)return;
  grid.innerHTML=(G.achievements||ACHIEVEMENTS).map(a=>`
    <div class="card ${a.done?'':''}">
      <div style="font-size:28px;margin-bottom:6px">${a.done?a.icon:'ðŸ”’'}</div>
      <div style="font-weight:700;font-size:13px;margin-bottom:2px">${a.name}</div>
      <div style="font-size:11px;color:var(--text2)">${a.desc}</div>
      ${a.done?'<div style="font-size:11px;color:var(--green);margin-top:4px">âœ“ Unlocked</div>':''}
    </div>
  `).join('');
}

// ============================================================
// WEEKEND BONUS
// ============================================================
function isWeekend(){const d=new Date().getDay();return d===0||d===6;}
function checkWeekend(){
  const w=isWeekend();
  document.getElementById('weekend-banner').classList.toggle('hidden',!w);
  document.getElementById('weekend-banner2').classList.toggle('hidden',!w);
  document.getElementById('weekend-stat').style.display=w?'flex':'none';
}

// ============================================================
// ADMIN PANEL
// ============================================================
function adminAddBalance(){const amt=parseFloat(document.getElementById('admin-balance').value)||0;addBalance(amt,'Admin: Add Balance','win');notify('Added $'+fmt(amt),'success');}
function adminAddXP(){const amt=parseInt(document.getElementById('admin-xp').value)||0;addXP(amt);notify('Added '+amt+' XP','success');}
function adminSpawnSkin(){const r=document.getElementById('admin-skin-rarity').value;const s=generateSkin(r,'Admin Spawn');G.inventory.push(s);renderInventory();renderSidebar();notify('Spawned: '+s.name,'success');if(r==='knife'){showKnifeOverlay(s);spawnParticles();}}
function adminSetLevel(){const l=parseInt(document.getElementById('admin-level').value)||1;G.level=l;G.xp=0;renderSidebar();notify('Level set to '+l,'success');}
function adminToggleLuck(){G.luckBonus=G.luckBonus>0?0:100;notify('Luck bonus: '+(G.luckBonus>0?'ON (100%)':'OFF'),'success');}
function adminMaxUpgrades(){UPGRADES.forEach(u=>{const maxL=u.max||10;const cur=G.upgrades[u.id]||0;const add=maxL-cur;for(let i=0;i<add;i++){if(u.clickAdd)G.clickValue+=u.clickAdd;if(u.cpsAdd)G.cps+=u.cpsAdd;if(u.luckAdd)G.luckBonus=(G.luckBonus||0)+u.luckAdd;}G.upgrades[u.id]=maxL;});renderUpgrades();renderSidebar();notify('All upgrades maxed!','success');}

// ============================================================
// NOTIFICATIONS
// ============================================================
function notify(msg,type='info'){
  const c=document.getElementById('notif-container');
  const n=document.createElement('div');
  n.className='notif '+(type||'');
  n.textContent=msg;
  c.appendChild(n);
  setTimeout(()=>{n.style.animation='notifOut .3s forwards';setTimeout(()=>n.remove(),300);},3000);
}

// ============================================================
// SOUND (Web Audio API)
// ============================================================
let audioCtx=null;
function getAudio(){if(!audioCtx)try{audioCtx=new(window.AudioContext||window.webkitAudioContext)();}catch(e){}return audioCtx;}
function playSound(type){
  if(!G?.sfxOn)return;
  try{
    const ctx=getAudio();if(!ctx)return;
    const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);
    const sounds={click:[800,0.03,0.05,'square'],win:[523,0.15,0.3,'sine'],lose:[200,0.1,0.2,'sawtooth'],rare:[1046,0.2,0.5,'sine'],knife:[1600,0.3,1,'sine'],buy:[660,0.1,0.15,'sine'],card:[440,0.05,0.08,'triangle'],slots:[330,0.1,0.15,'square'],coin:[880,0.15,0.3,'sine'],case_open:[392,0.2,0.4,'sine']};
    const s=sounds[type]||sounds.click;
    o.type=s[3];o.frequency.setValueAtTime(s[0],ctx.currentTime);
    if(type==='win')o.frequency.exponentialRampToValueAtTime(s[0]*1.5,ctx.currentTime+s[2]);
    if(type==='knife'){o.frequency.setValueAtTime(s[0],ctx.currentTime);o.frequency.exponentialRampToValueAtTime(s[0]*2,ctx.currentTime+0.1);o.frequency.exponentialRampToValueAtTime(s[0],ctx.currentTime+0.5);}
    g.gain.setValueAtTime(s[1],ctx.currentTime);g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+s[2]);
    o.start();o.stop(ctx.currentTime+s[2]+0.01);
  }catch(e){}
}

// ============================================================
// SETTINGS
// ============================================================
function toggleSFX(){
  const on=document.getElementById('sfx-toggle').checked;
  G.sfxOn=on;
  document.getElementById('sfx-knob').style.transform=on?'translateX(20px)':'translateX(0)';
  document.querySelector('#sfx-toggle+span').style.background=on?'var(--accent)':'var(--bg5)';
  saveGame();
}
function setTheme(t){
  G.theme=t;
  if(t==='light'){document.documentElement.style.setProperty('--bg','#f0f2f5');document.documentElement.style.setProperty('--bg2','#ffffff');document.documentElement.style.setProperty('--bg3','#f8f9fb');document.documentElement.style.setProperty('--bg4','#e8eaef');document.documentElement.style.setProperty('--text','#1a1b23');document.documentElement.style.setProperty('--text2','#5a5b70');}
  else{document.documentElement.style.setProperty('--bg','#0d0e12');document.documentElement.style.setProperty('--bg2','#13141a');document.documentElement.style.setProperty('--bg3','#1a1b23');document.documentElement.style.setProperty('--bg4','#22232e');document.documentElement.style.setProperty('--text','#e8e9f0');document.documentElement.style.setProperty('--text2','#9a9bb0');}
  saveGame();
}
function resetAllData(){
  if(!confirm('RESET ALL DATA? This cannot be undone!'))return;
  ACCOUNTS[currentUser].state=null;saveAccounts();location.reload();
}

// ============================================================
// SKIN INSPECT
// ============================================================
let inspectedSkinId=null;
function inspectSkin(id){
  const skin=G.inventory.find(s=>s.id===id);
  if(!skin)return;
  inspectedSkinId=id;
  const col=RARITIES[skin.rarity].color;
  document.getElementById('inspect-title').textContent=skin.name;
  document.getElementById('inspect-title').style.color=col;
  document.getElementById('inspect-art').innerHTML=`<div style="width:100%;height:100%">${getSkinSVG(skin)}</div>`;
  document.getElementById('inspect-weapon').textContent=skin.weapon;
  document.getElementById('inspect-finish').textContent=skin.finish;
  document.getElementById('inspect-rarity').textContent=RARITIES[skin.rarity].name;
  document.getElementById('inspect-rarity').style.color=col;
  document.getElementById('inspect-wear').textContent=skin.wear;
  document.getElementById('inspect-float').textContent=skin.float.toFixed(8);
  document.getElementById('inspect-seed').textContent=skin.pattern;
  document.getElementById('inspect-price').textContent='$'+fmt(skin.price);
  document.getElementById('inspect-price').style.color=col;
  document.getElementById('inspect-float-marker').style.left=(skin.float*100)+'%';
  // Stickers
  const stickerEl=document.getElementById('inspect-stickers');
  if(stickerEl){
    const stickers=skin.stickers||[];
    const slots=4;
    stickerEl.innerHTML=Array.from({length:slots},(_,i)=>{
      const s=stickers[i];
      return s
        ?`<div title="${s.name}" style="width:36px;height:36px;background:var(--bg4);border:1px solid var(--bg5);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer" onclick="removeSticker('${id}',${i})">${s.emoji}</div>`
        :`<div style="width:36px;height:36px;background:var(--bg4);border:1px dashed var(--bg5);border-radius:6px;display:flex;align-items:center;justify-content:center;color:var(--text3);font-size:16px">+</div>`;
    }).join('');
  }
  document.getElementById('inspect-modal').style.display='flex';
}
function closeInspect(){document.getElementById('inspect-modal').style.display='none';inspectedSkinId=null;}
function sellInspected(){if(!inspectedSkinId)return;sellSkin(inspectedSkinId);closeInspect();}

// STICKER SYSTEM
const STICKERS=[
  {name:'Headshot',emoji:'ðŸŽ¯'},{name:'Clutch',emoji:'ðŸ”¥'},{name:'Dragon',emoji:'ðŸ‰'},
  {name:'CS:GO',emoji:'ðŸŽ®'},{name:'Lucky',emoji:'ðŸ€'},{name:'Crown',emoji:'ðŸ‘‘'},
  {name:'Diamond',emoji:'ðŸ’Ž'},{name:'Blood',emoji:'ðŸ’‰'},{name:'Bomb',emoji:'ðŸ’£'},
  {name:'Flash',emoji:'âš¡'},{name:'Gold',emoji:'â­'},{name:'Smoke',emoji:'ðŸ’¨'},
  {name:'Graffiti',emoji:'ðŸŽ¨'},{name:'Skull',emoji:'ðŸ’€'},{name:'Ghost',emoji:'ðŸ‘»'},
];
function applyRandomSticker(){
  if(!inspectedSkinId)return;
  if(!checkBal(50))return;
  const skin=G.inventory.find(s=>s.id===inspectedSkinId);
  if(!skin)return;
  if(!skin.stickers)skin.stickers=[];
  if(skin.stickers.length>=4){notify('Max 4 stickers per skin!','error');return;}
  G.balance-=50;
  const sticker=STICKERS[Math.floor(Math.random()*STICKERS.length)];
  skin.stickers.push(sticker);
  // Stickers add 5-15% value
  const bonus=skin.price*(0.05+Math.random()*0.1);
  skin.price+=bonus;
  notify(`ðŸ·ï¸ Applied ${sticker.emoji} ${sticker.name} sticker! Value +$${fmt(bonus)}!`,'success');
  renderSidebar();saveGame();
  inspectSkin(inspectedSkinId);// refresh modal
}
function removeSticker(skinId,slot){
  const skin=G.inventory.find(s=>s.id==skinId);
  if(!skin||!skin.stickers)return;
  const removed=skin.stickers.splice(slot,1)[0];
  if(removed)notify(`ðŸ·ï¸ Removed ${removed.emoji} ${removed.name} sticker`,'info');
  saveGame();
  inspectSkin(skinId);
}

// ============================================================
// DAILY SPIN WHEEL
// ============================================================
const SPIN_PRIZES=[
  {label:'$50',value:50,type:'cash',color:'#4b69ff'},
  {label:'$250',value:250,type:'cash',color:'#2ecc71'},
  {label:'$10',value:10,type:'cash',color:'#5e98d9'},
  {label:'Skin!',value:0,type:'skin_random',color:'#d32ce6'},
  {label:'$1,000',value:1000,type:'cash',color:'#e4ae39'},
  {label:'500 XP',value:500,type:'xp',color:'#00c8ff'},
  {label:'$100',value:100,type:'cash',color:'#8847ff'},
  {label:'KNIFE!',value:0,type:'skin_knife',color:'#e4ae39'},
  {label:'$500',value:500,type:'cash',color:'#eb4b4b'},
  {label:'200 XP',value:200,type:'xp',color:'#ff6b35'},
  {label:'$2,500',value:2500,type:'cash',color:'#f0a500'},
  {label:'Rare Skin',value:0,type:'skin_covert',color:'#eb4b4b'},
];
let spinCanvas=null,spinCtx=null,spinAngle=0,spinSpinning=false;

function drawSpinWheel(angle=0){
  const canvas=document.getElementById('spin-canvas');
  if(!canvas)return;
  if(!spinCtx)spinCtx=canvas.getContext('2d');
  const ctx=spinCtx,W=280,cx=140,cy=140,R=130;
  ctx.clearRect(0,0,W,W);
  const sliceAngle=(Math.PI*2)/SPIN_PRIZES.length;
  SPIN_PRIZES.forEach((p,i)=>{
    const start=angle+sliceAngle*i,end=start+sliceAngle;
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,R,start,end); ctx.closePath();
    ctx.fillStyle=p.color+'cc'; ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,0.15)'; ctx.lineWidth=1.5; ctx.stroke();
    ctx.save(); ctx.translate(cx,cy); ctx.rotate(start+sliceAngle/2);
    ctx.textAlign='right'; ctx.fillStyle='#fff';
    ctx.font=`bold ${p.label.length>4?9:11}px 'Barlow Condensed',sans-serif`;
    ctx.shadowColor='rgba(0,0,0,.7)'; ctx.shadowBlur=3;
    ctx.fillText(p.label,R-8,4); ctx.restore();
  });
  // Center circle
  ctx.beginPath(); ctx.arc(cx,cy,18,0,Math.PI*2);
  const grad=ctx.createRadialGradient(cx,cy,2,cx,cy,18);
  grad.addColorStop(0,'#f0a500'); grad.addColorStop(1,'#c07800');
  ctx.fillStyle=grad; ctx.fill();
  ctx.strokeStyle='rgba(255,255,255,0.5)'; ctx.lineWidth=2; ctx.stroke();
  ctx.fillStyle='#000'; ctx.font='bold 10px Rajdhani'; ctx.textAlign='center';
  ctx.fillText('GO',cx,cy+4);
}

function openSpinModal(){
  document.getElementById('spin-modal').style.display='flex';
  const today=new Date().toDateString();
  const canSpin=G.lastSpinDate!==today;
  document.getElementById('spin-btn').disabled=!canSpin;
  document.getElementById('spin-btn').style.opacity=canSpin?'1':'0.5';
  document.getElementById('spin-result').textContent=canSpin?'':'Already spun today â€” come back tomorrow!';
  document.getElementById('spin-result').style.color='var(--text2)';
  drawSpinWheel(spinAngle);
}
function closeSpinModal(){document.getElementById('spin-modal').style.display='none';}

function doSpin(){
  const today=new Date().toDateString();
  if(G.lastSpinDate===today){notify('Already spun today!','error');return;}
  if(spinSpinning)return;
  spinSpinning=true;
  document.getElementById('spin-btn').disabled=true;
  document.getElementById('spin-result').textContent='';
  // Pick winner
  const weights=[1,5,8,3,0.5,6,4,0.3,2,7,1,1];
  const total=weights.reduce((s,w)=>s+w,0);
  let roll=Math.random()*total,winIdx=0;
  for(let i=0;i<weights.length;i++){roll-=weights[i];if(roll<=0){winIdx=i;break;}}
  const sliceAngle=(Math.PI*2)/SPIN_PRIZES.length;
  // Target: winning slice at top (angle = -PI/2)
  const targetAngle=-Math.PI/2-(sliceAngle*winIdx+sliceAngle/2);
  const spins=5+Math.random()*3;
  const totalRotation=spins*Math.PI*2+targetAngle-spinAngle;
  const duration=4000,start=performance.now();
  const startAngle=spinAngle;
  const tick=(now)=>{
    const el=performance.now()-start;
    const t=Math.min(1,el/duration);
    const eased=1-Math.pow(1-t,4);
    spinAngle=startAngle+totalRotation*eased;
    drawSpinWheel(spinAngle);
    if(t<1){requestAnimationFrame(tick);}
    else{
      spinSpinning=false;
      G.lastSpinDate=today;
      const prize=SPIN_PRIZES[winIdx];
      document.getElementById('spin-badge').style.display='none';
      if(prize.type==='cash'){
        addBalance(prize.value,'Daily Spin: '+prize.label,'win');
        document.getElementById('spin-result').textContent='ðŸŽ‰ You won '+prize.label+'!';
        playSound('win');
      }else if(prize.type==='xp'){
        addXP(prize.value);
        document.getElementById('spin-result').textContent='ðŸŽ‰ You won '+prize.label+'!';
      }else if(prize.type==='skin_knife'){
        const s=generateSkin('knife','Daily Spin');G.inventory.push(s);
        renderInventory();showKnifeOverlay(s);spawnParticles();
        document.getElementById('spin-result').textContent='ðŸ”ª You got a KNIFE: '+s.name+'!';
        playSound('knife');
      }else if(prize.type==='skin_covert'){
        const s=generateSkin('covert','Daily Spin');G.inventory.push(s);renderInventory();
        document.getElementById('spin-result').textContent='âš¡ You got: '+s.name+'!';
        playSound('rare');
      }else if(prize.type==='skin_random'){
        const s=generateSkin(rollRarity(),'Daily Spin');G.inventory.push(s);renderInventory();
        document.getElementById('spin-result').textContent='ðŸŽ You got: '+s.name+'!';
      }
      document.getElementById('spin-result').style.color=prize.color;
      saveGame();
    }
  };
  requestAnimationFrame(tick);
}


// ============================================================
// EVENTS SYSTEM
// ============================================================
const EVENTS = [
  {id:'halloween',name:'ðŸŽƒ Halloween Event',months:[9],color:'#ff6b35',gradient:'linear-gradient(135deg,#ff6b35,#8847ff,#000)',
   skins:['â˜… Karambit | Ghost Blade','AK-47 | Haunted Skull','AWP | Witch\'s Veil','M4A4 | Jack-o-Lantern','Glock-18 | Pumpkin Carve'],
   desc:'Spooky skins drop more often!',icon:'ðŸŽƒ'},
  {id:'christmas',name:'ðŸŽ„ Winter Holiday Event',months:[11,0],color:'#5e98d9',gradient:'linear-gradient(135deg,#5e98d9,#fff,#eb4b4b)',
   skins:['â˜… Butterfly Knife | Snowflake','AK-47 | Winter Feast','AWP | Candy Cane','M4A1-S | Blizzard','P250 | Jingle Bell'],
   desc:'Holiday skins spread cheer!',icon:'ðŸŽ„'},
  {id:'summer',name:'â˜€ï¸ Summer Heat Event',months:[5,6,7],color:'#f0a500',gradient:'linear-gradient(135deg,#f0a500,#ff6b35,#ffcc00)',
   skins:['â˜… Karambit | Beach Tiger','AWP | Sunset Strip','AK-47 | Tropical Heat','USP-S | Sunburn','Glock-18 | Sand Splash'],
   desc:'Hot skins all summer long!',icon:'â˜€ï¸'},
  {id:'anniversary',name:'ðŸŽ‰ CS Anniversary Event',months:[8],color:'#e4ae39',gradient:'linear-gradient(135deg,#e4ae39,#4b69ff,#d32ce6)',
   skins:['â˜… Classic Knife | Gold Anniversary','AK-47 | Legends Edition','AWP | Anniversary','M4A4 | Twenty Years','Glock-18 | OG Chrome'],
   desc:'Celebrating CS!',icon:'ðŸŽ‰'},
  {id:'spring',name:'ðŸŒ¸ Spring Bloom Event',months:[2,3,4],color:'#2ecc71',gradient:'linear-gradient(135deg,#2ecc71,#ff6b35,#8847ff)',
   skins:['â˜… Huntsman Knife | Cherry Blossom','AK-47 | Sakura Storm','AWP | Bloom','M4A4 | Petal Fade','P250 | Spring Flourish'],
   desc:'Beautiful spring skins!',icon:'ðŸŒ¸'},
];

// ============================================================
// EVENTS SYSTEM â€” 5 min active, 10 min cooldown rotation
// ============================================================
const EVENT_ACTIVE_MS   = 5 * 60 * 1000;   // 5 minutes
const EVENT_COOLDOWN_MS = 10 * 60 * 1000;  // 10 minutes
let eventTimer = null;

function startEventCycle(){
  if(eventTimer)clearTimeout(eventTimer);
  // If an event is currently active check if it expired
  if(G.activeEvent&&G.activeEvent.active){
    const elapsed=Date.now()-(G.activeEvent.startTime||0);
    if(elapsed>=EVENT_ACTIVE_MS){
      endCurrentEvent();
    }else{
      // Still active â€” schedule end
      eventTimer=setTimeout(endCurrentEvent, EVENT_ACTIVE_MS-elapsed);
      renderEventBanner();
      return;
    }
  }
  // Check cooldown
  const cooldownRemaining = G.activeEvent
    ? Math.max(0, EVENT_COOLDOWN_MS - (Date.now()-(G.activeEvent.endTime||0)))
    : 0;
  if(cooldownRemaining>0){
    eventTimer=setTimeout(triggerNextEvent, cooldownRemaining);
  }else{
    triggerNextEvent();
  }
}

function triggerNextEvent(){
  // Pick a random event (avoid repeating same one if possible)
  const lastId=G.activeEvent?.id;
  const pool=lastId?EVENTS.filter(e=>e.id!==lastId):EVENTS;
  const ev=pool[Math.floor(Math.random()*pool.length)];
  G.activeEvent={...ev,active:true,startTime:Date.now(),endTime:null};
  saveGame();
  renderEventBanner();
  notify(`ðŸŽ‰ ${ev.name} is LIVE for 5 minutes! Event skins available!`,'success');
  playSound('rare');
  // Schedule end
  eventTimer=setTimeout(endCurrentEvent, EVENT_ACTIVE_MS);
}

function endCurrentEvent(){
  if(G.activeEvent){
    G.activeEvent.active=false;
    G.activeEvent.endTime=Date.now();
    notify(`â° ${G.activeEvent.name} has ended! Next event in 10 minutes.`,'error');
  }
  renderEventBanner();
  saveGame();
  // Schedule next
  eventTimer=setTimeout(triggerNextEvent, EVENT_COOLDOWN_MS);
}

function renderEventBanner(){
  const wrapper=document.getElementById('event-banner-wrapper');
  const banner=document.getElementById('event-banner');
  if(!wrapper||!banner)return;
  if(G.activeEvent&&G.activeEvent.active){
    const remaining=Math.max(0,Math.ceil((EVENT_ACTIVE_MS-(Date.now()-G.activeEvent.startTime))/1000));
    const mm=Math.floor(remaining/60), ss=remaining%60;
    banner.innerHTML=`<span style="font-size:22px">${G.activeEvent.icon}</span>
      <div style="flex:1"><b style="color:${G.activeEvent.color}">${G.activeEvent.name}</b> â€” ${G.activeEvent.desc}</div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:20px;color:${G.activeEvent.color};font-weight:700">${mm}:${ss.toString().padStart(2,'0')}</div>
      <button class="btn btn-sm btn-primary" onclick="openEventCase()">Open Event Case</button>`;
    wrapper.classList.remove('hidden');
    banner.className='event-banner';
    banner.style.borderColor=G.activeEvent.color+'60';
  }else{
    wrapper.classList.add('hidden');
  }
}

function openEventCase(){
  if(!G.activeEvent||!G.activeEvent.active){notify('No active event!','error');return;}
  const cost=5;
  if(G.balance<cost){notify('Need $5 to open an event case!','error');return;}
  G.balance-=cost;renderSidebar();
  // 30% chance of event skin, otherwise generate normally
  let skin;
  if(Math.random()<0.30){
    skin=generateEventSkin();
    if(!skin)skin=generateSkin(rollRarity(),'Event');
  }else{
    skin=generateSkin(rollRarity(5),'Event');
  }
  G.inventory.push(skin);G.casesOpened++;
  addHistory('Event Case',-cost,'expense');
  addXP(10);saveGame();renderInventory();
  notify(`${skin.isEvent?'ðŸŒŸ EVENT SKIN':'ðŸ“¦'} ${skin.name} â€” $${fmt(skin.price)}`,skin.rarity==='knife'||skin.isEvent?'rare':'success');
  if(skin.rarity==='knife'||skin.isEvent){showKnifeOverlay(skin);spawnParticles();}
}

// Refresh banner countdown every second
setInterval(()=>{if(G?.activeEvent?.active)renderEventBanner();},1000);

function checkEventState(){
  startEventCycle();
}

function generateEventSkin(){
  if(!G.activeEvent)return null;
  const ev=G.activeEvent;
  const skinName=ev.skins[Math.floor(Math.random()*ev.skins.length)];
  const parts=skinName.split(' | ');
  const weapon=parts[0], finish=parts[1]||'Special';
  const isKnife=weapon.startsWith('â˜…');
  const rarity=isKnife?'knife':'covert';
  const float=+(Math.random()*0.2).toFixed(8);
  const price=isKnife?+(Math.random()*800+200).toFixed(2):+(Math.random()*120+30).toFixed(2);
  return {
    id:Date.now()+Math.random(),weapon,finish,name:skinName,rarity,float,
    wear:'Factory New',pattern:Math.floor(Math.random()*1000),price,
    icon:isKnife?'ðŸ”ª':'âš¡',case:'Event',date:Date.now(),fav:false,banked:false,
    isEvent:true,eventGradient:ev.gradient,eventColor:ev.color,
  };
}

// Event skin SVG override
function getEventSkinSVG(skin){
  const col=skin.eventColor||'#f0a500';
  const grad=skin.eventGradient||'linear-gradient(135deg,#f0a500,#ff6b35)';
  return `<svg width="100%" height="100%" viewBox="0 0 100 80" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="eg${skin.id.toString().slice(-6).replace('.','_')}" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stop-color="${col}" stop-opacity="0.9"/>
        <stop offset="50%" stop-color="#fff" stop-opacity="0.2"/>
        <stop offset="100%" stop-color="${col}" stop-opacity="0.6"/>
      </linearGradient>
      <filter id="eglow"><feGaussianBlur stdDeviation="1.5" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
    </defs>
    <rect width="100" height="80" fill="#080910"/>
    <rect width="100" height="80" fill="url(#eg${skin.id.toString().slice(-6).replace('.','_')})" opacity="0.25"/>
    <path d="M10,38 L70,38 L73,33 L65,28 L32,28 L30,33 L10,33Z" fill="url(#eg${skin.id.toString().slice(-6).replace('.','_')})" filter="url(#eglow)" opacity="0.9"/>
    <text x="50" y="58" text-anchor="middle" font-size="7" fill="${col}" opacity="0.9" font-family="Barlow Condensed" font-weight="700">âœ¦ EVENT SKIN âœ¦</text>
    <text x="50" y="67" text-anchor="middle" font-size="6" fill="rgba(255,255,255,0.6)" font-family="Barlow Condensed">${skin.finish||skin.name.split(' | ')[1]||''}</text>
  </svg>`;
}

// ============================================================
// TOKEN CURRENCY (Casino)
// ============================================================
function addTokens(amt,label){
  G.tokens=(G.tokens||0)+amt;
  updateTokenDisplay();
  addHistory(label+' (tokens)',amt,'win');
}
function spendTokens(amt){
  if((G.tokens||0)<amt){notify(`Not enough tokens! You have ${fmtTokens(G.tokens)} tokens.`,'error');return false;}
  G.tokens-=amt;updateTokenDisplay();return true;
}
function fmtTokens(t){return fmt(t||0);}
function updateTokenDisplay(){
  document.querySelectorAll('.token-balance').forEach(el=>el.textContent=fmtTokens(G.tokens)+' ðŸ”µ');
}
function buyTokens(){
  const amt=parseFloat(document.getElementById('buy-token-amount')?.value)||100;
  const cost=amt*0.01;
  if(!checkBal(cost))return;
  G.balance-=cost;addTokens(amt,'Bought tokens');renderSidebar();
  notify(`Bought ${fmtTokens(amt)} tokens for $${fmt(cost)}!`,'success');
}
function sellTokens(){
  const amt=parseFloat(document.getElementById('sell-token-amount')?.value)||100;
  const choice=document.querySelector('input[name="token-convert"]:checked')?.value||'cash';
  if((G.tokens||0)<amt){notify('Not enough tokens!','error');return;}
  G.tokens-=amt;
  if(choice==='cash'){
    // 25% house cut â€” 1 token = $0.0075 cash
    const cash=+(amt*0.0075).toFixed(2);
    G.balance+=cash;G.totalEarned+=cash;
    addHistory('Token â†’ Cash (25% fee)',cash,'win');renderSidebar();
    notify(`Converted ${fmtTokens(amt)} tokens â†’ $${fmt(cash)} cash (25% fee applied)!`,'success');
  }else{
    // 10% fee on skin value â€” 1 token = $0.009 towards skin value
    const targetVal=+(amt*0.009).toFixed(2);
    const rarity=targetVal>200?'knife':targetVal>50?'covert':targetVal>15?'classified':targetVal>3?'restricted':targetVal>0.5?'milspec':'industrial';
    const skin=generateSkin(rarity,'Token Convert');
    skin.price=Math.max(targetVal,0.01);
    G.inventory.push(skin);saveGame();renderInventory();
    notify(`Converted ${fmtTokens(amt)} tokens â†’ ${skin.name} ($${fmt(targetVal)}) (10% fee)!`,'success');
  }
  updateTokenDisplay();saveGame();
}

// Patch casino functions to use tokens
function checkTokenBal(amt){
  if((G.tokens||0)<amt){notify(`Not enough tokens! Buy tokens first. (Have: ${fmtTokens(G.tokens)})`, 'error');return false;}
  return true;
}
function tokenWin(tokens,label){
  addTokens(tokens,label);
  G.casinoWins++;
  G.winStreak=(G.winStreak||0)+1;
  G.hotStreak=(G.hotStreak||0)+1;
  // Tilt recovery
  G.tiltLevel=Math.max(0,(G.tiltLevel||0)-5);
  // Risk index goes up
  G.riskIndex=Math.min(100,(G.riskIndex||0)+2);
  updateRiskUI();
  const streakBonus=Math.min(5,G.winStreak);
  const bonusMult=1+((streakBonus-1)*0.1);
  const skillMult=1+(getSkillBonus('casino')||0)/100;
  const final=Math.ceil(tokens*bonusMult*skillMult);
  if(final>tokens)G.tokens+=(final-tokens);
  // Lifetime stats
  if(tokens>G.lifetimeBiggestWin)G.lifetimeBiggestWin=tokens;
  G.totalWagered=(G.totalWagered||0)+tokens;
  G.missions.casinoWinAmount=(G.missions.casinoWinAmount||0)+(final*0.01);
  addWagerWarAmount(tokens);
  // Reputation up
  G.reputation=Math.min(100,(G.reputation||0)+1);
  addXP(10);checkMissions();renderSidebar();updateTokenDisplay();
  if(G.winStreak>=3)notify(`ðŸ”¥ ${G.winStreak} Win Streak! +${((bonusMult-1)*100).toFixed(0)}% token bonus!`,'success');
  if(G.hotStreak>=5&&G.hotStreak%5===0)notify(`âš¡ ${G.hotStreak}-win hot streak! You're unstoppable!`,'rare');
  checkHotStreak();
  updateVIPTier();
  checkGlobalEvents();
}
function tokenLose(tokens,label){
  G.winStreak=0;
  G.hotStreak=0;
  G.casinoLosses++;
  // Tilt increases on losses
  G.tiltLevel=Math.min(100,(G.tiltLevel||0)+10);
  if(tokens>G.lifetimeBiggestLoss)G.lifetimeBiggestLoss=tokens;
  G.totalWagered=(G.totalWagered||0)+tokens;
  G.totalBet+=tokens*0.01;
  // Karma comeback mechanic: very tilted = small hidden luck boost
  if(G.tiltLevel>=70)G.luckBonus=Math.min((G.luckBonus||0)+2,20);
  updateRiskUI();
  checkHotStreak();
  addHistory(label+' (lost)',-tokens,'loss');addXP(2);checkMissions();renderSidebar();updateTokenDisplay();
  updateVIPTier();
}
function updateRiskUI(){
  const el=document.getElementById('risk-index-bar');
  if(el)el.style.width=(G.riskIndex||0)+'%';
  const tl=document.getElementById('tilt-index-bar');
  if(tl)tl.style.width=(G.tiltLevel||0)+'%';
}

// ============================================================
// LOAN CONSEQUENCES
// ============================================================
function getLoanLimit(){
  const level=G.level||1;
  const base=500;
  return Math.floor(base*Math.pow(1.3,Math.min(level-1,30)));
}
function checkLoanConsequences(){
  if(!G||!G.loan||G.loan<=0)return;
  if(!G.loanTakenAt||G.loanTakenAt===0){G.loanTakenAt=Date.now();return;}
  const elapsed=Date.now()-G.loanTakenAt;
  const hourMs=3600000;
  if(elapsed>hourMs){
    // Seize inventory skins as collateral
    const seized=G.inventory.splice(0,Math.min(3,G.inventory.length));
    if(seized.length>0){
      const seizedVal=seized.reduce((s,sk)=>s+sk.price,0);
      G.loan=Math.max(0,G.loan-seizedVal);
      addHistory(`âš ï¸ LOAN SEIZURE: ${seized.length} skins confiscated`,-seizedVal,'loss');
      G.loanTakenAt=Date.now();// reset timer
      notify(`âš ï¸ LOAN OVERDUE! ${seized.length} skins seized as collateral! Repay your loan!`,'error');
      renderInventory();renderSidebar();saveGame();
    }else if(G.balance>0){
      const seize=Math.min(G.balance,G.loan*0.25);
      G.balance-=seize;G.loan=Math.max(0,G.loan-seize);
      G.loanTakenAt=Date.now();
      notify(`âš ï¸ $${fmt(seize)} seized from balance for overdue loan!`,'error');
      renderSidebar();
    }
  }
}
// ============================================================
// IMPORT / EXPORT
// ============================================================
function exportSave(){
  if(!G)return;
  const data=btoa(JSON.stringify({state:G,version:3}));
  const blob=new Blob([data],{type:'text/plain'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='csroll_save_v3.txt';a.click();
  notify('Save exported!','success');
}
function importSave(){
  const input=document.createElement('input');input.type='file';input.accept='.txt';
  input.onchange=e=>{
    const file=e.target.files[0];if(!file)return;
    const reader=new FileReader();
    reader.onload=ev=>{
      try{
        const decoded=JSON.parse(atob(ev.target.result));
        if(!decoded.state){notify('Invalid save file!','error');return;}
        G={...decoded.state};
        migrateSave();
        ACCOUNTS[currentUser].state=G;
        saveGame();
        // Re-init UI
        renderSidebar();renderCases();renderUpgrades();renderInventory();renderMissions();renderStats();
        notify('Save imported successfully!','success');
      }catch(e){notify('Failed to parse save file!','error');}
    };reader.readAsText(file);
  };input.click();
}

// ============================================================
// AUTO-OPEN CASES
// ============================================================
let autoOpenInterval=null;
function toggleAutoOpen(){
  G.autoOpenActive=!G.autoOpenActive;
  const btn=document.getElementById('auto-open-btn');
  if(G.autoOpenActive){
    if(btn){btn.textContent='â¹ Stop Auto-Open';btn.style.background='var(--red)';}
    autoOpenInterval=setInterval(()=>{
      if(!G.autoOpenActive){clearInterval(autoOpenInterval);return;}
      if(!currentCase){notify('No case selected for auto-open!','error');G.autoOpenActive=false;clearInterval(autoOpenInterval);return;}
      if(G.balance<currentCase.price){notify('Out of funds â€” auto-open stopped.','error');G.autoOpenActive=false;clearInterval(autoOpenInterval);return;}
      // Quick open without animation
      G.balance-=currentCase.price;G.casesOpened++;
      const rarity=rollRarity(currentCase.price);
      const skin=generateSkin(rarity,currentCase.name);
      G.inventory.push(skin);
      G.totalEarned+=skin.price;
      addHistory('Auto-Open: '+currentCase.name+' â†’ '+skin.name,skin.price,'win');
      addXP(5);checkMissions();checkAchievements();
      renderSidebar();renderInventory();
      if(skin.rarity==='knife'||skin.rarity==='covert'){
        G.autoOpenActive=false;clearInterval(autoOpenInterval);
        if(btn){btn.textContent='â–¶ Auto-Open';btn.style.background='';}
        showKnifeOverlay(skin);spawnParticles();
        notify(`ðŸ”ª Auto-open stopped â€” you got a ${skin.rarity}!`,'success');
      }
    },1500);
  }else{
    clearInterval(autoOpenInterval);
    if(btn){btn.textContent='â–¶ Auto-Open';btn.style.background='';}
  }
  saveGame();
}

// ============================================================
// COSMETIC SHOP
// ============================================================
const SHOP_THEMES = [
  {id:'default',name:'Default Dark',price:0,preview:'linear-gradient(135deg,#0d0e12,#13141a)',owned:true},
  {id:'neon',name:'Neon Night',price:500,preview:'linear-gradient(135deg,#050510,#0a0020)',css:{bg:'#050510',bg2:'#0a0020',bg3:'#10003a',accent:'#00ffcc',accent2:'#7700ff'}},
  {id:'red',name:'Bloodline Red',price:500,preview:'linear-gradient(135deg,#100205,#1a0a0a)',css:{bg:'#100205',bg2:'#1a0508',bg3:'#250a0d',accent:'#ff2244',accent2:'#ff6622'}},
  {id:'forest',name:'Forest Ops',price:500,preview:'linear-gradient(135deg,#0a1206,#0d1a0a)',css:{bg:'#0a1206',bg2:'#0d1a0a',bg3:'#132009',accent:'#44ff66',accent2:'#88cc22'}},
  {id:'gold',name:'Golden Prestige',price:2000,preview:'linear-gradient(135deg,#120e00,#1a1500)',css:{bg:'#120e00',bg2:'#1a1500',bg3:'#221c00',accent:'#ffcc00',accent2:'#ff9900'},special:true},
  {id:'diamond',name:'Diamond Elite',price:5000,preview:'linear-gradient(135deg,#050d1a,#0a0820)',css:{bg:'#050d1a',bg2:'#080c1f',bg3:'#0e1230',accent:'#88ccff',accent2:'#5588ee'},special:true},
];
const SHOP_TITLES = [
  {id:'Newbie',name:'Newbie',price:0},{id:'Opener',name:'Case Opener',price:100},
  {id:'Gambler',name:'High Roller',price:300},{id:'Collector',name:'Skin Collector',price:500},
  {id:'Elite',name:'Elite Player',price:1000},{id:'Legend',name:'Legend',price:3000},
  {id:'God',name:'CS:GOD',price:10000},
];
const SHOP_AVATARS = [
  {id:'default',emoji:'ðŸ‘¤',name:'Default',price:0},{id:'knife',emoji:'ðŸ”ª',name:'Knife',price:200},
  {id:'crown',emoji:'ðŸ‘‘',name:'Crown',price:500},{id:'fire',emoji:'ðŸ”¥',name:'Fire',price:300},
  {id:'diamond',emoji:'ðŸ’Ž',name:'Diamond',price:1000},{id:'skull',emoji:'ðŸ’€',name:'Skull',price:400},
  {id:'snake',emoji:'ðŸ',name:'Snake King',price:800},{id:'star',emoji:'â­',name:'Star',price:600},
  {id:'rocket',emoji:'ðŸš€',name:'Rocket',price:700},{id:'alien',emoji:'ðŸ‘½',name:'Alien',price:1500},
];

function renderShop(){
  const el=document.getElementById('page-shop');if(!el)return;
  const coins=G.cosmetics?.shopCoins||0;
  const ownedThemes=G.cosmetics?.ownedThemes||['default'];
  const ownedTitles=G.cosmetics?.ownedTitles||['Newbie'];
  const ownedAvatars=G.cosmetics?.ownedAvatars||['default'];
  el.querySelector('#shop-coins').textContent=fmtTokens(coins)+' ðŸª™ Shop Coins';
  // Themes
  el.querySelector('#shop-themes').innerHTML=SHOP_THEMES.map(t=>`
    <div style="background:var(--bg3);border:2px solid ${G.cosmetics?.theme===t.id?'var(--accent)':'var(--bg5)'};border-radius:12px;padding:14px;cursor:pointer;transition:.2s" onclick="buyTheme('${t.id}')">
      <div style="height:40px;border-radius:8px;margin-bottom:8px;background:${t.preview};border:1px solid rgba(255,255,255,.1)"></div>
      <div style="font-weight:700;font-size:13px">${t.name}${t.special?'  âœ¦':''}${G.cosmetics?.theme===t.id?' âœ“':''}</div>
      <div style="font-size:11px;color:var(--text3)">${ownedThemes.includes(t.id)?'<span style="color:var(--green)">âœ“ Owned</span>':'ðŸª™ '+fmt(t.price)+' coins'}</div>
    </div>
  `).join('');
  // Titles
  el.querySelector('#shop-titles').innerHTML=SHOP_TITLES.map(t=>`
    <div style="background:var(--bg3);border:1px solid ${G.cosmetics?.title===t.id?'var(--accent)':'var(--bg5)'};border-radius:8px;padding:10px 14px;cursor:pointer;display:flex;align-items:center;justify-content:space-between" onclick="buyTitle('${t.id}')">
      <div style="font-weight:700">${t.name}${G.cosmetics?.title===t.id?' âœ“':''}</div>
      <div style="font-size:11px;color:var(--text3)">${ownedTitles.includes(t.id)?'<span style="color:var(--green)">Equipped</span>':'ðŸª™ '+fmt(t.price)}</div>
    </div>
  `).join('');
  // Avatars
  el.querySelector('#shop-avatars').innerHTML=SHOP_AVATARS.map(a=>`
    <div style="background:var(--bg3);border:2px solid ${G.cosmetics?.avatar===a.id?'var(--accent)':'var(--bg5)'};border-radius:12px;padding:12px;text-align:center;cursor:pointer;transition:.2s" onclick="buyAvatar('${a.id}')">
      <div style="font-size:32px;margin-bottom:6px">${a.emoji}</div>
      <div style="font-size:12px;font-weight:700">${a.name}</div>
      <div style="font-size:10px;color:var(--text3)">${ownedAvatars.includes(a.id)?'<span style="color:var(--green)">âœ“</span>':'ðŸª™ '+fmt(a.price)}</div>
    </div>
  `).join('');
}
function buyTheme(id){
  const theme=SHOP_THEMES.find(t=>t.id===id);if(!theme)return;
  const owned=(G.cosmetics.ownedThemes||[]).includes(id);
  if(!owned){
    const coins=G.cosmetics.shopCoins||0;
    if(coins<theme.price){notify(`Need ${fmt(theme.price)} shop coins!`,'error');return;}
    G.cosmetics.shopCoins-=theme.price;
    G.cosmetics.ownedThemes=[...(G.cosmetics.ownedThemes||['default']),id];
  }
  G.cosmetics.theme=id;
  applyTheme(id);saveGame();renderShop();renderSidebar();
  notify(`Theme changed to "${theme.name}"!`,'success');
}
function buyTitle(id){
  const t=SHOP_TITLES.find(x=>x.id===id);if(!t)return;
  const owned=(G.cosmetics.ownedTitles||[]).includes(id);
  if(!owned){
    const coins=G.cosmetics.shopCoins||0;
    if(coins<t.price){notify(`Need ${fmt(t.price)} shop coins!`,'error');return;}
    G.cosmetics.shopCoins-=t.price;
    G.cosmetics.ownedTitles=[...(G.cosmetics.ownedTitles||['Newbie']),id];
  }
  G.cosmetics.title=id;saveGame();renderShop();renderSidebar();
  notify(`Title set to "${t.name}"!`,'success');
}
function buyAvatar(id){
  const a=SHOP_AVATARS.find(x=>x.id===id);if(!a)return;
  const owned=(G.cosmetics.ownedAvatars||[]).includes(id);
  if(!owned){
    const coins=G.cosmetics.shopCoins||0;
    if(coins<a.price){notify(`Need ${fmt(a.price)} shop coins!`,'error');return;}
    G.cosmetics.shopCoins-=a.price;
    G.cosmetics.ownedAvatars=[...(G.cosmetics.ownedAvatars||['default']),id];
  }
  G.cosmetics.avatar=id;saveGame();renderShop();renderSidebar();
  notify(`Avatar set to ${a.emoji}!`,'success');
}
function applyTheme(themeId){
  const t=SHOP_THEMES.find(x=>x.id===themeId);
  if(!t||!t.css)return;
  const root=document.documentElement;
  Object.entries(t.css).forEach(([k,v])=>root.style.setProperty('--'+k,v));
}
function earnShopCoins(amt){
  if(!G.cosmetics)migrateSave();
  G.cosmetics.shopCoins=(G.cosmetics.shopCoins||0)+amt;
}

// ============================================================
// DICE GAME (Under/Over)
// ============================================================
let diceSelectedSide='under';

function selectDiceSide(side){
  diceSelectedSide=side;
  document.getElementById('dice-under-info').style.borderColor=side==='under'?'var(--accent2)':'var(--bg5)';
  document.getElementById('dice-over-info').style.borderColor=side==='over'?'var(--accent3)':'var(--bg5)';
  updateDiceOdds();
}

function updateDiceOdds(){
  const target=parseInt(document.getElementById('dice-target')?.value||50);
  document.getElementById('dice-target-val').textContent=target;
  document.getElementById('dice-under-num').textContent='< '+target;
  document.getElementById('dice-over-num').textContent='> '+target;
  // Win chance: for under = (target-1)/100, for over = (100-target)/100
  const underChance=(target-1)/100;
  const overChance=(100-target)/100;
  // Payout = (1/chance)*0.98 (2% house edge)
  const underMult=underChance>0?+(0.98/underChance).toFixed(2):99;
  const overMult=overChance>0?+(0.98/overChance).toFixed(2):99;
  document.getElementById('dice-under-mult').textContent=underMult+'Ã—';
  document.getElementById('dice-over-mult').textContent=overMult+'Ã—';
  const activeChance=diceSelectedSide==='under'?underChance:overChance;
  const activeMult=diceSelectedSide==='under'?underMult:overMult;
  document.getElementById('dice-win-pct').textContent=(activeChance*100).toFixed(1)+'%';
  document.getElementById('dice-mult-display').textContent=activeMult+'Ã—';
  selectDiceSide(diceSelectedSide);// refresh border
}

function rollDice(){
  const bet=parseInt(document.getElementById('dice-bet')?.value)||100;
  if(!spendTokens(bet))return;
  const target=parseInt(document.getElementById('dice-target')?.value||50);
  const roll=Math.floor(Math.random()*100)+1;// 1â€“100
  const underChance=(target-1)/100;
  const overChance=(100-target)/100;
  const mult=diceSelectedSide==='under'?+(0.98/underChance).toFixed(2):+(0.98/overChance).toFixed(2);
  const win=(diceSelectedSide==='under'&&roll<target)||(diceSelectedSide==='over'&&roll>target);
  // Animate roll display
  const rollEl=document.getElementById('dice-roll-display');
  const resEl=document.getElementById('dice-result-text');
  rollEl.style.color='var(--text3)';
  let count=0;
  const anim=setInterval(()=>{
    rollEl.textContent=Math.floor(Math.random()*100)+1;
    count++;
    if(count>15){
      clearInterval(anim);
      rollEl.textContent=roll;
      if(win){
        const won=Math.floor(bet*mult);
        rollEl.style.color='var(--green)';
        resEl.textContent=`âœ… Roll ${roll} â€” ${diceSelectedSide==='under'?'Under':'Over'} ${target}! Won ${fmtTokens(won)} tokens (${mult}Ã—)`;
        resEl.style.color='var(--green)';
        tokenWin(won,'Dice Win ('+diceSelectedSide+' '+target+', rolled '+roll+')');
        earnShopCoins(Math.floor(Math.log10(won+1)));
        playSound('win');
      }else{
        rollEl.style.color='var(--red)';
        resEl.textContent=`âŒ Roll ${roll} â€” Lost ${fmtTokens(bet)} tokens`;
        resEl.style.color='var(--red)';
        tokenLose(0,'Dice Loss ('+diceSelectedSide+' '+target+', rolled '+roll+')');
        playSound('lose');
      }
    }
  },60);
}

// ============================================================
// KENO
// ============================================================
let kenoPicks=new Set();
function initKeno(){
  const grid=document.getElementById('keno-grid');
  if(!grid||grid.children.length===80)return;
  grid.innerHTML='';
  for(let i=1;i<=40;i++){
    const btn=document.createElement('button');
    btn.className='btn btn-secondary btn-sm';
    btn.id='keno-num-'+i;
    btn.textContent=i;
    btn.style.cssText='padding:4px 2px;font-size:13px;font-weight:700;font-family:"Barlow Condensed",sans-serif;border-radius:6px;min-width:0';
    btn.onclick=()=>kenoToggle(i);
    grid.appendChild(btn);
  }
}
function kenoToggle(n){
  if(kenoPicks.has(n)){kenoPicks.delete(n);document.getElementById('keno-num-'+n).style.background='';}
  else if(kenoPicks.size<10){kenoPicks.add(n);document.getElementById('keno-num-'+n).style.background='var(--accent)';}
  document.getElementById('keno-pick-count').textContent=kenoPicks.size;
}
function kenoQuickPick(){kenoClear();while(kenoPicks.size<7){kenoToggle(Math.floor(Math.random()*40)+1);}}
function kenoClear(){kenoPicks.forEach(n=>{document.getElementById('keno-num-'+n).style.background='';});kenoPicks.clear();document.getElementById('keno-pick-count').textContent=0;}
const KENO_PAYOUTS=[0,0,1,2,4,8,15,30,75,200,500];// index = matches
function kenoPlay(){
  if(kenoPicks.size<2){notify('Pick at least 2 numbers!','error');return;}
  const bet=parseInt(document.getElementById('keno-bet').value)||100;
  if(!spendTokens(bet))return;
  // Draw 20 from 1-40
  const pool=Array.from({length:40},(_,i)=>i+1);
  for(let i=pool.length-1;i>0;i--){const j=Math.random()*(i+1)|0;[pool[i],pool[j]]=[pool[j],pool[i]];}
  const drawn=new Set(pool.slice(0,20));
  // Highlight drawn numbers
  for(let i=1;i<=40;i++){
    const el=document.getElementById('keno-num-'+i);
    if(!el)continue;
    if(drawn.has(i)&&kenoPicks.has(i)){el.style.background='#2ecc71';el.style.color='#000';}
    else if(drawn.has(i)){el.style.background='var(--bg3)';}
    else if(kenoPicks.has(i)){el.style.background='var(--red)';}
    else{el.style.background='';}
  }
  const matches=Array.from(kenoPicks).filter(n=>drawn.has(n)).length;
  const payIdx=Math.min(matches,kenoPicks.size,10);
  const mult=KENO_PAYOUTS[payIdx]||0;
  const won=Math.floor(bet*mult);
  const res=document.getElementById('keno-result');
  const drawList=document.getElementById('keno-drawn-display');
  drawList.textContent='Drawn: '+Array.from(drawn).sort((a,b)=>a-b).join(', ');
  if(won>0){
    tokenWin(won,'Keno '+matches+' matches');
    res.textContent=`âœ… ${matches} match${matches!==1?'es':''} â€” Won ${fmtTokens(won)} tokens (${mult}Ã—)!`;
    res.style.color='var(--green)';playSound('win');
  }else{
    tokenLose(0,'Keno no match');
    res.textContent=`âŒ ${matches} match${matches!==1?'es':''} â€” Lost ${fmtTokens(bet)} tokens`;
    res.style.color='var(--red)';playSound('lose');
  }
}

// ============================================================
// TOWER CLIMB
// ============================================================
let towerActive=false,towerFloor=0,towerBet=0,towerMultiplier=1,towerMines=2;
const TOWER_FLOORS=10;
const TOWER_MULTS=[1.5,2.2,3.2,4.8,7,11,18,28,48,80];// mult at each floor
function initTower(){
  const grid=document.getElementById('tower-grid');
  if(!grid)return;
  grid.innerHTML='';
  for(let i=TOWER_FLOORS-1;i>=0;i--){
    const row=document.createElement('div');
    row.style.cssText='display:flex;gap:4px;justify-content:center';
    for(let d=0;d<3;d++){
      const btn=document.createElement('button');
      btn.className='btn btn-secondary';
      btn.id=`tower-door-${i}-${d}`;
      btn.style.cssText=`flex:1;padding:8px 4px;font-size:18px;opacity:${towerActive&&i===towerFloor?1:0.4};pointer-events:${towerActive&&i===towerFloor?'auto':'none'}`;
      btn.textContent='ðŸšª';
      btn.onclick=()=>towerChoose(i,d);
      row.appendChild(btn);
    }
    const label=document.createElement('div');
    label.style.cssText='font-size:10px;color:var(--text3);text-align:center;margin-top:2px;font-family:"Barlow Condensed",sans-serif';
    label.textContent=`F${i+1} â€” ${TOWER_MULTS[i]}Ã—`;
    const wrap=document.createElement('div');
    wrap.id='tower-row-'+i;
    wrap.appendChild(row);wrap.appendChild(label);
    grid.appendChild(wrap);
  }
}
function towerStart(){
  towerBet=parseInt(document.getElementById('tower-bet').value)||100;
  towerMines=parseInt(document.getElementById('tower-mines').value)||2;
  if(!spendTokens(towerBet))return;
  towerActive=true;towerFloor=0;towerMultiplier=1;
  document.getElementById('tower-start-btn').style.display='none';
  document.getElementById('tower-cashout-btn').style.display='block';
  document.getElementById('tower-result').textContent='';
  updateTowerDisplay();initTower();
  addHistory('Tower Bet (tokens)',-towerBet,'expense');
}
function updateTowerDisplay(){
  document.getElementById('tower-floor-num').textContent=towerFloor;
  const m=towerFloor<TOWER_FLOORS?TOWER_MULTS[towerFloor]:TOWER_MULTS[TOWER_FLOORS-1];
  towerMultiplier=m;
  document.getElementById('tower-mult-display').textContent=m+'Ã—';
  document.getElementById('tower-payout-display').textContent=fmtTokens(Math.floor(towerBet*m));
  for(let i=0;i<TOWER_FLOORS;i++){
    for(let d=0;d<3;d++){
      const btn=document.getElementById(`tower-door-${i}-${d}`);
      if(btn){btn.style.opacity=towerActive&&i===towerFloor?1:0.35;btn.style.pointerEvents=towerActive&&i===towerFloor?'auto':'none';}
    }
  }
}
function towerChoose(floor,door){
  if(!towerActive||floor!==towerFloor)return;
  // Reveal door
  const btn=document.getElementById(`tower-door-${floor}-${door}`);
  // Randomly place mines
  const mineDoors=[];
  while(mineDoors.length<towerMines){const d=Math.floor(Math.random()*3);if(!mineDoors.includes(d))mineDoors.push(d);}
  // Reveal all doors on this floor
  for(let d=0;d<3;d++){
    const b=document.getElementById(`tower-door-${floor}-${d}`);
    if(!b)continue;
    b.textContent=mineDoors.includes(d)?'ðŸ’£':'ðŸ’Ž';
    b.style.background=mineDoors.includes(d)?'#3a1a1a':'#1a3a25';
    b.style.opacity=0.9;
  }
  if(mineDoors.includes(door)){
    // Hit mine
    towerActive=false;
    document.getElementById('tower-start-btn').style.display='block';
    document.getElementById('tower-cashout-btn').style.display='none';
    const res=document.getElementById('tower-result');
    res.textContent=`ðŸ’¥ Mine hit on floor ${floor+1}! Lost all ${fmtTokens(towerBet)} tokens`;
    res.style.color='var(--red)';
    tokenLose(0,'Tower exploded floor '+(floor+1));playSound('lose');
  }else{
    towerFloor++;
    if(towerFloor>=TOWER_FLOORS){towerCashout();return;}
    updateTowerDisplay();playSound('win');
    document.getElementById('tower-result').textContent=`âœ… Floor ${floor+1} cleared! Next: ${TOWER_MULTS[towerFloor]}Ã—`;
    document.getElementById('tower-result').style.color='var(--green)';
  }
}
function towerCashout(){
  if(!towerActive)return;
  towerActive=false;
  const won=Math.floor(towerBet*towerMultiplier);
  tokenWin(won,'Tower cashout floor '+towerFloor);
  document.getElementById('tower-start-btn').style.display='block';
  document.getElementById('tower-cashout-btn').style.display='none';
  const res=document.getElementById('tower-result');
  res.textContent=`ðŸ’° Cashed out! Won ${fmtTokens(won)} tokens (${towerMultiplier}Ã—)`;
  res.style.color='var(--gold)';playSound('knife');
  updateTowerDisplay();
}

// ============================================================
// LIMBO
// ============================================================
function updateLimboInfo(){
  const target=parseFloat(document.getElementById('limbo-target')?.value)||2;
  const winChance=Math.min(98,100/target)*0.98;// 2% edge
  const payout=+(target).toFixed(2);
  document.getElementById('limbo-win-pct').textContent=winChance.toFixed(1)+'%';
  document.getElementById('limbo-payout-display').textContent=payout+'Ã—';
}
function setLimboTarget(v){const el=document.getElementById('limbo-target');if(el){el.value=v;updateLimboInfo();}}
function limboRoll(){
  const bet=parseInt(document.getElementById('limbo-bet').value)||100;
  const target=parseFloat(document.getElementById('limbo-target').value)||2;
  if(!spendTokens(bet))return;
  const resEl=document.getElementById('limbo-result-num');
  const textEl=document.getElementById('limbo-result-text');
  resEl.style.color='var(--text3)';resEl.textContent='â€¦';
  let frames=0;
  const animate=setInterval(()=>{
    resEl.textContent=+(Math.random()*target*3+0.01).toFixed(2)+'Ã—';
    frames++;
    if(frames>20){
      clearInterval(animate);
      // Generate result â€” house has 2% edge
      const r=Math.random();
      const crashPoint=r<0.02?1:(1/r);
      const result=+Math.max(1.01,crashPoint).toFixed(2);
      resEl.textContent=result+'Ã—';
      if(result>=target){
        const won=Math.floor(bet*target);
        resEl.style.color='var(--green)';
        textEl.textContent=`âœ… ${result}Ã— â‰¥ ${target}Ã—! Won ${fmtTokens(won)} tokens!`;
        textEl.style.color='var(--green)';
        tokenWin(won,'Limbo '+target+'Ã— hit ('+result+'Ã—)');playSound('win');
      }else{
        resEl.style.color='var(--red)';
        textEl.textContent=`âŒ ${result}Ã— < ${target}Ã—! Lost ${fmtTokens(bet)} tokens`;
        textEl.style.color='var(--red)';
        tokenLose(0,'Limbo miss');playSound('lose');
      }
    }
  },60);
}

// ============================================================
// WHEEL OF FORTUNE
// ============================================================
const WHEEL_SEGS=[
  {label:'0.2Ã—',mult:0.2,color:'#eb4b4b'},{label:'1.5Ã—',mult:1.5,color:'#5e98d9'},
  {label:'0.5Ã—',mult:0.5,color:'#e74c3c'},{label:'3Ã—',mult:3,color:'#4b69ff'},
  {label:'0.2Ã—',mult:0.2,color:'#eb4b4b'},{label:'2Ã—',mult:2,color:'#2ecc71'},
  {label:'0.5Ã—',mult:0.5,color:'#e74c3c'},{label:'5Ã—',mult:5,color:'#8847ff'},
  {label:'0.2Ã—',mult:0.2,color:'#eb4b4b'},{label:'1Ã—',mult:1,color:'#5e98d9'},
  {label:'0.5Ã—',mult:0.5,color:'#e74c3c'},{label:'10Ã—',mult:10,color:'#d32ce6'},
  {label:'0.2Ã—',mult:0.2,color:'#eb4b4b'},{label:'2Ã—',mult:2,color:'#2ecc71'},
  {label:'0.5Ã—',mult:0.5,color:'#e74c3c'},{label:'50Ã—',mult:50,color:'#e4ae39'},
];
let wheelSpinning=false,wheelAngle=0;
function initWheelCanvas(){
  const canvas=document.getElementById('wheel-canvas');
  if(!canvas)return;
  drawWheelStatic(wheelAngle);
}
function drawWheelStatic(angle){
  const canvas=document.getElementById('wheel-canvas');
  if(!canvas)return;
  const ctx=canvas.getContext('2d');
  const W=280,H=280,cx=W/2,cy=H/2,r=cx-6;
  ctx.clearRect(0,0,W,H);
  const n=WHEEL_SEGS.length;
  const arc=2*Math.PI/n;
  WHEEL_SEGS.forEach((seg,i)=>{
    const a=angle+i*arc;
    ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,r,a,a+arc);ctx.closePath();
    ctx.fillStyle=seg.color;ctx.fill();
    ctx.strokeStyle='#08090f';ctx.lineWidth=2;ctx.stroke();
    ctx.save();ctx.translate(cx,cy);ctx.rotate(a+arc/2);
    ctx.textAlign='right';ctx.font='bold 11px "Barlow Condensed"';ctx.fillStyle='white';
    ctx.shadowColor='rgba(0,0,0,.8)';ctx.shadowBlur=3;
    ctx.fillText(seg.label,r-6,4);ctx.restore();
  });
  // Center circle
  ctx.beginPath();ctx.arc(cx,cy,18,0,Math.PI*2);ctx.fillStyle='#08090f';ctx.fill();
  ctx.strokeStyle='#f0a500';ctx.lineWidth=2;ctx.stroke();
  ctx.textAlign='center';ctx.font='bold 10px Barlow';ctx.fillStyle='#f0a500';ctx.fillText('SPIN',cx,cy+3.5);
}
function renderWheelPaytable(){
  const el=document.getElementById('wheel-paytable');
  if(!el)return;
  const unique=[...new Map(WHEEL_SEGS.map(s=>[s.label,s])).values()].sort((a,b)=>b.mult-a.mult);
  el.innerHTML=unique.map(s=>`<div style="background:${s.color}30;border:1px solid ${s.color}60;border-radius:6px;padding:4px 8px;font-weight:700;color:${s.color}">${s.label}</div>`).join('');
}
function wheelSpin(){
  if(wheelSpinning)return;
  const bet=parseInt(document.getElementById('wheel-bet').value)||100;
  if(!spendTokens(bet))return;
  wheelSpinning=true;
  document.getElementById('wheel-spin-btn').disabled=true;
  const result=Math.floor(Math.random()*WHEEL_SEGS.length);
  const fullRots=5+Math.floor(Math.random()*4);
  const n=WHEEL_SEGS.length;
  const arc=2*Math.PI/n;
  const targetAngle=fullRots*2*Math.PI+(-result*arc+Math.PI/2+arc/2);
  const start=wheelAngle,dist=targetAngle-start,duration=4000;
  const t0=performance.now();
  const ease=t=>t<0.5?2*t*t:-1+(4-2*t)*t;
  const step=(now)=>{
    const p=Math.min(1,(now-t0)/duration);
    wheelAngle=start+dist*ease(p);
    drawWheelStatic(wheelAngle);
    if(p<1)requestAnimationFrame(step);
    else{
      wheelSpinning=false;
      document.getElementById('wheel-spin-btn').disabled=false;
      const seg=WHEEL_SEGS[result];
      const won=Math.floor(bet*seg.mult);
      const res=document.getElementById('wheel-result');
      if(seg.mult>=1){
        tokenWin(won,'Wheel '+seg.label);
        res.textContent=`âœ… ${seg.label} â€” Won ${fmtTokens(won)} tokens!`;
        res.style.color=seg.color;playSound(seg.mult>=10?'knife':'win');
      }else{
        const refund=Math.floor(bet*seg.mult);
        addTokens(refund,'Wheel partial refund');
        tokenLose(0,'Wheel '+seg.label);
        res.textContent=`âŒ ${seg.label} â€” Lost ${fmtTokens(bet-refund)} tokens`;
        res.style.color='var(--red)';playSound('lose');
      }
    }
  };
  requestAnimationFrame(step);
}

// ============================================================
// VIDEO POKER (Jacks or Better)
// ============================================================
let vpHand=[],vpHeld=[],vpDealt=false,vpBet=0;
function vpInit(){document.getElementById('vp-deal-btn').style.display='inline-flex';document.getElementById('vp-draw-btn').style.display='none';vpRenderEmpty();}
function vpCard(){return{v:['2','3','4','5','6','7','8','9','10','J','Q','K','A'][Math.random()*13|0],s:['â™ ','â™¥','â™¦','â™£'][Math.random()*4|0]};}
function vpVal(c){if(['J','Q','K'].includes(c.v))return 10;if(c.v==='A')return 14;return +c.v;}
function vpRank(h){
  const vals=h.map(vpVal).sort((a,b)=>a-b);
  const suits=h.map(c=>c.s);
  const flush=suits.every(s=>s===suits[0]);
  const straight=vals[4]-vals[0]===4&&new Set(vals).size===5||(vals.join(',')===('2,3,4,5,14'));
  const counts={};vals.forEach(v=>counts[v]=(counts[v]||0)+1);
  const freq=Object.values(counts).sort((a,b)=>b-a);
  if(flush&&straight&&vals[4]===14&&vals[0]===10)return[9,'Royal Flush',800];
  if(flush&&straight)return[8,'Straight Flush',50];
  if(freq[0]===4)return[7,'Four of a Kind',25];
  if(freq[0]===3&&freq[1]===2)return[6,'Full House',9];
  if(flush)return[5,'Flush',6];
  if(straight)return[4,'Straight',4];
  if(freq[0]===3)return[3,'Three of a Kind',3];
  if(freq[0]===2&&freq[1]===2)return[2,'Two Pair',2];
  // Jacks or better
  const pairs=Object.entries(counts).filter(([v,c])=>c===2);
  if(pairs.length===1&&vpVal({v:pairs[0][0]})>=vpVal({v:'J'}))return[1,'Jacks or Better',1];
  return[0,'No Win',0];
}
function vpRenderEmpty(){
  document.getElementById('vp-cards').innerHTML=Array(5).fill('<div style="width:60px;height:90px;background:var(--bg4);border-radius:8px;border:2px solid var(--bg5)"></div>').join('');
  document.getElementById('vp-hold-btns').innerHTML='';
  document.getElementById('vp-hand-name').textContent='';
  document.getElementById('vp-result').textContent='';
}
function vpRenderHand(){
  const cardCol=c=>['â™¥','â™¦'].includes(c.s)?'#eb4b4b':'white';
  document.getElementById('vp-cards').innerHTML=vpHand.map((c,i)=>`
    <div style="width:60px;height:90px;background:${vpHeld[i]?'#1a3a1a':'var(--bg3)'};border-radius:8px;border:2px solid ${vpHeld[i]?'var(--green)':'var(--bg5)'};display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-weight:700;cursor:${vpDealt?'pointer':'default'};" onclick="${vpDealt?'vpToggleHold('+i+')':''}">
      <div style="font-size:22px;color:${cardCol(c)}">${c.v}</div>
      <div style="font-size:18px;color:${cardCol(c)}">${c.s}</div>
      ${vpHeld[i]?'<div style="font-size:9px;color:var(--green);margin-top:2px">HOLD</div>':''}
    </div>
  `).join('');
}
function vpToggleHold(i){if(!vpDealt)return;vpHeld[i]=!vpHeld[i];vpRenderHand();}
function vpDeal(){
  vpBet=parseInt(document.getElementById('vp-bet').value)||100;
  if(!spendTokens(vpBet))return;
  vpHand=Array(5).fill(null).map(()=>vpCard());
  vpHeld=Array(5).fill(false);vpDealt=true;
  vpRenderHand();
  document.getElementById('vp-deal-btn').style.display='none';
  document.getElementById('vp-draw-btn').style.display='inline-flex';
  document.getElementById('vp-hand-name').textContent='Click cards to HOLD, then Draw';
  document.getElementById('vp-hand-name').style.color='var(--text2)';
  document.getElementById('vp-result').textContent='';
}
function vpDraw(){
  for(let i=0;i<5;i++){if(!vpHeld[i])vpHand[i]=vpCard();}
  vpDealt=false;vpRenderHand();
  const [rank,name,mult]=vpRank(vpHand);
  document.getElementById('vp-hand-name').textContent=name;
  document.getElementById('vp-hand-name').style.color=rank>0?'var(--gold)':'var(--text3)';
  document.getElementById('vp-deal-btn').style.display='inline-flex';
  document.getElementById('vp-draw-btn').style.display='none';
  document.getElementById('vp-hold-btns').innerHTML='';
  if(rank>0){
    const won=Math.floor(vpBet*mult);
    tokenWin(won,'Video Poker: '+name);
    document.getElementById('vp-result').textContent=`âœ… ${name}! Won ${fmtTokens(won)} tokens (${mult}Ã—)`;
    document.getElementById('vp-result').style.color='var(--green)';playSound(rank>=7?'knife':'win');
  }else{
    tokenLose(0,'Video Poker no win');
    document.getElementById('vp-result').textContent=`âŒ ${name}. Lost ${fmtTokens(vpBet)} tokens.`;
    document.getElementById('vp-result').style.color='var(--red)';playSound('lose');
  }
}

// ============================================================
// THE HEIST (Original Feature)
// ============================================================
const HEIST_STAGES=[
  {name:'ðŸ” Scout the Target',desc:'Your crew slips past the outer security. A guard patrol starts in 30 seconds.',risk:'Low (75% safe)',chance:0.75,mult:1.5},
  {name:'ðŸ” Crack the Vault',desc:'The safecracker works fast. One wrong digit and alarms go off.',risk:'Medium (60% safe)',chance:0.60,mult:2.5},
  {name:'ðŸ’Ž Grab the Goods',desc:'Bags are filling up. The laser grid is active. One stumble = catastrophe.',risk:'High (50% safe)',chance:0.50,mult:4.5},
  {name:'ðŸš Fight to the Exit',desc:'Guards spotted you. Three routes out â€” only one is clear.',risk:'Very High (40% safe)',chance:0.40,mult:8},
  {name:'ðŸŒ… The Getaway',desc:'Police roadblocks everywhere. Your driver has one chance. Final stretch.',risk:'Extreme (30% safe)',chance:0.30,mult:32},
];
let heistState={active:false,stage:0,bet:0};
function renderHeistStages(){
  const el=document.getElementById('heist-stages-display');
  if(!el)return;
  el.innerHTML=HEIST_STAGES.map((s,i)=>`
    <div style="background:${i<heistState.stage?'#1a3a1a':i===heistState.stage&&heistState.active?'var(--bg3)':'var(--bg4)'};border:2px solid ${i<heistState.stage?'var(--green)':i===heistState.stage&&heistState.active?'var(--accent)':'var(--bg5)'};border-radius:8px;padding:8px;text-align:center;transition:.3s">
      <div style="font-size:18px">${i<heistState.stage?'âœ…':i===heistState.stage&&heistState.active?'âš¡':'ðŸ”’'}</div>
      <div style="font-size:9px;color:var(--text2);margin-top:2px;line-height:1.3">${s.name.slice(2)}</div>
      <div style="font-size:10px;font-weight:700;color:var(--gold);font-family:'Barlow Condensed',sans-serif">${s.mult}Ã—</div>
    </div>
  `).join('');
}
function heistAction(){
  if(!heistState.active){
    // Start heist
    heistState.bet=parseInt(document.getElementById('heist-bet').value)||500;
    if(!spendTokens(heistState.bet))return;
    heistState.active=true;heistState.stage=0;
    addHistory('Heist started (tokens)',-heistState.bet,'expense');
    document.getElementById('heist-abort-btn').style.display='inline-flex';
    document.getElementById('heist-action-btn').textContent='ðŸŽ¯ Execute Stage';
  }
  const stage=HEIST_STAGES[heistState.stage];
  document.getElementById('heist-narrative').textContent=stage.desc;
  renderHeistStages();
  const res=document.getElementById('heist-result');
  res.textContent='Executing: '+stage.name+'â€¦';
  res.style.color='var(--text2)';
  setTimeout(()=>{
    if(Math.random()<stage.chance){
      heistState.stage++;
      if(heistState.stage>=HEIST_STAGES.length){
        // Win!
        const won=Math.floor(heistState.bet*32);
        tokenWin(won,'ðŸ•µï¸ HEIST COMPLETE!');
        res.textContent=`ðŸŽŠ HEIST COMPLETE! Won ${fmtTokens(won)} tokens (32Ã—)!`;
        res.style.color='var(--gold)';playSound('knife');
        heistReset();
      }else{
        const partialMult=HEIST_STAGES[heistState.stage-1].mult;
        res.textContent=`âœ… ${HEIST_STAGES[heistState.stage-1].name} cleared! Pot: ${fmtTokens(Math.floor(heistState.bet*partialMult))} tokens`;
        res.style.color='var(--green)';playSound('win');
        renderHeistStages();
      }
    }else{
      res.textContent=`ðŸ’¥ Stage ${heistState.stage+1} FAILED! All ${fmtTokens(heistState.bet)} tokens lost!`;
      res.style.color='var(--red)';playSound('lose');
      tokenLose(0,'Heist failed stage '+(heistState.stage+1));
      heistReset();
    }
  },1500);
}
function heistAbort(){
  if(!heistState.active||heistState.stage===0){notify('Nothing to abort!','error');return;}
  const mult=HEIST_STAGES[heistState.stage-1].mult;
  const kept=Math.floor(heistState.bet*mult);
  addTokens(kept,'Heist abort â€” keeping stage rewards');
  document.getElementById('heist-result').textContent=`ðŸš¨ Heist aborted! Kept ${fmtTokens(kept)} tokens from completed stages`;
  document.getElementById('heist-result').style.color='var(--accent)';
  heistReset();
}
function heistReset(){
  heistState={active:false,stage:0,bet:0};
  document.getElementById('heist-abort-btn').style.display='none';
  document.getElementById('heist-action-btn').textContent='ðŸšª Begin Heist';
  renderHeistStages();
}

// ============================================================
// SKIN FORGE (Original Feature)
// ============================================================
const RARITY_ORDER=['consumer','industrial','milspec','restricted','classified','covert','knife'];
let forgeSlots=[null,null,null],forgePickTarget=0;
function forgeSlotClick(i){
  forgePickTarget=i;
  const el=document.getElementById('forge-picker-modal');
  if(!el)return;
  el.style.display='block';
  const grid=document.getElementById('forge-picker-grid');
  const rarity=forgeSlots.find(s=>s!==null)?.rarity||null;
  const eligible=G.inventory.filter(s=>!s.banked&&(!rarity||s.rarity===rarity)&&!forgeSlots.find(f=>f&&+f.id===+s.id));
  if(!eligible.length){el.style.display='none';notify('No eligible skins! Forge needs 3 skins of the same rarity.','error');return;}
  grid.innerHTML=eligible.map(s=>`
    <div onclick="forgePick('${s.id}')" style="background:var(--bg3);border:2px solid ${RARITIES[s.rarity].color}40;border-radius:10px;cursor:pointer;overflow:hidden;transition:.15s" onmouseover="this.style.borderColor='${RARITIES[s.rarity].color}'" onmouseout="this.style.borderColor='${RARITIES[s.rarity].color}40'">
      <div style="height:70px;overflow:hidden">${getSkinSVG(s)}</div>
      <div style="padding:4px 6px;font-size:9px;color:${RARITIES[s.rarity].color};font-weight:700;overflow:hidden;white-space:nowrap;text-overflow:ellipsis">${s.name}</div>
      <div style="padding:0 6px 4px;font-size:10px;color:var(--text2)">$${fmt(s.price)}</div>
    </div>
  `).join('');
}
function forgePick(id){
  const skin=G.inventory.find(s=>+s.id===+id);
  if(!skin)return;
  forgeSlots[forgePickTarget]=skin;
  closeForgePicker();
  renderForgeSlots();
  updateForgeInfo();
}
function closeForgePicker(){document.getElementById('forge-picker-modal').style.display='none';}
function forgeClear(){forgeSlots=[null,null,null];renderForgeSlots();updateForgeInfo();}
function renderForgeSlots(){
  for(let i=0;i<3;i++){
    const el=document.getElementById('forge-slot-'+i);
    if(!el)continue;
    const skin=forgeSlots[i];
    if(skin){
      el.innerHTML=`<div style="width:100%;height:70px;overflow:hidden">${getSkinSVG(skin)}</div><div style="font-size:9px;padding:2px 4px;color:${RARITIES[skin.rarity].color};font-weight:700;overflow:hidden;white-space:nowrap;text-overflow:ellipsis">${skin.name}</div><button onclick="event.stopPropagation();forgeSlots[${i}]=null;renderForgeSlots();updateForgeInfo();" style="background:none;color:var(--red);font-size:12px;cursor:pointer;border:none;padding:0 4px">âœ• Remove</button>`;
      el.style.borderColor=RARITIES[skin.rarity].color+'60';
    }else{
      el.innerHTML='<div style="font-size:28px">âž•</div><div style="font-size:11px;color:var(--text3);margin-top:4px">Add Skin</div>';
      el.style.borderColor='var(--bg5)';
    }
  }
}
function updateForgeInfo(){
  const filled=forgeSlots.filter(Boolean);
  const btn=document.getElementById('forge-btn');
  const info=document.getElementById('forge-info');
  if(filled.length<3){info.textContent=`Select ${3-filled.length} more skin${3-filled.length!==1?'s':''}â€¦`;btn.disabled=true;return;}
  const rarities=new Set(filled.map(s=>s.rarity));
  if(rarities.size>1){info.textContent='âš ï¸ All 3 skins must be the same rarity!';info.style.color='var(--red)';btn.disabled=true;return;}
  const rarity=[...rarities][0];
  const nextRarity=RARITY_ORDER[RARITY_ORDER.indexOf(rarity)+1];
  if(!nextRarity){info.textContent='âš ï¸ Knives cannot be forged higher.';info.style.color='var(--red)';btn.disabled=true;return;}
  info.style.color='var(--green)';
  info.textContent=`âœ… Ready! 3Ã— ${rarity} â†’ 1Ã— ${nextRarity}. Cost: 3 skins.`;
  btn.disabled=false;
}
function forgeExecute(){
  const filled=forgeSlots.filter(Boolean);
  if(filled.length<3)return;
  const rarity=filled[0].rarity;
  if(filled.some(s=>s.rarity!==rarity)){notify('Mismatched rarities!','error');return;}
  const nextRarity=RARITY_ORDER[RARITY_ORDER.indexOf(rarity)+1];
  if(!nextRarity)return;
  // Remove the 3 skins
  filled.forEach(skin=>{const i=G.inventory.findIndex(s=>+s.id===+skin.id);if(i>=0)G.inventory.splice(i,1);});
  const newSkin=generateSkin(nextRarity,'Forge');
  G.inventory.push(newSkin);
  saveGame();renderInventory();
  document.getElementById('forge-result').innerHTML=`
    <div style="background:var(--bg4);border:2px solid ${RARITIES[nextRarity].color};border-radius:12px;padding:10px;display:inline-block;text-align:center">
      <div style="width:140px;height:90px;overflow:hidden;margin:0 auto">${getSkinSVG(newSkin)}</div>
      <div style="font-size:13px;font-weight:700;color:${RARITIES[nextRarity].color};margin-top:6px">${newSkin.name}</div>
      <div style="font-size:12px;color:var(--text2)">$${fmt(newSkin.price)} â€” Forged!</div>
    </div>`;
  notify(`âš—ï¸ Forged! ${rarity} â†’ ${nextRarity}: ${newSkin.name}!`,'rare');playSound('knife');
  forgeSlots=[null,null,null];renderForgeSlots();updateForgeInfo();
}

// ============================================================
// CHICKEN GAME (Original Feature)
// ============================================================
const BOT_PROFILES={
  wimp:{name:'Chicken Bot ðŸ¥',emoji:'ðŸ¥',foldChance:0.55,escalateChance:0.2},
  normal:{name:'Normal Bot ðŸ¤–',emoji:'ðŸ¤–',foldChance:0.35,escalateChance:0.35},
  maniac:{name:'Madman Bot ðŸ˜ˆ',emoji:'ðŸ˜ˆ',foldChance:0.1,escalateChance:0.6},
};
let chickenState={active:false,pot:0,round:0,playerIn:0,botIn:0,bet:0,profile:null};
function chickenLog(msg){
  const el=document.getElementById('chicken-log');
  if(!el)return;
  el.innerHTML+=`<div>${msg}</div>`;el.scrollTop=el.scrollHeight;
}
function chickenUpdate(){
  document.getElementById('chicken-pot').textContent='ðŸ† '+fmtTokens(chickenState.pot);
  document.getElementById('chicken-round-num').textContent='Round '+chickenState.round;
  document.getElementById('chicken-player-in').textContent='In pot: '+fmtTokens(chickenState.playerIn);
  document.getElementById('chicken-bot-in').textContent='In pot: '+fmtTokens(chickenState.botIn);
  document.getElementById('chicken-player-tokens').textContent=fmtTokens(G.tokens||0);
  document.getElementById('chicken-bot-tokens').textContent=fmtTokens(chickenState.pot);
}
function chickenStart(){
  const bet=parseInt(document.getElementById('chicken-bet').value)||100;
  const diff=document.getElementById('chicken-bot-difficulty').value;
  if(!spendTokens(bet)){return;}
  const profile=BOT_PROFILES[diff];
  const botBet=bet;// bot always matches first round
  chickenState={active:true,pot:bet+botBet,round:1,playerIn:bet,botIn:botBet,bet:bet,profile:profile};
  document.getElementById('chicken-bot-emoji').textContent=profile.emoji;
  document.getElementById('chicken-bot-name').textContent=profile.name;
  document.getElementById('chicken-log').innerHTML='';
  chickenLog(`ðŸŽ® Game starts! Both bet ${fmtTokens(bet)} tokens`);
  chickenLog(`${profile.emoji} ${profile.name} joined the table`);
  chickenUpdate();
  document.getElementById('chicken-buttons').innerHTML=`
    <button class="btn btn-red btn-lg" onclick="chickenEscalate()">ðŸ“ˆ Raise Stakes</button>
    <button class="btn btn-secondary btn-lg" onclick="chickenFold()">ðŸ” I Fold (Keep my ${fmtTokens(bet)} tokens)</button>`;
}
function chickenEscalate(){
  if(!chickenState.active)return;
  const raise=Math.floor(chickenState.bet*(1+chickenState.round*0.3));
  if(!spendTokens(raise)){notify('Not enough tokens!','error');return;}
  chickenState.playerIn+=raise;chickenState.pot+=raise;chickenState.round++;
  chickenLog(`ðŸ˜¤ You raised by ${fmtTokens(raise)} tokens! Pot now ${fmtTokens(chickenState.pot)}`);
  // Bot decision
  setTimeout(()=>{
    const r=Math.random();
    const profile=chickenState.profile;
    const foldNow=r<profile.foldChance;
    if(foldNow){
      // Bot folds â€” you win pot
      chickenLog(`${profile.emoji} ${profile.name} FOLDS! ðŸ” Coward!`);
      tokenWin(chickenState.pot,'Chicken Game WIN');
      document.getElementById('chicken-pot').textContent='ðŸ† '+fmtTokens(0);
      const res=document.createElement('div');res.style.cssText='color:var(--green);font-size:18px;font-weight:700;margin-top:10px;font-family:"Rajdhani",sans-serif';
      res.textContent=`âœ… ${profile.name} chickened out! You won ${fmtTokens(chickenState.pot)} tokens!`;
      document.getElementById('chicken-buttons').appendChild(res);
      chickenEndButtons();playSound('knife');
    }else{
      const botRaise=Math.floor(chickenState.bet*(1+chickenState.round*0.25));
      chickenState.botIn+=botRaise;chickenState.pot+=botRaise;
      chickenLog(`${profile.emoji} ${profile.name} RAISES by ${fmtTokens(botRaise)}! Pot: ${fmtTokens(chickenState.pot)}`);
      chickenUpdate();
      document.getElementById('chicken-buttons').innerHTML=`
        <button class="btn btn-red btn-lg" onclick="chickenEscalate()">ðŸ“ˆ Raise Stakes (+${fmtTokens(Math.floor(chickenState.bet*(1+chickenState.round*0.3)))} more)</button>
        <button class="btn btn-secondary btn-lg" onclick="chickenFold()">ðŸ” I Fold (Lose my ${fmtTokens(chickenState.playerIn)} tokens)</button>`;
    }
  },1200);
}
function chickenFold(){
  if(!chickenState.active)return;
  const profile=chickenState.profile;
  chickenLog(`ðŸ˜° You FOLD! ${profile.emoji} ${profile.name} wins the pot!`);
  tokenLose(0,'Chicken Game LOSS');
  const res=document.createElement('div');res.style.cssText='color:var(--red);font-size:18px;font-weight:700;margin-top:10px;font-family:"Rajdhani",sans-serif';
  res.textContent=`âŒ You chickened out! Lost ${fmtTokens(chickenState.playerIn)} tokens.`;
  document.getElementById('chicken-buttons').appendChild(res);
  chickenEndButtons();playSound('lose');
}
function chickenEndButtons(){
  chickenState.active=false;
  setTimeout(()=>{
    document.getElementById('chicken-buttons').innerHTML=`<button class="btn btn-primary btn-lg" onclick="chickenStart()">ðŸ” Play Again</button>`;
  },2500);
}
let plinkoMulti=1,plinkoAutoInterval=null;
function setPlinkoBalls(n){
  plinkoMulti=n;
  document.querySelectorAll('.plinko-multi-btn').forEach(b=>b.classList.remove('active'));
  event.target.classList.add('active');
}
function togglePlinkoAuto(){
  if(plinkoAutoInterval){clearInterval(plinkoAutoInterval);plinkoAutoInterval=null;document.getElementById('plinko-auto-btn').textContent='â–¶ Auto Drop';return;}
  plinkoAutoInterval=setInterval(()=>{
    if(!G||G.balance<(parseFloat(document.getElementById('plinko-bet')?.value)||10)){
      clearInterval(plinkoAutoInterval);plinkoAutoInterval=null;
      document.getElementById('plinko-auto-btn').textContent='â–¶ Auto Drop';
      notify('Auto-drop stopped: low balance','error');return;
    }
    plinkoDrop();
  },2200);
  document.getElementById('plinko-auto-btn').textContent='â¹ Stop Auto';
}
function plinkoDropMulti(){
  for(let i=0;i<plinkoMulti;i++)setTimeout(()=>plinkoDrop(),i*400);
}

// ============================================================
// MULTI-CASE OPEN GRID
// ============================================================
function renderMultiOpenResults(skins){
  const el=document.getElementById('multi-open-grid');
  if(!el||!skins||!skins.length)return;
  // Also update the in-modal grid
  const modalGrid=document.getElementById('case-modal-multi-grid');
  const html=skins.map(s=>`
    <div style="background:var(--bg4);border:2px solid ${RARITIES[s.rarity].color}60;border-radius:10px;overflow:hidden;flex-shrink:0;width:${skins.length<=6?'140px':'110px'};cursor:pointer" onclick="inspectSkin('${s.id}')" title="${s.name}">
      <div style="height:${skins.length<=6?'90px':'70px'};overflow:hidden;position:relative">
        ${s.isEvent?getEventSkinSVG(s):getSkinSVG(s)}
        ${s.rarity==='knife'?'<div style="position:absolute;top:3px;right:3px;font-size:9px;background:rgba(228,174,57,.9);color:#000;border-radius:4px;padding:1px 4px;font-weight:700">KNIFE</div>':''}
        ${s.isEvent?'<div style="position:absolute;top:3px;left:3px;font-size:8px;background:rgba(0,0,0,.8);color:'+s.eventColor+';border-radius:4px;padding:1px 4px;font-weight:700">EVENT</div>':''}
      </div>
      <div style="padding:4px 6px">
        <div style="font-size:${skins.length<=6?'10px':'8px'};color:${RARITIES[s.rarity].color};font-weight:700;overflow:hidden;white-space:nowrap;text-overflow:ellipsis">${s.name.slice(0,22)}</div>
        <div style="font-size:${skins.length<=6?'11px':'9px'};color:var(--text2);font-weight:700">$${fmt(s.price)}</div>
      </div>
    </div>
  `).join('');
  el.innerHTML=html;
  el.style.display='flex';
  el.style.flexWrap='wrap';
  el.style.gap='6px';
  el.style.justifyContent='center';
  el.style.maxHeight='320px';
  el.style.overflowY='auto';
  el.style.padding='8px';
  if(modalGrid){modalGrid.innerHTML=html;modalGrid.style.display='flex';}
}
function updateSpecialUI(){
  if(!G)return;
  const streak=G.winStreak||0;
  const el=document.getElementById('streak-stat');
  if(el)el.style.display=streak>=2?'flex':'none';
  const sv=document.getElementById('streak-val');
  if(sv)sv.textContent=streak+'ðŸ”¥';
  const today=new Date().toDateString();
  const badge=document.getElementById('spin-badge');
  if(badge)badge.style.display=G.lastSpinDate===today?'none':'inline';
}
setInterval(updateSpecialUI,1000);

// ============================================================
// SKILL TREE SYSTEM
// ============================================================
const SKILL_BRANCHES={
  luck:{title:'ðŸ€ Luck Branch',color:'#2ecc71',skills:[
    {id:'lk1',name:'Lucky Star',icon:'â­',desc:'Case drop luck +10%',cost:1,maxLevel:5,bonus:'luck',bonusPerLevel:10},
    {id:'lk2',name:'Golden Touch',icon:'âœ¨',desc:'Knife drop chance +5%',cost:2,maxLevel:3,bonus:'knifeChance',bonusPerLevel:5},
    {id:'lk3',name:'Fortune\'s Favor',icon:'ðŸ€',desc:'Weekend bonus +50%',cost:3,maxLevel:2,bonus:'weekendBonus',bonusPerLevel:50},
    {id:'lk4',name:'Apex Luck',icon:'ðŸ’«',desc:'All luck modifiers Ã—1.25',cost:5,maxLevel:1,bonus:'apexLuck',bonusPerLevel:25},
  ]},
  economy:{title:'ðŸ’° Economy Branch',color:'#f0a500',skills:[
    {id:'ec1',name:'Thrifty',icon:'ðŸ’¸',desc:'Case opening costs -5%',cost:1,maxLevel:5,bonus:'caseCostReduce',bonusPerLevel:5},
    {id:'ec2',name:'Investor',icon:'ðŸ“ˆ',desc:'Investment returns +15%',cost:2,maxLevel:3,bonus:'investReturn',bonusPerLevel:15},
    {id:'ec3',name:'Loan Shark',icon:'ðŸ¦ˆ',desc:'Max loan limit +25%',cost:2,maxLevel:3,bonus:'loanLimit',bonusPerLevel:25},
    {id:'ec4',name:'Market Sage',icon:'ðŸ›ï¸',desc:'Sell prices +10%',cost:3,maxLevel:3,bonus:'sellBonus',bonusPerLevel:10},
    {id:'ec5',name:'Inflation Hedge',icon:'ðŸ›¡ï¸',desc:'Inflation factor reduced',cost:5,maxLevel:1,bonus:'inflationShield',bonusPerLevel:50},
  ]},
  highroller:{title:'ðŸŽ² High Roller Branch',color:'#8847ff',skills:[
    {id:'hr1',name:'Token Hoarder',icon:'ðŸ”µ',desc:'Casino win tokens +5%',cost:1,maxLevel:5,bonus:'casino',bonusPerLevel:5},
    {id:'hr2',name:'Crash Pro',icon:'ðŸš€',desc:'Crash crash chance -10%',cost:2,maxLevel:3,bonus:'crashResist',bonusPerLevel:10},
    {id:'hr3',name:'Streak Master',icon:'ðŸ”¥',desc:'Win streak cap +1',cost:3,maxLevel:2,bonus:'streakCap',bonusPerLevel:1},
    {id:'hr4',name:'House Edge',icon:'ðŸ ',desc:'All casino RTP +2%',cost:4,maxLevel:2,bonus:'rtpBonus',bonusPerLevel:2},
    {id:'hr5',name:'God Mode',icon:'âš¡',desc:'Double streak bonuses',cost:8,maxLevel:1,bonus:'godMode',bonusPerLevel:100},
  ]},
  prestige:{title:'â­ Prestige Branch',color:'#d32ce6',skills:[
    {id:'ps1',name:'Rebirth Mastery',icon:'â™»ï¸',desc:'Rebirth luck bonus +5%',cost:1,maxLevel:5,bonus:'rebirthLuck',bonusPerLevel:5},
    {id:'ps2',name:'Ancient Power',icon:'ðŸŒ€',desc:'XP gain +15%',cost:2,maxLevel:3,bonus:'xpBoost',bonusPerLevel:15},
    {id:'ps3',name:'Artifact Hunter',icon:'ðŸº',desc:'Artifact drop chance +20%',cost:3,maxLevel:2,bonus:'artifactChance',bonusPerLevel:20},
    {id:'ps4',name:'Immortal Aura',icon:'ðŸ‘‘',desc:'All bonuses +5% per prestige tier',cost:5,maxLevel:1,bonus:'prestigeAura',bonusPerLevel:5},
  ]},
};

function getSkillLevel(id){
  for(const branch of Object.values(SKILL_BRANCHES)){
    const sk=branch.skills.find(s=>s.id===id);
    if(sk){const lvl=(G.skillTree||{})[branch.title.split(' ')[1].toLowerCase()]?.find?.(s=>s.id===id)?.level;return lvl||0;}
  }
  return 0;
}
function getSkillBonus(bonusType){
  let total=0;
  for(const [key,branch] of Object.entries(SKILL_BRANCHES)){
    for(const sk of branch.skills){
      if(sk.bonus===bonusType){
        const stored=G.skillTree?.[key]?.find?.(s=>s.id===sk.id);
        if(stored)total+=(stored.level||0)*sk.bonusPerLevel;
      }
    }
  }
  return total;
}
function unlockSkill(branchKey,skillId){
  const branch=SKILL_BRANCHES[branchKey];
  const sk=branch?.skills.find(s=>s.id===skillId);
  if(!sk)return;
  if(!G.skillTree[branchKey])G.skillTree[branchKey]=[];
  let stored=G.skillTree[branchKey].find(s=>s.id===skillId);
  if(!stored){stored={id:skillId,level:0};G.skillTree[branchKey].push(stored);}
  if(stored.level>=sk.maxLevel){notify('Already maxed!','error');return;}
  const costForNext=sk.cost*(stored.level+1);
  if((G.skillPoints||0)<costForNext){notify(`Need ${costForNext} SP! You have ${G.skillPoints}.`,'error');return;}
  G.skillPoints-=costForNext;
  stored.level++;
  notify(`âœ… ${sk.name} Lv${stored.level} unlocked!`,'success');
  updateSkillBadge();renderSkillTree();renderSidebar();saveGame();
}
function renderSkillTree(){
  const grid=document.getElementById('skill-tree-grid');
  const sp=document.getElementById('skill-points-display');
  if(!grid)return;
  if(sp)sp.textContent=G.skillPoints||0;
  grid.innerHTML=Object.entries(SKILL_BRANCHES).map(([key,branch])=>`
    <div>
      <div class="skill-branch-title" style="color:${branch.color};border-color:${branch.color}40">${branch.title}</div>
      ${branch.skills.map(sk=>{
        const stored=(G.skillTree?.[key]||[]).find(s=>s.id===sk.id)||{level:0};
        const lvl=stored.level;const isMax=lvl>=sk.maxLevel;const costForNext=sk.cost*(lvl+1);
        const cls=isMax?'maxed':lvl>0?'unlocked':'';
        const clickHandler=isMax?'':`unlockSkill('${key}','${sk.id}')`;
        return `<div class="skill-node ${cls}" onclick="${clickHandler}">
          <div class="skill-icon">${sk.icon}</div>
          <div class="skill-name">${sk.name}</div>
          <div class="skill-desc">${sk.desc}</div>
          <div style="font-size:9px;color:var(--text3);margin-top:3px">${lvl}/${sk.maxLevel}</div>
          <div class="skill-cost">${isMax?'âœ“ MAXED':costForNext+' SP'}</div>
        </div>`;
      }).join('')}
    </div>
  `).join('');
}
function updateSkillBadge(){
  const badge=document.getElementById('skill-badge');
  if(badge)badge.style.display=(G.skillPoints>0)?'inline':'none';
}

// ============================================================
// PRESTIGE SYSTEM
// ============================================================
const PRESTIGE_TIERS=[
  {name:'Bronze',icon:'ðŸ¥‰',color:'#cd7f32',rebirth:1,bonus:'All drops +5%, XP +10%'},
  {name:'Silver',icon:'ðŸ¥ˆ',color:'#c0c0c0',rebirth:3,bonus:'Luck Ã—1.2, Casino tokens +10%'},
  {name:'Gold',icon:'ðŸ¥‡',color:'#ffd700',rebirth:6,bonus:'Rarity upgrade +15%, market prices +10%'},
  {name:'Diamond',icon:'ðŸ’Ž',color:'#4b69ff',rebirth:10,bonus:'Knife chance Ã—2, investments +25%'},
  {name:'Immortal',icon:'ðŸ‘‘',color:'#e4ae39',rebirth:20,bonus:'ALL multipliers Ã—1.5'},
];
function renderPrestige(){
  const el=document.getElementById('prestige-content');
  if(!el)return;
  el.innerHTML=`
    <div class="card" style="margin-bottom:14px;text-align:center">
      <div style="font-size:13px;color:var(--text2)">Current Prestige Tier</div>
      <div style="font-family:'Rajdhani',sans-serif;font-size:36px;font-weight:700;color:${PRESTIGE_TIERS[G.prestigeTier]?.color||'var(--text3)'}">${PRESTIGE_TIERS[G.prestigeTier]?.icon||'â€”'} ${PRESTIGE_TIERS[G.prestigeTier]?.name||'None'}</div>
      <div style="font-size:12px;color:var(--text2);margin-top:4px">Rebirths: <b style="color:var(--gold)">${G.rebirths||0}</b></div>
    </div>
    ${PRESTIGE_TIERS.map((t,i)=>{
      const owned=(G.prestigeTier||0)>i;
      const current=(G.prestigeTier||0)===i;
      const canUnlock=(G.rebirths||0)>=t.rebirth&&!owned&&!current;
      return `<div class="prestige-tier ${current?'active-tier':''}">
        <div style="font-size:28px">${t.icon}</div>
        <div style="font-family:'Rajdhani',sans-serif;font-size:20px;font-weight:700;color:${t.color}">${t.name} Prestige</div>
        <div style="font-size:11px;color:var(--text3);margin:4px 0">${t.bonus}</div>
        <div style="font-size:12px;color:var(--text2)">Requires ${t.rebirth} rebirths</div>
        ${owned?`<div style="color:var(--green);font-size:12px;margin-top:6px">âœ“ Owned</div>`
          :canUnlock?`<button class="btn btn-primary btn-sm mt-1" onclick="claimPrestige(${i})">â­ Ascend to ${t.name}</button>`
          :`<div style="color:var(--text3);font-size:11px;margin-top:6px">Need ${t.rebirth} rebirths</div>`}
      </div>`;
    }).join('')}
  `;
}
function claimPrestige(tier){
  if((G.rebirths||0)<PRESTIGE_TIERS[tier].rebirth){notify('Not enough rebirths!','error');return;}
  if((G.prestigeTier||0)>tier){notify('Already at higher tier','error');return;}
  G.prestigeTier=tier+1;
  notify(`â­ PRESTIGE! You are now ${PRESTIGE_TIERS[tier].name} tier!`,'rare');
  renderPrestige();saveGame();
}

// ============================================================
// LEGACY PERKS SYSTEM
// ============================================================
const LEGACY_PERKS_DEF=[
  {id:'lp1',name:'Undying Luck',icon:'ðŸ€',desc:'Luck bonus +15% (permanent, never resets)',cost:5,max:3,bonus:'luck',bpL:15},
  {id:'lp2',name:'Ancient Vault',icon:'ðŸ¦',desc:'Bank interest rate +0.5% bonus',cost:3,max:5,bonus:'bankInterest',bpL:0.5},
  {id:'lp3',name:'Legend\'s Eye',icon:'ðŸ‘ï¸',desc:'Covert+ drop rates +5%',cost:4,max:3,bonus:'covertPlus',bpL:5},
  {id:'lp4',name:'Wealthy Bloodline',icon:'ðŸ’°',desc:'Starting balance on rebirth +$500',cost:5,max:5,bonus:'startBalance',bpL:500},
  {id:'lp5',name:'Eternal XP',icon:'ðŸ“š',desc:'XP from all sources +20%',cost:4,max:3,bonus:'xpBoost',bpL:20},
  {id:'lp6',name:'The Knife Factor',icon:'ðŸ”ª',desc:'Knife drop rate Ã—1.1',cost:6,max:3,bonus:'knifeBoost',bpL:10},
  {id:'lp7',name:'Market Oracle',icon:'ðŸ”®',desc:'Market sell prices +15%',cost:5,max:2,bonus:'marketSell',bpL:15},
  {id:'lp8',name:'Token Baron',icon:'ðŸ”µ',desc:'Token casino wins +10%',cost:5,max:3,bonus:'tokenBonus',bpL:10},
];
function renderLegacyPerks(){
  const grid=document.getElementById('legacy-perks-grid');
  if(!grid)return;
  grid.innerHTML=LEGACY_PERKS_DEF.map(pk=>{
    const owned=(G.legacyPerks||[]).find(p=>p.id===pk.id)||{level:0};
    const lvl=owned.level||0;const isMax=lvl>=pk.max;
    return `<div class="legacy-perk ${lvl>0?'lp-owned':'lp-locked'}">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
        <span style="font-size:28px">${pk.icon}</span>
        <div><div style="font-weight:700;font-size:14px">${pk.name}</div><div style="font-size:10px;color:var(--text3)">${pk.desc}</div></div>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-size:11px;color:var(--text2)">Lv ${lvl}/${pk.max}</div>
        ${isMax?`<span style="font-size:11px;color:var(--gold)">âœ“ MAXED</span>`:`<button class="btn btn-secondary btn-sm" onclick="buyLegacyPerk('${pk.id}')">Buy (${pk.cost} Rebirths)</button>`}
      </div>
    </div>`;
  }).join('');
}
function buyLegacyPerk(id){
  const pk=LEGACY_PERKS_DEF.find(p=>p.id===id);
  if(!pk)return;
  if(!G.legacyPerks)G.legacyPerks=[];
  let owned=G.legacyPerks.find(p=>p.id===id);
  if(!owned){owned={id,level:0};G.legacyPerks.push(owned);}
  if(owned.level>=pk.max){notify('Already maxed!','error');return;}
  if((G.rebirths||0)<pk.cost){notify(`Need ${pk.cost} rebirths! You have ${G.rebirths||0}.`,'error');return;}
  G.rebirths-=pk.cost;owned.level++;
  notify(`ðŸ‘‘ Legacy Perk: ${pk.name} Lv${owned.level}!`,'rare');
  renderLegacyPerks();renderSidebar();saveGame();
}
function getLegacyBonus(type){
  let total=0;
  for(const pk of LEGACY_PERKS_DEF){
    const owned=(G.legacyPerks||[]).find(p=>p.id===pk.id);
    if(owned&&pk.bonus===type)total+=owned.level*pk.bpL;
  }
  return total;
}

// ============================================================
// SKIN UPGRADE SYSTEM
// ============================================================
// RARITY_ORDER defined in Skin Forge section above
let selectedUpgradeSkin=null;
let upgradeInsurancePaid=false;
function renderUpgradeList(){
  const list=document.getElementById('upgrade-skin-list');
  if(!list)return;
  if(!G.inventory.length){list.innerHTML='<div style="color:var(--text3);font-size:12px;padding:8px">No skins in inventory</div>';return;}
  list.innerHTML=G.inventory.map((s,i)=>`
    <div onclick="selectUpgradeSkin(${i})" style="padding:8px;border-radius:8px;border:1px solid var(--bg5);margin-bottom:6px;cursor:pointer;background:${selectedUpgradeSkin===i?'var(--bg5)':'var(--bg4)'};display:flex;align-items:center;gap:8px;transition:.15s">
      <div style="font-size:16px">${s.icon||'ðŸ”«'}</div>
      <div style="flex:1;min-width:0">
        <div style="font-size:11px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${s.name}</div>
        <div style="font-size:10px;color:${RARITIES[s.rarity]?.color||'var(--text3)'}">${s.rarity.toUpperCase()}</div>
      </div>
      <div style="font-size:11px;font-weight:700;color:var(--accent)">$${fmt(s.price)}</div>
    </div>
  `).join('');
}
function selectUpgradeSkin(idx){
  selectedUpgradeSkin=idx;upgradeInsurancePaid=false;
  const s=G.inventory[idx];
  const rIdx=RARITY_ORDER.indexOf(s.rarity);
  const nextRarity=RARITY_ORDER[rIdx+1]||'knife';
  const ud=document.getElementById('upgrade-selected');
  if(ud)ud.innerHTML=`<div style="font-size:11px;font-weight:700">${s.name}</div><div style="font-size:10px;color:${RARITIES[s.rarity]?.color||'#fff'}">${s.rarity.toUpperCase()}</div><div style="font-size:12px;color:var(--text2)">$${fmt(s.price)}</div>`;
  const sLabel=document.getElementById('upgrade-success-label');
  if(sLabel)sLabel.textContent=`â†’ ${nextRarity.toUpperCase()} tier`;
  renderUpgradeList();updateUpgradeUI();
}
function updateUpgradeUI(){
  const pct=parseInt(document.getElementById('upgrade-slider')?.value||50);
  const lbl=document.getElementById('upgrade-pct-label');
  if(lbl)lbl.textContent=pct+'%';
}
function toggleInsurance(){
  G.insuranceOn=!G.insuranceOn;
  const btn=document.getElementById('insurance-btn');
  if(btn){btn.textContent=G.insuranceOn?'ðŸ›¡ï¸ Insure ON':'ðŸ›¡ï¸ Insure OFF';btn.style.color=G.insuranceOn?'var(--green)':'';}
}
function attemptUpgrade(){
  const res=document.getElementById('upgrade-result');
  if(selectedUpgradeSkin===null||selectedUpgradeSkin>=G.inventory.length){notify('Select a skin first!','error');return;}
  const skin=G.inventory[selectedUpgradeSkin];
  const pct=parseInt(document.getElementById('upgrade-slider')?.value||50)/100;
  const rIdx=RARITY_ORDER.indexOf(skin.rarity);
  if(rIdx>=RARITY_ORDER.length-1){notify('Already max rarity!','error');return;}
  // Insurance cost
  if(G.insuranceOn){
    const insCost=Math.ceil(skin.price*0.2);
    if(G.balance<insCost){notify('Not enough balance for insurance!','error');return;}
    G.balance-=insCost;upgradeInsurancePaid=true;
  }
  addXP(5);
  const roll=Math.random();
  if(roll<=pct){
    // Success!
    const nextRarity=RARITY_ORDER[rIdx+1];
    skin.rarity=nextRarity;
    skin.price=+(skin.price*(1.5+Math.random()*2)).toFixed(2);
    skin.icon=RARITIES[nextRarity]?.icon||skin.icon;
    if(res)res.innerHTML=`<span style="color:var(--green)">âœ… UPGRADED to ${nextRarity.toUpperCase()}! Now worth $${fmt(skin.price)}</span>`;
    spawnParticles();playSound('knife');
  }else{
    // Failure
    if(G.insuranceOn&&upgradeInsurancePaid){
      const refund=Math.ceil(skin.price*0.5);
      G.balance+=refund;
      if(res)res.innerHTML=`<span style="color:var(--accent2)">ðŸ’€ Failed! ðŸ›¡ï¸ Insurance: +$${fmt(refund)} refund</span>`;
    }else{
      if(res)res.innerHTML=`<span style="color:var(--red)">ðŸ’¥ FAILED! Skin destroyed!</span>`;
    }
    G.inventory.splice(selectedUpgradeSkin,1);
    selectedUpgradeSkin=null;
    playSound('lose');
  }
  upgradeInsurancePaid=false;
  renderUpgradeList();renderInventory();renderSidebar();saveGame();
}

// ============================================================
// BOSS FIGHT SYSTEM
// ============================================================
const BOSS_DEFS=[
  {name:'Shadow Lurker',sprite:'ðŸ‘¤',tier:1,baseHp:5000,atk:5,reward:'milspec'},
  {name:'The Shadow Lord',sprite:'ðŸ‘¹',tier:2,baseHp:15000,atk:12,reward:'restricted'},
  {name:'Void Titan',sprite:'ðŸ¦¹',tier:3,baseHp:40000,atk:25,reward:'classified'},
  {name:'Blood Moon Herald',sprite:'ðŸ§›',tier:4,baseHp:100000,atk:50,reward:'covert'},
  {name:'The Immortal',sprite:'ðŸ’€',tier:5,baseHp:500000,atk:120,reward:'knife'},
  {name:'CS:GOD',sprite:'âš¡',tier:6,baseHp:2000000,atk:300,reward:'knife'},
];
function initBoss(){
  const defeated=G.boss?.defeated||0;
  const def=BOSS_DEFS[Math.min(defeated,BOSS_DEFS.length-1)];
  const hpMult=1+defeated*0.3;
  G.boss={name:def.name,sprite:def.sprite,tier:def.tier,maxHp:Math.floor(def.baseHp*hpMult),hp:Math.floor(def.baseHp*hpMult),atk:Math.floor(def.atk*hpMult),reward:def.reward,defeated};
  G.playerBossHp=G.playerBossMaxHp;
  renderBossPage();saveGame();
}
function calcPlayerPower(){
  const invValue=inventoryValue()+G.bankBalance*0.5;
  const base=Math.max(10,Math.floor(invValue/10));
  const skillBonus=1+(getSkillBonus('luck')||0)/100;
  return Math.floor(base*skillBonus*(1+(G.level||1)*0.02));
}
function bossAttack(){
  if(!G.boss||G.boss.hp<=0){notify('Start a new boss!','error');return;}
  const power=calcPlayerPower();
  const dmg=Math.floor(power*(0.8+Math.random()*0.4));
  G.boss.hp=Math.max(0,G.boss.hp-dmg);
  const bossAtk=Math.floor((G.boss.atk||10)*(0.7+Math.random()*0.6));
  G.playerBossHp=Math.max(0,G.playerBossHp-bossAtk);
  showBossFloatingDmg(dmg);
  bossLog(`âš”ï¸ You deal ${dmg} dmg. Boss hits for ${bossAtk}.`);
  if(G.boss.hp<=0)bossDefeat();
  else if(G.playerBossHp<=0)bossLose();
  renderBossPage();saveGame();
  addXP(5);
}
function bossSpecial(){
  const hpCost=Math.ceil(G.playerBossMaxHp*0.1);
  if(G.playerBossHp<=hpCost){notify('Not enough HP for special!','error');return;}
  G.playerBossHp-=hpCost;
  const power=calcPlayerPower()*3;
  const dmg=Math.floor(power*(1.5+Math.random()));
  G.boss.hp=Math.max(0,G.boss.hp-dmg);
  showBossFloatingDmg(dmg,true);
  bossLog(`âœ¨ SPECIAL! You deal ${dmg} MEGA damage! (-${hpCost} HP)`);
  if(G.boss.hp<=0)bossDefeat();
  renderBossPage();saveGame();
}
function bossDefeat(){
  const reward=G.boss.reward;
  const skin=generateSkin(reward,'Boss Drop');
  G.inventory.push(skin);
  G.boss.defeated=(G.boss.defeated||0)+1;
  const cashReward=G.boss.maxHp*0.001;
  G.balance+=cashReward;G.totalEarned+=cashReward;
  const rd=document.getElementById('boss-reward-display');
  if(rd)rd.innerHTML=`ðŸ† BOSS DEFEATED! Got: <b>${skin.name}</b> ($${fmt(skin.price)}) + $${fmt(cashReward)} cash!`;
  notify(`ðŸ‘¹ BOSS DEFEATED! ${skin.name} dropped!`,'rare');spawnParticles();playSound('knife');
  addXP(200);checkAchievements();renderInventory();renderSidebar();
}
function bossLose(){
  const lostBal=Math.min(G.balance*0.1,1000);
  G.balance-=lostBal;G.playerBossHp=1;
  const rd=document.getElementById('boss-reward-display');
  if(rd)rd.innerHTML=`<span style="color:var(--red)">ðŸ’€ You were defeated! Lost $${fmt(lostBal)}</span>`;
  notify(`ðŸ’€ Boss defeated YOU! Lost $${fmt(lostBal)}`,'error');playSound('lose');
}
function bossLog(msg){const el=document.getElementById('boss-log');if(el){el.innerHTML='<div>'+msg+'</div>'+el.innerHTML;if(el.children.length>8)el.lastElementChild?.remove();}}
function showBossFloatingDmg(dmg,special=false){
  const el=document.createElement('div');
  el.className='boss-dmg-float';
  el.textContent=(special?'âš¡ ':'')+'-'+dmg;
  el.style.cssText=`top:${200+Math.random()*60}px;left:${window.innerWidth/2+(-60+Math.random()*120)}px;color:${special?'var(--gold)':'var(--red)'};font-size:${special?28:20}px`;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),1200);
}
function renderBossPage(){
  if(!G.boss||!G.boss.name)return;
  const hn=document.getElementById('boss-hp-bar');const ht=document.getElementById('boss-hp-text');
  const sp=document.getElementById('boss-sprite');const bn=document.getElementById('boss-name');
  const pa=document.getElementById('boss-atk');const pp=document.getElementById('player-power');
  const php=document.getElementById('player-hp-label');const bt=document.getElementById('boss-tier-label');
  const hpPct=Math.max(0,G.boss.hp/G.boss.maxHp*100);
  if(hn)hn.style.width=hpPct+'%';
  if(ht)ht.textContent=`${G.boss.hp.toLocaleString()} / ${G.boss.maxHp.toLocaleString()}`;
  if(sp){sp.textContent=G.boss.sprite;sp.className='boss-sprite-anim';}
  if(bn)bn.textContent=G.boss.name;
  if(bt)bt.textContent=`Tier ${G.boss.tier} Boss (Defeated: ${G.boss.defeated||0})`;
  if(pa)pa.textContent=G.boss.atk;
  if(pp)pp.textContent=calcPlayerPower().toLocaleString();
  if(php)php.textContent=G.playerBossHp+'/'+G.playerBossMaxHp;
}

// ============================================================
// DUNGEON RUN (ROGUE-LITE)
// ============================================================
const DUNGEON_ROOMS=[
  {name:'Entrance Hall',icon:'ðŸšª',type:'gamble',desc:'Win a coin-flip to proceed. Lose 10% balance.',bet:0.10},
  {name:'Monster Den',icon:'ðŸ‰',type:'battle',desc:'Fight a random enemy using your power score.',enemies:['Goblin','Orc','Troll']},
  {name:'Treasure Room',icon:'ðŸ’Ž',type:'reward',desc:'Find a guaranteed rare skin.'},
  {name:'Casino Floor',icon:'ðŸŽ²',type:'casino',desc:'Win 2Ã— your entry fee or lose it all.'},
  {name:'Boss Chamber',icon:'ðŸ’€',type:'boss',desc:'Beat the dungeon boss for the Artifact reward.'},
];
function startDungeon(){
  const entryCost=G.balance*0.05;
  if(entryCost<10){notify('Need at least $200 balance to enter dungeon!','error');return;}
  G.balance-=entryCost;
  G.dungeonRun={stage:0,entryFee:entryCost,alive:true,rewards:[]};
  renderDungeon();saveGame();renderSidebar();
}
function dungeonAction(){
  if(!G.dungeonRun||!G.dungeonRun.alive)return;
  const room=DUNGEON_ROOMS[G.dungeonRun.stage];
  let success=false,msg='';
  if(room.type==='gamble'){
    success=Math.random()<0.5;
    if(!success){const lose=G.balance*room.bet;G.balance-=lose;msg=`ðŸ’¥ Lost! -$${fmt(lose)}`;}
    else msg='âœ… Win! Proceed...';
  }else if(room.type==='battle'){
    const power=calcPlayerPower();const ePower=50+G.dungeonRun.stage*30;
    success=Math.random()<(power/(power+ePower));
    msg=success?'âš”ï¸ Victory!':'ðŸ’€ Defeated! You retreat.';
    if(!success){G.balance-=G.dungeonRun.entryFee*0.5;}
  }else if(room.type==='reward'){
    success=true;const rarity=['restricted','classified','covert'][G.dungeonRun.stage%3];
    const skin=generateSkin(rarity,'Dungeon');G.inventory.push(skin);G.dungeonRun.rewards.push(skin.name);
    msg=`ðŸ’Ž Found: ${skin.name} ($${fmt(skin.price)})!`;
  }else if(room.type==='casino'){
    success=Math.random()<0.45;
    if(success){G.balance+=G.dungeonRun.entryFee;msg=`ðŸŽ² WIN! +$${fmt(G.dungeonRun.entryFee)}`;}
    else{msg='ðŸŽ² LOSS! The house wins.';}
  }else if(room.type==='boss'){
    const power=calcPlayerPower();
    success=Math.random()<Math.min(0.8,power/(power+5000));
    if(success){
      const artifact=generateArtifact();G.artifacts.push(artifact);G.dungeonRun.rewards.push('ARTIFACT: '+artifact.name);
      G.balance+=G.dungeonRun.entryFee*5;
      msg=`ðŸ‘‘ BOSS SLAIN! Artifact: ${artifact.name} + $${fmt(G.dungeonRun.entryFee*5)}!`;
    }else msg='ðŸ’€ The boss destroys you!';
  }
  if(success&&G.dungeonRun.stage<DUNGEON_ROOMS.length-1){G.dungeonRun.stage++;}
  else if(!success||G.dungeonRun.stage===DUNGEON_ROOMS.length-1){G.dungeonRun.alive=false;if(success)notify('ðŸ† DUNGEON COMPLETE!','rare');}
  renderDungeon();renderSidebar();saveGame();addXP(20);
  if(success)playSound(room.type==='boss'?'knife':'win');else playSound('lose');
}
function renderDungeon(){
  const el=document.getElementById('dungeon-content');
  if(!el)return;
  if(!G.dungeonRun){
    el.innerHTML=`<div class="card" style="text-align:center">
      <div style="font-size:48px;margin-bottom:12px">ðŸšï¸</div>
      <div style="font-family:'Rajdhani',sans-serif;font-size:20px;font-weight:700;margin-bottom:8px">Enter the Dungeon</div>
      <div style="font-size:13px;color:var(--text2);margin-bottom:16px">5 stages of escalating danger. Entry fee: 5% of your balance.<br>Complete all rooms for a legendary Artifact. Fail and lose your entry!</div>
      <button class="btn btn-primary btn-lg" onclick="startDungeon()">ðŸšï¸ Begin Run ($${fmt((G.balance*0.05)||0)})</button>
      ${G.artifacts.length?`<div style="margin-top:12px;font-size:12px;color:var(--gold)">ðŸº Artifacts owned: ${G.artifacts.length}</div>`:''}
    </div>`;
    return;
  }
  const run=G.dungeonRun;
  el.innerHTML=`
    <div class="card" style="margin-bottom:12px">
      <div style="display:flex;gap:6px;justify-content:center;margin-bottom:14px">
        ${DUNGEON_ROOMS.map((r,i)=>`<div style="width:40px;height:40px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px;background:${i<run.stage?'var(--green)40':i===run.stage?'var(--accent)30':'var(--bg4)'};border:2px solid ${i<run.stage?'var(--green)':i===run.stage?'var(--accent)':'var(--bg5)'}">${r.icon}</div>`).join('')}
      </div>
      ${run.alive?`<div class="dungeon-room d-current">
        <div style="font-size:32px;margin-bottom:6px">${DUNGEON_ROOMS[run.stage].icon}</div>
        <div style="font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:700">${DUNGEON_ROOMS[run.stage].name}</div>
        <div style="font-size:12px;color:var(--text2);margin:6px 0">${DUNGEON_ROOMS[run.stage].desc}</div>
        <button class="btn btn-primary" onclick="dungeonAction()">âš”ï¸ ${run.stage===4?'Face the Boss!':'Continue'}</button>
      </div>`:`<div style="text-align:center;padding:20px">
        <div style="font-size:32px;margin-bottom:8px">${run.rewards.length?'ðŸ†':'ðŸ’€'}</div>
        <div style="font-family:'Rajdhani',sans-serif;font-size:20px;font-weight:700;color:${run.rewards.length?'var(--gold)':'var(--red)'}">${run.rewards.length?'Run Complete!':'You Fell!'}</div>
        ${run.rewards.length?`<div style="font-size:12px;color:var(--text2);margin:8px 0">Rewards: ${run.rewards.join(', ')}</div>`:''}
        <button class="btn btn-primary mt-1" onclick="G.dungeonRun=null;renderDungeon()">ðŸ”„ New Run</button>
      </div>`}
    </div>
  `;
}

// ============================================================
// ARTIFACT SYSTEM
// ============================================================
const ARTIFACT_DEFS=[
  {name:'Orb of Fortune',icon:'ðŸ”®',effect:'luck',value:15,desc:'Permanent +15% luck'},
  {name:'Blade of Eternity',icon:'âš”ï¸',effect:'knife',value:20,desc:'Knife drop rate +20%'},
  {name:'Coin of Midas',icon:'ðŸª™',effect:'casino',value:20,desc:'Casino token wins +20%'},
  {name:'Tome of XP',icon:'ðŸ“š',effect:'xp',value:25,desc:'All XP gains +25%'},
  {name:'Crown of Prestige',icon:'ðŸ‘‘',effect:'prestige',value:10,desc:'All prestige bonuses Ã—1.1'},
  {name:'Merchant\'s Stone',icon:'ðŸ’Ž',effect:'market',value:15,desc:'Sell values +15%'},
];
function generateArtifact(){
  const def=ARTIFACT_DEFS[Math.floor(Math.random()*ARTIFACT_DEFS.length)];
  return {...def,id:Date.now()+Math.random(),obtained:Date.now()};
}
function getArtifactBonus(type){
  return (G.artifacts||[]).filter(a=>a.effect===type).reduce((s,a)=>s+a.value,0);
}

// ============================================================
// INVESTMENT SYSTEM
// ============================================================
const INVEST_TIERS=[
  {id:'stable',name:'Stable Bond',icon:'ðŸ¦',color:'#5e98d9',riskLabel:'LOW RISK',minReturn:0.03,maxReturn:0.05,days:1,desc:'3â€“5% guaranteed return. Matures in 1 min.',failChance:0},
  {id:'market',name:'Market Fund',icon:'ðŸ“ˆ',color:'#f0a500',riskLabel:'MEDIUM',minReturn:0.10,maxReturn:0.25,days:2,desc:'10â€“25% return. Small chance of loss.',failChance:0.1},
  {id:'venture',name:'Venture Capital',icon:'ðŸš€',color:'#d32ce6',riskLabel:'HIGH RISK',minReturn:0.30,maxReturn:1.50,days:3,desc:'30â€“150% return or total loss!',failChance:0.35},
];
function invest(tierId){
  const tier=INVEST_TIERS.find(t=>t.id===tierId);if(!tier)return;
  const amtEl=document.getElementById('invest-amount-'+tierId);
  const amt=parseFloat(amtEl?.value)||100;
  if(!checkBal(amt))return;
  G.balance-=amt;
  const matureAt=Date.now()+tier.days*60000;// 1 day = 1 min for game purposes
  G.investments.push({tierId,tier:tier.name,amount:amt,matureAt,collected:false});
  renderSidebar();renderInvestments();saveGame();
  notify(`ðŸ“ˆ Invested $${fmt(amt)} in ${tier.name}. Matures in ${tier.days} min!`,'success');
}
function collectInvestment(idx){
  const inv=G.investments[idx];if(!inv||inv.collected)return;
  if(Date.now()<inv.matureAt){notify(`Not ready yet! ${Math.ceil((inv.matureAt-Date.now())/60000)} min remaining.`,'error');return;}
  const tier=INVEST_TIERS.find(t=>t.id===inv.tierId);
  if(Math.random()<(tier?.failChance||0)){
    notify(`ðŸ’€ ${tier.name}: Investment FAILED! Lost $${fmt(inv.amount)}!`,'error');
    addHistory(`${tier.name} failed`,-inv.amount,'loss');playSound('lose');
  }else{
    const returnPct=tier.minReturn+Math.random()*(tier.maxReturn-tier.minReturn);
    const earned=+(inv.amount*(1+returnPct)).toFixed(2);
    G.balance+=earned;G.totalEarned+=earned;
    addHistory(`${tier.name} return`,earned,'win');
    notify(`ðŸ“ˆ Investment returned $${fmt(earned)} (${(returnPct*100).toFixed(0)}% profit)!`,'success');playSound('win');
    renderSidebar();
  }
  inv.collected=true;
  G.investments.splice(idx,1);
  renderInvestments();saveGame();
}
function renderInvestments(){
  const tiers=document.getElementById('invest-tiers');
  const active=document.getElementById('active-investments');
  if(tiers){
    tiers.innerHTML=INVEST_TIERS.map(t=>`
      <div class="invest-card" style="border-color:${t.color}40">
        <div style="text-align:center;margin-bottom:8px">
          <div style="font-size:28px">${t.icon}</div>
          <div style="font-weight:700;font-size:14px">${t.name}</div>
          <div style="font-size:10px;color:${t.color};font-weight:700;margin:2px 0">${t.riskLabel}</div>
          <div style="font-size:10px;color:var(--text3)">${t.desc}</div>
        </div>
        <div style="display:flex;gap:6px;align-items:center">
          <input id="invest-amount-${t.id}" type="number" value="100" min="1" placeholder="$" style="flex:1;background:var(--bg4);border:1px solid var(--bg5);border-radius:6px;padding:5px 8px;color:var(--text);font-size:12px">
          <button class="btn btn-primary btn-sm" onclick="invest('${t.id}')">Invest</button>
        </div>
      </div>
    `).join('');
  }
  if(active){
    const pending=G.investments.filter(i=>!i.collected);
    if(!pending.length){active.innerHTML='<div style="color:var(--text3);font-size:12px;padding:8px">No active investments</div>';return;}
    active.innerHTML=pending.map((inv,i)=>{
      const ready=Date.now()>=inv.matureAt;
      const remaining=Math.max(0,Math.ceil((inv.matureAt-Date.now())/60000));
      return `<div style="background:var(--bg4);border-radius:8px;padding:10px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between">
        <div><div style="font-size:12px;font-weight:700">${inv.tier}</div><div style="font-size:10px;color:var(--text3)">$${fmt(inv.amount)} â€¢ ${ready?'<span style="color:var(--green)">READY</span>':remaining+' min left'}</div></div>
        <button class="btn btn-${ready?'green':'secondary'} btn-sm" onclick="collectInvestment(${i})" ${ready?'':'disabled'}>Collect</button>
      </div>`;
    }).join('');
  }
}

// ============================================================
// AUCTION HOUSE
// ============================================================
const AUCTION_BOT_NAMES=['AuctionBot_A','Sniper_77','WhaleBid','CasePro','LuckyBidder'];
function initAuctions(){
  if(!G.auctionItems||G.auctionItems.length<4||Date.now()>G.auctionItems[0]?.endsAt){
    G.auctionItems=Array.from({length:4},()=>{
      const rar=['restricted','classified','covert'][Math.floor(Math.random()*3)];
      const skin=generateSkin(rar,'Auction');
      const startBid=Math.floor(skin.price*0.7);
      const endsAt=Date.now()+90000;// 90 sec
      return {skin,currentBid:startBid,bidder:'Bot',endsAt,myBid:0,won:false};
    });
    saveGame();
  }
  renderAuctions();
}
function bidAuction(idx){
  const item=G.auctionItems[idx];
  if(!item||Date.now()>item.endsAt){notify('Auction ended!','error');return;}
  const minBid=Math.ceil(item.currentBid*1.05);
  const bid=parseInt(prompt(`Min bid: $${minBid}. Enter your bid:`));
  if(!bid||bid<minBid){notify(`Minimum bid is $${minBid}!`,'error');return;}
  if(!checkBal(bid))return;
  if(item.myBid>0)G.balance+=item.myBid;// refund prev bid
  G.balance-=bid;
  item.currentBid=bid;item.bidder=G.username;item.myBid=bid;
  notify(`ðŸ”¨ Bid $${fmt(bid)} placed!`,'success');
  renderAuctions();renderSidebar();saveGame();
}
function renderAuctions(){
  const grid=document.getElementById('auction-grid');if(!grid)return;
  if(!G.auctionItems?.length){initAuctions();return;}
  const now=Date.now();
  grid.innerHTML=G.auctionItems.map((item,i)=>{
    const remaining=Math.max(0,Math.ceil((item.endsAt-now)/1000));
    const ended=now>item.endsAt;
    // Bot bidding
    if(!ended&&Math.random()<0.15){
      const botBid=Math.ceil(item.currentBid*(1.02+Math.random()*0.1));
      if(item.bidder!==G.username){item.currentBid=botBid;item.bidder=AUCTION_BOT_NAMES[Math.random()*AUCTION_BOT_NAMES.length|0];}
    }
    if(ended&&item.bidder===G.username&&!item.won){
      item.won=true;G.inventory.push(item.skin);renderInventory();saveGame();
    }
    return `<div class="auction-card">
      <div style="height:90px;overflow:hidden;background:var(--bg4)">${getSkinSVG(item.skin)}</div>
      <div style="padding:10px">
        <div style="font-size:11px;font-weight:700;color:${RARITIES[item.skin.rarity]?.color||'var(--text)'};margin-bottom:4px">${item.skin.name.slice(0,24)}</div>
        <div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:6px">
          <span style="color:var(--text2)">Top bid:</span><span style="color:var(--accent);font-weight:700">$${fmt(item.currentBid)}</span>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:8px">
          <span style="color:var(--text3)">${item.bidder==='Bot'?'No bids':'Bidder: '+item.bidder.slice(0,10)}</span>
          <span class="auction-timer" style="font-size:13px;color:${remaining<20?'var(--red)':'var(--accent2)'}">${ended?'ENDED':remaining+'s'}</span>
        </div>
        ${ended?(item.won?`<div style="color:var(--green);font-size:12px;font-weight:700">âœ… You Won!</div>`:`<div style="color:var(--red);font-size:11px">âŒ ${item.bidder} won</div>`)
          :`<button class="btn btn-primary btn-sm w-full" onclick="bidAuction(${i})">ðŸ”¨ Bid</button>`}
      </div>
    </div>`;
  }).join('');
}

// ============================================================
// BLACK MARKET
// ============================================================
const BM_REFRESH_INTERVAL=30*60*1000;// 30 min
const BM_OPEN_DURATION=5*60*1000;// 5 min
let bmTimer=null;
function checkBlackMarket(){
  const now=Date.now();
  if(!G.blackMarket)G.blackMarket={items:[],refreshAt:0,nextOpenAt:0};
  if(now>=G.blackMarket.refreshAt){
    // Refresh black market
    G.blackMarket.refreshAt=now+BM_REFRESH_INTERVAL;
    G.blackMarket.nextOpenAt=now+BM_OPEN_DURATION;
    G.blackMarket.items=Array.from({length:6},()=>{
      const rar=['classified','covert','knife'][Math.floor(Math.random()*3)];
      const skin=generateSkin(rar,'Black Market');
      return {skin,price:Math.floor(skin.price*(0.6+Math.random()*0.4)),stock:Math.floor(Math.random()*3+1),sold:false};
    });
    // Activate badge
    const badge=document.getElementById('bm-badge');
    if(badge)badge.style.display='inline';
    notify('ðŸ•µï¸ Black Market is OPEN! 5 minutes only!','rare');
    saveGame();
  }
}
function renderBlackMarket(){
  checkBlackMarket();
  const now=Date.now();const isOpen=now<G.blackMarket.nextOpenAt;
  const timer=document.getElementById('bm-timer-bar');
  const grid=document.getElementById('bm-grid');
  if(timer){
    const remaining=Math.max(0,Math.ceil((G.blackMarket.nextOpenAt-now)/1000));
    const untilOpen=Math.max(0,Math.ceil((G.blackMarket.refreshAt-G.blackMarket.nextOpenAt-(BM_REFRESH_INTERVAL-BM_OPEN_DURATION))/1000));
    timer.textContent=isOpen?`ðŸŸ¢ OPEN â€” ${Math.floor(remaining/60)}:${(remaining%60).toString().padStart(2,'0')} remaining`:`ðŸ”´ CLOSED â€” Opens in ${Math.floor((G.blackMarket.refreshAt-now)/60000)} min`;
    timer.style.color=isOpen?'var(--green)':'var(--red)';
  }
  if(grid){
    if(!isOpen){grid.innerHTML='<div style="grid-column:1/-1;text-align:center;color:var(--text3);padding:40px;font-size:14px">ðŸ•µï¸ Market is closed. Come back when it opens!</div>';return;}
    grid.innerHTML=(G.blackMarket.items||[]).map((item,i)=>`
      <div class="bm-item ${item.sold||item.stock<=0?'sold':''}">
        <div style="height:70px;overflow:hidden;border-radius:6px;margin-bottom:6px">${item.isEvent?getEventSkinSVG(item.skin):getSkinSVG(item.skin)}</div>
        <div style="font-size:10px;font-weight:700;color:${RARITIES[item.skin.rarity]?.color||'#fff'};margin-bottom:2px">${item.skin.name.slice(0,18)}</div>
        <div style="font-size:11px;color:var(--text3);margin-bottom:4px">Stock: ${item.stock}</div>
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:700;color:var(--accent);margin-bottom:6px">$${fmt(item.price)}</div>
        <div style="font-size:9px;color:var(--text3);margin-bottom:6px">Market value: ~$${fmt(item.skin.price)}</div>
        <button class="btn btn-primary btn-sm w-full" onclick="buyBlackMarket(${i})">Buy</button>
      </div>
    `).join('');
  }
}
function buyBlackMarket(idx){
  const item=G.blackMarket.items[idx];
  if(!item||item.stock<=0||item.sold){notify('Out of stock!','error');return;}
  if(!checkBal(item.price))return;
  G.balance-=item.price;item.stock--;
  if(item.stock<=0)item.sold=true;
  G.inventory.push(item.skin);
  renderSidebar();renderInventory();renderBlackMarket();saveGame();
  notify(`ðŸ•µï¸ Bought ${item.skin.name} from Black Market!`,'success');
  addXP(15);
}

// ============================================================
// TOURNAMENT SYSTEM
// ============================================================
const TOURNAMENT_BOTS=['xXSniper99Xx','DROP_KING','FragMaster','CaseAddict','HighRoller','Bot_Alpha','Bot_Sigma'];
function startTournament(entryFee){
  if(!checkBal(entryFee))return;
  G.balance-=entryFee;
  const players=[G.username,...TOURNAMENT_BOTS.slice(0,7)].map(n=>({name:n,isPlayer:n===G.username,power:n===G.username?calcPlayerPower():Math.floor(Math.random()*calcPlayerPower()*2)}));
  G.tournament={entryFee,prize:entryFee*8,players,round:0,results:[],active:true,elo:G.elo||1000};
  renderTournament();renderSidebar();saveGame();
}
function tournamentFight(){
  if(!G.tournament?.active)return;
  const t=G.tournament;const remaining=t.players.filter(p=>!p.eliminated);
  if(remaining.length<=1){
    if(remaining[0]?.isPlayer){
      G.balance+=t.prize;G.totalEarned+=t.prize;G.elo=(G.elo||1000)+50;
      addHistory('ðŸ† Tournament Win!',t.prize,'win');
      notify(`ðŸ† TOURNAMENT CHAMPION! Won $${fmt(t.prize)} + 50 ELO!`,'rare');spawnParticles();playSound('knife');
    }else{G.elo=Math.max(0,(G.elo||1000)-20);notify(`âŒ Tournament lost! -20 ELO`,'error');}
    G.tournament.active=false;renderTournament();renderSidebar();saveGame();return;
  }
  // Run a round of matches
  t.round++;const matchLog=[];
  for(let i=0;i<remaining.length-1;i+=2){
    const a=remaining[i],b=remaining[i+1];
    const aWins=Math.random()<(a.power/(a.power+b.power));
    const loser=aWins?b:a;loser.eliminated=true;
    matchLog.push(`Round ${t.round}: ${aWins?a.name:b.name} beats ${aWins?b.name:a.name}`);
  }
  t.results.push(...matchLog);
  renderTournament();saveGame();addXP(10);
}
function renderTournament(){
  const el=document.getElementById('tournament-content');if(!el)return;
  if(!G.tournament){
    el.innerHTML=`<div class="card" style="text-align:center">
      <div style="font-size:48px;margin-bottom:12px">ðŸ†</div>
      <div style="font-family:'Rajdhani',sans-serif;font-size:22px;font-weight:700;margin-bottom:8px">Tournament Mode</div>
      <div style="font-size:13px;color:var(--text2);margin-bottom:16px">8-player single-elimination bracket. Beat all opponents to claim the prize pool!</div>
      <div style="font-size:12px;color:var(--text3);margin-bottom:6px">Your ELO: <b style="color:var(--accent)">${G.elo||1000}</b></div>
      <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
        <button class="btn btn-secondary" onclick="startTournament(500)">Entry $500 (Prize $4K)</button>
        <button class="btn btn-primary" onclick="startTournament(2000)">Entry $2K (Prize $16K)</button>
        <button class="btn btn-secondary" onclick="startTournament(10000)" style="border-color:var(--gold);color:var(--gold)">Entry $10K (Prize $80K)</button>
      </div>
    </div>`;return;
  }
  const t=G.tournament;const remaining=t.players.filter(p=>!p.eliminated);
  const me=t.players.find(p=>p.isPlayer);
  el.innerHTML=`<div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div style="font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:700">Round ${t.round}</div>
      <div style="font-size:12px;color:var(--accent)">Prize: $${fmt(t.prize)}</div>
    </div>
    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px">
      ${t.players.map(p=>`<div style="padding:4px 8px;border-radius:6px;font-size:11px;font-weight:700;background:${p.eliminated?'var(--bg4)':p.isPlayer?'var(--accent)30':'var(--bg3)'};color:${p.eliminated?'var(--text3)':p.isPlayer?'var(--accent)':'var(--text)'};border:1px solid ${p.eliminated?'var(--bg5)':p.isPlayer?'var(--accent)40':'var(--bg5)'};">${p.eliminated?'âŒ':p.isPlayer?'ðŸ‘¤':'ðŸ¤–'} ${p.name}</div>`).join('')}
    </div>
    <div style="background:var(--bg4);border-radius:8px;padding:8px;max-height:100px;overflow-y:auto;font-size:11px;color:var(--text2);margin-bottom:12px;font-family:'Barlow Condensed',sans-serif">${t.results.slice(-6).join('<br>')||'No rounds yet'}</div>
    ${t.active?
      (me?.eliminated?`<div style="color:var(--red);text-align:center;font-size:14px;font-weight:700">ðŸ’€ You were eliminated! <button class="btn btn-secondary btn-sm" onclick="G.tournament=null;renderTournament()">Exit</button></div>`
      :`<div style="display:flex;gap:10px;justify-content:center"><button class="btn btn-primary" onclick="tournamentFight()">âš”ï¸ Fight Round</button><button class="btn btn-secondary btn-sm" onclick="G.tournament=null;renderTournament()">Forfeit</button></div>`)
      :`<div style="text-align:center"><div style="font-size:14px;font-weight:700;color:var(--gold);margin-bottom:8px">${remaining[0]?.isPlayer?'ðŸ† YOU WON!':'ðŸ’€ You lost!'}</div><button class="btn btn-secondary btn-sm" onclick="G.tournament=null;renderTournament()">New Tournament</button></div>`}
  </div>`;
}

// ============================================================
// HIGH ROLLER ROOM
// ============================================================
function renderHighRoller(){
  const el=document.getElementById('highroller-content');if(!el)return;
  if((G.level||1)<25){
    el.innerHTML=`<div class="card" style="text-align:center;background:linear-gradient(135deg,var(--bg3),#1a0a00)">
      <div style="font-size:48px;margin-bottom:12px">ðŸ’Ž</div>
      <div style="font-family:'Rajdhani',sans-serif;font-size:22px;font-weight:700;color:var(--gold);margin-bottom:8px">High Roller Room</div>
      <div style="font-size:14px;color:var(--text2);margin-bottom:16px">This exclusive room requires Level 25.</div>
      <div style="font-size:18px;color:var(--red)">ðŸ”’ Current Level: ${G.level||1} / 25</div>
    </div>`;return;
  }
  el.innerHTML=`<div style="background:linear-gradient(135deg,#1a1200,#2a2000);border:2px solid var(--gold)40;border-radius:16px;padding:20px">
    <div style="font-family:'Rajdhani',sans-serif;font-size:22px;font-weight:700;color:var(--gold);text-align:center;margin-bottom:16px">ðŸ’Ž VIP High Roller Room</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px">
      <div class="card" style="text-align:center;background:var(--bg4)">
        <div style="font-size:11px;color:var(--text3);margin-bottom:4px">MYTHIC CASE OPENER</div>
        <div style="font-size:13px;color:var(--text2);margin-bottom:10px">Open a mythic-biased case ($5,000). 3Ã— knife chance!</div>
        <button class="btn btn-primary" onclick="hrOpenMythicCase()">ðŸ’Ž Open ($5,000)</button>
      </div>
      <div class="card" style="text-align:center;background:var(--bg4)">
        <div style="font-size:11px;color:var(--text3);margin-bottom:4px">ALL-IN CHALLENGE</div>
        <div style="font-size:13px;color:var(--text2);margin-bottom:10px">Bet your ENTIRE balance on a 50/50. No limits!</div>
        <button class="btn btn-red btn-lg w-full" onclick="hrAllIn()">ðŸŽ° ALL IN</button>
      </div>
    </div>
    <div class="card" style="background:var(--bg4);text-align:center">
      <div style="font-size:11px;color:var(--text3);margin-bottom:4px">ELITE JACKPOT (HR ONLY)</div>
      <div style="font-size:13px;color:var(--text2);margin-bottom:6px">10% of your balance enters the elite pot. Massive payouts.</div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:700;color:var(--gold);margin-bottom:10px" id="hr-pot">$0</div>
      <button class="btn btn-primary btn-lg" onclick="hrJackpot()">ðŸ’Ž Enter Elite Jackpot</button>
    </div>
    <div style="text-align:center;margin-top:12px;font-size:11px;color:var(--text3)">VIP Tier: ${VIP_TIERS[G.vipTier||0]?.name||'None'} â€¢ Total Wagered: $${fmt(G.totalWagered||0)}</div>
  </div>`;
  const pot=document.getElementById('hr-pot');
  if(pot)pot.textContent='$'+fmt((G.hrPot||0));
}
function hrOpenMythicCase(){
  if(!checkBal(5000))return;
  G.balance-=5000;
  G.luckBonus=(G.luckBonus||0)+50;// temp huge luck boost
  const rarity=rollRarity(50);
  G.luckBonus-=50;
  const skin=generateSkin(rarity,'HR Mythic');
  skin.price=+(skin.price*2).toFixed(2);
  G.inventory.push(skin);renderInventory();renderSidebar();saveGame();
  notify(`ðŸ’Ž HR Case: ${skin.name} ($${fmt(skin.price)})!`,rarity==='knife'?'rare':'success');
  addXP(50);
}
function hrAllIn(){
  const bet=Math.floor(G.balance);
  if(bet<100){notify('Need at least $100!','error');return;}
  if(!confirm(`âš ï¸ BET YOUR ENTIRE $${fmt(bet)}? 50/50 â€” cannot be undone!`))return;
  G.balance=0;
  const win=Math.random()<0.50;
  if(win){G.balance=bet*2;G.totalEarned+=bet;addHistory('ALL-IN WIN!',bet,'win');notify(`ðŸŽ° ALL-IN WIN! +$${fmt(bet)}!`,'rare');spawnParticles();playSound('knife');}
  else{addHistory('ALL-IN LOSS',-bet,'loss');notify(`ðŸ’€ ALL-IN LOSS! Lost $${fmt(bet)}!`,'error');playSound('lose');}
  renderSidebar();addXP(30);saveGame();
}
function hrJackpot(){
  const entry=Math.floor(G.balance*0.1);
  if(!checkBal(entry))return;
  G.balance-=entry;G.hrPot=(G.hrPot||0)+entry;
  // 10% chance to win the whole pot
  if(Math.random()<0.10){const prize=G.hrPot;G.balance+=prize;G.totalEarned+=prize;G.hrPot=0;addHistory('HR Jackpot!',prize,'win');notify(`ðŸ’ŽðŸ’Ž HR JACKPOT! Won $${fmt(prize)}!`,'rare');spawnParticles();}
  else notify(`Entered HR Jackpot with $${fmt(entry)}. Pot: $${fmt(G.hrPot||0)}`,'success');
  renderSidebar();renderHighRoller();saveGame();
}

// ============================================================
// VIP TIER SYSTEM
// ============================================================
const VIP_TIERS=[
  {name:'Regular',icon:'ðŸ‘¤',wager:0,bonus:'None'},
  {name:'Silver VIP',icon:'ðŸ¥ˆ',wager:10000,bonus:'+5% casino tokens'},
  {name:'Gold VIP',icon:'ðŸ¥‡',wager:50000,bonus:'+10% tokens, Market +5%'},
  {name:'Platinum VIP',icon:'ðŸ’ ',wager:200000,bonus:'+15% tokens, High Roller access'},
  {name:'Diamond VIP',icon:'ðŸ’Ž',wager:1000000,bonus:'+25% all, exclusive cases'},
  {name:'Immortal VIP',icon:'ðŸ‘‘',wager:10000000,bonus:'God-tier bonuses, ALL Ã—2'},
];
function updateVIPTier(){
  const wager=G.totalWagered||0;
  let tier=0;
  for(let i=VIP_TIERS.length-1;i>=0;i--){if(wager>=VIP_TIERS[i].wager){tier=i;break;}}
  if(tier>(G.vipTier||0)){G.vipTier=tier;notify(`â­ VIP Upgraded: ${VIP_TIERS[tier].name}!`,'rare');}
}

// ============================================================
// GLOBAL RANDOM EVENTS
// ============================================================
const GLOBAL_EVENTS=[
  {id:'flashcrash',name:'ðŸ’¥ Flash Crash!',desc:'Market values drop 30% for 2 min',duration:120000,effect:'marketCrash'},
  {id:'jackpotsurge',name:'âš¡ Jackpot Surge!',desc:'Casino token wins Ã—2 for 2 min!',duration:120000,effect:'tokenDouble'},
  {id:'bossinvasion',name:'ðŸ‘¹ Boss Invasion!',desc:'Boss fight rewards Ã—3 for 3 min!',duration:180000,effect:'bossBonus'},
  {id:'goldenrain',name:'ðŸŒ§ï¸ Golden Rain!',desc:'Passive income Ã—5 for 1 min!',duration:60000,effect:'incomeBoost'},
  {id:'luckstorm',name:'ðŸ€ Luck Storm!',desc:'All drop rates Ã—2 for 2 min!',duration:120000,effect:'luckBoost'},
];
function checkGlobalEvents(){
  if(!G||!G.globalEvent)return;
  if(Date.now()>G.globalEventExpiry){G.globalEvent=null;saveGame();}
}
function triggerGlobalEvent(){
  const ev=GLOBAL_EVENTS[Math.floor(Math.random()*GLOBAL_EVENTS.length)];
  G.globalEvent=ev;G.globalEventExpiry=Date.now()+ev.duration;
  // Show overlay
  const div=document.createElement('div');
  div.className='global-event-banner';
  div.innerHTML=`<div style="font-size:20px;font-weight:700;font-family:'Rajdhani',sans-serif;color:var(--gold)">${ev.name}</div><div style="font-size:12px;color:var(--text2);margin-top:4px">${ev.desc}</div>`;
  document.body.appendChild(div);
  setTimeout(()=>div.remove(),6000);
  notify(`ðŸŒ GLOBAL EVENT: ${ev.name} â€” ${ev.desc}`,'rare');playSound('rare');saveGame();
}

// ============================================================
// DAILY EVENT MODIFIER
// ============================================================
const DAILY_MODIFIERS=[
  {name:'ðŸ€ Lucky Day',effect:'luck',value:50,desc:'+50% luck all day'},
  {name:'ðŸ’° Bull Market',effect:'market',value:25,desc:'All skin prices +25%'},
  {name:'ðŸŽ² Casino Boost',effect:'casino',value:30,desc:'Casino token wins +30%'},
  {name:'ðŸ“¦ Case Frenzy',effect:'cases',value:30,desc:'Better case drop rates'},
  {name:'âš¡ XP Rush',effect:'xp',value:100,desc:'Double XP all day'},
  {name:'ðŸ’¸ Bear Market',effect:'market',value:-15,desc:'Skin prices -15% (bad day)'},
  {name:'ðŸ©¸ Blood Moon',effect:'bloodmoon',value:1,desc:'Increased volatility & rare drops'},
  {name:'â˜€ï¸ Golden Hour',effect:'goldenhour',value:1,desc:'2Ã— rarity for 10 min'},
];
function checkDailyModifier(){
  const today=new Date().toDateString();
  if(G.dailyEventDate!==today){
    G.dailyEventDate=today;
    G.dailyEventModifier=DAILY_MODIFIERS[Math.floor(Math.random()*DAILY_MODIFIERS.length)];
    // Apply special effects
    if(G.dailyEventModifier.effect==='bloodmoon'){G.bloodMoonActive=true;applyBloodMoon();}
    else{G.bloodMoonActive=false;removeBloodMoon();}
    if(G.dailyEventModifier.effect==='goldenhour'){G.goldenHourActive=true;G.goldenHourExpiry=Date.now()+600000;applyGoldenHour();}
    notify(`ðŸ“… Daily Modifier: ${G.dailyEventModifier.name} â€” ${G.dailyEventModifier.desc}`,'success');
    saveGame();
  }
  renderDailyModifier();
}
function renderDailyModifier(){
  const dm=G.dailyEventModifier;if(!dm)return;
  document.querySelectorAll('.daily-mod-display').forEach(el=>{
    el.innerHTML=`<span style="font-size:14px">${dm.name}</span> <span style="font-size:11px;color:var(--text2)">${dm.desc}</span>`;
  });
}
function applyBloodMoon(){
  if(!document.getElementById('blood-moon-overlay')){
    const d=document.createElement('div');d.id='blood-moon-overlay';d.className='blood-moon-bg';
    document.body.appendChild(d);
  }
}
function removeBloodMoon(){document.getElementById('blood-moon-overlay')?.remove();}
function applyGoldenHour(){
  if(!document.getElementById('golden-hour-overlay')){
    const d=document.createElement('div');d.id='golden-hour-overlay';d.className='golden-hour-bg';
    document.body.appendChild(d);
    setTimeout(()=>{d.remove();G.goldenHourActive=false;},600000);
  }
}

// ============================================================
// STATTRAK SYSTEM
// ============================================================
function addStatTrakKill(skinId,wins=1){
  if(!G.statTrakItems)G.statTrakItems={};
  G.statTrakItems[skinId]=(G.statTrakItems[skinId]||0)+wins;
}
function getStatTrakKills(skinId){return G.statTrakItems?.[skinId]||0;}
function applyStatTrakBonus(skin){
  const kills=getStatTrakKills(skin.id);
  if(kills>=100)return skin.price*1.1;
  if(kills>=1000)return skin.price*1.25;
  if(kills>=10000)return skin.price*1.5;
  return skin.price;
}

// ============================================================
// ITEM AGING SYSTEM
// ============================================================
function getAgedValue(skin){
  if(!skin.date)return skin.price;
  const ageDays=(Date.now()-skin.date)/(1000*60*60*24);
  const ageBonus=Math.min(ageDays*0.001,0.15);// up to +15% over time
  return +(skin.price*(1+ageBonus)).toFixed(2);
}

// ============================================================
// CORRUPTED ITEM SYSTEM (rare mutation on case open)
// ============================================================
function maybeCorruptSkin(skin){
  const chance=0.01+(getSkillBonus('artifactChance')||0)/1000;
  if(Math.random()<chance){
    skin.corrupted=true;
    const multi=Math.random()<0.5?0.2:3;// 50% chance good or bad
    skin.price=+(skin.price*multi).toFixed(2);
    skin.name='[CORRUPTED] '+skin.name;
  }
  return skin;
}

// ============================================================
// ADVANCED ANALYTICS
// ============================================================
function renderStats(){
  const el=document.getElementById('page-stats');if(!el)return;
  const inv=G.inventory||[];
  const total=G.totalWagered||0;
  const winRate=G.casinoWins+G.casinoLosses>0?(G.casinoWins/(G.casinoWins+G.casinoLosses)*100).toFixed(1):0;
  const roi=total>0?((G.totalEarned-100)/100*100).toFixed(1):0;
  const netWorth=G.balance+(G.bankBalance||0)+inv.reduce((s,sk)=>s+sk.price,0);
  const dailyMod=G.dailyEventModifier;
  el.innerHTML=`
    <div class="page-header"><div class="page-title">ðŸ“Š Advanced Analytics</div></div>
    ${dailyMod?`<div class="card" style="margin-bottom:14px;background:linear-gradient(135deg,var(--bg3),var(--bg4));border-color:var(--accent)40">
      <div style="font-size:12px;color:var(--text3);margin-bottom:4px">TODAY'S MODIFIER</div>
      <div style="font-size:16px;font-weight:700">${dailyMod.name}</div>
      <div style="font-size:12px;color:var(--text2)">${dailyMod.desc}</div>
    </div>`:''}
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:16px">
      ${[
        {label:'Net Worth',val:'$'+fmt(netWorth),color:'var(--gold)'},
        {label:'Win Rate',val:winRate+'%',color:winRate>50?'var(--green)':'var(--red)'},
        {label:'Total Wagered',val:'$'+fmt(total),color:'var(--accent3)'},
        {label:'Lifetime ROI',val:roi+'%',color:roi>0?'var(--green)':'var(--red)'},
        {label:'Biggest Win',val:'$'+fmt(G.lifetimeBiggestWin||0),color:'var(--green)'},
        {label:'Biggest Loss',val:'$'+fmt(G.lifetimeBiggestLoss||0),color:'var(--red)'},
        {label:'Cases Opened',val:G.casesOpened,color:'var(--accent)'},
        {label:'Knives Unboxed',val:G.knivesUnboxed,color:'var(--knife)'},
        {label:'Casino Wins',val:G.casinoWins,color:'var(--green)'},
        {label:'Casino Losses',val:G.casinoLosses,color:'var(--red)'},
        {label:'ELO Rating',val:G.elo||1000,color:'var(--accent3)'},
        {label:'VIP Tier',val:VIP_TIERS[G.vipTier||0]?.name||'Regular',color:'var(--gold)'},
        {label:'Prestige Tier',val:PRESTIGE_TIERS[G.prestigeTier||0]?.name||'None',color:PRESTIGE_TIERS[G.prestigeTier||0]?.color||'var(--text3)'},
        {label:'Artifacts',val:(G.artifacts||[]).length,color:'var(--gold)'},
        {label:'Tilt Level',val:(G.tiltLevel||0)+'%',color:G.tiltLevel>50?'var(--red)':'var(--green)'},
        {label:'Risk Index',val:(G.riskIndex||0)+'%',color:'var(--accent2)'},
      ].map(s=>`<div style="background:var(--bg3);border-radius:8px;padding:10px;border:1px solid var(--bg5)">
        <div style="font-size:10px;color:var(--text3);margin-bottom:2px">${s.label}</div>
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:700;color:${s.color}">${s.val}</div>
      </div>`).join('')}
    </div>
    <div class="card">
      <div class="section-title">Tilt & Risk Meters</div>
      <div style="margin-top:10px">
        <div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:4px"><span style="color:var(--text2)">Tilt Level (losing streak penalty)</span><span id="tilt-pct-label">${G.tiltLevel||0}%</span></div>
        <div class="tilt-indicator"><div class="tilt-fill" id="tilt-index-bar" style="width:${G.tiltLevel||0}%"></div></div>
        <div style="display:flex;justify-content:space-between;font-size:11px;margin:10px 0 4px"><span style="color:var(--text2)">Risk Index (aggression level)</span><span>${G.riskIndex||0}%</span></div>
        <div style="height:5px;border-radius:3px;background:var(--bg5);overflow:hidden"><div id="risk-index-bar" style="height:100%;border-radius:3px;background:linear-gradient(90deg,var(--green),var(--accent2),var(--red));width:${G.riskIndex||0}%"></div></div>
      </div>
    </div>
    <div class="card mt-2">
      <div class="section-title">Volatility Mode</div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="volatility-btn ${(G.volatilityMode||'normal')==='low'?'active-vol':''}" onclick="setVolatility('low')">ðŸŒ Low â€” Steady</button>
        <button class="volatility-btn ${(G.volatilityMode||'normal')==='normal'?'active-vol':''}" onclick="setVolatility('normal')">âš–ï¸ Normal</button>
        <button class="volatility-btn ${(G.volatilityMode||'normal')==='high'?'active-vol':''}" onclick="setVolatility('high')">âš¡ High â€” Volatile</button>
      </div>
      <div style="font-size:11px;color:var(--text3);margin-top:8px">Low: steadier income, fewer big wins â€¢ High: extreme variance, bigger highs AND lows</div>
    </div>
  `;
}
function setVolatility(mode){
  G.volatilityMode=mode;notify(`Volatility set to: ${mode}`,'success');renderStats();saveGame();
}

// ============================================================
// RIVAL SYSTEM
// ============================================================
function updateRival(){
  if(!G.rival)G.rival={name:'Bot_'+Math.random().toString(36).slice(2,6),level:1,balance:100,casesOpened:0,wins:0};
  // Rival gains based on player activity
  G.rival.balance*=(1+Math.random()*0.01);
  G.rival.casesOpened+=Math.random()<0.3?1:0;
  const rEl=document.getElementById('rival-display');
  if(rEl){rEl.innerHTML=`<div style="font-size:12px;color:var(--text2)">ðŸ¤º Rival: <b>${G.rival.name}</b></div>
    <div style="font-size:11px;color:var(--text3)">Lv ${G.rival.level} â€¢ $${fmt(G.rival.balance)} â€¢ ${G.rival.casesOpened} cases</div>`;}
}

// ============================================================
// INFLATION CONTROL ENGINE
// ============================================================
function updateInflation(){
  if(!G.inflationFactor)G.inflationFactor=1;
  const invValue=inventoryValue();
  // Soft cap: if total inv value > $100k, start compression
  if(invValue>100000){
    const excess=(invValue-100000)/100000;
    G.inflationFactor=Math.max(0.5,1-excess*0.05);
  }else{
    G.inflationFactor=Math.min(1,G.inflationFactor+0.001);
  }
  // Apply to new skin prices: patch in rarityBasePrice
}
// Patch rarityBasePrice to apply inflation
const _origRarityBasePrice=typeof rarityBasePrice!=='undefined'?rarityBasePrice:null;

// ============================================================
// SHOWPAGE EXTENSION (all new pages)
// ============================================================
const _origShowPage=showPage;
function showPage(p){
  document.querySelectorAll('.page').forEach(el=>el.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));
  const pg=document.getElementById('page-'+p);
  if(pg)pg.classList.add('active');
  const navs=document.querySelectorAll('.nav-item');
  navs.forEach(el=>{if(el.getAttribute('onclick')?.includes("'"+p+"'"))el.classList.add('active');});
  const titles={clicker:'Click Farm',cases:'Cases',casino:'Casino',battles:'Case Battles',jackpot:'Jackpot',tradeup:'Trade-Up',dice:'Dice',upgrade:'Skin Upgrade',boss:'Boss Fight',dungeon:'Dungeon Run',tournament:'Tournament',highroller:'High Roller',invest:'Investments',auction:'Auction House',blackmarket:'Black Market',skilltree:'Skill Tree',prestige:'Prestige',legacyperks:'Legacy Perks',fairness:'Provably Fair',inventory:'Inventory',bank:'Bank',market:'Marketplace',tokens:'Tokens',shop:'Cosmetic Shop',profile:'Profile',missions:'Missions',battlepass:'Battle Pass',stats:'Analytics',leaderboard:'Leaderboard',settings:'Settings',admin:'Admin',heist:'The Heist',forge:'Skin Forge',chicken:'Chicken Game',scratch:'Scratch Cards',streak:'Daily Streak',mystery:'Mystery Crate',wagerwars:'Wager Wars',collection:'Collection Book',ranked:'Ranked Matches',prestigestore:'Prestige Store',lucklab:'Luck Lab'};
  document.getElementById('topbar-title').textContent=titles[p]||p;
  // Page-specific renders
  if(p==='stats')renderStats();
  if(p==='inventory')renderInventory();
  if(p==='market'){renderMarket();renderMarketChart();}
  if(p==='leaderboard')renderLeaderboard();
  if(p==='missions'){updateMissionProgress();renderMissions();}
  if(p==='profile')renderAchievements();
  if(p==='shop')renderShop();
  if(p==='bank')renderBank();
  if(p==='tokens'){const bigEl=document.getElementById('token-big-display');const usdEl=document.getElementById('token-usd-val');if(bigEl)bigEl.textContent=fmtTokens(G.tokens);if(usdEl)usdEl.textContent=fmt((G.tokens||0)*0.01);}
  if(p==='dice')setTimeout(()=>{updateDiceOdds();selectDiceSide('under');},50);
  if(p==='casino')initPlinko();
  if(p==='upgrade'){renderUpgradeList();updateUpgradeUI();}
  if(p==='boss'){if(!G.boss?.name)initBoss();else renderBossPage();}
  if(p==='dungeon')renderDungeon();
  if(p==='tournament')renderTournament();
  if(p==='highroller')renderHighRoller();
  if(p==='invest')renderInvestments();
  if(p==='auction')renderAuctions();
  if(p==='blackmarket')renderBlackMarket();
  if(p==='skilltree')renderSkillTree();
  if(p==='heist'){renderHeistStages();}
  if(p==='forge'){forgeClear();renderForgeSlots();updateForgeInfo();}
  if(p==='chicken'){
    document.getElementById('chicken-log').innerHTML='';
    document.getElementById('chicken-buttons').innerHTML='<button class="btn btn-primary btn-lg" onclick="chickenStart()">ðŸ” Start Game</button>';
    chickenState={active:false,pot:0,round:0,playerIn:0,botIn:0,bet:0,profile:null};
    chickenUpdate();
  }
  if(p==='prestige')renderPrestige();
  if(p==='legacyperks')renderLegacyPerks();
  if(p==='fairness')renderFairness();
  if(p==='scratch'){document.getElementById('scratch-cards-area').innerHTML='<div style="grid-column:1/-1;text-align:center;color:var(--text3);padding:30px;font-size:14px">Buy a scratch card to play!</div>';}
  if(p==='streak')renderStreakPage();
  if(p==='mystery')renderMysteryShop();
  if(p==='wagerwars')initWagerWars();
  if(p==='collection')renderCollectionBook();
  if(p==='highroller'){renderHighRoller();const hr=document.getElementById('hr-lock');if(hr)hr.style.display=(G.level||1)>=25?'none':'inline';}
  if(p==='ranked'){renderRankedPage();if(G&&G.rankedActive)renderRankedArena();}
  if(p==='prestigestore')renderPrestigeStore();
  if(p==='lucklab'){renderReagentGrid();renderLabStatus();updateBrewSlotDisplay();}
}

// ============================================================
// EXTENDED initApp with all new systems
// ============================================================
function initAppExtensions(){
  try{
    // Render all pages that have dynamic content upfront
    renderSkillTree();renderPrestige();renderLegacyPerks();
    renderTournament();renderDungeon();renderHighRoller();
    renderInvestments();renderAuctions();renderBlackMarket();
    renderBossPage();
    // Check daily modifier
    checkDailyModifier();
    // Init boss
    if(!G.boss?.name)initBoss();
    // Init black market checker
    checkBlackMarket();
    // Init auctions
    initAuctions();
    // Update rival
    updateRival();
    // Update VIP tier
    updateVIPTier();
    // Update risk meters
    updateRiskUI();
    updateSkillBadge();
    // High roller lock badge
    const hr=document.getElementById('hr-lock');
    if(hr)hr.style.display=(G.level||1)>=25?'none':'inline';
    // Update tournament ELO display
    const tElo=document.getElementById('tournament-elo');
    if(tElo)tElo.textContent=G.elo||1000;
    // Render fairness
    renderFairness();
    // New addictive hooks
    checkDailyStreak();
    checkFirstTimeBonus();
    startActivityFeed();
    checkHotStreak();
    // Periodic timers
    setInterval(()=>{updateRival();checkBlackMarket();updateInflation();},60000);
    setInterval(renderAuctions,5000);
    setInterval(()=>{collectMatureInvestments();},30000);
    setInterval(checkHotStreak,2000);
    setInterval(()=>{if(Math.random()<0.2)triggerGlobalEvent();},300000);
    if(G.bloodMoonActive)applyBloodMoon();
    if(G.goldenHourActive&&Date.now()<G.goldenHourExpiry)applyGoldenHour();
  }catch(e){
    console.error('initAppExtensions error:',e);
  }
}

function collectMatureInvestments(){
  if(!G.investments?.length)return;
  const ready=G.investments.filter(i=>!i.collected&&Date.now()>=i.matureAt);
  if(ready.length>0)notify(`ðŸ“ˆ ${ready.length} investment(s) ready to collect!`,'success');
}

// ============================================================
// ============================================================
// MYSTERY CRATE SYSTEM
// ============================================================
const CRATE_TIERS=[
  {id:'bronze',name:'Bronze Crate',price:150,icon:'ðŸ“¦',color:'#cd7f32',desc:'Consumer to Mil-Spec skins + small cash',skinMin:'consumer',skinMax:'milspec',cashRange:[50,300],tokens:[50,200],xp:[100,500]},
  {id:'silver',name:'Silver Crate',price:500,icon:'ðŸ¥ˆ',color:'#c0c0c0',desc:'Mil-Spec to Classified skins + good rewards',skinMin:'milspec',skinMax:'classified',cashRange:[200,1000],tokens:[200,800],xp:[300,1500]},
  {id:'gold',name:'Gold Crate',price:2000,icon:'ðŸ¥‡',color:'var(--gold)',desc:'Restricted to Covert + rare chance at knife',skinMin:'restricted',skinMax:'covert',cashRange:[500,5000],tokens:[500,2000],xp:[1000,5000]},
  {id:'diamond',name:'Diamond Crate',price:10000,icon:'ðŸ’Ž',color:'var(--classified)',desc:'Covert guaranteed + 5% knife chance + jackpot cash',skinMin:'covert',skinMax:'knife',cashRange:[2000,25000],tokens:[2000,10000],xp:[5000,20000]},
];
const CRATE_RARITY_PROGRESSION={consumer:['consumer','industrial'],industrial:['consumer','industrial','milspec'],milspec:['industrial','milspec','restricted'],restricted:['milspec','restricted','classified'],classified:['restricted','classified','covert'],covert:['classified','covert','knife']};

function renderMysteryShop(){
  const el=document.getElementById('crate-tiers');
  if(!el)return;
  el.innerHTML=CRATE_TIERS.map(c=>`
    <div class="card" style="border-color:${c.color}40;text-align:center;cursor:pointer;transition:.15s" 
         onclick="openMysteryCrate('${c.id}')"
         onmouseover="this.style.borderColor='${c.color}'" 
         onmouseout="this.style.borderColor='${c.color}40'">
      <div style="font-size:40px;margin-bottom:6px">${c.icon}</div>
      <div style="font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:700;color:${c.color}">${c.name}</div>
      <div style="font-size:11px;color:var(--text3);margin:4px 0 10px">${c.desc}</div>
      <button class="btn btn-primary w-full" style="background:linear-gradient(135deg,${c.color},${c.color}aa)">
        Open â€” $${fmt(c.price)}
      </button>
    </div>
  `).join('');
}

function openMysteryCrate(tierId){
  const tier=CRATE_TIERS.find(c=>c.id===tierId);
  if(!tier||!checkBal(tier.price))return;
  G.balance-=tier.price;
  
  const area=document.getElementById('crate-reveal-area');
  area.innerHTML=`<div style="font-size:48px;animation:pulse 0.5s infinite alternate">ðŸ“¦</div>`;
  playSound('case_open');
  
  setTimeout(()=>{
    const rewards=[];
    // 2-4 skins
    const rarities=Object.keys(RARITIES).filter(r=>r!=='knife');
    const tierRarities=CRATE_RARITY_PROGRESSION[tier.skinMax]||['consumer'];
    const skinCount=2+Math.floor(Math.random()*3);
    for(let i=0;i<skinCount;i++){
      const rarity=tierRarities[Math.floor(Math.random()*tierRarities.length)];
      const skin=generateSkin(rarity,'Mystery Crate');
      G.inventory.push(skin);
      addToCollection(skin);
      rewards.push({type:'skin',skin});
    }
    // Knife chance
    if(tierId==='diamond'&&Math.random()<0.05||tierId==='gold'&&Math.random()<0.01){
      const knife=generateSkin('knife','Mystery Crate');
      G.inventory.push(knife);
      addToCollection(knife);
      rewards.push({type:'knife',skin:knife});
      showKnifeOverlay(knife);spawnParticles();
    }
    // Cash
    const cash=Math.floor(tier.cashRange[0]+Math.random()*(tier.cashRange[1]-tier.cashRange[0]));
    G.balance+=cash;G.totalEarned+=cash;
    rewards.push({type:'cash',amount:cash});
    // Tokens
    const toks=Math.floor(tier.tokens[0]+Math.random()*(tier.tokens[1]-tier.tokens[0]));
    G.tokens=(G.tokens||0)+toks;
    rewards.push({type:'tokens',amount:toks});
    // XP
    const xpAmt=Math.floor(tier.xp[0]+Math.random()*(tier.xp[1]-tier.xp[0]));
    addXP(xpAmt);
    rewards.push({type:'xp',amount:xpAmt});
    
    area.innerHTML=`
      <div style="width:100%">
        <div style="font-size:20px;font-weight:700;color:var(--gold);margin-bottom:14px;font-family:'Rajdhani',sans-serif">âœ¨ Crate Opened!</div>
        <div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center">
          ${rewards.map(r=>{
            if(r.type==='skin'||r.type==='knife'){
              return `<div style="background:var(--bg4);border:1px solid ${RARITIES[r.skin.rarity].color}60;border-radius:8px;padding:8px;text-align:center;min-width:90px">
                <div style="font-size:24px">${r.skin.icon||'ðŸ”«'}</div>
                <div style="font-size:10px;color:${RARITIES[r.skin.rarity].color};font-weight:700">${r.skin.name}</div>
                <div style="font-size:10px;color:var(--green)">$${fmt(r.skin.price)}</div>
              </div>`;
            }
            if(r.type==='cash')return `<div style="background:var(--bg4);border-radius:8px;padding:10px;text-align:center"><div style="font-size:24px">ðŸ’°</div><div style="font-size:12px;font-weight:700;color:var(--gold)">+$${fmt(r.amount)}</div></div>`;
            if(r.type==='tokens')return `<div style="background:var(--bg4);border-radius:8px;padding:10px;text-align:center"><div style="font-size:24px">ðŸ”µ</div><div style="font-size:12px;font-weight:700;color:var(--accent3)">+${r.amount} tokens</div></div>`;
            if(r.type==='xp')return `<div style="background:var(--bg4);border-radius:8px;padding:10px;text-align:center"><div style="font-size:24px">â­</div><div style="font-size:12px;font-weight:700;color:var(--accent)">+${r.amount} XP</div></div>`;
            return '';
          }).join('')}
        </div>
      </div>
    `;
    addHistory(`Mystery Crate (${tier.name})`,-tier.price,'expense');
    renderSidebar();saveGame();playSound('win');
    notify(`ðŸŽ Crate opened! Got ${rewards.filter(r=>r.type==='skin'||r.type==='knife').length} skins + more!`,'success');
  },800);
}

// ============================================================
// WAGER WARS SYSTEM
// ============================================================
let wwState={active:false,challenge:null,myWager:0,expiry:0,joined:false};
const WW_CHALLENGES=[
  {name:'5-Minute Blitz',desc:'Wager the most in 5 minutes. Top 3 win prizes!',duration:300,prize:5000,icon:'âš¡'},
  {name:'Casino Rush',desc:'Play casino games only. Highest wager wins!',duration:180,prize:2500,icon:'ðŸŽ²'},
  {name:'High Stakes Hour',desc:'60-minute marathon. No limits. Biggest wager wins!',duration:3600,prize:50000,icon:'ðŸ’Ž'},
  {name:'Lucky Draw',desc:'Every $100 wagered = 1 ticket. Random draw at end!',duration:240,prize:10000,icon:'ðŸŽ«'},
];
const WW_BOTS=[
  {name:'xXSniper99',wager:0},{name:'DropKing',wager:0},{name:'CasePro',wager:0},
  {name:'HighRoller',wager:0},{name:'FragMaster',wager:0},{name:'AceBot',wager:0},
];
let wwTimerInterval=null;

function initWagerWars(){
  if(!wwState.active){
    const challenge=WW_CHALLENGES[Math.floor(Math.random()*WW_CHALLENGES.length)];
    wwState={active:false,challenge,myWager:0,expiry:0,joined:false};
    WW_BOTS.forEach(b=>b.wager=0);
  }
  renderWagerWars();
}
function renderWagerWars(){
  const c=wwState.challenge;
  if(!c)return;
  const titleEl=document.getElementById('ww-title');
  const descEl=document.getElementById('ww-desc');
  const timerEl=document.getElementById('ww-timer');
  const myWagerEl=document.getElementById('ww-my-wager');
  const prizeEl=document.getElementById('ww-prize');
  const joinBtn=document.getElementById('ww-join-btn');
  const lb=document.getElementById('ww-leaderboard');
  
  if(titleEl)titleEl.textContent=c.icon+' '+c.name;
  if(descEl)descEl.textContent=c.desc;
  if(prizeEl)prizeEl.textContent='$'+fmt(c.prize+(wwState.myWager*0.1));
  if(myWagerEl)myWagerEl.textContent='$'+fmt(wwState.myWager);
  
  if(wwState.active){
    const left=Math.max(0,wwState.expiry-Date.now());
    const mins=Math.floor(left/60000);
    const secs=Math.floor((left%60000)/1000);
    if(timerEl)timerEl.textContent=`${mins}:${secs.toString().padStart(2,'0')}`;
    if(joinBtn)joinBtn.textContent='âš¡ Active â€” keep wagering!';
    if(joinBtn)joinBtn.style.background='var(--green)';
  } else {
    if(timerEl)timerEl.textContent=wwState.joined?'Ended':'--:--';
    if(joinBtn){joinBtn.textContent='âš¡ Join Challenge';joinBtn.style.background='';}
  }
  
  // Leaderboard
  if(lb){
    const allPlayers=[{name:G.username||'You',wager:wwState.myWager,isMe:true},...WW_BOTS];
    allPlayers.sort((a,b)=>b.wager-a.wager);
    lb.innerHTML=allPlayers.map((p,i)=>`
      <div style="display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid var(--bg4)">
        <div style="width:20px;text-align:center;font-weight:700;color:${i<3?'var(--gold)':'var(--text3)'}">${i+1}</div>
        <div style="flex:1;font-weight:${p.isMe?700:400};color:${p.isMe?'var(--accent)':'var(--text)'}">${p.name}</div>
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:700;color:${i===0?'var(--gold)':i<3?'var(--green)':'var(--text2)'}">$${fmt(p.wager)}</div>
        ${i<3?`<div style="font-size:10px;color:var(--gold)">${['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'][i]}</div>`:''}
      </div>
    `).join('');
  }
}
function joinWagerWar(){
  if(wwState.active)return;
  const c=wwState.challenge;
  wwState.active=true;
  wwState.joined=true;
  wwState.expiry=Date.now()+c.duration*1000;
  // Simulate bots wagering
  WW_BOTS.forEach(b=>{b.wager=Math.floor(1000+Math.random()*c.prize*0.8);});
  if(wwTimerInterval)clearInterval(wwTimerInterval);
  wwTimerInterval=setInterval(()=>{
    if(Date.now()>=wwState.expiry){
      clearInterval(wwTimerInterval);
      wwState.active=false;
      endWagerWar();
    }
    renderWagerWars();
  },1000);
  notify('âš¡ Wager War started! Wager as much as possible!','success');
  renderWagerWars();
}
function endWagerWar(){
  const c=wwState.challenge;
  const allPlayers=[{name:G.username||'You',wager:wwState.myWager,isMe:true},...WW_BOTS];
  allPlayers.sort((a,b)=>b.wager-a.wager);
  const myRank=allPlayers.findIndex(p=>p.isMe)+1;
  const prizes=[c.prize,Math.floor(c.prize*0.5),Math.floor(c.prize*0.25)];
  const histEl=document.getElementById('ww-history');
  if(myRank<=3){
    const prize=prizes[myRank-1];
    G.balance+=prize;G.totalEarned+=prize;
    renderSidebar();saveGame();
    notify(`ðŸ† Wager War: ${['1st','2nd','3rd'][myRank-1]} place! +$${fmt(prize)}!`,'rare');
    if(histEl)histEl.innerHTML=`<div style="color:var(--gold)">You finished #${myRank} â†’ +$${fmt(prize)}! ðŸ†</div>`+(histEl.innerHTML||'');
  } else {
    notify(`âš¡ Wager War ended. You finished #${myRank}. Better luck next time!`,'info');
    if(histEl)histEl.innerHTML=`<div style="color:var(--text2)">Finished #${myRank} â€” no prize this round.</div>`+(histEl.innerHTML||'');
  }
  // Reset for next round
  setTimeout(()=>{
    const nextChallenge=WW_CHALLENGES[Math.floor(Math.random()*WW_CHALLENGES.length)];
    wwState={active:false,challenge:nextChallenge,myWager:0,expiry:0,joined:false};
    WW_BOTS.forEach(b=>b.wager=0);
    renderWagerWars();
  },5000);
}
function addWagerWarAmount(amt){
  if(!wwState.active)return;
  wwState.myWager+=amt;
  renderWagerWars();
}

// ============================================================
// COLLECTION BOOK SYSTEM
// ============================================================
function addToCollection(skin){
  if(!G.collection)G.collection={};
  const key=skin.name.toLowerCase().replace(/[^a-z0-9]/g,'_');
  if(!G.collection[key]){
    G.collection[key]={name:skin.name,icon:skin.icon||'ðŸ”«',rarity:skin.rarity,price:skin.price,firstObtained:Date.now()};
    // Bonus for first discovery
    notify(`ðŸ“– New skin discovered: ${skin.name}!`,'success');
  }
}
function renderCollectionBook(){
  if(!G.collection)G.collection={};
  // Generate master list from CASES
  const allSkinNames=new Set();
  if(typeof CASES!=='undefined'){
    CASES.forEach(c=>{
      if(c.skins)c.skins.forEach(s=>allSkinNames.add(s));
    });
  }
  // Also add from weapons list
  const totalPossible=Math.max(allSkinNames.size,80);
  const owned=Object.keys(G.collection).length;
  const pct=Math.min(100,Math.floor((owned/totalPossible)*100));
  
  const uniqueEl=document.getElementById('col-unique');
  const pctEl=document.getElementById('col-pct');
  const barEl=document.getElementById('col-progress-bar');
  if(uniqueEl)uniqueEl.textContent=owned;
  if(pctEl)pctEl.textContent=pct+'%';
  if(barEl)barEl.style.width=pct+'%';
  
  const setsEl=document.getElementById('col-sets');
  if(setsEl){
    const rarityGroups={};
    Object.values(G.collection).forEach(s=>{
      if(!rarityGroups[s.rarity])rarityGroups[s.rarity]=0;
      rarityGroups[s.rarity]++;
    });
    const sets=Object.keys(rarityGroups).filter(r=>rarityGroups[r]>=5).length;
    setsEl.textContent=`${sets}/7`;
    // Set completion rewards
    Object.entries(rarityGroups).forEach(([r,cnt])=>{
      const key=`set_reward_${r}_5`;
      if(cnt>=5&&!G[key]){
        G[key]=true;
        const reward={consumer:50,industrial:100,milspec:300,restricted:750,classified:2000,covert:8000,knife:50000}[r]||100;
        G.balance+=reward;G.totalEarned+=reward;
        notify(`ðŸ“– Set Complete: ${r}! +$${fmt(reward)} bonus!`,'rare');
        saveGame();
      }
    });
  }
  
  renderCollectionGrid('all');
}
let colCurrentFilter='all';
function filterCollection(rarity,btn){
  colCurrentFilter=rarity;
  document.querySelectorAll('.col-filter').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  renderCollectionGrid(rarity);
}
function renderCollectionGrid(filter){
  const grid=document.getElementById('collection-grid');
  if(!grid||!G.collection)return;
  const items=Object.values(G.collection).filter(s=>filter==='all'||s.rarity===filter);
  if(items.length===0){
    grid.innerHTML=`<div style="grid-column:1/-1;text-align:center;color:var(--text3);padding:30px">No ${filter==='all'?'':''+filter} skins discovered yet. Open cases to discover new skins!</div>`;
    return;
  }
  const sorted=items.sort((a,b)=>{const order={knife:0,covert:1,classified:2,restricted:3,milspec:4,industrial:5,consumer:6};return (order[a.rarity]||9)-(order[b.rarity]||9);});
  grid.innerHTML=sorted.map(s=>`
    <div style="background:var(--bg3);border:1px solid ${RARITIES[s.rarity]?.color||'var(--bg5)'}40;border-radius:10px;padding:10px;text-align:center">
      <div style="font-size:28px;margin-bottom:4px">${s.icon}</div>
      <div style="font-size:10px;font-weight:700;color:${RARITIES[s.rarity]?.color||'var(--text)'};line-height:1.2">${s.name}</div>
      <div style="font-size:10px;color:var(--text3);margin-top:2px">$${fmt(s.price)}</div>
    </div>
  `).join('');
}

// HOOK: Add to collection when inventory skin obtained
const _origGenerateSkin=generateSkin;
generateSkin=function(rarity,source){
  const skin=_origGenerateSkin(rarity,source);
  // Don't auto-add here - only add when actually given to player
  return skin;
};

// GUEST LOGIN
// ============================================================
function doGuestLogin(){
  currentUser='__guest__';
  G=defaultState();
  G.username='Guest';
  G.balance=500;// give guest a head start
  migrateSave();
  startApp();
}

// ============================================================
// COLLAPSIBLE NAV
// ============================================================
function toggleNavGroup(header){
  const body=header.nextElementSibling;
  const isOpen=header.classList.contains('open');
  header.classList.toggle('open',!isOpen);
  body.style.display=isOpen?'none':'block';
}

// ============================================================
// LOGIN PAGE LIVE TICKER
// ============================================================
const TICKER_WINS=[
  'ðŸ”ª xXSniper99 unboxed a Karambit Fade ($1,240)',
  'ðŸ’° DropKing won $880 in Crash',
  'ðŸŽ² FragMaster hit Jackpot: $4,200',
  'ðŸ“¦ CaseAddict opened 10 cases, got Covert AK-47',
  'ðŸ† HighRoller won Tournament for $16,000',
  'ðŸ”ª Bot_Alpha forged a Butterfly Knife',
  'ðŸ’Ž LuckyBidder won auction for M9 Bayonet',
  'ðŸŽ° WhaleBid hit All-In for $12,500 win',
  'âš¡ Pro_Player unboxed AWP Asiimov StatTrak',
  'ðŸ•µï¸ GhostHunter completed Heist â€” 32Ã— payout',
];
let tickerIdx=0;
function startLoginTicker(){
  const el=document.getElementById('login-ticker');
  if(!el)return;
  setInterval(()=>{
    tickerIdx=(tickerIdx+1)%TICKER_WINS.length;
    el.style.opacity=0;
    setTimeout(()=>{el.textContent=TICKER_WINS[tickerIdx];el.style.opacity=1;},300);
  },3000);
  el.textContent=TICKER_WINS[0];
  // Fake player count fluctuation
  const pcEl=document.getElementById('live-player-count');
  if(pcEl){
    setInterval(()=>{
      const base=2800+Math.floor(Math.random()*200-100);
      pcEl.textContent=`ðŸŸ¢ ${base.toLocaleString()} players online`;
    },8000);
  }
}

// ============================================================
// SCRATCH CARDS
// ============================================================
let scratchTierPrice=50,scratchTierIcon='ðŸ¥ˆ';
const SCRATCH_SYMBOLS=['ðŸ’°','ðŸ”«','ðŸ’Ž','â­','ðŸŽ²','ðŸƒ','ðŸ§ª','ðŸ†'];
const SCRATCH_PAYOUTS={'ðŸ’°ðŸ’°ðŸ’°':100,'ðŸ”«ðŸ”«ðŸ”«':25,'ðŸ’ŽðŸ’ŽðŸ’Ž':15,'â­â­â­':8,'ðŸŽ²ðŸŽ²ðŸŽ²':4};
function setScratchTier(price,icon,btn){
  scratchTierPrice=price;scratchTierIcon=icon;
  document.querySelectorAll('.scratch-tier-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('scratch-price-display').textContent=price;
}
function buyScratchCard(){
  if(!checkBal(scratchTierPrice))return;
  G.balance-=scratchTierPrice;
  // Generate 9 cells (3x3)
  const grid=[];
  // Determine win type
  const r=Math.random();
  if(r<0.03){ // jackpot
    const sym='ðŸ’°';grid.push(...Array(9).fill(null).map((_,i)=>i<3?sym:SCRATCH_SYMBOLS[Math.floor(Math.random()*SCRATCH_SYMBOLS.length)]));
  } else if(r<0.12){ // triple match
    const sym=SCRATCH_SYMBOLS[Math.floor(Math.random()*5)];
    grid.push(sym,sym,sym);
    for(let i=3;i<9;i++)grid.push(SCRATCH_SYMBOLS[Math.floor(Math.random()*SCRATCH_SYMBOLS.length)]);
  } else if(r<0.30){ // pair of ðŸ’°
    grid.push('ðŸ’°','ðŸ’°');
    for(let i=2;i<9;i++)grid.push(SCRATCH_SYMBOLS[1+Math.floor(Math.random()*(SCRATCH_SYMBOLS.length-1))]);
  } else {
    for(let i=0;i<9;i++)grid.push(SCRATCH_SYMBOLS[Math.floor(Math.random()*SCRATCH_SYMBOLS.length)]);
  }
  // Shuffle non-first-3
  for(let i=3;i<grid.length;i++){const j=3+Math.floor(Math.random()*(grid.length-3));[grid[i],grid[j]]=[grid[j],grid[i]];}
  renderScratchCard(grid);
  renderSidebar();saveGame();
}
function renderScratchCard(symbols){
  const area=document.getElementById('scratch-cards-area');
  const key=symbols.slice(0,3).join('');
  const mult=SCRATCH_PAYOUTS[key]||(symbols.filter(s=>s==='ðŸ’°').length>=2?2:0);
  const won=Math.floor(scratchTierPrice*mult);
  const cardEl=document.createElement('div');
  cardEl.style.cssText=`background:var(--bg3);border:2px solid ${mult>0?'var(--gold)':'var(--bg5)'};border-radius:12px;padding:12px;text-align:center;animation:fadeIn .3s`;
  cardEl.innerHTML=`
    <div style="font-size:10px;color:var(--text3);margin-bottom:8px;letter-spacing:1px">${scratchTierIcon} ${mult>0?'WINNER!':'No match'}</div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:10px">
      ${symbols.map((s,i)=>`<div class="scratch-cell" onclick="revealCell(this,'${s}')" style="background:var(--bg5);border-radius:6px;font-size:22px;padding:8px;cursor:pointer;transition:.15s;min-height:44px;display:flex;align-items:center;justify-content:center">${i<3?s:'â“'}</div>`).join('')}
    </div>
    <div style="font-size:12px;font-weight:700;color:${won>0?'var(--gold)':'var(--text3)'}">${won>0?`Won $${fmt(won)}!`:'Better luck next time'}</div>
    ${won>0?`<button class="btn btn-primary btn-sm w-full mt-1" onclick="collectScratch(this,${won})">Collect $${fmt(won)}</button>`:''}
  `;
  // Auto-reveal first 3 (the match row)
  area.innerHTML='';
  area.appendChild(cardEl);
  if(won>0){tokenWin(0,'');G.balance+=won;G.totalEarned+=won;renderSidebar();saveGame();notify(`ðŸŽ« Scratch Win! +$${fmt(won)}`,'success');playSound('win');}
  else{notify('ðŸŽ« No match â€” try again!','error');playSound('lose');}
  addXP(2);
}
function revealCell(el,sym){el.textContent=sym;el.style.background='var(--bg4)';el.style.cursor='default';el.onclick=null;}
function collectScratch(btn,amt){btn.remove();notify(`ðŸ’° $${fmt(amt)} collected!`,'success');}

// ============================================================
// DAILY STREAK SYSTEM
// ============================================================
const STREAK_MILESTONES=[
  {days:1,reward:100,icon:'ðŸŒ±',label:'Newbie'},
  {days:3,reward:300,icon:'ðŸ”¥',label:'On Fire'},
  {days:7,reward:1000,icon:'ðŸ’«',label:'Week Warrior'},
  {days:14,reward:3000,icon:'âš¡',label:'2-Week Grinder'},
  {days:30,reward:10000,icon:'ðŸ‘‘',label:'Month Master'},
  {days:60,reward:50000,icon:'ðŸŒŸ',label:'Dedicated'},
  {days:100,reward:200000,icon:'ðŸ’Ž',label:'Legend'},
];
function checkDailyStreak(){
  if(!G)return;
  const today=new Date().toDateString();
  if(!G.loginStreak)G.loginStreak=0;
  if(!G.lastLoginDate)G.lastLoginDate='';
  if(!G.streakClaimedToday)G.streakClaimedToday=false;
  const yesterday=new Date(Date.now()-86400000).toDateString();
  if(G.lastLoginDate===today){
    // already logged in today, no change
  } else if(G.lastLoginDate===yesterday){
    G.loginStreak++;
    G.lastLoginDate=today;
    G.streakClaimedToday=false;
    saveGame();
  } else if(G.lastLoginDate!==today){
    // streak broken or first time
    if(G.lastLoginDate!=='')G.loginStreak=1;
    else G.loginStreak=1;
    G.lastLoginDate=today;
    G.streakClaimedToday=false;
    saveGame();
  }
  // Badge
  const badge=document.getElementById('streak-nav-badge');
  if(badge)badge.style.display=G.streakClaimedToday?'none':'inline';
}
function renderStreakPage(){
  const count=G.loginStreak||0;
  const claimed=G.streakClaimedToday||false;
  const emojis=['ðŸ˜´','ðŸŒ±','ðŸ”¥','ðŸ”¥','ðŸ’«','ðŸ’«','ðŸ’«','âš¡','âš¡','âš¡','âš¡','âš¡','âš¡','âš¡','ðŸ‘‘'];
  document.getElementById('streak-count-display').textContent=count;
  document.getElementById('streak-emoji-display').textContent=emojis[Math.min(count,emojis.length-1)];
  const claimArea=document.getElementById('streak-claim-area');
  const todayReward=100+count*50;
  claimArea.innerHTML=claimed
    ?`<div style="background:var(--bg4);border-radius:8px;padding:12px;font-size:13px;color:var(--text2)">âœ… Today's reward claimed! Come back tomorrow.</div>`
    :`<div style="background:linear-gradient(135deg,var(--bg4),var(--bg5));border-radius:12px;padding:16px;margin-bottom:8px">
        <div style="font-size:13px;color:var(--text2)">Today's reward</div>
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:32px;font-weight:700;color:var(--gold)">$${fmt(todayReward)}</div>
        <div style="font-size:12px;color:var(--text3);margin-bottom:10px">Day ${count} bonus</div>
        <button class="btn btn-primary btn-lg" onclick="claimStreakReward()">ðŸ”¥ Claim Day ${count} Reward</button>
      </div>`;
  // Milestones
  const grid=document.getElementById('streak-milestones');
  if(grid){
    grid.innerHTML=STREAK_MILESTONES.map(m=>{
      const done=count>=m.days;
      const current=!done&&count>=m.days-3;
      return `<div style="background:var(--bg4);border:2px solid ${done?'var(--gold)':current?'var(--accent)':'var(--bg5)'};border-radius:10px;padding:10px;text-align:center;opacity:${done||current?1:0.6}">
        <div style="font-size:24px">${done?'âœ…':m.icon}</div>
        <div style="font-size:11px;font-weight:700;color:${done?'var(--gold)':'var(--text2)'}">${m.label}</div>
        <div style="font-size:10px;color:var(--text3)">${m.days}d streak</div>
        <div style="font-size:12px;color:var(--green);font-weight:700">$${fmt(m.reward)}</div>
        ${done&&!G[`milestone_claimed_${m.days}`]?`<button class="btn btn-primary btn-sm w-full mt-1" onclick="claimMilestone(${m.days},${m.reward})">Claim!</button>`:''}
      </div>`;
    }).join('');
  }
}
function claimStreakReward(){
  if(G.streakClaimedToday)return;
  const reward=100+(G.loginStreak||0)*50;
  G.balance+=reward;G.totalEarned+=reward;
  G.streakClaimedToday=true;
  addHistory('Daily Streak Reward',reward,'win');
  notify(`ðŸ”¥ Day ${G.loginStreak} streak! +$${fmt(reward)}!`,'success');
  playSound('win');renderStreakPage();renderSidebar();saveGame();
  addXP(10);
  const badge=document.getElementById('streak-nav-badge');
  if(badge)badge.style.display='none';
}
function claimMilestone(days,reward){
  if(G[`milestone_claimed_${days}`])return;
  G[`milestone_claimed_${days}`]=true;
  G.balance+=reward;G.totalEarned+=reward;
  addHistory(`Streak Milestone: ${days}d`,reward,'win');
  notify(`ðŸ† Milestone! ${days}-day streak bonus: +$${fmt(reward)}!`,'rare');
  spawnParticles();playSound('knife');renderStreakPage();renderSidebar();saveGame();
}

// ============================================================
// HOT STREAK MULTIPLIER (casino wins in a row)
// ============================================================
function checkHotStreak(){
  if(!G)return;
  if(!G.hotStreak)G.hotStreak=0;
  if(!G.hotStreakMult)G.hotStreakMult=1;
  const el=document.getElementById('hot-streak-display');
  if(el){
    if(G.hotStreak>=3){
      el.style.display='flex';
      el.querySelector('#hs-count').textContent=G.hotStreak;
      el.querySelector('#hs-mult').textContent=(1+G.hotStreak*0.1).toFixed(1)+'x';
    } else {
      el.style.display='none';
    }
  }
}

// ============================================================
// ACTIVITY FEED (social proof sidebar ticker)
// ============================================================
const ACTIVITY_MSGS=[
  ()=>`<span style="color:var(--gold);font-weight:700">$WIN</span> ${rndPlayer()} won $${fmt(500+Math.random()*5000|0)}`,
  ()=>`<span style="color:var(--knife);font-weight:700">KNIFE</span> ${rndPlayer()} unboxed a ${['Karambit','Butterfly','M9 Bayonet','Gut Knife'][Math.random()*4|0]}`,
  ()=>`<span style="color:var(--accent);font-weight:700">OPEN</span> ${rndPlayer()} opened ${2+Math.random()*10|0} cases`,
  ()=>`<span style="color:var(--accent2);font-weight:700">TOUR</span> ${rndPlayer()} won a Tournament`,
  ()=>`<span style="color:var(--accent3);font-weight:700">FORGE</span> ${rndPlayer()} forged a Covert skin`,
  ()=>`<span style="color:var(--restricted);font-weight:700">50Ã—</span> ${rndPlayer()} hit 50Ã— on Limbo`,
  ()=>`<span style="color:var(--classified);font-weight:700">JACKPOT</span> ${rndPlayer()} won $${fmt(2000+Math.random()*10000|0)}`,
];
const PLAYER_NAMES=['xXSniper','DropKing','CasePro','HRoller','FragMaster','AceBot','LuckyOne','Pro99','VaultBoy','SkinHunter'];
function rndPlayer(){return PLAYER_NAMES[Math.random()*PLAYER_NAMES.length|0]+'_'+(Math.random()*99|0);}
function startActivityFeed(){
  const el=document.getElementById('activity-feed');
  if(!el)return;
  let msgs=[];
  function push(){
    const msg=ACTIVITY_MSGS[Math.random()*ACTIVITY_MSGS.length|0]();
    msgs.unshift(msg);if(msgs.length>4)msgs.pop();
    el.innerHTML=msgs.map(m=>`<div style="padding:3px 0;border-bottom:1px solid var(--bg4);font-size:11px;color:var(--text2)">${m}</div>`).join('');
  }
  push();setInterval(push,4000);
}

// ============================================================
// POPUP REWARD SYSTEM (first-time bonuses, surprise rewards)
// ============================================================
function checkFirstTimeBonus(){
  if(!G.firstTimeBonus){
    G.firstTimeBonus=true;
    setTimeout(()=>{
      showPopupReward('ðŸŽ‰ Welcome Bonus!','You got a free $500 to get started!',500,'cash');
    },2000);
    saveGame();
  }
}
function showPopupReward(title,msg,amount,type){
  const div=document.createElement('div');
  div.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:9000;display:flex;align-items:center;justify-content:center;animation:fadeIn .3s';
  div.innerHTML=`<div style="background:var(--bg2);border:2px solid var(--gold);border-radius:20px;padding:40px;text-align:center;max-width:380px;position:relative;overflow:hidden">
    <div style="position:absolute;top:-1px;left:20%;right:20%;height:2px;background:linear-gradient(90deg,transparent,var(--gold),transparent)"></div>
    <div style="margin-bottom:12px;display:flex;align-items:center;justify-content:center"><svg width="56" height="56" viewBox="0 0 56 56" fill="none"><circle cx="28" cy="28" r="26" fill="#f1c40f" opacity="0.15" stroke="#f1c40f" stroke-width="1.5"/><polygon points="28,10 32.7,21.7 45,22.6 36,30.5 38.7,42.6 28,36.3 17.3,42.6 20,30.5 11,22.6 23.3,21.7" fill="#f1c40f" opacity="0.8"/></svg></div>
    <div style="font-family:'Rajdhani',sans-serif;font-size:26px;font-weight:700;color:var(--gold)">${title}</div>
    <div style="color:var(--text2);margin:10px 0 20px;font-size:14px">${msg}</div>
    <div style="font-family:'Barlow Condensed',sans-serif;font-size:48px;font-weight:700;color:var(--green);margin-bottom:20px">+$${fmt(amount)}</div>
    <button class="btn btn-primary btn-lg" onclick="claimPopupReward(${amount},'${type}',this.parentElement.parentElement)">Claim!</button>
  </div>`;
  document.body.appendChild(div);
}
function claimPopupReward(amount,type,div){
  G.balance+=amount;G.totalEarned+=amount;
  renderSidebar();saveGame();
  spawnParticles();
  div.remove();
  notify(`ðŸŽ +$${fmt(amount)} claimed!`,'success');
}


// ============================================================
// COMBO CLICK SYSTEM
// ============================================================
let comboCount = 0;
let comboTimer = null;
let comboTimeout = 1500; // ms to reset combo

function updateCombo() {
  if (!G) return;
  const display = document.getElementById('combo-display');
  const badge = document.getElementById('combo-badge');
  const fill = document.getElementById('combo-fill');
  if (!display) return;
  if (comboCount >= 3) {
    display.style.display = 'block';
    const mult = Math.min(1 + (comboCount - 2) * 0.15, 5).toFixed(2);
    badge.textContent = mult + 'Ã— COMBO';
    badge.className = 'combo-badge' + (comboCount >= 20 ? ' ultra' : comboCount >= 10 ? ' hot' : '');
    // Animate fill timer
    fill.style.width = '100%';
    clearTimeout(comboTimer);
    comboTimer = setTimeout(() => {
      comboCount = 0;
      display.style.display = 'none';
    }, comboTimeout);
  } else {
    display.style.display = 'none';
  }
}

// Patch doClick to add combo
const _origDoClick = doClick;
function doClick(e) {
  comboCount++;
  updateCombo();
  // Apply combo multiplier to click value
  const combMult = comboCount >= 3 ? Math.min(1 + (comboCount - 2) * 0.15, 5) : 1;
  const origVal = G.clickValue;
  G.clickValue = origVal * combMult;
  _origDoClick(e);
  G.clickValue = origVal;
  // Earn reagents occasionally
  if (Math.random() < 0.03) {
    earnReagent();
  }
}

// ============================================================
// QUICK BET
// ============================================================
function quickBet(mult, winChance) {
  const betEl = document.getElementById('qb-bet');
  const bet = parseFloat(betEl?.value) || 50;
  const res = document.getElementById('qb-result');
  if (!G || G.balance < bet) { if (res) { res.style.color = 'var(--red)'; res.textContent = 'Not enough balance!'; } return; }
  G.balance -= bet;
  addXP(1);
  const roll = Math.random();
  if (roll < winChance) {
    const won = +(bet * mult).toFixed(2);
    G.balance += won;
    G.totalEarned += won;
    addHistory('Quick Bet ' + mult + 'Ã—', won - bet, 'win');
    if (res) { res.style.color = 'var(--green)'; res.textContent = '+$' + fmt(won - bet) + ' WIN!'; }
    playSound('win');
    if (G.hotStreak !== undefined) { G.hotStreak++; checkHotStreak(); }
  } else {
    addHistory('Quick Bet ' + mult + 'Ã—', -bet, 'loss');
    if (res) { res.style.color = 'var(--red)'; res.textContent = '-$' + fmt(bet) + ' LOSS'; }
    playSound('lose');
    if (G.hotStreak !== undefined) { G.hotStreak = 0; checkHotStreak(); }
  }
  renderSidebar();
  checkMissions();
  saveGame();
}

// ============================================================
// BOTTOM HOTBAR SYNC
// ============================================================
function syncHotbar(page) {
  document.querySelectorAll('.hb-btn').forEach(b => b.classList.remove('active'));
  const map = { clicker: 'hb-clicker', cases: 'hb-cases', casino: 'hb-casino', inventory: 'hb-inventory', missions: 'hb-missions' };
  if (map[page]) document.getElementById(map[page])?.classList.add('active');
  // Mission badge sync
  const mb = document.getElementById('hb-mission-badge');
  const origMB = document.getElementById('mission-badge');
  if (mb && origMB) mb.style.display = origMB.style.display;
}

// Patch showPage to sync hotbar
const _origShowPage = showPage;
function showPage(id) {
  _origShowPage(id);
  syncHotbar(id);
}

// ============================================================
// RANKED MATCHES
// ============================================================
const RANKED_TIERS = [
  { name: 'Bronze', color: '#cd7f32', minElo: 0, reward: 300 },
  { name: 'Silver', color: '#c0c0c0', minElo: 1100, reward: 800 },
  { name: 'Gold', color: '#f1c40f', minElo: 1300, reward: 2000 },
  { name: 'Platinum', color: '#00e5ff', minElo: 1600, reward: 6000 },
  { name: 'Diamond', color: '#b44fff', minElo: 2000, reward: 20000 },
  { name: 'Elite', color: '#ff4444', minElo: 2500, reward: 80000 },
];

function getRankedTier(elo) {
  for (let i = RANKED_TIERS.length - 1; i >= 0; i--) {
    if (elo >= RANKED_TIERS[i].minElo) return RANKED_TIERS[i];
  }
  return RANKED_TIERS[0];
}

function renderRankedPage() {
  if (!G) return;
  const eloEl = document.getElementById('ranked-elo-display');
  if (eloEl) eloEl.textContent = G.elo || 1000;
  const tier = getRankedTier(G.elo || 1000);
  const tierEl = document.getElementById('ranked-tier-badge');
  if (tierEl) { tierEl.textContent = tier.name; tierEl.style.color = tier.color; }
  if (!G.rankedWins) G.rankedWins = 0;
  if (!G.rankedLosses) G.rankedLosses = 0;
  const wEl = document.getElementById('ranked-wins');
  if (wEl) wEl.textContent = G.rankedWins;
  const lEl = document.getElementById('ranked-losses');
  if (lEl) lEl.textContent = G.rankedLosses;
  // Render tiers
  const grid = document.getElementById('ranked-tiers-display');
  if (grid) {
    grid.innerHTML = RANKED_TIERS.map(t => {
      const active = tier.name === t.name;
      return `<div style="background:var(--bg4);border-radius:8px;padding:10px;text-align:center;border:1px solid ${active ? t.color : 'transparent'}">
        <div style="font-size:18px;font-weight:700;color:${t.color};font-family:'Barlow Condensed'">${t.name}</div>
        <div style="font-size:9px;color:var(--text3)">${t.minElo}+ ELO</div>
        <div style="font-size:11px;color:var(--green);margin-top:2px">+$${fmt(t.reward)}</div>
      </div>`;
    }).join('');
  }
}

function startRankedMatch(entry) {
  if (!G) return;
  if (G.balance < entry) { notify('Not enough balance!', 'error'); return; }
  if (G.rankedActive) { notify('Already in a match!', 'error'); return; }
  G.balance -= entry;
  G.rankedEntry = entry;
  G.rankedActive = true;
  G.rankedRound = 1;
  G.rankedRoundsWon = 0;
  const botName = ['AceKiller', 'ProPlayer', 'FragBot', 'HeadshotKing', 'EliteSniper'][Math.random() * 5 | 0] + '_' + (Math.random() * 99 | 0);
  const botElo = (G.elo || 1000) + Math.floor(Math.random() * 200 - 50);
  G.rankedBot = { name: botName, elo: botElo, hp: 100 };
  G.rankedPlayerHp = 100;
  addHistory('Ranked Match Entry', -entry, 'expense');
  renderSidebar();
  renderRankedArena();
  saveGame();
}

function renderRankedArena() {
  if (!G || !G.rankedActive) { renderRankedPage(); return; }
  const content = document.getElementById('ranked-content');
  if (!content) return;
  const bot = G.rankedBot;
  const pHpPct = Math.max(0, G.rankedPlayerHp);
  const bHpPct = Math.max(0, bot.hp);
  content.innerHTML = `
    <div class="ranked-arena">
      <div style="font-size:12px;color:var(--text2);margin-bottom:4px">ROUND ${G.rankedRound} / 5 â€” WINS: ${G.rankedRoundsWon}</div>
      <div class="ranked-vs">
        <div class="ranked-fighter">
          <div class="ranked-fighter-name">${G.username}</div>
          <div class="ranked-fighter-elo">ELO: ${G.elo || 1000}</div>
          <div class="ranked-hp"><div class="ranked-hp-fill" style="width:${pHpPct}%;background:var(--green)"></div></div>
          <div style="font-size:11px;color:var(--text3);margin-top:4px">${pHpPct}/100 HP</div>
        </div>
        <div style="font-family:'Rajdhani',sans-serif;font-size:28px;font-weight:700;color:var(--accent)">VS</div>
        <div class="ranked-fighter">
          <div class="ranked-fighter-name">${bot.name}</div>
          <div class="ranked-fighter-elo">ELO: ${bot.elo}</div>
          <div class="ranked-hp"><div class="ranked-hp-fill" style="width:${bHpPct}%;background:var(--red)"></div></div>
          <div style="font-size:11px;color:var(--text3);margin-top:4px">${bHpPct}/100 HP</div>
        </div>
      </div>
      <div class="ranked-log" id="ranked-log">${G.rankedLog || 'Battle begins!'}</div>
      <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
        <button class="btn btn-red btn-lg" onclick="rankedAttack('normal')">Attack</button>
        <button class="btn btn-secondary" onclick="rankedAttack('heavy')">Heavy (20% HP cost)</button>
        <button class="btn btn-secondary btn-sm" onclick="forfeitRanked()">Forfeit</button>
      </div>
    </div>`;
}

function rankedAttack(type) {
  if (!G || !G.rankedActive) return;
  const bot = G.rankedBot;
  let playerDmg = 20 + Math.random() * 30 | 0;
  let botDmg = 15 + Math.random() * 25 | 0;
  let logMsg = '';
  if (type === 'heavy') {
    if (G.rankedPlayerHp < 20) { notify('Not enough HP for heavy!', 'error'); return; }
    G.rankedPlayerHp -= 20;
    playerDmg = 40 + Math.random() * 40 | 0;
    logMsg += `You used Heavy Strike! `;
  }
  // Apply ELO difference as small modifier
  const eloDiff = (G.elo || 1000) - bot.elo;
  playerDmg = Math.max(5, playerDmg + Math.floor(eloDiff / 100));
  bot.hp = Math.max(0, bot.hp - playerDmg);
  G.rankedPlayerHp = Math.max(0, G.rankedPlayerHp - botDmg);
  logMsg += `You hit ${playerDmg}. Bot hit ${botDmg}.`;
  if (!G.rankedLog) G.rankedLog = '';
  G.rankedLog = logMsg + '\n' + G.rankedLog;
  playSound('click');
  // Check round end
  if (bot.hp <= 0) {
    G.rankedRoundsWon++;
    G.rankedLog = `You won Round ${G.rankedRound}!\n` + G.rankedLog;
    if (G.rankedRound >= 5 || G.rankedRoundsWon >= 3) {
      rankedMatchEnd(true);
      return;
    }
    G.rankedRound++;
    G.rankedPlayerHp = Math.min(100, G.rankedPlayerHp + 30); // heal between rounds
    bot.hp = 100;
  } else if (G.rankedPlayerHp <= 0) {
    G.rankedLog = `You lost Round ${G.rankedRound}.\n` + G.rankedLog;
    if (G.rankedRound >= 5 || (G.rankedRound - G.rankedRoundsWon) >= 3) {
      rankedMatchEnd(false);
      return;
    }
    G.rankedRound++;
    G.rankedPlayerHp = Math.min(100, G.rankedPlayerHp + 25);
    bot.hp = 100;
  }
  renderRankedArena();
  saveGame();
}

function rankedMatchEnd(won) {
  if (!G) return;
  G.rankedActive = false;
  const tier = getRankedTier(G.elo || 1000);
  if (won) {
    G.elo = (G.elo || 1000) + 25;
    if (!G.rankedWins) G.rankedWins = 0;
    G.rankedWins++;
    const reward = G.rankedEntry * 2 + tier.reward;
    G.balance += reward;
    G.totalEarned += reward;
    addHistory('Ranked Match WIN', reward, 'win');
    notify('Ranked WIN! +$' + fmt(reward) + ' | ELO: +25', 'success');
    spawnParticles();
    addXP(50);
  } else {
    G.elo = Math.max(800, (G.elo || 1000) - 20);
    if (!G.rankedLosses) G.rankedLosses = 0;
    G.rankedLosses++;
    addHistory('Ranked Match LOSS', -G.rankedEntry, 'loss');
    notify('Ranked LOSS â€” ELO: -20', 'error');
  }
  G.rankedLog = '';
  renderSidebar();
  renderRankedPage();
  saveGame();
}

function forfeitRanked() {
  if (!G || !G.rankedActive) return;
  G.rankedActive = false;
  G.rankedLog = '';
  G.elo = Math.max(800, (G.elo || 1000) - 10);
  notify('Forfeited â€” ELO: -10', 'error');
  renderRankedPage();
  saveGame();
}

// ============================================================
// PRESTIGE STORE
// ============================================================
const PRESTIGE_STORE = [
  { id: 'ps_luck', name: 'Oracle\'s Eye', desc: 'Permanently +15% luck on all drops. Stacks 3 times.', cost: 1, max: 3, effect: 'luck15', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="#ff44ff" stroke-width="2"><circle cx="12" cy="12" r="8"/><circle cx="12" cy="12" r="3" fill="#ff44ff" opacity="0.5"/></svg>' },
  { id: 'ps_click', name: 'Golden Touch', desc: 'Permanently doubles your click value. Stacks.', cost: 2, max: 5, effect: 'clickx2', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="#ff44ff" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01z"/></svg>' },
  { id: 'ps_cps', name: 'Auto Overlord', desc: '+$2/s permanent passive income. Stacks 10 times.', cost: 1, max: 10, effect: 'cps2', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="#ff44ff" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>' },
  { id: 'ps_xp', name: 'Scholar\'s Crest', desc: 'Earn 50% more XP from all sources permanently.', cost: 2, max: 3, effect: 'xp150', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="#ff44ff" stroke-width="2"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>' },
  { id: 'ps_bank', name: 'Compound King', desc: 'Bank interest rate goes to 4% daily permanently.', cost: 3, max: 1, effect: 'bankint', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="#ff44ff" stroke-width="2"><rect x="2" y="8" width="20" height="12" rx="2"/><path d="M12 2L2 8h20L12 2z"/></svg>' },
  { id: 'ps_inv', name: 'Vault Expander', desc: 'Inventory capacity +100. Can be purchased unlimited times.', cost: 1, max: 99, effect: 'invslots', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="#ff44ff" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 0 0-4 0v2M8 7V5a2 2 0 0 0-4 0"/></svg>' },
  { id: 'ps_reagent', name: 'Alchemist\'s Gift', desc: 'Reagents drop 3x more often from case openings.', cost: 2, max: 1, effect: 'reagent3x', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="#ff44ff" stroke-width="2"><path d="M10 2v7.31L6 20h12l-4-10.69V2"/><path d="M8.5 2h7"/></svg>' },
  { id: 'ps_combo', name: 'Fury Hands', desc: 'Combo multiplier cap raised from 5Ã— to 10Ã—.', cost: 3, max: 1, effect: 'combomax', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="#ff44ff" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>' },
];

function renderPrestigeStore() {
  if (!G) return;
  if (!G.prestigeTokens) G.prestigeTokens = 0;
  const tokenEl = document.getElementById('pstore-tokens');
  if (tokenEl) tokenEl.textContent = G.prestigeTokens;
  const grid = document.getElementById('pstore-grid');
  if (!grid) return;
  if (!G.pstoreOwned) G.pstoreOwned = {};
  grid.innerHTML = PRESTIGE_STORE.map(item => {
    const owned = G.pstoreOwned[item.id] || 0;
    const atMax = item.max && owned >= item.max;
    const canAfford = G.prestigeTokens >= item.cost;
    return `<div class="pstore-card ${atMax ? 'owned' : ''}" onclick="${atMax ? '' : `buyPrestigeStore('${item.id}')`}" style="${atMax ? 'cursor:default' : ''}">
      <div class="pstore-icon">${item.icon}</div>
      <div style="flex:1">
        <div style="font-weight:700;margin-bottom:2px;font-size:14px">${item.name} ${owned > 0 ? `<span style="color:var(--accent);font-size:11px">Lv${owned}</span>` : ''}</div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:8px">${item.desc}</div>
        <div style="display:flex;align-items:center;gap:8px">
          ${atMax
            ? `<span style="color:var(--green);font-size:12px;font-weight:700">MAXED</span>`
            : `<span style="font-family:'Barlow Condensed';font-size:16px;font-weight:700;color:${canAfford ? 'rgba(255,68,255,1)' : 'var(--text3)'}">
                ${item.cost} Token${item.cost > 1 ? 's' : ''}
               </span>`}
          ${item.max > 1 ? `<span style="font-size:10px;color:var(--text3)">${owned}/${item.max}</span>` : ''}
        </div>
      </div>
    </div>`;
  }).join('');
}

function buyPrestigeStore(id) {
  if (!G) return;
  const item = PRESTIGE_STORE.find(p => p.id === id);
  if (!item) return;
  if (!G.pstoreOwned) G.pstoreOwned = {};
  const owned = G.pstoreOwned[id] || 0;
  if (item.max && owned >= item.max) { notify('Already maxed!', 'error'); return; }
  if ((G.prestigeTokens || 0) < item.cost) { notify('Not enough Prestige Tokens!', 'error'); return; }
  G.prestigeTokens -= item.cost;
  G.pstoreOwned[id] = owned + 1;
  // Apply effect
  applyPrestigeStoreEffect(item.effect);
  notify(item.name + ' purchased!', 'rare');
  renderPrestigeStore();
  saveGame();
}

function applyPrestigeStoreEffect(effect) {
  if (!G) return;
  if (effect === 'luck15') G.luckBonus = (G.luckBonus || 0) + 15;
  if (effect === 'clickx2') G.clickValue = (G.clickValue || 0.5) * 2;
  if (effect === 'cps2') G.cps = (G.cps || 0) + 2;
  if (effect === 'xp150') G.xpMult = (G.xpMult || 1) * 1.5;
  if (effect === 'bankint') G.bankInterestRate = 0.04;
  if (effect === 'combomax') comboTimeout = 2500;
  renderSidebar();
}

// ============================================================
// LUCK LAB (REAGENTS & POTIONS)
// ============================================================
const REAGENTS = [
  { id: 'rg_green', name: 'Verdant Dust', color: '#2ecc71', desc: '+5% luck for 10 min', brew: 'minor' },
  { id: 'rg_blue', name: 'Azure Shard', color: '#3498db', desc: 'Needed for medium brews', brew: 'medium' },
  { id: 'rg_purple', name: 'Void Fragment', color: '#8847ff', desc: 'Rare â€” for powerful brews', brew: 'major' },
  { id: 'rg_gold', name: 'Gilded Essence', color: '#f1c40f', desc: 'High value reagent', brew: 'major' },
  { id: 'rg_red', name: 'Crimson Catalyst', color: '#eb4b4b', desc: 'Boosts any brew', brew: 'boost' },
];

const BREWS = {
  minor: { name: 'Minor Luck Potion', luck: 10, duration: 600, color: '#2ecc71' },
  medium: { name: 'Medium Luck Potion', luck: 25, duration: 1200, color: '#3498db' },
  major: { name: 'Major Luck Potion', luck: 50, duration: 1800, color: '#8847ff' },
  supreme: { name: 'Supreme Luck Elixir', luck: 100, duration: 3600, color: '#f1c40f' },
};

let brewSlots = [null, null, null];

function earnReagent() {
  if (!G) return;
  if (!G.reagents) G.reagents = {};
  // Reagent 3x perk check
  const mult = (G.pstoreOwned && G.pstoreOwned.ps_reagent) ? 3 : 1;
  const rg = REAGENTS[Math.random() * REAGENTS.length | 0];
  G.reagents[rg.id] = (G.reagents[rg.id] || 0) + mult;
  notify('Reagent found: ' + rg.name + '!', 'success');
  renderReagentGrid();
  saveGame();
}

function renderReagentGrid() {
  const grid = document.getElementById('reagent-grid');
  if (!grid || !G) return;
  if (!G.reagents) G.reagents = {};
  grid.innerHTML = REAGENTS.map(rg => {
    const count = G.reagents[rg.id] || 0;
    return `<div class="reagent-card ${brewSlots.includes(rg.id) ? 'selected' : ''}" onclick="addToBrewSlot('${rg.id}')">
      <div class="reagent-icon">
        <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
          <circle cx="20" cy="20" r="16" fill="${rg.color}" opacity="0.15" stroke="${rg.color}" stroke-width="1.5"/>
          <path d="M16 10h8v8l4 10H12L16 18V10z" fill="${rg.color}" opacity="0.5"/>
          <path d="M14 10h12" stroke="${rg.color}" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
      </div>
      <div style="font-size:12px;font-weight:700;margin-bottom:2px">${rg.name}</div>
      <div style="font-size:10px;color:var(--text3);margin-bottom:6px">${rg.desc}</div>
      <div style="font-family:'Barlow Condensed';font-size:18px;font-weight:700;color:${count > 0 ? rg.color : 'var(--text3)'}">${count}</div>
    </div>`;
  }).join('');
}

function addToBrewSlot(id) {
  if (!G || !G.reagents) return;
  if ((G.reagents[id] || 0) <= 0) { notify('No ' + (REAGENTS.find(r => r.id === id)?.name || 'reagent') + '!', 'error'); return; }
  const emptySlot = brewSlots.indexOf(null);
  if (emptySlot === -1) { notify('Brew slots full!', 'error'); return; }
  brewSlots[emptySlot] = id;
  G.reagents[id]--;
  updateBrewSlotDisplay();
  renderReagentGrid();
}

function clearBrewSlot(i) {
  if (!G) return;
  if (brewSlots[i]) {
    if (!G.reagents) G.reagents = {};
    G.reagents[brewSlots[i]] = (G.reagents[brewSlots[i]] || 0) + 1;
    brewSlots[i] = null;
    updateBrewSlotDisplay();
    renderReagentGrid();
  }
}

function updateBrewSlotDisplay() {
  [0, 1, 2].forEach(i => {
    const slot = document.getElementById('brew-slot-' + i);
    if (!slot) return;
    if (brewSlots[i]) {
      const rg = REAGENTS.find(r => r.id === brewSlots[i]);
      slot.classList.add('filled');
      slot.innerHTML = `<div style="text-align:center"><div style="width:32px;height:32px;border-radius:50%;background:${rg.color}40;margin:0 auto 2px;display:flex;align-items:center;justify-content:center"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="${rg.color}" stroke-width="2"><path d="M10 2v7.31L6 20h12l-4-10.69V2"/></svg></div><div style="font-size:9px;color:var(--text2)">${rg.name.split(' ')[0]}</div></div>`;
    } else {
      slot.classList.remove('filled');
      slot.innerHTML = `<span style="color:var(--text3);font-size:10px">Slot ${i + 1}</span>`;
    }
  });
  // Preview brew result
  const preview = document.getElementById('brew-preview');
  if (!preview) return;
  const filled = brewSlots.filter(Boolean);
  if (filled.length === 0) { preview.textContent = 'Add reagents to see what you\'ll brew'; return; }
  const brew = predictBrew(filled);
  preview.innerHTML = brew
    ? `Will brew: <span style="color:${brew.color};font-weight:700">${brew.name}</span> (+${brew.luck}% luck for ${brew.duration / 60}min)`
    : `<span style="color:var(--text3)">This combination doesn't work yet...</span>`;
}

function predictBrew(slots) {
  const types = slots.map(id => REAGENTS.find(r => r.id === id)?.brew).filter(Boolean);
  const hasBoost = types.includes('boost');
  const mainTypes = types.filter(t => t !== 'boost');
  if (mainTypes.includes('major') && mainTypes.length >= 2) return hasBoost ? BREWS.supreme : BREWS.major;
  if (mainTypes.includes('medium')) return BREWS.medium;
  if (mainTypes.includes('minor') || mainTypes.length >= 1) return BREWS.minor;
  return null;
}

function brewPotion() {
  const filled = brewSlots.filter(Boolean);
  if (filled.length === 0) { notify('Add reagents first!', 'error'); return; }
  const brew = predictBrew(filled);
  const res = document.getElementById('brew-result');
  if (!brew) {
    if (res) { res.style.color = 'var(--red)'; res.textContent = 'Brew failed! Invalid combination.'; }
    brewSlots = [null, null, null];
    updateBrewSlotDisplay();
    return;
  }
  // Apply potion
  if (!G.activePotions) G.activePotions = [];
  G.activePotions.push({ ...brew, expiry: Date.now() + brew.duration * 1000 });
  G.luckBonus = (G.luckBonus || 0) + brew.luck;
  brewSlots = [null, null, null];
  updateBrewSlotDisplay();
  if (res) { res.style.color = brew.color; res.textContent = brew.name + ' brewed! +' + brew.luck + '% luck active!'; }
  notify(brew.name + ' active! +' + brew.luck + '% luck!', 'rare');
  spawnParticles();
  playSound('knife');
  renderLabStatus();
  saveGame();
}

function renderLabStatus() {
  const el = document.getElementById('lab-active-potion');
  const timer = document.getElementById('lab-potion-timer');
  if (!el || !G) return;
  if (!G.activePotions) G.activePotions = [];
  // Clean expired
  G.activePotions = G.activePotions.filter(p => Date.now() < p.expiry);
  if (G.activePotions.length === 0) {
    el.textContent = 'No active potion. Brew one below!';
    if (timer) timer.textContent = '';
    return;
  }
  const p = G.activePotions[0];
  el.innerHTML = `<span style="color:${p.color};font-weight:700">${p.name}</span> â€” +${p.luck}% luck`;
  const remaining = Math.max(0, Math.ceil((p.expiry - Date.now()) / 1000));
  if (timer) timer.textContent = `Expires in: ${Math.floor(remaining / 60)}m ${remaining % 60}s`;
}

// ============================================================
// INIT EXTENSIONS (append to existing initAppExtensions)
// ============================================================
const _origInitAppExtensions = typeof initAppExtensions === 'function' ? initAppExtensions : () => {};
function initAppExtensions() {
  _origInitAppExtensions();
  renderRankedPage();
  renderPrestigeStore();
  renderReagentGrid();
  setInterval(renderLabStatus, 5000);
  // Award prestige tokens when prestige happens (patch doPrestige)
  patchPrestigeForTokens();
}

function patchPrestigeForTokens() {
  const _orig = window.doPrestige;
  if (!_orig) return;
  window.doPrestige = function() {
    const prevLevel = G.level || 1;
    _orig();
    // Award tokens based on level reached
    const tokens = Math.max(1, Math.floor(prevLevel / 10));
    G.prestigeTokens = (G.prestigeTokens || 0) + tokens;
    notify('Prestige! Earned ' + tokens + ' Prestige Token' + (tokens > 1 ? 's' : '') + '!', 'rare');
    renderPrestigeStore();
  };
}


  startLoginTicker();
  loadAccounts();
  const lastUser=localStorage.getItem('csroll_last_user');
  if(lastUser&&ACCOUNTS[lastUser]&&ACCOUNTS[lastUser].state){
    currentUser=lastUser;
    G=ACCOUNTS[lastUser].state;
    if(!G.missions)G.missions=generateMissions();
    if(!G.marketTrend)G.marketTrend=Array.from({length:20},()=>+(0.8+Math.random()*0.4).toFixed(2));
    G.username=lastUser;
    migrateSave();
    startApp();
    return;
  }
  const sfx=document.getElementById('sfx-toggle');
  if(sfx)sfx.checked=true;
});
</script>
</body>
</html>
